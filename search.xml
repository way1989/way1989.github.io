<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>è§£è€¦ç¥å™¨Dagger2</title>
      <link href="/2017/09/10/blogs/Dagger2/"/>
      <url>/2017/09/10/blogs/Dagger2/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€-Dagger2ä»‹ç»"><a href="#ä¸€-Dagger2ä»‹ç»" class="headerlink" title="ä¸€. Dagger2ä»‹ç»"></a>ä¸€. Dagger2ä»‹ç»</h2><h3 id="1-Dagger2æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#1-Dagger2æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1.Dagger2æ˜¯ä»€ä¹ˆï¼Ÿ"></a>1.Dagger2æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>&emsp;&emsp;Dagger2æ˜¯ç”±Googleæ¥æ‰‹å¼€å‘ï¼Œæœ€æ—©çš„ç‰ˆæœ¬Dagger1 æ˜¯ç”±Squareå…¬å¸å¼€å‘çš„ï¼Œå¤§ç¥<a href="https://github.com/JakeWharton">JakeWharton</a>æœ€è¿‘ä¹Ÿä» Square å…¬å¸è·³æ§½åˆ° Googleã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A fast dependency injector <span class="keyword">for</span> Android and Java</span><br><span class="line">Androidå’ŒJavaçš„ä¾èµ–å¿«é€Ÿæ³¨å…¥å™¨</span><br></pre></td></tr></table></figure><h3 id="2-Dagger2ç›¸è¾ƒäºDagger1çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#2-Dagger2ç›¸è¾ƒäºDagger1çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="2. Dagger2ç›¸è¾ƒäºDagger1çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ"></a>2. Dagger2ç›¸è¾ƒäºDagger1çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ</h3><ul><li><strong>æ›´å¥½çš„æ€§èƒ½</strong>ï¼šç›¸è¾ƒäºDagger1ï¼Œå®ƒä½¿ç”¨çš„é¢„ç¼–è¯‘æœŸé—´ç”Ÿæˆä»£ç æ¥å®Œæˆä¾èµ–æ³¨å…¥ï¼Œè€Œä¸æ˜¯ç”¨çš„åå°„ã€‚å¤§å®¶çŸ¥é“åå°„å¯¹æ‰‹æœºåº”ç”¨å¼€å‘å½±å“æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œå› ä¸ºåå°„æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ è½½ç±»æ¥è¿›è¡Œå¤„ç†æ‰€ä»¥ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œè€Œæ‰‹æœºç¡¬ä»¶èµ„æºæœ‰é™ï¼Œæ‰€ä»¥ç›¸å¯¹æ¥è¯´ä¼šå¯¹æ€§èƒ½äº§ç”Ÿä¸€å®šçš„å½±å“ã€‚</li><li><strong>å®¹æ˜“è·Ÿè¸ªè°ƒè¯•</strong>ï¼šå› ä¸ºDagger2æ˜¯ä½¿ç”¨ç”Ÿæˆä»£ç æ¥å®ç°å®Œæ•´ä¾èµ–æ³¨å…¥ï¼Œæ‰€ä»¥å®Œå…¨å¯ä»¥åœ¨ç›¸å…³ä»£ç å¤„ä¸‹æ–­ç‚¹è¿›è¡Œè¿è¡Œè°ƒè¯•ã€‚</li></ul><h3 id="3-ä½¿ç”¨ä¾èµ–æ³¨å…¥çš„æœ€å¤§å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#3-ä½¿ç”¨ä¾èµ–æ³¨å…¥çš„æœ€å¤§å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="3. ä½¿ç”¨ä¾èµ–æ³¨å…¥çš„æœ€å¤§å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ"></a>3. ä½¿ç”¨ä¾èµ–æ³¨å…¥çš„æœ€å¤§å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>&emsp;&emsp;å¿«é€Ÿè‡ªåŠ¨çš„æ„å»ºå‡ºæˆ‘ä»¬æ‰€éœ€è¦çš„ä¾èµ–å¯¹è±¡ï¼Œè¿™é‡Œçš„ä¾èµ–å¯¹è±¡å¯ä»¥ç†è§£ä¸ºæŸä¸€ä¸ªæˆå‘˜å˜é‡ã€‚ä¾‹å¦‚åœ¨ <code>MVP</code> ä¸­ï¼Œ<code>VP</code> å±‚å°±æ˜¯äº’ç›¸å…³è”çš„ï¼Œ <code>V</code> è¦ä¾èµ–å¯¹åº”çš„ <code>P</code>ï¼Œè€Œ <code>P</code> ä¹Ÿè¦ä¾èµ–å¯¹åº”çš„ <code>V</code> ã€‚Dagger2 èƒ½è§£å†³çš„å°±æ˜¯è¿™ç§ä¾èµ–å…³ç³»ï¼Œé€šè¿‡æ³¨å…¥çš„æ–¹å¼ï¼Œå°†åŒæ–¹çš„è€¦åˆå†æ¬¡é™ä½ï¼Œåœ¨å®é™…çš„ä½¿ç”¨ä¸­ä½“ç°ä¸ºä¸€ä¸ªæ³¨è§£æƒ³è¦çš„å¯¹è±¡å°±åˆ›å»ºå¥½äº†ï¼Œå’±ä»¬ä¸ç”¨å†å»ç®¡ç†æ‰€ä¾èµ–å¯¹è±¡çš„åˆ›å»ºç­‰æƒ…å†µäº†ã€‚</p><h3 id="4-ä¸¾ä¸ªä¾‹å­"><a href="#4-ä¸¾ä¸ªä¾‹å­" class="headerlink" title="4. ä¸¾ä¸ªä¾‹å­"></a>4. ä¸¾ä¸ªä¾‹å­</h3><p>&emsp;&emsp;å¦‚æœåœ¨ <code>MainActivity</code> ä¸­ï¼Œæœ‰ <code>Tinno</code>çš„å®ä¾‹ï¼Œåˆ™ç§° <code>MainActivity</code> å¯¹ <code>Tinno</code> æœ‰ä¸€ä¸ªä¾èµ–ã€‚å¦‚æœä¸ç”¨Dagger2çš„æƒ…å†µä¸‹æˆ‘ä»¬åº”è¯¥è¿™ä¹ˆå†™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Tinno mTinno;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">MainActivity</span><span class="params">()</span> &#123;</span><br><span class="line">    mTinno = <span class="keyword">new</span> <span class="title class_">Tinno</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;ä¸Šé¢ä¾‹å­é¢ä¸´ç€ä¸€ä¸ªé—®é¢˜ï¼Œä¸€æ—¦æŸä¸€å¤©<code>Tinno</code>çš„åˆ›å»ºæ–¹å¼ï¼ˆå¦‚æ„é€ å‚æ•°ï¼‰å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆä½ ä¸ä½†éœ€è¦ä¿®æ”¹<code>MainActivity</code>ä¸­åˆ›å»º<code>Tinno</code>çš„ä»£ç ï¼Œè¿˜è¦ä¿®æ”¹å…¶ä»–æ‰€æœ‰åœ°æ–¹åˆ›å»º<code>Tinno</code>çš„ä»£ç ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨äº†Dagger2çš„è¯ï¼Œå°±ä¸éœ€è¦ç®¡è¿™äº›äº†ï¼Œåªéœ€è¦åœ¨éœ€è¦<code>Tinno</code>çš„åœ°æ–¹å†™ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Inject</span></span><br><span class="line">Tinno mTinno;</span><br></pre></td></tr></table></figure><h2 id="äºŒ-Dagger2ä½¿ç”¨"><a href="#äºŒ-Dagger2ä½¿ç”¨" class="headerlink" title="äºŒ. Dagger2ä½¿ç”¨"></a>äºŒ. Dagger2ä½¿ç”¨</h2><h3 id="1-gradleé…ç½®"><a href="#1-gradleé…ç½®" class="headerlink" title="1. gradleé…ç½®"></a>1. gradleé…ç½®</h3><p>&emsp;&emsp;Android Studio 2.2ä»¥å‰çš„ç‰ˆæœ¬éœ€è¦ä½¿ç”¨Gradleæ’ä»¶<code>android-apt</code>(Annotation Processing Tool)ï¼ŒååŠ©Android Studioå¤„ç†<code>annotation processors</code>ï¼›<code>annotationProcessor</code>å°±æ˜¯APTå·¥å…·ä¸­çš„ä¸€ç§ï¼Œæ˜¯googleå¼€å‘çš„å†…ç½®æ¡†æ¶ï¼Œä¸éœ€è¦å¼•å…¥ï¼Œæ‰€ä»¥å¯ä»¥åƒä¸‹é¢è¿™æ ·ç›´æ¥ä½¿ç”¨ã€‚</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add Dagger dependencies</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">  compile <span class="string">&#x27;com.google.dagger:dagger:2.4&#x27;</span></span><br><span class="line">  annotationProcessor <span class="string">&#x27;com.google.dagger:dagger-compiler:2.4&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-æ³¨è§£"><a href="#2-æ³¨è§£" class="headerlink" title="2. æ³¨è§£"></a>2. æ³¨è§£</h3><p>&emsp;&emsp;Dagger2 é€šè¿‡æ³¨è§£æ¥ç”Ÿæˆä»£ç ï¼Œå®šä¹‰ä¸åŒçš„è§’è‰²ï¼Œä¸»è¦çš„æ³¨è§£å¦‚ä¸‹ï¼š</p><ul><li><strong>@Module</strong>: ç”¨æ¥æ ‡æ³¨ç±»ï¼Œ<code>Module</code>ç±»é‡Œé¢çš„æ–¹æ³•ä¸“é—¨æä¾›ä¾èµ–ï¼Œæ‰€ä»¥æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç±»ï¼Œç”¨<code>@Module</code>æ³¨è§£ï¼Œè¿™æ ·Daggeråœ¨æ„é€ ç±»çš„å®ä¾‹çš„æ—¶å€™ï¼Œå°±çŸ¥é“ä»å“ªé‡Œå»æ‰¾åˆ°éœ€è¦çš„ä¾èµ–ã€‚</li><li><strong>@Provides</strong>: ç”¨æ¥æ ‡æ³¨æ–¹æ³•ï¼Œåœ¨<code>Module</code>ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰çš„æ–¹æ³•æ˜¯ç”¨è¿™ä¸ªæ³¨è§£ï¼Œä»¥æ­¤æ¥å‘Šè¯‰<code>Dagger2</code>æˆ‘ä»¬æƒ³è¦æ„é€ å¯¹è±¡å¹¶æä¾›è¿™äº›ä¾èµ–ã€‚</li><li><strong>@Inject</strong>: ç”¨æ¥æ ‡æ³¨å¯¹è±¡å˜é‡æˆ–æ„é€ æ–¹æ³•ï¼Œé€šå¸¸åœ¨éœ€è¦ä¾èµ–çš„åœ°æ–¹ä½¿ç”¨è¿™ä¸ªæ³¨è§£ã€‚æ¢å¥è¯è¯´ï¼Œä½ ç”¨å®ƒå‘Šè¯‰<code>Dagger2</code>è¿™ä¸ªç±»æˆ–è€…å­—æ®µéœ€è¦ä¾èµ–æ³¨å…¥ã€‚è¿™æ ·ï¼Œ<code>Dagger2</code>å°±ä¼šæ„é€ ä¸€ä¸ªè¿™ä¸ªç±»çš„å®ä¾‹å¹¶æ»¡è¶³ä»–ä»¬çš„ä¾èµ–ã€‚</li><li><strong>@Component</strong>: é€šå¸¸ç”¨æ¥æ ‡æ³¨æ¥å£ï¼Œ<code>Component</code>ä»æ ¹æœ¬ä¸Šæ¥è¯´å°±æ˜¯ä¸€ä¸ªæ³¨å…¥å™¨ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯<code>@Inject</code>å’Œ<code>@Module</code>çš„æ¡¥æ¢ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨å°±æ˜¯è¿æ¥è¿™ä¸¤ä¸ªéƒ¨åˆ†ã€‚å°†<code>Module</code>ä¸­äº§ç”Ÿçš„ä¾èµ–å¯¹è±¡è‡ªåŠ¨æ³¨å…¥åˆ°éœ€è¦ä¾èµ–å®ä¾‹çš„Containerä¸­ã€‚</li><li><strong>@Scope</strong>: æ ‡æ³¨<code>Component</code>å’Œ<code>Module</code>æä¾›å¯¹è±¡çš„æ–¹æ³•ï¼Œ<code>Dagger2</code>å¯ä»¥é€šè¿‡è‡ªå®šä¹‰æ³¨è§£é™å®šæ³¨è§£ä½œç”¨åŸŸï¼Œæ¥ç®¡ç†æ¯ä¸ªå¯¹è±¡å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸã€‚</li><li><strong>@Qualifier</strong>: ç”¨æ¥æ ‡æ³¨æ–¹æ³•ï¼Œå½“ç±»çš„ç±»å‹ä¸è¶³ä»¥é‰´åˆ«ä¸€ä¸ªä¾èµ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ³¨è§£æ ‡ç¤ºã€‚ä¾‹å¦‚ï¼šåœ¨Androidä¸­ï¼Œæˆ‘ä»¬ä¼šéœ€è¦ä¸åŒç±»å‹çš„<code>Context</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥å®šä¹‰<code>Qualifier</code>æ³¨è§£<code>@ApplicationQualifier</code>å’Œ<code>@ActivityQualifier</code>ï¼Œè¿™æ ·å½“æ³¨å…¥ä¸€ä¸ª<code>Context</code>çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥å‘Šè¯‰<code>Dagger2</code>æˆ‘ä»¬æƒ³è¦å“ªç§ç±»å‹çš„<code>Context</code>ã€‚</li></ul><h3 id="3-ç»“æ„"><a href="#3-ç»“æ„" class="headerlink" title="3. ç»“æ„"></a>3. ç»“æ„</h3><p>&emsp;&emsp;Dagger2è¦å®ç°ä¸€ä¸ªå®Œæ•´çš„ä¾èµ–æ³¨å…¥ï¼Œé€šå¸¸å¿…ä¸å¯å°‘çš„å…ƒç´ æœ‰ä¸‰ç§ï¼š<strong>Module</strong>ï¼Œ<strong>Component</strong>ï¼Œ<strong>Container</strong>ã€‚ä¸ºäº†ä¾¿äºç†è§£ï¼Œå…¶å®å¯ä»¥æŠŠ<code>component</code>æƒ³è±¡æˆ<code>é’ˆç®¡</code>ï¼Œ<code>module</code>æ˜¯<code>æ³¨å°„å™¨</code>ï¼Œé‡Œé¢çš„<code>ä¾èµ–å¯¹è±¡</code>æ˜¯<code>å¾…æ³¨å…¥çš„è¯æ°´</code>ï¼Œ<code>buildæ–¹æ³•</code>æ˜¯æ’è¿›<code>æ‚£è€…ï¼ˆContainerï¼‰</code>ï¼Œ<code>injectæ–¹æ³•</code>çš„è°ƒç”¨æ˜¯<code>æ¨åŠ¨æ´»å¡</code>ã€‚</p><div align="center"><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/dagger2/1.png"/></div><h3 id="4-ç®€å•çš„ä¾‹å­"><a href="#4-ç®€å•çš„ä¾‹å­" class="headerlink" title="4. ç®€å•çš„ä¾‹å­"></a>4. ç®€å•çš„ä¾‹å­</h3><p><strong>å£°æ˜éœ€è¦ä¾èµ–çš„å¯¹è±¡</strong>ï¼šä½¿ç”¨äº†æ³¨è§£æ–¹å¼ï¼Œè¿˜æ˜¯ä»¥<code>Tinno</code>ä¸ºä¾‹ï¼Œä½¿å¾—Dagger2èƒ½æ‰¾åˆ°å®ƒã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tinno</span> &#123;</span><br><span class="line">    <span class="meta">@Inject</span> <span class="comment">//è¿™é‡Œå¯ä»¥çœ‹åˆ°åŠ å…¥äº†æ³¨è§£æ–¹å¼</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Tinno</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <strong>å£°æ˜<code>Component</code>æ¥å£</strong>ï¼šå£°æ˜å®Œårebuildä¸€ä¸‹å·¥ç¨‹ï¼Œä½¿å…¶è‡ªåŠ¨ç”Ÿæˆ<code>Component</code>å®ç°ç±»<code>DaggerMainActivityComponent</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç”¨è¿™ä¸ªæ ‡æ³¨æ ‡è¯†æ˜¯ä¸€ä¸ªè¿æ¥å™¨</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MainActivityComponent</span> &#123;</span><br><span class="line">    <span class="comment">//è¿™ä¸ªè¿æ¥å™¨è¦æ³¨å…¥çš„å¯¹è±¡ã€‚è¿™ä¸ªinjectæ ‡æ³¨çš„æ„æ€æ˜¯ï¼Œæˆ‘åé¢çš„å‚æ•°å¯¹è±¡é‡Œé¢æœ‰æ ‡æ³¨ä¸º@Injectçš„å±æ€§ï¼Œè¿™ä¸ªæ ‡æ³¨çš„å±æ€§æ˜¯éœ€è¦è¿™ä¸ªè¿æ¥å™¨æ³¨å…¥è¿›æ¥çš„ã€‚</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">inject</span><span class="params">(MainActivity activity)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <strong>åœ¨ä½¿ç”¨çš„åœ°æ–¹æ³¨å…¥ï¼Œè¿™é‡Œæ˜¯ MainActivityï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;MainActivity&quot;</span>;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    Tinno mTinno;<span class="comment">//åŠ å…¥æ³¨è§£ï¼Œæ ‡æ³¨è¿™ä¸ªTinnoæ˜¯éœ€è¦æ³¨å…¥çš„</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">TextView</span> <span class="variable">dagger2TextView</span> <span class="operator">=</span> (TextView) findViewById(R.id.dagger2_text_view);</span><br><span class="line">        <span class="comment">//ä½¿ç”¨ç»„ä»¶è¿›è¡Œæ„é€ ï¼Œæ³¨å…¥</span></span><br><span class="line">        DaggerMainActivityComponent.builder().build().inject(<span class="built_in">this</span>);</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onCreate: mTinno = &quot;</span> + mTinno);</span><br><span class="line"></span><br><span class="line">        dagger2TextView.setText(mTinno.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; è¿™æ˜¯æœ€ç®€å•çš„ä¸€ç§ä½¿ç”¨äº†ã€‚é¦–å…ˆæˆ‘ä»¬çœ‹åˆ°ï¼Œç¬¬ä¸€å°è±¡æ˜¯æˆ‘å»ğŸ˜²ï¼Œè¿™ä¸ªæ›´å¤æ‚äº†å•ŠğŸ˜‚ğŸ˜‚ã€‚æˆ‘åªèƒ½è¯´ç¡®å®ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯å®ƒå¯¹çš„æœ€åŸºç¡€çš„ä½¿ç”¨ï¼Œçœ‹èµ·æ¥å¾ˆç¬¨æ‹™ï¼Œä½†æ˜¯å½“å®ƒåœ¨å¤§å‹é¡¹ç›®é‡Œé¢ï¼Œåœ¨ä¾èµ–æ›´å¤šçš„æƒ…å†µä¸‹ï¼Œåˆ™ä¼šå‘ç”Ÿè´¨çš„é£è·ƒï¼Œä¼šå‘ç°å®ƒéå¸¸å¥½ç”¨ï¼Œå¹¶ä¸”å°†ä½ éœ€è¦ä¼ é€’çš„å‚æ•°éƒ½éšè—æ‰ï¼Œæ¥å®ç°è§£è€¦ã€‚</p><h3 id="5-å¸¸è§„ä½¿ç”¨æ–¹æ³•"><a href="#5-å¸¸è§„ä½¿ç”¨æ–¹æ³•" class="headerlink" title="5. å¸¸è§„ä½¿ç”¨æ–¹æ³•"></a>5. å¸¸è§„ä½¿ç”¨æ–¹æ³•</h3><p>&emsp;&emsp;ç»†å¿ƒçš„æœ‹å‹å‘ç°äº†ï¼Œæˆ‘åœ¨ç»“æ„ä¸­è¯´ Dagger2ç»“æ„çš„æ—¶å€™æåˆ°é€šå¸¸å¿…ä¸å¯å°‘çš„ä¸‰å…ƒç´ ï¼Œè¿™ä¸ªä¾‹å­åªç”¨åˆ°äº† <strong>Component__å’Œ__Container</strong>ï¼Œè€Œ <strong>Module</strong> å¹¶æœªæåŠï¼Œé€šè¿‡ä»¥ä¸‹è¿™ä¸ªä¾‹å­ï¼Œèƒ½æ›´åŠ æ·±åˆ»çš„ç†è§£ <strong>Module</strong> çš„ä½œç”¨ã€‚<br>&emsp;&emsp;å®ç°ä¸€ä¸ª <strong>MainModule</strong>ï¼Œæä¾›ä¸€äº›å®ä¾‹æ„é€ ï¼Œé€šè¿‡ <strong>Component</strong> è”ç³»èµ·æ¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span> <span class="comment">//å®ç°ä¸€ä¸ªç±»ï¼Œæ ‡æ³¨ä¸º Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainModule</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span> <span class="comment">//å®ç°ä¸€äº›æä¾›æ–¹æ³•ï¼Œä¾›å¤–éƒ¨ä½¿ç”¨</span></span><br><span class="line">    <span class="keyword">public</span> Tinno <span class="title function_">provideTinno</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Tinno</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;åœ¨ <strong>MainComponent</strong> ä¸­ï¼ŒæŒ‡æ˜ <strong>Component</strong> æŸ¥æ‰¾ <strong>Module</strong> çš„ä½ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(modules = MainModule.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MainActivityComponent</span> &#123;<span class="comment">// é€šå¸¸å®šä¹‰ä¸ºæ¥å£ï¼ŒDagger2æ¡†æ¶å°†è‡ªåŠ¨ç”ŸæˆComponentçš„å®ç°ç±»ï¼Œå¯¹åº”çš„ç±»åæ˜¯DaggerÃ—Ã—Ã—Ã—Ã—ï¼Œè¿™é‡Œå¯¹åº”çš„å®ç°ç±»æ˜¯DaggerMainActivityComponent</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">inject</span><span class="params">(MainActivity activity)</span>;<span class="comment">// æ³¨å…¥åˆ°MainActivity(Container)çš„æ–¹æ³•ï¼Œæ–¹æ³•åä¸€èˆ¬ä½¿ç”¨inject</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;æœ€åæˆ‘ä»¬çš„<code>Tinno</code>ç±»ä¸­çš„<code>@Inject</code>å’Œæ„é€ å‡½æ•°å¯ä»¥å»æ‰äº†(äº²æµ‹ä¸å»æ‰ä¹Ÿæ˜¯å¯ä»¥æ­£å¸¸è¿è¡Œçš„ï¼Œæ­¤æ—¶ä¹Ÿæ˜¯ä½¿ç”¨<code>Module</code>ä¸­æä¾›çš„å¯¹è±¡ï¼Œå…·ä½“å¯ä»¥é€šè¿‡åé¢åˆ†äº«çš„<code>@Scope</code>æ¥éªŒè¯ï¼Œè¿™æ ·è¯´æ˜ï¼š<strong>Componentä¼šé¦–å…ˆä»Moduleç»´åº¦ä¸­æŸ¥æ‰¾ç±»å®ä¾‹ï¼Œè‹¥æ‰¾åˆ°å°±ç”¨Moduleç»´åº¦åˆ›å»ºç±»å®ä¾‹ï¼Œå¹¶åœæ­¢æŸ¥æ‰¾Injectç»´åº¦ï¼Œå¦åˆ™æ‰æ˜¯ä»Injectç»´åº¦æŸ¥æ‰¾ç±»å®ä¾‹ï¼Œæ‰€ä»¥åˆ›å»ºç±»å®ä¾‹çº§åˆ«Moduleç»´åº¦è¦é«˜äºInjectç»´åº¦ã€‚</strong>)ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tinno</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;æ³¨å…¥ä½¿ç”¨çš„åœ°æ–¹å®Œå…¨ä¸ç”¨ä¿®æ”¹ï¼Œä¹Ÿèƒ½å¾—åˆ°å’Œä¹‹å‰ä¾‹å­ä¸€æ ·çš„ç»“æœã€‚</p><h3 id="6-æ›´å¤šç”¨æ³•"><a href="#6-æ›´å¤šç”¨æ³•" class="headerlink" title="6. æ›´å¤šç”¨æ³•"></a>6. æ›´å¤šç”¨æ³•</h3><h4 id="6-1-æ–¹æ³•å‚æ•°"><a href="#6-1-æ–¹æ³•å‚æ•°" class="headerlink" title="6.1 æ–¹æ³•å‚æ•°"></a>6.1 æ–¹æ³•å‚æ•°</h4><p>&emsp;&emsp;ä¸Šé¢çš„ä¾‹å­<code>@Provides</code>æ ‡æ³¨çš„æ–¹æ³•æ˜¯æ²¡æœ‰è¾“å…¥å‚æ•°çš„ï¼Œ<code>Module</code>ä¸­<code>@Provides</code>æ ‡æ³¨çš„æ–¹æ³•æ˜¯å¯ä»¥å¸¦è¾“å…¥å‚æ•°çš„ï¼Œå…¶å‚æ•°å€¼å¯ä»¥ç”±<code>Module</code>ä¸­çš„å…¶ä»–è¢«<code>@Provides</code>æ ‡æ³¨çš„æ–¹æ³•æä¾›ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span> <span class="comment">//å®ç°ä¸€ä¸ªç±»ï¼Œæ ‡æ³¨ä¸º Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainModule</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Context mContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MainModule</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span> <span class="comment">//å®ç°ä¸€äº›æä¾›æ–¹æ³•ï¼Œä¾›å¤–éƒ¨ä½¿ç”¨</span></span><br><span class="line">    <span class="keyword">public</span> Tinno <span class="title function_">provideTinno</span><span class="params">(Gson gson, CameraTeam cameraTeam)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Tinno</span>(mContext, gson, cameraTeam);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="keyword">public</span> Gson <span class="title function_">provideGson</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GsonBuilder</span>()</span><br><span class="line">                .excludeFieldsWithModifiers(Modifier.PROTECTED)<span class="comment">//å¿½ç•¥protectedå­—æ®µ</span></span><br><span class="line">                .setDateFormat(<span class="string">&quot;yyyy-MM-dd&#x27;T&#x27;HH:mm:ssZ&quot;</span>)</span><br><span class="line">                .create();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Provides</span></span><br><span class="line"><span class="comment">//    public CameraTeam provideCameraTeam() &#123;</span></span><br><span class="line"><span class="comment">//        return new CameraTeam();</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;å¦‚æœæ‰¾ä¸åˆ°è¢«<code>@Provides</code>æ³¨é‡Šçš„æ–¹æ³•æä¾›å¯¹åº”å‚æ•°å¯¹è±¡çš„è¯ï¼Œå°†ä¼šè‡ªåŠ¨è°ƒç”¨è¢«<code>@Inject</code>æ³¨é‡Šçš„æ„é€ æ–¹æ³•ç”Ÿæˆç›¸åº”å¯¹è±¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CameraTeam</span> &#123;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CameraTeam</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;ç”±äºæˆ‘ä»¬ä¿®æ”¹äº†<code>MainModule</code>ï¼Œæ‰€ä»¥å¯¹åº”æ³¨å…¥çš„åœ°æ–¹è¦ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ³¨æ„æ­¤å¤„æ¯”ä¹‹å‰å¤šäº†.mainModule(new MainModule(getApplicationContext()))</span></span><br><span class="line">DaggerMainActivityComponent.builder().mainModule(<span class="keyword">new</span> <span class="title class_">MainModule</span>(getApplicationContext())).build().inject(<span class="built_in">this</span>);</span><br></pre></td></tr></table></figure><p><strong>æ€è€ƒ</strong><br>&emsp;&emsp; é€šè¿‡ä¸Šé¢3ä¸ªä¾‹å­<code>@Provides</code>å’Œ<code>@Inject</code>ä¸¤ç§æ–¹å¼æä¾›å¯¹è±¡çš„åŒºåˆ«ï¼Ÿ</p><h4 id="6-2-æ·»åŠ å¤šä¸ªModule"><a href="#6-2-æ·»åŠ å¤šä¸ªModule" class="headerlink" title="6.2 æ·»åŠ å¤šä¸ªModule"></a>6.2 æ·»åŠ å¤šä¸ªModule</h4><p>&emsp;&emsp;ä¸€ä¸ª<code>Component</code>å¯ä»¥æ·»åŠ å¤šä¸ª<code>Module</code>ï¼Œè¿™æ ·<code>Component</code>è·å–ä¾èµ–æ—¶å€™ä¼šè‡ªåŠ¨ä»å¤šä¸ª<code>Module</code>ä¸­æŸ¥æ‰¾è·å–ã€‚æ·»åŠ å¤šä¸ª<code>Module</code>æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯åœ¨<code>Component</code>çš„æ³¨è§£<code>@Component(modules=&#123;Ã—Ã—Ã—Ã—ï¼ŒÃ—Ã—Ã—&#125;)</code>ä¸­æ·»åŠ å¤šä¸ª<code>modules</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(modules=&#123;MainModule.class,ModuleA.class,ModuleB.class,ModuleC.class&#125;)</span> <span class="comment">//ç›´æ¥åœ¨Componentå¼•ç”¨å¤šä¸ª Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MainActivityComponent</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;å¦å¤–ä¸€ç§æ·»åŠ å¤šä¸ª<code>Module</code>çš„æ–¹æ³•å¯ä»¥ä½¿ç”¨<code>@Module</code>çš„ <code>includes</code>çš„æ–¹æ³•<code>ï¼ˆincludes=&#123;Ã—Ã—Ã—Ã—ï¼ŒÃ—Ã—Ã—&#125;ï¼‰</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module(includes=&#123;ModuleA.class,ModuleB.class,ModuleC.class&#125;)</span><span class="comment">//å…ˆåœ¨ä¸€ä¸ª Module ä¸­includeså…¶ä»– Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainModule</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Component(modules=&#123;MainModule.class&#125;)</span> <span class="comment">//åªæœ‰ä¸€ä¸ª Module æ—¶å¯ä»¥ä¸ç”¨&#123;&#125;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MainActivityComponent</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-3-åŒºåˆ†è¿”å›ç±»å‹ç›¸åŒ-Providesæ–¹æ³•"><a href="#6-3-åŒºåˆ†è¿”å›ç±»å‹ç›¸åŒ-Providesæ–¹æ³•" class="headerlink" title="6.3 åŒºåˆ†è¿”å›ç±»å‹ç›¸åŒ@Providesæ–¹æ³•"></a>6.3 åŒºåˆ†è¿”å›ç±»å‹ç›¸åŒ@Providesæ–¹æ³•</h4><p>&emsp;&emsp;å¦‚æœæˆ‘ä»¬åœ¨ <code>Module</code> ä¸­æœ‰é‡å¤çš„ç±»å‹è¿”å›ï¼Œä¾‹å¦‚æˆ‘å®šä¹‰ä¸¤ä¸ª <code>Context</code> ç±»å‹çš„<code>Provides</code> åœ¨ <code>Module</code> ä¸­çš„è¯ï¼Œç¼–è¯‘ç›´æ¥ä¼šæŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Error:(16, 10) é”™è¯¯: android.content.Context is bound multiple times:</span><br><span class="line">@Provides android.content.Context com.ape.dagger2.MainModule.provideApplicationContext()</span><br><span class="line">@Provides android.content.Context com.ape.dagger2.MainModule.provideActivityContext()</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;é‚£å¦‚æœæˆ‘ä»¬çœŸçš„éœ€è¦æ³¨å…¥åŒä¸€ç±»å‹å¤šæ¬¡å‘¢ï¼Œè¿™ä¸ªé—®é¢˜æ€»ä¼šæœ‰è§£å†³æ–¹æ¡ˆçš„å§ï¼Ÿè¦æ˜¯çœŸçš„è¿™ä¹ˆå‘ä¼°è®¡ä¹Ÿæ²¡äººç”¨ Dagger2 äº†å§ï¼å“ˆå“ˆã€‚ã€‚ã€‚ğŸ˜‚  å…¶å® Dagger2 ä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ç§æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p><ul><li><strong>å¯ä»¥ä½¿ç”¨<code>@Qualifier</code> çš„æ³¨è§£æ¥åŒºåˆ†</strong></li><li><strong><code>@Named(&quot;xx&quot;)</code> çš„æ³¨è§£</strong>ã€‚</li></ul><p><strong>@Named æ–¹å¼</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span> <span class="comment">//å®ç°ä¸€ä¸ªç±»ï¼Œæ ‡æ³¨ä¸º Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainModule</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Context mApplicationContext;</span><br><span class="line">    <span class="keyword">private</span> Context mActivityContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MainModule</span><span class="params">(Context context, Context activityContext)</span> &#123;</span><br><span class="line">        mApplicationContext = context;</span><br><span class="line">        mActivityContext = activityContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span> <span class="comment">//å®ç°ä¸€äº›æä¾›æ–¹æ³•ï¼Œä¾›å¤–éƒ¨ä½¿ç”¨</span></span><br><span class="line">    <span class="keyword">public</span> Tinno <span class="title function_">provideTinno</span><span class="params">(<span class="meta">@Named(&quot;application&quot;)</span><span class="comment">/*ä½¿ç”¨çš„æ˜¯ application*/</span>Context context, Gson gson, CameraTeam cameraTeam)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Tinno</span>(context, gson, cameraTeam);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Named(&quot;application&quot;)</span> <span class="comment">//æ ‡æ³¨ä¸º application</span></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="keyword">public</span> Context <span class="title function_">provideApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mApplicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Named(&quot;activity&quot;)</span> <span class="comment">//æ ‡æ³¨ä¸º activity</span></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="keyword">public</span> Context <span class="title function_">provideActivityContext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mActivityContext;</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>@Qualifieræ–¹å¼</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ApplicationQualifier &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ActivityQualifier &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Module</span> <span class="comment">//å®ç°ä¸€ä¸ªç±»ï¼Œæ ‡æ³¨ä¸º Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainModule</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Context mApplicationContext;</span><br><span class="line">    <span class="keyword">private</span> Context mActivityContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MainModule</span><span class="params">(Context context, Context activityContext)</span> &#123;</span><br><span class="line">        mApplicationContext = context;</span><br><span class="line">        mActivityContext = activityContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span> <span class="comment">//å®ç°ä¸€äº›æä¾›æ–¹æ³•ï¼Œä¾›å¤–éƒ¨ä½¿ç”¨</span></span><br><span class="line">    <span class="keyword">public</span> Tinno <span class="title function_">provideTinno</span><span class="params">(<span class="meta">@ApplicationQualifier</span><span class="comment">/*æ­¤å¤„ä½¿ç”¨ä¸º ApplicationQualifier*/</span> Context context, Gson gson, CameraTeam cameraTeam)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Tinno</span>(context, gson, cameraTeam);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApplicationQualifier</span> <span class="comment">//æ ‡æ³¨ä¸º ApplicationQualifier</span></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="keyword">public</span> Context <span class="title function_">provideApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mApplicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActivityQualifier</span> <span class="comment">//æ ‡æ³¨ä¸º ActivityQualifier</span></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="keyword">public</span> Context <span class="title function_">provideActivityContext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mActivityContext;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;ä½¿ç”¨å“ªç§æ–¹å¼å°±ä»è€…è§ä»æ™ºè€…è§æ™ºäº†ï¼Œä½†ä¸ªäººæ¨èä½¿ç”¨<code>@Qualifier</code>ï¼Œæ¯•ç«Ÿè¾“å…¥å¤ªå¤šå­—ç¬¦ä¸²å®¹æ˜“å‡ºé”™ã€‚</p><h4 id="6-4-ç»„ä»¶é—´ä¾èµ–å’Œå­ç»„ä»¶"><a href="#6-4-ç»„ä»¶é—´ä¾èµ–å’Œå­ç»„ä»¶" class="headerlink" title="6.4 ç»„ä»¶é—´ä¾èµ–å’Œå­ç»„ä»¶"></a>6.4 ç»„ä»¶é—´ä¾èµ–å’Œå­ç»„ä»¶</h4><p>&emsp;&emsp;æœ‰æ—¶æˆ‘ä»¬éœ€è¦ä¾èµ–ä¸€ä¸ªç»„ä»¶ï¼Œè¿™ä¸ªæœ€å¸¸è§çš„ç”¨æ³•æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å®šä¹‰äº† <code>MainActivity</code> çš„ <code>MainComponent</code> ï¼Œå¹¶ä¸”å®ƒä¾èµ–å’±ä»¬çš„ <code>AppComponent</code> é‡Œé¢çš„ <code>IRepositoryManager</code> çš„è¯å°±è¦è¿™æ ·å®šä¹‰äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Component(dependencies = AppComponent.class, modules = MainPresenterModule.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MainComponent</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">inject</span><span class="params">(MainActivity activity)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;åœ¨ <code>AppComponent</code> ä¸­éœ€è¦å°†è·å– <code>IRepositoryManager</code> çš„æ–¹æ³•æš´éœ²å‡ºæ¥ï¼Œä¸ç„¶è¿˜æ˜¯æ— æ³•æ³¨å…¥æˆåŠŸçš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Component(modules = &#123;AppModule.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AppComponent</span> &#123;</span><br><span class="line">    <span class="comment">//ç”¨äºç®¡ç†ç½‘ç»œè¯·æ±‚å±‚,ä»¥åŠæ•°æ®ç¼“å­˜å±‚,å¯¹å¤–å¼€æ”¾çš„æ¥å£</span></span><br><span class="line">    IRepositoryManager <span class="title function_">repositoryManager</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;é‚£å¦‚æœæˆ‘è§‰å¾—æš´éœ²è¿™äº›æ–¹æ³•å¤ªéº»çƒ¦äº†ï¼Œé‚£éœ€è¦æ€ä¹ˆåŠå‘¢ï¼Ÿæœ€ç®€å•å°±æ˜¯ä½¿ç”¨ <code>@SubComponent</code> ,åœ¨æ‰€å±çš„çˆ¶ <code>Component</code> ä¸­å®šä¹‰ä¸€ä¸ª <code>SubComponent</code>ï¼Œè¯¥ <code>SubComponent</code> ä¸­å°†ä¼šåŒ…å«çˆ¶ <code>Component</code> çš„æ‰€æœ‰æ–¹æ³•ï¼Œçˆ¶ <code>Component</code> ä¸æ˜¾ç¤ºå£°æ˜éƒ½å¯ä»¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Subcomponent(modules = MainPresenterModule.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MainComponent</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">inject</span><span class="params">(MainActivity activity)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Component(modules = &#123;AppModule.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AppComponent</span> &#123;</span><br><span class="line">    <span class="comment">// æä¾› MainComponent å¯¹è±¡çš„è·å–æ–¹æ³•</span></span><br><span class="line">    MainComponent <span class="title function_">mainComponent</span><span class="params">(MainPresenterModule <span class="keyword">module</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;åœ¨æ³¨å…¥çš„æ—¶å€™ç›´æ¥ä½¿ç”¨çˆ¶ç»„ä»¶çš„<code>mainComponent(MainPresenterModule module)</code>åŒ…å«å­ç»„ä»¶çš„<code>module</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">appComponent.mainComponent(<span class="keyword">new</span> <span class="title class_">MainPresenterModule</span>(<span class="built_in">this</span>)).inject(<span class="built_in">this</span>);</span><br><span class="line"><span class="comment">//DaggerMainComponent.builder().appComponent(appComponent)</span></span><br><span class="line"><span class="comment">//                .mainPresenterModule(new MainPresenterModule(this)).build().inject(this);</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>ç»„ä»¶ä¾èµ–å’Œå­ç»„ä»¶çš„åŒºåˆ«</strong>ï¼š</p><table><thead><tr><th>ç»„ä»¶ä¾èµ–</th><th>å­ç»„ä»¶</th></tr></thead><tbody><tr><td>1. ä¿æŒä¸¤ä¸ª Component éƒ½ç‹¬ç«‹ï¼Œæ²¡æœ‰ä»»ä½•å…³è”<br />2. æ˜ç¡®çš„å‘Šè¯‰åˆ«äººè¿™ä¸ª Component æ‰€ä¾èµ–çš„ Component <br />3. ä¸¤ä¸ªæ‹¥æœ‰ä¾èµ–å…³ç³»çš„ Component æ˜¯ä¸èƒ½æœ‰ç›¸åŒ @Scope æ³¨è§£çš„<br />4. ä¾èµ–çš„ç»„ä»¶ä¼šç”ŸæˆDaggerâ€¦Component</td><td>1. ä¿æŒä¸¤ä¸ª Component å†…èš<br />2. ä¸å…³å¿ƒè¿™ä¸ª Component ä¾èµ–å“ªä¸ª Component<br />3. å¯ä»¥ä½¿ç”¨ç›¸åŒçš„@Scopeæ³¨è§£<br />4. å­ç»„ä»¶çš„ç»„ä»¶ä¸ä¼šç”ŸæˆDaggerâ€¦Component</td></tr></tbody></table><h4 id="6-5-æ‡’åŠ è½½å’Œå¼ºåŠ è½½æ¨¡å¼"><a href="#6-5-æ‡’åŠ è½½å’Œå¼ºåŠ è½½æ¨¡å¼" class="headerlink" title="6.5 æ‡’åŠ è½½å’Œå¼ºåŠ è½½æ¨¡å¼"></a>6.5 æ‡’åŠ è½½å’Œå¼ºåŠ è½½æ¨¡å¼</h4><p>&emsp;&emsp;åœ¨ä¸Šé¢çš„æ¯”å–»ä¸­ï¼Œä¸€é’ˆæ‰è¿›å»ï¼Œæ˜¯å•¥éƒ½ç»™ä½ æ‰“è¿›å»äº†ï¼Œé‚£ä¹ˆå¦‚æœæœ‰äº›æˆ‘æƒ³è¦åœ¨è°ƒç”¨çš„æ—¶å€™æ‰åŠ è½½å‘¢ï¼Ÿè¿™é‡Œ Dagger2 æä¾›äº† <code>Lazy&lt;T&gt;</code> çš„æ–¹å¼æ¥æ³¨å…¥ï¼›åŒæ—¶ç›¸åçš„æä¾›ä¸€ä¸ªå¼ºåˆ¶åŠ è½½æ–¹å¼<code>Provider&lt;T&gt;</code>ï¼Œæ¯æ¬¡è°ƒç”¨getéƒ½ä¼šè°ƒç”¨Moduleçš„Providesæ–¹æ³•ä¸€æ¬¡ï¼Œå¯¹åº”çš„è·å–å°±æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Container</span>&#123;</span><br><span class="line">    <span class="meta">@Inject</span> Lazy&lt;Tinno&gt; mTinnoLazy; <span class="comment">//å»¶è¿ŸåŠ è½½</span></span><br><span class="line">    <span class="meta">@Inject</span> Provider&lt;Tinno&gt; mTinnoProvider;<span class="comment">//å®ç°å¼ºåˆ¶åŠ è½½ï¼Œæ¯æ¬¡è°ƒç”¨getéƒ½ä¼šè°ƒç”¨Moduleçš„Providesæ–¹æ³•ä¸€æ¬¡ï¼Œå’Œæ‡’åŠ è½½æ¨¡å¼æ­£å¥½ç›¸å,æ¯”å¦‚æˆ‘ä»¬éœ€è¦ä¸€æ¬¡æ€§åˆ›å»ºå‡º10ä¸ªTinno å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        DaggerComponent.create().inject(<span class="built_in">this</span>);</span><br><span class="line">        <span class="type">Tinno</span> <span class="variable">tinno</span> <span class="operator">=</span> mTinnoLazy.get();  <span class="comment">//è°ƒç”¨getæ—¶æ‰åˆ›å»ºb</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-6-Scopeè¯¦è§£"><a href="#6-6-Scopeè¯¦è§£" class="headerlink" title="6.6 @Scopeè¯¦è§£"></a>6.6 <code>@Scope</code>è¯¦è§£</h4><p><strong>@Scope æ˜¯ä»€ä¹ˆ</strong><br>&emsp;&emsp; <code>Scope</code> ç¿»è¯‘è¿‡æ¥å°±æ˜¯è¾–åŸŸï¼Œå†ç»“åˆåˆ°è®¡ç®—æœºä¸Šï¼Œå…¶å®å°±æ˜¯ä½œç”¨åŸŸçš„æ„æ€ï¼Œå­¦è¿‡é«˜çº§è¯­è¨€çš„åº”è¯¥éƒ½çŸ¥é“è®¾è®¡æ¨¡å¼ä¸­ä¸€ä¸ªæ¨¡å¼å«åšå•ä¾‹æ¨¡å¼ï¼Œå•ä¾‹å³ä¸ºå…¨å±€ä¸­è¯¥å¯¹è±¡çš„å®ä¾‹åªå­˜åœ¨ä¸€ä¸ªï¼Œè€Œåœ¨ Dagger2 ä¸­ï¼Œ<code>@scope</code> çš„ä¸€ä¸ªé»˜è®¤å®ç°å°±æ˜¯ <code>@Singleton</code>ï¼Œä¹Ÿæ˜¯Dagger2å”¯ä¸€è‡ªå¸¦çš„Scopeæ³¨è§£ï¼Œä¸‹é¢æ˜¯<code>@Singleton</code>çš„æºç ï¼Œä¹ä¸€çœ‹ï¼Œå¾ˆç¥å¥‡å•Šï¼Œä»…ä»…ä½¿ç”¨ä¸€ä¸ªæ³¨è§£å°±å¯ä»¥å®ç°å•ä¾‹ï¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scope</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Singleton&#123;&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å®šä¹‰ä¸€ä¸ª<code>Scope</code>æ³¨è§£ï¼Œé€šå¸¸éœ€è¦æ·»åŠ ä»¥ä¸‹ä¸‰éƒ¨åˆ†ï¼š</p><ul><li><strong>@Scope</strong>ï¼šæ³¨æ˜æ˜¯Scope</li><li><strong>@Documented</strong>ï¼šæ ‡è®°æ–‡æ¡£æç¤ºï¼Œå¯ä»¥ä¸ç”¨</li><li><strong>@Retention(RUNTIME)</strong>ï¼šè¿è¡Œæ—¶çº§åˆ«</li></ul><p><strong>@Scpoe æ€ä¹ˆç”¨</strong><br>&emsp;&emsp; é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹ä¸€ä¸‹å®ƒçš„ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ™®é€šçš„å¯¹è±¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tinno</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span><span class="comment">//å£°æ˜Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainModule</span> &#123;</span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    Tinno <span class="title function_">provideTinno</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Tinno</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component(modules = UserModule.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MainActivityComponent</span> &#123;<span class="comment">//åŒä¸€ä¸ªComponentå¯ä»¥å£°æ˜å¤šä¸ªæ³¨å…¥Container</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">inject</span><span class="params">(MainActivity activity)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">inject</span><span class="params">(SecondActivity activity)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ™®é€šçš„ <code>Tinno</code> ç±»ï¼Œç„¶ååˆ›å»ºå®ƒçš„<code>Module</code>ï¼Œå¹¶ä¸”ç”¨ <code>@Singleton</code> æ ‡è®°è¯¥ <code>Tinno</code> è¿”å›å¯¹è±¡ï¼Œæœ€åæˆ‘ä»¬å†åˆ›å»ºå®ƒçš„ <code>Component</code>ï¼Œç„¶åç”¨ <code>@Singleton</code> æ ‡è®°è¿™ä¸ª <code>Component</code>ã€‚è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„å¥—è·¯æµç¨‹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <code>MainActivity</code> å’Œä¸€ä¸ª <code>SecondActivity</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    Tinno mTinno1;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    Tinno mTinno2;</span><br><span class="line">    <span class="keyword">private</span> TextView mContentTextView;</span><br><span class="line">    <span class="keyword">private</span> Button mContentButton;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        mContentTextView = (TextView) findViewById(R.id.tv_content);</span><br><span class="line">        mContentButton = (Button) findViewById(R.id.btn_content);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [1]</span></span><br><span class="line">        <span class="type">MainActivityComponent</span> <span class="variable">component</span> <span class="operator">=</span> DaggerMainActivityComponent.create();</span><br><span class="line">        component.inject(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€è¡Œä¸º mTinno1 çš„ä¿¡æ¯ï¼Œç¬¬äºŒè¡Œä¸º mTinno2 çš„ä¿¡æ¯ï¼Œç¬¬ä¸‰è¡Œä¸ºè¯¥ç±»ä¸­ MainActivityComponent çš„ä¿¡æ¯</span></span><br><span class="line">        mContentTextView.setText(mTinno1.toString() + <span class="string">&quot;\n&quot;</span> + mTinno2.toString()+<span class="string">&quot;\n&quot;</span>+ component.toString());</span><br><span class="line">        mContentButton.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                startActivity(<span class="keyword">new</span> <span class="title class_">Intent</span>(MainActivity.<span class="built_in">this</span>, SecondActivity.class));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    Tinno mTinno;</span><br><span class="line">    <span class="keyword">private</span> TextView mContentTextView;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_second);</span><br><span class="line">        mContentTextView = (TextView) findViewById(R.id.tv_content);</span><br><span class="line">        <span class="comment">// [2]</span></span><br><span class="line">        <span class="type">MainActivityComponent</span> <span class="variable">component</span> <span class="operator">=</span> DaggerMainActivityComponent.create();</span><br><span class="line">        component.inject(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€è¡Œä¸º mTinno çš„ä¿¡æ¯ï¼Œç¬¬äºŒè¡Œä¸ºè¯¥ç±»ä¸­ MainActivityComponent çš„ä¿¡æ¯</span></span><br><span class="line">        mContentTextView.setText(mTinno.toString() + <span class="string">&quot;\n&quot;</span> + component.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ²¡æœ‰é—®é¢˜çš„ï¼Œå•ä¾‹å®ç°æˆåŠŸäº†ï¼Œå‘ç°ä¸¤ä¸ª <code>Tinno</code>çš„åœ°å€æ˜¯ä¸€æ ·çš„ã€‚</p><div align="center"><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/dagger2/2.png"/></div><p>æˆ‘ä»¬ä»…ä»…é€šè¿‡ä¸€ä¸ª <code>@Singleton</code> æ ‡è®°å°±ä½¿å¾—å¯¹è±¡å®ç°äº†å•ä¾‹æ¨¡å¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç‚¹ä¸€ä¸‹æŒ‰é’®è·³è½¬åˆ° <code>SecondActivity</code> ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><div align="center"><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/dagger2/3.png"/></div><p>&emsp;&emsp;ä½†æ˜¯æ­¤æ—¶æˆ‘ä»¬å‘ç°ï¼Œä¸å¯¹å•Šï¼Œ<code>SecondActivity</code> çš„ <code>Tinno</code> å¯¹è±¡çš„åœ°å€å’Œ <code>MainActivity</code> ä¸­çš„ <code>Tinno</code> å¯¹è±¡åœ°å€å¹¶ä¸ä¸€æ ·å•Šï¼Œè¿™ä¸ªå•ä¾‹å¥½åƒå¤±æ•ˆäº†å•Šï¼äº‹å®ä¸Šå¹¶ä¸æ˜¯è¿™æ ·ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿™ä¸ªå•ä¾‹â€œå¤±æ•ˆâ€äº†å‘¢ï¼Ÿç»†å¿ƒçš„å°ä¼™ä¼´ä»¬å·²ç»çœ‹åˆ°äº†ï¼Œä¸¤ä¸ª <code>Activity</code> ä¸­çš„ <code>Component</code> å¯¹è±¡çš„åœ°å€æ˜¯å¹¶ä¸ä¸€æ ·çš„ï¼Œè¿™æ ·å°±å¥½ç†è§£äº† â€”â€”â€” ç”±äº <code>Component</code> å¯¹è±¡ä¸æ˜¯åŒä¸€ä¸ªï¼Œå½“ç„¶å®ƒä»¬æ³¨å…¥çš„å¯¹è±¡ä¹Ÿä¸ä¼šæ˜¯åŒä¸€ä¸ªã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ<br>æˆ‘ä»¬åœ¨ <code>Application</code> å±‚åˆå§‹åŒ– <code>MainActivityComponent</code>ï¼Œç„¶ååœ¨ <code>Activity</code> ä¸­ç›´æ¥è·å–è¿™ä¸ª <code>MainActivityComponent</code> å¯¹è±¡ï¼Œç”±äº <code>Application</code> åœ¨å…¨å±€ä¸­åªä¼šåˆå§‹åŒ–ä¸€æ¬¡ï¼Œ æ‰€ä»¥ <code>Application</code> ä¸­çš„ <code>MainActivityComponent</code> å¯¹è±¡åªåˆå§‹åŒ–ä¸€æ¬¡ï¼Œæˆ‘ä»¬æ¯æ¬¡åœ¨ <code>Activity</code> ä¸­è·å– <code>Application</code> ä¸­çš„è¿™ä¸ª <code>MainActivityComponent</code> å½“ç„¶å°±æ˜¯åŒä¸€ä¸ªçš„å•¦ã€‚<code>Application</code> ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">    MainActivityComponent mComponent;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate();</span><br><span class="line">        mComponent = DaggerMainActivityComponent.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MainActivityComponent <span class="title function_">getComponent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mComponent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;æˆ‘ä»¬åªéœ€è¦å°† [1] å’Œ [2] å¤„çš„ä»£ç æ›´æ”¹æˆ <code>MainActivityComponent component = ((App)getApplication()).getComponent();</code>è¿™æ ·æˆ‘ä»¬ä¸å°±èƒ½å°†æˆ‘ä»¬çš„ <code>MainActivityComponent</code> â€œå•ä¾‹â€åŒ–äº†å—ï¼Ÿæˆªå›¾è¿™é‡Œå°±ä¸å†è´´å‡ºäº†ã€‚</p><p><strong>è‡ªå®šä¹‰@Scpoe</strong></p><p>&emsp;&emsp;Dagger2ä¸­<code>@Singleton</code>å’Œè‡ªå·±å®šä¹‰çš„<code>@ActivityScope</code>ã€<code>@ApplicationScope</code>ç­‰ä»£ç ä¸Šå¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŒåŒºåˆ«æ˜¯åœ¨é‚£ç§<code>Component</code>ä¾èµ–çš„<code>Component</code>çš„æƒ…å†µä¸‹ï¼Œä¸¤ä¸ª<code>Component</code>çš„<code>@Scope</code>ä¸èƒ½ç›¸åŒï¼Œæ—¢ç„¶æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦è¿™ä¹ˆåšå‘¢ï¼Ÿæ˜¯å› ä¸ºè¿™æ ·æ ‡ç¤ºå¯ä»¥æ¸…æ™°çš„åŒºåˆ†<code>Component</code>ä¾èµ–çš„å±‚æ¬¡ï¼Œæ–¹ä¾¿ç†æ¸…æˆ‘ä»¬çš„ä»£ç é€»è¾‘å±‚æ¬¡ï¼Œå¦‚ä¸‹ä¸ºè‡ªå®šä¹‰çš„<code>ActivityScope</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Scope</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ActivityScope &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;æœ‰<code>@Scope</code>æ³¨è§£å’Œæ²¡<code>@Scope</code>æ³¨è§£çš„ç¼–è¯‘æ—¶ç”Ÿæˆä»£ç çš„åŒºåˆ«ï¼Œåœ¨ç¼–è¯‘ç”Ÿæˆçš„<code>DaggerMainActivityComponent</code>çš„<code>initialize</code>å‡½æ•°ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(<span class="keyword">final</span> Builder builder)</span> &#123;</span><br><span class="line">    <span class="comment">//æ ‡è®°äº†`@Singleton`ä¸­`DaggerMainActivityComponent`ä¸­å®ä¾‹åŒ–provideTinnoProvideræ–¹å¼</span></span><br><span class="line">    <span class="built_in">this</span>.provideTinnoProvider =</span><br><span class="line">      DoubleCheck.provider(MainModule_ProvideTinnoFactory.create(builder.mainModule));</span><br><span class="line">    <span class="comment">//æœªæ ‡è®°</span></span><br><span class="line">    <span class="built_in">this</span>.provideTinnoProvider = MainModule_ProvideTinnoFactory.create(builder.mainModule);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;æœ‰<code>@Scope</code>ç±»æ³¨è§£çš„<code>@Provider</code>ç”Ÿæˆçš„ä»£ç ï¼Œå¤–å±‚å¤šäº†ä¸€å±‚<code>DoubleCheck.provider(â€¦);</code>æ²¡æœ‰<code>@Scope</code>ç±»æ³¨è§£çš„åˆ™æ˜¯ç›´æ¥createä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚å…³äº<code>DoubleCheck</code>ï¼Œç®€å•æ¥è¯´å°±æ˜¯åŠ äº†<code>@Scope</code>çš„<code>Provider</code>ï¼Œ<code>Dagger</code>ä¼šç¼“å­˜ä¸€ä¸ªå®ä¾‹åœ¨<code>DaggerMainComponent</code>ä¸­ï¼Œåœ¨<code>DaggerMainComponent</code>ä¸­ä¿æŒå•ä¾‹ï¼Œç¼“å­˜çš„<code>provide</code>è·Ÿéš<code>DaggerMainComponent</code>çš„ç”Ÿå‘½å‘¨æœŸï¼Œ<code>DaggerMainComponent</code>è¢«é”€æ¯æ—¶ï¼Œ<code>provider</code>ä¹Ÿè¢«é”€æ¯ï¼Œè¿™å°±æ˜¯å±€éƒ¨å•ä¾‹çš„æ¦‚å¿µï¼Œå‡å¦‚ä½ çš„<code>DaggerMainComponent</code>æ˜¯åœ¨ä½ åº”ç”¨çš„<code>application</code>ä¸­ï¼Œåˆ™å°±å½¢æˆäº†å…¨å±€å•ä¾‹ã€‚</p><h2 id="ä¸‰-å°ç»“"><a href="#ä¸‰-å°ç»“" class="headerlink" title="ä¸‰. å°ç»“"></a>ä¸‰. å°ç»“</h2><h3 id="1-Dagger2åˆ°åº•æœ‰å“ªäº›å¥½å¤„ï¼Ÿ"><a href="#1-Dagger2åˆ°åº•æœ‰å“ªäº›å¥½å¤„ï¼Ÿ" class="headerlink" title="1. Dagger2åˆ°åº•æœ‰å“ªäº›å¥½å¤„ï¼Ÿ"></a>1. Dagger2åˆ°åº•æœ‰å“ªäº›å¥½å¤„ï¼Ÿ</h3><ul><li><p><strong>å¢åŠ å¼€å‘æ•ˆç‡ã€çœå»é‡å¤çš„ç®€å•ä½“åŠ›åŠ³åŠ¨</strong><br>é¦–å…ˆnewä¸€ä¸ªå®ä¾‹çš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªé‡å¤çš„ç®€å•ä½“åŠ›åŠ³åŠ¨ï¼ŒDagger2å®Œå…¨å¯ä»¥æŠŠnewä¸€ä¸ªå®ä¾‹çš„å·¥ä½œåšäº†ï¼Œå› æ­¤æˆ‘ä»¬æŠŠä¸»è¦ç²¾åŠ›é›†ä¸­åœ¨å…³é”®ä¸šåŠ¡ä¸Šã€åŒæ—¶ä¹Ÿèƒ½å¢åŠ å¼€å‘æ•ˆç‡ä¸Šã€‚çœå»å†™å•ä¾‹çš„æ–¹æ³•ï¼Œå¹¶ä¸”ä¹Ÿä¸éœ€è¦æ‹…å¿ƒè‡ªå·±å†™çš„å•ä¾‹æ–¹æ³•æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Œè‡ªå·±å†™çš„å•ä¾‹æ˜¯æ‡’æ±‰æ¨¡å¼è¿˜æ˜¯é¥¿æ±‰æ¨¡å¼ã€‚å› ä¸ºDagger2éƒ½å¯ä»¥æŠŠè¿™äº›å·¥ä½œåšäº†ã€‚</p></li><li><p><strong>æ›´å¥½çš„ç®¡ç†ç±»å®ä¾‹</strong><br>æ¯ä¸ªappä¸­çš„ApplicationComponentç®¡ç†æ•´ä¸ªappçš„å…¨å±€ç±»å®ä¾‹ï¼Œæ‰€æœ‰çš„å…¨å±€ç±»å®ä¾‹éƒ½ç»Ÿä¸€äº¤ç»™ApplicationComponentç®¡ç†ï¼Œå¹¶ä¸”å®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸä¸appçš„ç”Ÿå‘½å‘¨æœŸä¸€æ ·ã€‚æ¯ä¸ªé¡µé¢å¯¹åº”è‡ªå·±çš„Componentï¼Œé¡µé¢Componentç®¡ç†ç€è‡ªå·±é¡µé¢æ‰€ä¾èµ–çš„æ‰€æœ‰ç±»å®ä¾‹ã€‚å› ä¸ºComponentï¼ŒModuleï¼Œæ•´ä¸ªappçš„ç±»å®ä¾‹ç»“æ„å˜çš„å¾ˆæ¸…æ™°ã€‚</p></li><li><p><strong>è§£è€¦</strong><br>å‡å¦‚ä¸ç”¨Dagger2çš„è¯ï¼Œä¸€ä¸ªç±»çš„newä»£ç æ˜¯éå¸¸å¯èƒ½å……æ–¥åœ¨appçš„å¤šä¸ªç±»ä¸­çš„ï¼Œå‡å¦‚è¯¥ç±»çš„æ„é€ å‡½æ•°å‘ç”Ÿå˜åŒ–ï¼Œé‚£è¿™äº›æ¶‰åŠåˆ°çš„ç±»éƒ½å¾—è¿›è¡Œä¿®æ”¹ã€‚è®¾è®¡æ¨¡å¼ä¸­æå€¡æŠŠå®¹æ˜“å˜åŒ–çš„éƒ¨åˆ†å°è£…èµ·æ¥ã€‚</p></li></ul><h3 id="2-Dagger2åœ¨Cameraä¸­ä½¿ç”¨æ€è€ƒï¼"><a href="#2-Dagger2åœ¨Cameraä¸­ä½¿ç”¨æ€è€ƒï¼" class="headerlink" title="2. Dagger2åœ¨Cameraä¸­ä½¿ç”¨æ€è€ƒï¼"></a>2. Dagger2åœ¨Cameraä¸­ä½¿ç”¨æ€è€ƒï¼</h3><ul><li><strong>CameraScheduler</strong> ä¸­ä¾èµ–çš„å„ä¸ªæ¨¡å—å®ä¾‹å¯ä»¥é€šè¿‡Dagger2æ³¨å…¥ï¼Œå›è°ƒæ¥å£ä¹Ÿå¯ä»¥åœ¨æ³¨å…¥çš„æ—¶å€™ä¼ é€’è¿‡å»ï¼Œç±»ä¼¼ä¸MVPæ¨¡å¼å°†Vä¼ é€’ç»™Pã€‚</li><li>å„ä¸ªå­æ¨¡å—ä¹Ÿå¯ä»¥ä½¿ç”¨Dagger2æ¥æ³¨å…¥ç›¸å…³å®ä¾‹ã€‚</li></ul><p><strong>æœ¬æ–‡æ‰€æ¼”ç¤ºçš„ä»£ç åœ¨æ­¤ä¸‹è½½</strong>ï¼š<a href="https://github.com/way1989/Dagger2Test">Dagger2Sample</a></p><p><strong>MVPä½¿ç”¨ Dagger2çš„ä¾‹å­åœ¨æ­¤ä¸‹è½½</strong>ï¼š<a href="https://github.com/way1989/MaterialWeather">MaterialWeather</a></p>]]></content>
      
      <categories>
          
          <category> Dagger2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Dagger2 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Androidå¼€å‘å„å›½è¯­è¨€åç¼€å¯¹ç…§</title>
      <link href="/2017/06/07/notes/AndroidLanguage/"/>
      <url>/2017/06/07/notes/AndroidLanguage/</url>
      <content type="html"><![CDATA[<h2 id="androidå·¥ç¨‹çš„å¯¹åº”å…³ç³»"><a href="#androidå·¥ç¨‹çš„å¯¹åº”å…³ç³»" class="headerlink" title="androidå·¥ç¨‹çš„å¯¹åº”å…³ç³»"></a>androidå·¥ç¨‹çš„å¯¹åº”å…³ç³»</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">å›½å®¶        |      åç¼€    </span><br><span class="line">ä¸­æ–‡ï¼ˆä¸­å›½ï¼‰|values-zh-rCN</span><br><span class="line"></span><br><span class="line">ä¸­æ–‡ï¼ˆå°æ¹¾ï¼‰|values-zh-rTW</span><br><span class="line"></span><br><span class="line">ä¸­æ–‡ï¼ˆé¦™æ¸¯ï¼‰|values-zh-rHK</span><br><span class="line"></span><br><span class="line">è‹±è¯­ï¼ˆç¾å›½ï¼‰|values-en-rUS</span><br><span class="line"></span><br><span class="line">è‹±è¯­ï¼ˆè‹±å›½ï¼‰|values-en-rGB</span><br><span class="line"></span><br><span class="line">è‹±æ–‡ï¼ˆæ¾³å¤§åˆ©äºšï¼‰|values-en-rAU</span><br><span class="line"></span><br><span class="line">è‹±æ–‡ï¼ˆåŠ æ‹¿å¤§ï¼‰|values-en-rCA</span><br><span class="line"></span><br><span class="line">è‹±æ–‡ï¼ˆçˆ±å°”å…°ï¼‰|values-en-rIE</span><br><span class="line"></span><br><span class="line">è‹±æ–‡ï¼ˆå°åº¦ï¼‰|values-en-rIN</span><br><span class="line"></span><br><span class="line">è‹±æ–‡ï¼ˆæ–°è¥¿å…°ï¼‰|values-en-rNZ</span><br><span class="line"></span><br><span class="line">è‹±æ–‡ï¼ˆæ–°åŠ å¡ï¼‰|values-en-rSG</span><br><span class="line"></span><br><span class="line">è‹±æ–‡ï¼ˆå—éï¼‰|values-en-rZA</span><br><span class="line"></span><br><span class="line">é˜¿æ‹‰ä¼¯æ–‡ï¼ˆåŸƒåŠï¼‰|values-ar-rEG</span><br><span class="line"></span><br><span class="line">é˜¿æ‹‰ä¼¯æ–‡ï¼ˆä»¥è‰²åˆ—ï¼‰|values-ar-rIL</span><br><span class="line"></span><br><span class="line">ä¿åŠ åˆ©äºšæ–‡:  values-bg-rBG</span><br><span class="line"></span><br><span class="line">åŠ æ³°ç½—å°¼äºšæ–‡|values-ca-rES</span><br><span class="line"></span><br><span class="line">æ·å…‹æ–‡|values-cs-rCZ</span><br><span class="line"></span><br><span class="line">ä¸¹éº¦æ–‡|values-da-rDK</span><br><span class="line"></span><br><span class="line">å¾·æ–‡ï¼ˆå¥¥åœ°åˆ©ï¼‰|values-de-rAT</span><br><span class="line"></span><br><span class="line">å¾·æ–‡ï¼ˆç‘å£«ï¼‰|values-de-rCH</span><br><span class="line"></span><br><span class="line">å¾·æ–‡ï¼ˆå¾·å›½ï¼‰|values-de-rDE</span><br><span class="line"></span><br><span class="line">å¾·æ–‡ï¼ˆåˆ—æ”¯æ•¦å£«ç™»ï¼‰|values-de-rLI</span><br><span class="line"></span><br><span class="line">å¸Œè…Šæ–‡|values-el-rGR</span><br><span class="line"></span><br><span class="line">è¥¿ç­ç‰™æ–‡ï¼ˆè¥¿ç­ç‰™ï¼‰|values-es-rES</span><br><span class="line"></span><br><span class="line">è¥¿ç­ç‰™æ–‡ï¼ˆç¾å›½ï¼‰|values-es-rUS</span><br><span class="line"></span><br><span class="line">èŠ¬å…°æ–‡ï¼ˆèŠ¬å…°ï¼‰|values-fi-rFI</span><br><span class="line"></span><br><span class="line">æ³•æ–‡ï¼ˆæ¯”åˆ©æ—¶ï¼‰|values-fr-rBE</span><br><span class="line"></span><br><span class="line">æ³•æ–‡ï¼ˆåŠ æ‹¿å¤§ï¼‰|values-fr-rCA</span><br><span class="line"></span><br><span class="line">æ³•æ–‡ï¼ˆç‘å£«ï¼‰|values-fr-rCH</span><br><span class="line"></span><br><span class="line">æ³•æ–‡ï¼ˆæ³•å›½ï¼‰|values-fr-rFR</span><br><span class="line"></span><br><span class="line">å¸Œä¼¯æ¥æ–‡|values-iw-rIL</span><br><span class="line"></span><br><span class="line">å°åœ°æ–‡|values-hi-rIN</span><br><span class="line"></span><br><span class="line">å…‹ç½—é‡Œäºšæ–‡|values-hr-rHR</span><br><span class="line"></span><br><span class="line">åŒˆç‰™åˆ©æ–‡|values-hu-rHU</span><br><span class="line"></span><br><span class="line">å°åº¦å°¼è¥¿äºšæ–‡|values-in-rID</span><br><span class="line"></span><br><span class="line">æ„å¤§åˆ©æ–‡ï¼ˆç‘å£«ï¼‰|values-it-rCH</span><br><span class="line"></span><br><span class="line">æ„å¤§åˆ©æ–‡ï¼ˆæ„å¤§åˆ©ï¼‰|values-it-rIT</span><br><span class="line"></span><br><span class="line">æ—¥æ–‡|values-ja-rJP</span><br><span class="line"></span><br><span class="line">éŸ©æ–‡|values-ko-rKR</span><br><span class="line"></span><br><span class="line">ç«‹é™¶å®›æ–‡|valueslt-rLT</span><br><span class="line"></span><br><span class="line">æ‹‰è„±ç»´äºšæ–‡|values-lv-rLV</span><br><span class="line"></span><br><span class="line">æŒªå¨åšå…‹é©¬å°”æ–‡|values-nb-rNO</span><br><span class="line"></span><br><span class="line">è·å…°æ–‡(æ¯”åˆ©æ—¶)|values-nl-BE</span><br><span class="line"></span><br><span class="line">è·å…°æ–‡ï¼ˆè·å…°ï¼‰|values-nl-rNL</span><br><span class="line"></span><br><span class="line">æ³¢å…°æ–‡|values-pl-rPL</span><br><span class="line"></span><br><span class="line">è‘¡è„ç‰™æ–‡ï¼ˆå·´è¥¿ï¼‰|values-pt-rBR</span><br><span class="line"></span><br><span class="line">è‘¡è„ç‰™æ–‡ï¼ˆè‘¡è„ç‰™ï¼‰|values-pt-rPT</span><br><span class="line"></span><br><span class="line">ç½—é©¬å°¼äºšæ–‡|values-ro-rRO</span><br><span class="line"></span><br><span class="line">ä¿„æ–‡|values-ru-rRU</span><br><span class="line"></span><br><span class="line">æ–¯æ´›ä¼å…‹æ–‡|values-sk-rSK</span><br><span class="line"></span><br><span class="line">æ–¯æ´›æ–‡å°¼äºšæ–‡|values-sl-rSI</span><br><span class="line"></span><br><span class="line">å¡å°”ç»´äºšæ–‡|values-sr-rRS</span><br><span class="line"></span><br><span class="line">ç‘å…¸æ–‡|values-sv-rSE</span><br><span class="line"></span><br><span class="line">æ³°æ–‡|values-th-rTH</span><br><span class="line"></span><br><span class="line">å¡”åŠ æ´›è¯­|values-tl-rPH</span><br><span class="line"></span><br><span class="line">åœŸè€³å…¶æ–‡|values--r-rTR</span><br><span class="line"></span><br><span class="line">ä¹Œå…‹å…°æ–‡|values-uk-rUA</span><br><span class="line"></span><br><span class="line">è¶Šå—æ–‡|values-vi-rVN</span><br><span class="line"></span><br><span class="line">ç¼…ç”¸è¯­ | values-myï¼ˆè¡¥å……ä¸€ç§æ–°è¯­è¨€ï¼‰</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Language </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Camera2å½•åƒæµç¨‹</title>
      <link href="/2017/01/18/blogs/Camera2/"/>
      <url>/2017/01/18/blogs/Camera2/</url>
      <content type="html"><![CDATA[<h2 id="Android-Mç‰ˆæœ¬åŠä»¥ä¸Šéœ€è¦ç”³è¯·æƒé™"><a href="#Android-Mç‰ˆæœ¬åŠä»¥ä¸Šéœ€è¦ç”³è¯·æƒé™" class="headerlink" title="Android Mç‰ˆæœ¬åŠä»¥ä¸Šéœ€è¦ç”³è¯·æƒé™"></a>Android Mç‰ˆæœ¬åŠä»¥ä¸Šéœ€è¦ç”³è¯·æƒé™</h2><p> ç”³è¯·<code>CAMERA</code>å’Œ<code>RECORD_AUDIO</code>æƒé™ã€‚</p><h2 id="åœ¨TextureViewå¯ç”¨çš„æ—¶å€™ï¼Œæ‰“å¼€Cameraï¼Œé€šè¿‡CameraDevice-StateCallbackå›è°ƒè·å–æ‰“å¼€ç»“æœã€‚"><a href="#åœ¨TextureViewå¯ç”¨çš„æ—¶å€™ï¼Œæ‰“å¼€Cameraï¼Œé€šè¿‡CameraDevice-StateCallbackå›è°ƒè·å–æ‰“å¼€ç»“æœã€‚" class="headerlink" title="åœ¨TextureViewå¯ç”¨çš„æ—¶å€™ï¼Œæ‰“å¼€Cameraï¼Œé€šè¿‡CameraDevice.StateCallbackå›è°ƒè·å–æ‰“å¼€ç»“æœã€‚"></a>åœ¨TextureViewå¯ç”¨çš„æ—¶å€™ï¼Œæ‰“å¼€Cameraï¼Œé€šè¿‡<code>CameraDevice.StateCallback</code>å›è°ƒè·å–æ‰“å¼€ç»“æœã€‚</h2><p> å…¶ä¸­openCameraå‡½æ•°å£°æ˜å¦‚ä¸‹ï¼ˆ<code>cameraId</code>ï¼šCameraçš„idï¼Œé€šå¸¸0è¡¨ç¤ºåç½®æ‘„åƒå¤´ï¼Œ1è¡¨ç¤ºå‰ç½®æ‘„åƒå¤´ï¼›<code>callback</code>: <code>CameraDevice.StateCallback</code>ç›¸æœºçŠ¶æ€å›è°ƒ; <code>handler</code>:æ‰§è¡Œå›è°ƒæ“ä½œçš„hanlderï¼Œä¸ºç©ºæ—¶ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå¦‚æœä¼ å…¥å¼‚æ­¥çº¿ç¨‹çš„handler,åˆ™åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­æ‰§è¡Œï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiresPermission(android.Manifest.permission.CAMERA)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">openCamera</span><span class="params">(<span class="meta">@NonNull</span> String cameraId,</span></span><br><span class="line"><span class="params">           <span class="meta">@NonNull</span> <span class="keyword">final</span> CameraDevice.StateCallback callback, <span class="meta">@Nullable</span> Handler handler)</span></span><br><span class="line">           <span class="keyword">throws</span> CameraAccessException &#123;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure><p> å®Œæ•´æ‰“å¼€Cameraä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tries to open a &#123;<span class="doctag">@link</span> CameraDevice&#125;. The result is listened by `mStateCallback`.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">openCamera</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!hasPermissionsGranted(VIDEO_PERMISSIONS)) &#123;</span><br><span class="line">        requestVideoPermissions();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> getActivity();</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == activity || activity.isFinishing()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–CameraManagerå¯¹è±¡</span></span><br><span class="line">    <span class="type">CameraManager</span> <span class="variable">manager</span> <span class="operator">=</span> (CameraManager) activity.getSystemService(Context.CAMERA_SERVICE);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;tryAcquire&quot;</span>);</span><br><span class="line">        <span class="comment">//åšæ‰“å¼€è¶…æ—¶åˆ¤æ–­ï¼Œè¶…è¿‡2.5ç§’åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå¯¹åº”release()ç»“æŸ</span></span><br><span class="line">        <span class="keyword">if</span> (!mCameraOpenCloseLock.tryAcquire(<span class="number">2500</span>, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Time out waiting to lock camera opening.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cameraId</span> <span class="operator">=</span> manager.getCameraIdList()[<span class="number">0</span>];<span class="comment">//è·å–åæ‘„id</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Choose the sizes for camera preview and video recording</span></span><br><span class="line">        <span class="type">CameraCharacteristics</span> <span class="variable">characteristics</span> <span class="operator">=</span> manager.getCameraCharacteristics(cameraId);</span><br><span class="line">        <span class="comment">//ç±»ä¼¼ä¹‹å‰çš„Parameters</span></span><br><span class="line">        <span class="type">StreamConfigurationMap</span> <span class="variable">map</span> <span class="operator">=</span> characteristics</span><br><span class="line">                .get(CameraCharacteristics.SCALER_STREAM_CONFIGURATION_MAP);</span><br><span class="line">        mSensorOrientation = characteristics.get(CameraCharacteristics.SENSOR_ORIENTATION);</span><br><span class="line">        <span class="comment">//é€‰æ‹©å½•åƒå°ºå¯¸</span></span><br><span class="line">        mVideoSize = chooseVideoSize(map.getOutputSizes(MediaRecorder.class));</span><br><span class="line">        <span class="comment">//é€‰æ‹©åˆé€‚çš„é¢„è§ˆå°ºå¯¸</span></span><br><span class="line">        mPreviewSize = chooseOptimalSize(map.getOutputSizes(SurfaceTexture.class),</span><br><span class="line">                width, height, mVideoSize);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">orientation</span> <span class="operator">=</span> getResources().getConfiguration().orientation;</span><br><span class="line">        <span class="keyword">if</span> (orientation == Configuration.ORIENTATION_LANDSCAPE) &#123;</span><br><span class="line">            mTextureView.setAspectRatio(mPreviewSize.getWidth(), mPreviewSize.getHeight());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mTextureView.setAspectRatio(mPreviewSize.getHeight(), mPreviewSize.getWidth());</span><br><span class="line">        &#125;</span><br><span class="line">        configureTransform(width, height);</span><br><span class="line">        mMediaRecorder = <span class="keyword">new</span> <span class="title class_">MediaRecorder</span>();</span><br><span class="line">        <span class="comment">//æ‰“å¼€Cameraï¼Œé€šè¿‡CameraDevice.StateCallbackå›è°ƒæ‰“å¼€ç»“æœ</span></span><br><span class="line">        manager.openCamera(cameraId, mStateCallback, <span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CameraAccessException e) &#123;</span><br><span class="line">        Toast.makeText(activity, <span class="string">&quot;Cannot access the camera.&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">        activity.finish();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NullPointerException e) &#123;</span><br><span class="line">        <span class="comment">// Currently an NPE is thrown when the Camera2API is used but not supported on the</span></span><br><span class="line">        <span class="comment">// device this code runs.</span></span><br><span class="line">        ErrorDialog.newInstance(getString(R.string.camera_error))</span><br><span class="line">                .show(getChildFragmentManager(), FRAGMENT_DIALOG);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Interrupted while trying to lock camera opening.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è°ƒç”¨openCameraæ–¹æ³•åä¼šå›è°ƒCameraDevice-StateCallbackè¿™ä¸ªæ¥å£ï¼Œåœ¨è¯¥æ¥å£é‡Œé‡å†™onOpenedå‡½æ•°ï¼Œå¼€å¯é¢„è§ˆã€‚"><a href="#è°ƒç”¨openCameraæ–¹æ³•åä¼šå›è°ƒCameraDevice-StateCallbackè¿™ä¸ªæ¥å£ï¼Œåœ¨è¯¥æ¥å£é‡Œé‡å†™onOpenedå‡½æ•°ï¼Œå¼€å¯é¢„è§ˆã€‚" class="headerlink" title="è°ƒç”¨openCameraæ–¹æ³•åä¼šå›è°ƒCameraDevice.StateCallbackè¿™ä¸ªæ¥å£ï¼Œåœ¨è¯¥æ¥å£é‡Œé‡å†™onOpenedå‡½æ•°ï¼Œå¼€å¯é¢„è§ˆã€‚"></a>è°ƒç”¨<code>openCamera</code>æ–¹æ³•åä¼šå›è°ƒ<code>CameraDevice.StateCallback</code>è¿™ä¸ªæ¥å£ï¼Œåœ¨è¯¥æ¥å£é‡Œé‡å†™<code>onOpened</code>å‡½æ•°ï¼Œå¼€å¯é¢„è§ˆã€‚</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> CameraDevice.StateCallback&#125; is called when &#123;<span class="doctag">@link</span> CameraDevice&#125; changes its status.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> CameraDevice.<span class="type">StateCallback</span> <span class="variable">mStateCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CameraDevice</span>.StateCallback() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpened</span><span class="params">(CameraDevice cameraDevice)</span> &#123;<span class="comment">//æ‰“å¼€CameraæˆåŠŸ</span></span><br><span class="line">        mCameraDevice = cameraDevice;</span><br><span class="line">        startPreview();<span class="comment">//å¼€å§‹é¢„è§ˆ</span></span><br><span class="line">        mCameraOpenCloseLock.release();<span class="comment">//é‡Šæ”¾æ‰è¶…æ—¶åˆ¤æ–­</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != mTextureView) &#123;</span><br><span class="line">            configureTransform(mTextureView.getWidth(), mTextureView.getHeight());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDisconnected</span><span class="params">(CameraDevice cameraDevice)</span> &#123;<span class="comment">//Cameraæ–­å¼€è¿æ¥</span></span><br><span class="line">        mCameraOpenCloseLock.release();</span><br><span class="line">        cameraDevice.close();</span><br><span class="line">        mCameraDevice = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(CameraDevice cameraDevice, <span class="type">int</span> error)</span> &#123;<span class="comment">//æ‰“å¼€Cameraå¤±è´¥</span></span><br><span class="line">        mCameraOpenCloseLock.release();</span><br><span class="line">        cameraDevice.close();</span><br><span class="line">        mCameraDevice = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> getActivity();</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != activity) &#123;</span><br><span class="line">            activity.finish();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="å¼€å¯é¢„è§ˆä¸»è¦å°±æ˜¯ä½¿ç”¨CameraDeviceæ¥åˆ›å»ºä¼šè¯createCaptureSessionã€‚"><a href="#å¼€å¯é¢„è§ˆä¸»è¦å°±æ˜¯ä½¿ç”¨CameraDeviceæ¥åˆ›å»ºä¼šè¯createCaptureSessionã€‚" class="headerlink" title="å¼€å¯é¢„è§ˆä¸»è¦å°±æ˜¯ä½¿ç”¨CameraDeviceæ¥åˆ›å»ºä¼šè¯createCaptureSessionã€‚"></a>å¼€å¯é¢„è§ˆä¸»è¦å°±æ˜¯ä½¿ç”¨<code>CameraDevice</code>æ¥åˆ›å»ºä¼šè¯<code>createCaptureSession</code>ã€‚</h2><p> å£°æ˜å¦‚ä¸‹ï¼ˆ<code>outputs</code>:é¢„è§ˆè¾“å‡ºè½½ä½“ï¼Œæ¯”å¦‚TextureViewçš„getSurfaceTexture()ï¼Œæ‹ç…§æ—¶ImageReaderçš„getSurface()ï¼Œå½•åƒæ—¶MediaRecorderçš„getSurface()ï¼›<code>callback</code>:æ‘„åƒå¤´é‡‡é›†çŠ¶æ€å›è°ƒï¼›<code>handler</code>:åŒopenCameraï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">createCaptureSession</span><span class="params">(<span class="meta">@NonNull</span> List&lt;Surface&gt; outputs,</span></span><br><span class="line"><span class="params">        <span class="meta">@NonNull</span> CameraCaptureSession.StateCallback callback, <span class="meta">@Nullable</span> Handler handler)</span></span><br><span class="line">        <span class="keyword">throws</span> CameraAccessException;</span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„startPreviewå‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Start the camera preview.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startPreview</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == mCameraDevice || !mTextureView.isAvailable() || <span class="literal">null</span> == mPreviewSize) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        closePreviewSession();</span><br><span class="line">        <span class="type">SurfaceTexture</span> <span class="variable">texture</span> <span class="operator">=</span> mTextureView.getSurfaceTexture();<span class="comment">//è·å–TextureViewçš„SurfaceTextureï¼Œä½œä¸ºé¢„è§ˆè¾“å‡ºè½½ä½“</span></span><br><span class="line">        <span class="keyword">assert</span> texture != <span class="literal">null</span>;</span><br><span class="line">        texture.setDefaultBufferSize(mPreviewSize.getWidth(), mPreviewSize.getHeight());</span><br><span class="line">        <span class="comment">//åˆ›å»ºCameraRequest.Builder, å½“ç¨‹åºè°ƒç”¨setRepeatingRequest()æ–¹æ³•è¿›è¡Œé¢„è§ˆæ—¶ï¼Œ</span></span><br><span class="line">        <span class="comment">// æˆ–è°ƒç”¨capture()æ–¹æ³•è¿›è¡Œæ‹ç…§æ—¶ï¼Œéƒ½éœ€è¦ä¼ å…¥CameraRequestå‚æ•°.</span></span><br><span class="line">        <span class="comment">// CameraRequestä»£è¡¨äº†ä¸€æ¬¡æ•è·è¯·æ±‚ï¼Œç”¨äºæè¿°æ•è·å›¾ç‰‡çš„å„ç§å‚æ•°è®¾ç½®ï¼Œ</span></span><br><span class="line">        <span class="comment">// æ¯”å¦‚å¯¹ç„¦æ¨¡å¼ã€æ›å…‰æ¨¡å¼â€¦â€¦ç¨‹åºéœ€è¦å¯¹ç…§ç‰‡æ‰€åšçš„å„ç§æ§åˆ¶ï¼Œéƒ½é€šè¿‡CameraRequestå‚æ•°è¿›è¡Œè®¾ç½®ã€‚</span></span><br><span class="line">        <span class="comment">// å¯ä»¥ç†è§£ä¸€ä¸ªè¯·æ±‚å‚æ•°ä¸€æ ·ï¼ŒCameraRequest.Builderåˆ™è´Ÿè´£ç”ŸæˆCameraRequestå¯¹è±¡ã€‚</span></span><br><span class="line">        mPreviewBuilder = mCameraDevice.createCaptureRequest(CameraDevice.TEMPLATE_PREVIEW);</span><br><span class="line"></span><br><span class="line">        <span class="type">Surface</span> <span class="variable">previewSurface</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Surface</span>(texture);</span><br><span class="line">        mPreviewBuilder.addTarget(previewSurface);</span><br><span class="line"></span><br><span class="line">        mCameraDevice.createCaptureSession(Arrays.asList(previewSurface), <span class="keyword">new</span> <span class="title class_">CameraCaptureSession</span>.StateCallback() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onConfigured</span><span class="params">(CameraCaptureSession cameraCaptureSession)</span> &#123;</span><br><span class="line">                    mPreviewSession = cameraCaptureSession;</span><br><span class="line">                    mPreviewBuilder.set(CaptureRequest.CONTROL_MODE, CameraMetadata.CONTROL_MODE_AUTO);</span><br><span class="line">                    <span class="comment">//ä¸åœçš„å‘é€è·å–å›¾åƒè¯·æ±‚ï¼Œå®Œæˆè¿ç»­é¢„è§ˆ</span></span><br><span class="line">                    mPreviewSession.setRepeatingRequest(mPreviewBuilder.build(), <span class="literal">null</span>, mBackgroundHandler);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onConfigureFailed</span><span class="params">(CameraCaptureSession cameraCaptureSession)</span> &#123;</span><br><span class="line">                    <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> getActivity();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="literal">null</span> != activity) &#123;</span><br><span class="line">                        Toast.makeText(activity, <span class="string">&quot;Failed&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, mBackgroundHandler);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CameraAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p> setRepeatingRequestå’Œcaptureæ–¹æ³•å…¶å®éƒ½æ˜¯å‘ç›¸æœºè®¾å¤‡å‘é€è·å–å›¾åƒçš„è¯·æ±‚ï¼Œä½†æ˜¯captureå°±è·å–é‚£ä¹ˆä¸€æ¬¡ï¼Œè€ŒsetRepeatingRequestå°±æ˜¯ä¸åœçš„è·å–å›¾åƒæ•°æ®ï¼Œæ‰€ä»¥å‘¢ï¼Œä½¿ç”¨captureå°±åƒæ‹ç…§ä¸€æ ·ï¼Œå›¾åƒå°±åœåœ¨é‚£é‡Œï¼Œä½†æ˜¯setRepeatingRequestä¸€ç›´åœ¨å‘é€å’Œè·å–ï¼Œæ‰€ä»¥éœ€è¦è¿æ‹çš„æ—¶å€™å°±è°ƒç”¨å®ƒï¼Œç„¶ååœ¨onCaptureCompletedä¸­ä¿å­˜å›¾åƒå°±è¡Œäº†ã€‚ï¼ˆæ³¨æ„äº†ï¼Œå›¾åƒçš„é¢„è§ˆä¹Ÿæ˜¯ç”¨çš„setRepeatingRequestï¼Œåªæ˜¯ä¸å¤„ç†æ•°æ®ï¼‰</p><h2 id="è‡³æ­¤ï¼ŒCameraå·²ç»å®Œæˆé¢„è§ˆï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥å¼€å§‹å½•åƒäº‹ä»¶ã€‚"><a href="#è‡³æ­¤ï¼ŒCameraå·²ç»å®Œæˆé¢„è§ˆï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥å¼€å§‹å½•åƒäº‹ä»¶ã€‚" class="headerlink" title="è‡³æ­¤ï¼ŒCameraå·²ç»å®Œæˆé¢„è§ˆï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥å¼€å§‹å½•åƒäº‹ä»¶ã€‚"></a>è‡³æ­¤ï¼ŒCameraå·²ç»å®Œæˆé¢„è§ˆï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥å¼€å§‹å½•åƒäº‹ä»¶ã€‚</h2><p>å½“ç”¨æˆ·ç‚¹å‡»å½•åƒæŒ‰é’®æ—¶ï¼Œå…ˆé…ç½®å¥½<code>MediaRecorder</code>ç›¸å…³å‚æ•°ï¼Œç„¶åé‡å¯é¢„è§ˆï¼Œå¹¶åœ¨é¢„è§ˆå¼€å§‹æ—¶è°ƒç”¨<code>MediaRecorder.start()</code>,æ­£å¼å¼€å§‹å½•åƒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startRecordingVideo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == mCameraDevice || !mTextureView.isAvailable() || <span class="literal">null</span> == mPreviewSize) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        closePreviewSession();<span class="comment">//å…ˆå…³é—­é¢„è§ˆï¼Œå› ä¸ºéœ€è¦æ·»åŠ ä¸€ä¸ªé¢„è§ˆè¾“å…¥è½½ä½“åˆ°MediaRecorder.getSurface()</span></span><br><span class="line">        setUpMediaRecorder();<span class="comment">//è®¾ç½®MediaRecorderç›¸å…³å‚æ•°</span></span><br><span class="line">        <span class="type">SurfaceTexture</span> <span class="variable">texture</span> <span class="operator">=</span> mTextureView.getSurfaceTexture();<span class="comment">//è·å–TextureViewçš„è¾“å‡ºè½½ä½“</span></span><br><span class="line">        <span class="keyword">assert</span> texture != <span class="literal">null</span>;</span><br><span class="line">        texture.setDefaultBufferSize(mPreviewSize.getWidth(), mPreviewSize.getHeight());</span><br><span class="line">        <span class="comment">//å‡†å¤‡åˆ›å»ºCaptureRequest</span></span><br><span class="line">        mPreviewBuilder = mCameraDevice.createCaptureRequest(CameraDevice.TEMPLATE_RECORD);</span><br><span class="line">        List&lt;Surface&gt; surfaces = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up Surface for the camera preview</span></span><br><span class="line">        <span class="type">Surface</span> <span class="variable">previewSurface</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Surface</span>(texture);</span><br><span class="line">        surfaces.add(previewSurface);</span><br><span class="line">        mPreviewBuilder.addTarget(previewSurface);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up Surface for the MediaRecorder</span></span><br><span class="line">        mRecorderSurface = mMediaRecorder.getSurface();<span class="comment">//è·å–MediaRecorderé¢„è§ˆè¾“å‡ºè½½ä½“</span></span><br><span class="line">        surfaces.add(mRecorderSurface);</span><br><span class="line">        mPreviewBuilder.addTarget(mRecorderSurface);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start a capture session</span></span><br><span class="line">        <span class="comment">// Once the session starts, we can update the UI and start recording</span></span><br><span class="line">        mCameraDevice.createCaptureSession(surfaces, <span class="keyword">new</span> <span class="title class_">CameraCaptureSession</span>.StateCallback() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onConfigured</span><span class="params">(<span class="meta">@NonNull</span> CameraCaptureSession cameraCaptureSession)</span> &#123;</span><br><span class="line">                mPreviewSession = cameraCaptureSession;</span><br><span class="line">                mPreviewBuilder.set(CaptureRequest.CONTROL_MODE, CameraMetadata.CONTROL_MODE_AUTO);</span><br><span class="line">                <span class="comment">//ä¸åœçš„å‘é€è·å–å›¾åƒè¯·æ±‚ï¼Œå®Œæˆè¿ç»­é¢„è§ˆ</span></span><br><span class="line">                mPreviewSession.setRepeatingRequest(mPreviewBuilder.build(), <span class="literal">null</span>, mBackgroundHandler);</span><br><span class="line">                getActivity().runOnUiThread(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="comment">// UI</span></span><br><span class="line">                        mButtonVideo.setText(R.string.stop);</span><br><span class="line">                        mIsRecordingVideo = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Start recording</span></span><br><span class="line">                        mMediaRecorder.start();<span class="comment">//æ­£å¼å¼€å§‹å½•åƒ</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onConfigureFailed</span><span class="params">(<span class="meta">@NonNull</span> CameraCaptureSession cameraCaptureSession)</span> &#123;</span><br><span class="line">                <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> getActivity();</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != activity) &#123;</span><br><span class="line">                    Toast.makeText(activity, <span class="string">&quot;Failed&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, mBackgroundHandler);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CameraAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å½“ç”¨æˆ·å†ç‚¹å‡»åœæ­¢å½•åƒæŒ‰é’®æ—¶ï¼Œå°±åœæ­¢å½•åƒäº†ï¼Œé‡Šæ”¾æ‰ä¸€äº›èµ„æºï¼š"><a href="#å½“ç”¨æˆ·å†ç‚¹å‡»åœæ­¢å½•åƒæŒ‰é’®æ—¶ï¼Œå°±åœæ­¢å½•åƒäº†ï¼Œé‡Šæ”¾æ‰ä¸€äº›èµ„æºï¼š" class="headerlink" title="å½“ç”¨æˆ·å†ç‚¹å‡»åœæ­¢å½•åƒæŒ‰é’®æ—¶ï¼Œå°±åœæ­¢å½•åƒäº†ï¼Œé‡Šæ”¾æ‰ä¸€äº›èµ„æºï¼š"></a>å½“ç”¨æˆ·å†ç‚¹å‡»åœæ­¢å½•åƒæŒ‰é’®æ—¶ï¼Œå°±åœæ­¢å½•åƒäº†ï¼Œé‡Šæ”¾æ‰ä¸€äº›èµ„æºï¼š</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stopRecordingVideo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// UI</span></span><br><span class="line">    mIsRecordingVideo = <span class="literal">false</span>;</span><br><span class="line">    mButtonVideo.setText(R.string.record);</span><br><span class="line">    <span class="comment">// Stop recording</span></span><br><span class="line">    mMediaRecorder.stop();</span><br><span class="line">    mMediaRecorder.reset();</span><br><span class="line"></span><br><span class="line">    <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> getActivity();</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != activity) &#123;</span><br><span class="line">        Toast.makeText(activity, <span class="string">&quot;Video saved: &quot;</span> + mNextVideoAbsolutePath,</span><br><span class="line">                Toast.LENGTH_SHORT).show();</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;Video saved: &quot;</span> + mNextVideoAbsolutePath);</span><br><span class="line">    &#125;</span><br><span class="line">    mNextVideoAbsolutePath = <span class="literal">null</span>;</span><br><span class="line">    startPreview();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> åšå®¢ </category>
          
          <category> Camera2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åšå®¢ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Androidè¿è¡Œæ—¶èµ„æºè¦†ç›–</title>
      <link href="/2017/01/16/blogs/RuntimeResourceOverlay/"/>
      <url>/2017/01/16/blogs/RuntimeResourceOverlay/</url>
      <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯è¿è¡Œæ—¶èµ„æºè¦†ç›–"><a href="#ä»€ä¹ˆæ˜¯è¿è¡Œæ—¶èµ„æºè¦†ç›–" class="headerlink" title="ä»€ä¹ˆæ˜¯è¿è¡Œæ—¶èµ„æºè¦†ç›–"></a>ä»€ä¹ˆæ˜¯è¿è¡Œæ—¶èµ„æºè¦†ç›–</h2><p>æ— éœ€ä¿®æ”¹åŸappçš„ä»£ç ï¼Œæ— éœ€é‡æ–°ç¼–è¯‘ï¼Œå°±èƒ½è¦†ç›–appå†…çš„éƒ¨åˆ†èµ„æºï¼Œä»è€Œå®ç°ä¿®æ”¹appçš„éƒ¨åˆ†UI,åé¢ç®€ç§°RROã€‚</p><h2 id="RROåŸç†"><a href="#RROåŸç†" class="headerlink" title="RROåŸç†"></a>RROåŸç†</h2><ul><li><p>åº”ç”¨é€šè¿‡ getString&#x2F;getDrawableå»è°ƒç”¨æŸä¸ªèµ„æºæ—¶,ä¼šå°†è¿™ä¸ªresources ID ä½œä¸ºå‚æ•°ä¼ ç»™ framework å±‚ã€‚åŒä¸€åç§°ä½†ä¸åŒçŠ¶æ€çš„ resources ID æ˜¯ä¸€æ ·çš„,æ¯”å¦‚ä¸åŒåˆ†è¾¨ç‡ä½†åç§°ç›¸åŒçš„å›¾ç‰‡åˆ†åˆ«è¢«æ”¾ç½®åœ¨äº†drawable-hdpi&#x2F;drawable-ldpi&#x2F;drawable-mdpiä¸‹ï¼Œä½†åœ¨ç¼–è¯‘æ—¶é’ˆå¯¹è¯¥å›¾ç‰‡ç”Ÿæˆçš„resources IDåªæœ‰ä¸€ä¸ªã€‚</p></li><li><p>ä¸ºäº†å¿«é€ŸæŸ¥æ‰¾åˆ°æŒ‡å®šçš„èµ„æºï¼ŒApkç¼–è¯‘çš„æ—¶å€™ä¼šæŠŠJavaæ–‡ä»¶é‡Œé¢çš„R.String.app_nameæ›¿æ¢æˆox7f123456è¿™ç§æ ¼å¼çš„å€¼</p></li><li><p>æ¯ä¸ªapké‡Œé¢éƒ½æœ‰ä¸€ä¸ªæ–‡ä»¶(resources.arsc)è®°å½•ç€æŒ‡å®šçš„resource_idå¯¹åº”çš„èµ„æºç±»å‹ï¼Œå¦‚æœæ˜¯stringç±»å‹ï¼Œåˆ™è®°å½•çš„è¿™ä¸ªèµ„æºåç§°å¯¹åº”çš„æ‰€æœ‰è¯­è¨€çš„ç¿»è¯‘ï¼Œå¦‚æœæ˜¯drawableç±»å‹ï¼Œåˆ™è®°å½•ç€å“ªäº›åˆ†è¾¨ç‡åº•ä¸‹æœ‰è¿™ä¸ªèµ„æºã€‚</p></li></ul><h2 id="Resources-arscçš„ç»“æ„-string"><a href="#Resources-arscçš„ç»“æ„-string" class="headerlink" title="Resources.arscçš„ç»“æ„ string"></a>Resources.arscçš„ç»“æ„ string</h2><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/runtimeResourceOverlay/2017-01-16-23-12-24.jpg"/><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/runtimeResourceOverlay/2017-01-16-23-12-40.jpg"/><h2 id="Resources-arscçš„ç»“æ„-drawable"><a href="#Resources-arscçš„ç»“æ„-drawable" class="headerlink" title="Resources.arscçš„ç»“æ„ drawable"></a>Resources.arscçš„ç»“æ„ drawable</h2><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/runtimeResourceOverlay/2017-01-16-23-13-30.jpg"/><h2 id="RROå®ç°æ–¹æ³•"><a href="#RROå®ç°æ–¹æ³•" class="headerlink" title="RROå®ç°æ–¹æ³•"></a>RROå®ç°æ–¹æ³•</h2><ul><li>å»ºç«‹ä¸€ä¸ªæ–°çš„overlay apké¡¹ç›®ï¼Œapké¡¹ç›®åº•ä¸‹æœ‰ resæ–‡ä»¶å¤¹ï¼ŒAndroid.mkã€AndroidManifest.xml</li><li>ä¿®æ”¹AndroidManifest.xml é…ç½®apkçš„åŒ…åã€è¦è¦†ç›–çš„apkçš„åŒ…å</li><li>ä¿®æ”¹Android.mk ä½¿å¾—apkèƒ½é›†æˆåˆ°system&#x2F;vendor&#x2F;overlay&#x2F;ç›®å½•ä¸‹</li><li>æ‰¾åˆ°éœ€è¦è¦†ç›–çš„èµ„æºåï¼Œåœ¨overlay apkçš„resæŒ‡å®šç›®å½•ä¸‹å®šä¹‰åŒåçš„èµ„æº</li></ul><h2 id="AndroidManifest-xmlçš„å†™æ³•"><a href="#AndroidManifest-xmlçš„å†™æ³•" class="headerlink" title="AndroidManifest.xmlçš„å†™æ³•"></a>AndroidManifest.xmlçš„å†™æ³•</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>  </span></span><br><span class="line"><span class="tag"><span class="attr">package</span>=<span class="string">&quot;com.android.gallery3d.overlay&quot;</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">overlay</span> <span class="attr">android:targetPackage</span>=<span class="string">&quot;com.android.gallery3d&quot;</span> <span class="attr">android:priority</span>=<span class="string">&quot;1&quot;</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span> </span><br></pre></td></tr></table></figure><h2 id="Android-mkçš„å†™æ³•åŠè‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·çš„å®ç°"><a href="#Android-mkçš„å†™æ³•åŠè‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·çš„å®ç°" class="headerlink" title="Android.mkçš„å†™æ³•åŠè‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·çš„å®ç°"></a>Android.mkçš„å†™æ³•åŠè‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·çš„å®ç°</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">strip</span> <span class="variable">$(MYOS_APE_GALLERY31_SUPPORT)</span>)</span>, yes)</span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(<span class="built_in">strip</span> <span class="variable">$(MYOS_APE_GALLERY31_NAME)</span>)</span>,)</span><br><span class="line"><span class="variable">$(<span class="built_in">warning</span> --Android.mk--ApeGalleryOverlay31---------)</span></span><br><span class="line"></span><br><span class="line">LOCAL_PATH:= <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line"></span><br><span class="line">LOCAL_MODULE_TAGS := optional</span><br><span class="line">LOCAL_SRC_FILES := <span class="variable">$(<span class="built_in">call</span> all-java-files-under, res)</span></span><br><span class="line">LOCAL_PACKAGE_NAME := ApeGalleryOverlay31</span><br><span class="line">LOCAL_CERTIFICATE := platform</span><br><span class="line">LOCAL_MODULE_PATH := <span class="variable">$(TARGET_OUT)</span>/vendor/overlay</span><br><span class="line"></span><br><span class="line">version1 = 6</span><br><span class="line">version2 = 0</span><br><span class="line">version3 = <span class="variable">$(<span class="built_in">shell</span> cd <span class="variable">$(LOCAL_PATH)</span> &amp;&amp; git rev-list --count HEAD)</span></span><br><span class="line">build_date = <span class="variable">$(<span class="built_in">shell</span> date +%y%m%d)</span></span><br><span class="line">last_commit = <span class="variable">$(<span class="built_in">shell</span> cd <span class="variable">$(LOCAL_PATH)</span> &amp;&amp; git describe --always)</span></span><br><span class="line"></span><br><span class="line">version_code = <span class="variable">$(<span class="built_in">shell</span> expr <span class="variable">$(version1)</span> \* 1000000 + <span class="variable">$(version2)</span> \* 10000 + <span class="variable">$(version3)</span>)</span></span><br><span class="line">version_name := <span class="variable">$(version1)</span>.<span class="variable">$(version2)</span>.<span class="variable">$(version3)</span>.<span class="variable">$(build_date)</span>.<span class="variable">$(last_commit)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(<span class="built_in">warning</span> --ApeGalleryOverlay31---<span class="variable">$(version_code)</span>---<span class="variable">$(version_name)</span>---)</span></span><br><span class="line"></span><br><span class="line">LOCAL_AAPT_FLAGS += --version-code <span class="variable">$(version_code)</span></span><br><span class="line">LOCAL_AAPT_FLAGS += --version-name <span class="variable">$(version_name)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_PACKAGE)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure><h2 id="è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·çš„æ„ä¹‰"><a href="#è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·çš„æ„ä¹‰" class="headerlink" title="è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·çš„æ„ä¹‰"></a>è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·çš„æ„ä¹‰</h2><ul><li>å‡ºç°é—®é¢˜ä»¥ååæŸ¥é—®é¢˜åŸå› ,æ˜¯ä»£ç é—®é¢˜ï¼Œè¿˜æ˜¯é›†æˆé—®é¢˜</li><li>è¿™é‡Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨è‡ªåŠ¨ç‰ˆæœ¬å·:<ul><li>ä¸ç”¨æ¯æ¬¡æ”¹ç‰ˆæœ¬å·çš„éº»çƒ¦</li><li>ç‰ˆæœ¬å·æœ‰åºè‡ªå¢ï¼Œæ²¡æœ‰å‡ºé”™çš„é£é™©</li><li>æ¯ä¸€ä¸ªç¼–è¯‘å‡ºæ¥çš„apk,éƒ½èƒ½å®šä½åˆ°å½“æ—¶çš„æœ€åä¸€ä¸ªæäº¤</li><li>ç”±äºæ˜¯éšç³»ç»Ÿç¼–è¯‘,å¯èƒ½ä½ æ²¡æ¥å¾—åŠæ”¹ç‰ˆæœ¬å·å°±ç¼–è¯‘äº†ï¼Œæ‰€ä»¥æ‰‹å·¥æ”¹ç‰ˆæœ¬å·å¯èƒ½åªèƒ½å®šä½åˆ°å¤§è‡´çš„ä½ç½®</li></ul></li><li>æ³¨æ„äº‹é¡¹:<ul><li>ä»“åº“æäº¤9999æ¬¡ä»¥åï¼Œç‰ˆæœ¬ä¼šæº¢å‡ºï¼Œæ­¤æ—¶å¯ä»¥è„šæœ¬å‘å‰è¿›ä½</li></ul></li></ul><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><ul><li>ä¸èƒ½è¦†ç›–layoutã€AndroidManifest.xmlã€assetç›®å½•</li><li>å»ºè®®åªè¦†ç›–å­—ç¬¦èµ„æºã€è¦†ç›–å›¾ç‰‡è¦è°¨æ…</li><li>Overlay apkä¸­ä¸è¦æ·»åŠ å…¶å®ƒçš„ä¸œè¥¿ï¼Œæ¯”æ–¹è¯´style.xml å¯èƒ½ä¼šå¯¼è‡´è¢«è¦†ç›–çš„apkæ‰“å¼€å°±æŠ¥é”™</li><li>Overlay apk å¿…é¡»è¦ç­¾åï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆ </li><li>ä¸ºäº†å®‰å…¨èµ·è§ï¼ŒOverylayçš„apkå¿…é¡»æ”¾åˆ°system&#x2F;vendor&#x2F;overlay&#x2F;ç›®å½•ä¸‹æ‰ä¼šç”Ÿæ•ˆ</li><li>ç”±äºæ˜¯æŠŠæºç æ”¾åœ¨åŸºçº¿é‡Œé¢ç¼–è¯‘ï¼Œæ‰€ä»¥æäº¤ä»£ç éœ€è¦ç‰¹åˆ«å°å¿ƒï¼Œä¸è¦é€ æˆé¡¹ç›®ç¼–è¯‘ä¸è¿‡</li></ul><h2 id="RROå¯¹æˆ‘ä»¬ç›®å‰æ¥è¯´ä½¿ç”¨çš„æ„ä¹‰"><a href="#RROå¯¹æˆ‘ä»¬ç›®å‰æ¥è¯´ä½¿ç”¨çš„æ„ä¹‰" class="headerlink" title="RROå¯¹æˆ‘ä»¬ç›®å‰æ¥è¯´ä½¿ç”¨çš„æ„ä¹‰"></a>RROå¯¹æˆ‘ä»¬ç›®å‰æ¥è¯´ä½¿ç”¨çš„æ„ä¹‰</h2><ul><li>å¯¹äºå­—ç¬¦ç¿»è¯‘éœ€æ±‚ï¼Œå¿«é€Ÿè¾“å‡ºç‰ˆæœ¬</li><li>DCCä»¥åï¼Œåªæœ‰ç¿»è¯‘éœ€æ±‚ï¼Œæ— éœ€æ›´æ–°ä¸»apkç‰ˆæœ¬</li></ul>]]></content>
      
      <categories>
          
          <category> åšå®¢ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åšå®¢ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>mac OSå¸¸ç”¨å¼€å‘è½¯ä»¶æ¿€æ´»æ–¹å¼</title>
      <link href="/2017/01/15/notes/MacOS/"/>
      <url>/2017/01/15/notes/MacOS/</url>
      <content type="html"><![CDATA[<h2 id="Beyond-Compareæ¿€æ´»æ–¹æ³•ï¼š"><a href="#Beyond-Compareæ¿€æ´»æ–¹æ³•ï¼š" class="headerlink" title="Beyond Compareæ¿€æ´»æ–¹æ³•ï¼š"></a>Beyond Compareæ¿€æ´»æ–¹æ³•ï¼š</h2><ul><li>å»å®˜ç½‘ä¸‹è½½å¹¶å®‰è£…ï¼š<a href="http://www.scootersoftware.com/download.php">Beyond Compare</a></li><li>ä¸‹è½½ä¸€ä¸ªæ–‡ä»¶ï¼š<a href="http://o83jxl7u1.bkt.clouddn.com/trial.key">trial.key</a></li><li>åœ¨finder å³å‡»beyondæ–‡ä»¶&gt;æ˜¾ç¤ºåŒ…å†…å®¹&gt;Contents&gt;Recourse æ›¿æ¢ trial.key</li><li>é‡å¯è½¯ä»¶å³å¯ã€‚</li></ul><h2 id="Adobe-Photoshopæ¿€æ´»æ–¹æ³•ï¼š"><a href="#Adobe-Photoshopæ¿€æ´»æ–¹æ³•ï¼š" class="headerlink" title="Adobe Photoshopæ¿€æ´»æ–¹æ³•ï¼š"></a>Adobe Photoshopæ¿€æ´»æ–¹æ³•ï¼š</h2><ul><li>ä¸‹è½½ä¸€ä¸ªæ–‡ä»¶åè§£å‹ï¼š<a href="http://o83jxl7u1.bkt.clouddn.com/amtlib.framework.zip">amtlib.framework</a></li><li>å®‰è£…å®Œæˆåè¿è¡Œè½¯ä»¶ï¼Œé€‰æ‹©â€œè¯•ç”¨â€œï¼Œè¦æ–­ç½‘ï¼Œç‚¹å‡»â€œç¨åè¿æ¥â€œï¼Œç„¶åé€€å‡ºã€‚</li><li>å°†ç ´è§£åŒ…è§£å‹åï¼Œå³é”®ç¨‹åºå›¾æ ‡â€“&gt;æ˜¾ç¤ºåŒ…å†…å®¹â€“&gt;contentsâ€“&gt;frameworksï¼Œç”¨è§£å‹æ¥çš„æ–‡ä»¶æ›¿æ¢amtlib.frameworkã€‚</li><li>é‡å¯è½¯ä»¶ï¼Œåº”è¯¥å°±æ²¡æœ‰å€’è®¡æ—¶äº†å§ï¼Ÿ</li></ul><h2 id="æœªå®Œå¾…ç»­â€¦"><a href="#æœªå®Œå¾…ç»­â€¦" class="headerlink" title="æœªå®Œå¾…ç»­â€¦"></a>æœªå®Œå¾…ç»­â€¦</h2>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
          <category> mac </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>å„ç§å¸¸ç”¨è„šæœ¬</title>
      <link href="/2017/01/14/notes/Command/"/>
      <url>/2017/01/14/notes/Command/</url>
      <content type="html"><![CDATA[<h2 id="alogcatå¯ä»¥è¿‡æ»¤æ‰“å°å‡ºå¯¹åº”åŒ…åçš„logï¼š"><a href="#alogcatå¯ä»¥è¿‡æ»¤æ‰“å°å‡ºå¯¹åº”åŒ…åçš„logï¼š" class="headerlink" title="alogcatå¯ä»¥è¿‡æ»¤æ‰“å°å‡ºå¯¹åº”åŒ…åçš„logï¼š"></a><code>alogcat</code>å¯ä»¥è¿‡æ»¤æ‰“å°å‡ºå¯¹åº”åŒ…åçš„logï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½œç”¨ï¼šèƒ½å¤Ÿé€šè¿‡è¿›ç¨‹åæ˜¾ç¤ºlog</span></span><br><span class="line"><span class="comment"># ç”¨æ³•ï¼šalogcat com.android.calendar or alogcat calendar</span></span><br><span class="line"><span class="comment"># å½“ç›‘æ§çš„è¿›ç¨‹å¼‚å¸¸é€€å‡ºæ—¶ï¼Œéœ€è¦é‡æ–°è¿è¡Œæ­¤å‘½ä»¤</span></span><br><span class="line"><span class="comment">#function alogcat() &#123;</span></span><br><span class="line">    OUT=$(adb shell ps | grep -i <span class="variable">$1</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">    OUT=$(<span class="built_in">echo</span> <span class="variable">$OUT</span> | sed <span class="string">&#x27;s/[[:blank:]]\+/\|/g&#x27;</span>)</span><br><span class="line">    <span class="comment"># å½“è¿›ç¨‹å¼‚å¸¸é€€å‡ºï¼Œlogæ˜¯é€šè¿‡ AndroidRuntime è¾“å‡ºçš„</span></span><br><span class="line">    adb logcat -v <span class="keyword">time</span> | grep -E <span class="string">&quot;<span class="variable">$OUT</span>|AndroidRuntime&quot;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br></pre></td></tr></table></figure><h2 id="tingpngæ‰¹é‡å‹ç¼©å›¾ç‰‡èµ„æºçš„è„šæœ¬ï¼š"><a href="#tingpngæ‰¹é‡å‹ç¼©å›¾ç‰‡èµ„æºçš„è„šæœ¬ï¼š" class="headerlink" title="tingpngæ‰¹é‡å‹ç¼©å›¾ç‰‡èµ„æºçš„è„šæœ¬ï¼š"></a><code>tingpng</code>æ‰¹é‡å‹ç¼©å›¾ç‰‡èµ„æºçš„è„šæœ¬ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">pngquant -f --skip-if-larger --ext .png --quality 50-80 `find . -name <span class="string">&quot;*.png&quot;</span> -<span class="built_in">type</span> f ! -name <span class="string">&quot;*.9.png&quot;</span>`</span><br></pre></td></tr></table></figure><h2 id="åœ¨Macã€Linux-ç»ˆç«¯æ˜¾ç¤º-Git-å½“å‰æ‰€åœ¨åˆ†æ”¯"><a href="#åœ¨Macã€Linux-ç»ˆç«¯æ˜¾ç¤º-Git-å½“å‰æ‰€åœ¨åˆ†æ”¯" class="headerlink" title="åœ¨Macã€Linux ç»ˆç«¯æ˜¾ç¤º Git å½“å‰æ‰€åœ¨åˆ†æ”¯"></a>åœ¨Macã€Linux ç»ˆç«¯æ˜¾ç¤º Git å½“å‰æ‰€åœ¨åˆ†æ”¯</h2><p>ç¼–è¾‘.bashrcæ–‡ä»¶,å°†ä¸‹é¢çš„ä»£ç åŠ å…¥åˆ°æ–‡ä»¶çš„æœ€åå¤„,ä¿å­˜é€€å‡ºï¼Œæ‰§è¡ŒåŠ è½½å‘½ä»¤<code>source ./.bashrc</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Parses out the branch name from .git/HEAD:</span></span><br><span class="line"><span class="function"><span class="title">find_git_branch</span></span> () &#123;</span><br><span class="line">    <span class="built_in">local</span> <span class="built_in">dir</span>=. <span class="built_in">head</span></span><br><span class="line">    <span class="keyword">until</span> [ <span class="string">&quot;<span class="variable">$dir</span>&quot;</span> -ef / ]; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$dir</span>/.git/HEAD&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">head</span>=$(&lt; <span class="string">&quot;<span class="variable">$dir</span>/.git/HEAD&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> [[ <span class="variable">$head</span> = ref:\ refs/heads/* ]]; <span class="keyword">then</span></span><br><span class="line">                git_branch=<span class="string">&quot; â†’ <span class="variable">$&#123;head#*/*/&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">elif</span> [[ <span class="variable">$head</span> != <span class="string">&#x27;&#x27;</span> ]]; <span class="keyword">then</span></span><br><span class="line">                git_branch=<span class="string">&quot; â†’ (detached)&quot;</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                git_branch=<span class="string">&quot; â†’ (unknow)&quot;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            <span class="built_in">return</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="built_in">dir</span>=<span class="string">&quot;../<span class="variable">$dir</span>&quot;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    git_branch=<span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PROMPT_COMMAND=<span class="string">&quot;find_git_branch; <span class="variable">$PROMPT_COMMAND</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Here is bash color codes you can use</span></span><br><span class="line">  black=$<span class="string">&#x27;\[\e[1;30m\]&#x27;</span></span><br><span class="line">    red=$<span class="string">&#x27;\[\e[1;31m\]&#x27;</span></span><br><span class="line">  green=$<span class="string">&#x27;\[\e[1;32m\]&#x27;</span></span><br><span class="line"> yellow=$<span class="string">&#x27;\[\e[1;33m\]&#x27;</span></span><br><span class="line">   blue=$<span class="string">&#x27;\[\e[1;34m\]&#x27;</span></span><br><span class="line">magenta=$<span class="string">&#x27;\[\e[1;35m\]&#x27;</span></span><br><span class="line">   cyan=$<span class="string">&#x27;\[\e[1;36m\]&#x27;</span></span><br><span class="line">  white=$<span class="string">&#x27;\[\e[1;37m\]&#x27;</span></span><br><span class="line"> normal=$<span class="string">&#x27;\[\e[m\]&#x27;</span></span><br><span class="line"></span><br><span class="line">PS1=<span class="string">&quot;<span class="variable">$white</span>[<span class="variable">$white</span>\u<span class="variable">$white</span>@<span class="variable">$white</span>\h<span class="variable">$white</span>:<span class="variable">$white</span>\w<span class="variable">$yellow</span>\$git_branch<span class="variable">$white</span>]\$ <span class="variable">$normal</span>&quot;</span></span><br></pre></td></tr></table></figure><h2 id="é€šè¿‡git-diffall-branch-a-branch-bæ¥å¯¹æ¯”ä¸¤ä¸ªåˆ†æ”¯é—´å·®å¼‚é…ç½®ï¼š"><a href="#é€šè¿‡git-diffall-branch-a-branch-bæ¥å¯¹æ¯”ä¸¤ä¸ªåˆ†æ”¯é—´å·®å¼‚é…ç½®ï¼š" class="headerlink" title="é€šè¿‡git diffall branch_a...branch_bæ¥å¯¹æ¯”ä¸¤ä¸ªåˆ†æ”¯é—´å·®å¼‚é…ç½®ï¼š"></a>é€šè¿‡<code>git diffall branch_a...branch_b</code>æ¥å¯¹æ¯”ä¸¤ä¸ªåˆ†æ”¯é—´å·®å¼‚é…ç½®ï¼š</h2><p>åœ¨ï½&#x2F;binç›®å½•ä¸‹æ–°å»ºgit-diffallæ–‡ä»¶:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment"># Copyright 2010 - 2012, Tim Henigan &lt;tim.henigan@gmail.com&gt;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Permission is hereby granted, free of charge, to any person obtaining</span></span><br><span class="line"><span class="comment"># a copy of this software and associated documentation files (the</span></span><br><span class="line"><span class="comment"># &quot;Software&quot;), to deal in the Software without restriction, including</span></span><br><span class="line"><span class="comment"># without limitation the rights to use, copy, modify, merge, publish,</span></span><br><span class="line"><span class="comment"># distribute, sublicense, and/or sell copies of the Software, and to</span></span><br><span class="line"><span class="comment"># permit persons to whom the Software is furnished to do so, subject to</span></span><br><span class="line"><span class="comment"># the following conditions:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The above copyright notice and this permission notice shall be included</span></span><br><span class="line"><span class="comment"># in all copies or substantial portions of the Software.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span></span><br><span class="line"><span class="comment"># OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span></span><br><span class="line"><span class="comment"># MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.</span></span><br><span class="line"><span class="comment"># IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY</span></span><br><span class="line"><span class="comment"># CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,</span></span><br><span class="line"><span class="comment"># TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE</span></span><br><span class="line"><span class="comment"># SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Perform a directory diff between commits in the repository using</span></span><br><span class="line"><span class="comment"># the external diff or merge tool specified in the user&#x27;s config.</span></span><br><span class="line"></span><br><span class="line">USAGE=<span class="string">&#x27;[--cached] [--copy-back] [-x|--extcmd=&lt;command&gt;] &lt;commit&gt;&#123;0,2&#125; [-- &lt;path&gt;*]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    --cached     Compare to the index rather than the working tree.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    --copy-back  Copy files back to the working tree when the diff</span></span><br><span class="line"><span class="string">                 tool exits (in case they were modified by the</span></span><br><span class="line"><span class="string">                 user).  This option is only valid if the diff</span></span><br><span class="line"><span class="string">                 compared with the working tree.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    -x=&lt;command&gt;</span></span><br><span class="line"><span class="string">    --extcmd=&lt;command&gt;  Specify a custom command for viewing diffs.</span></span><br><span class="line"><span class="string">                 git-diffall ignores the configured defaults and</span></span><br><span class="line"><span class="string">                 runs $command $LOCAL $REMOTE when this option is</span></span><br><span class="line"><span class="string">                 specified. Additionally, $BASE is set in the</span></span><br><span class="line"><span class="string">                 environment.</span></span><br><span class="line"><span class="string">&#x27;</span></span><br><span class="line"></span><br><span class="line">SUBDIRECTORY_OK=1</span><br><span class="line">. <span class="string">&quot;<span class="subst">$(git --exec-path)</span>/git-sh-setup&quot;</span></span><br><span class="line"></span><br><span class="line">TOOL_MODE=diff</span><br><span class="line">. <span class="string">&quot;<span class="subst">$(git --exec-path)</span>/git-mergetool--lib&quot;</span></span><br><span class="line"></span><br><span class="line">merge_tool=<span class="string">&quot;<span class="subst">$(get_merge_tool)</span>&quot;</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -z <span class="string">&quot;<span class="variable">$merge_tool</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Error: Either the &#x27;diff.tool&#x27; or &#x27;merge.tool&#x27; option must be set.&quot;</span></span><br><span class="line">usage</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">start_dir=$(<span class="built_in">pwd</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># All the file paths returned by the diff command are relative to the root</span></span><br><span class="line"><span class="comment"># of the working copy. So if the script is called from a subdirectory, it</span></span><br><span class="line"><span class="comment"># must switch to the root of working copy before trying to use those paths.</span></span><br><span class="line">cdup=$(git rev-parse --show-cdup) &amp;&amp;</span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$cdup</span>&quot;</span> || &#123;</span><br><span class="line"><span class="built_in">echo</span> &gt;&amp;2 <span class="string">&quot;Cannot chdir to <span class="variable">$cdup</span>, the toplevel of the working tree&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># set up temp dir</span></span><br><span class="line">tmp=$(perl -e <span class="string">&#x27;use File::Temp qw(tempdir);</span></span><br><span class="line"><span class="string">$t=tempdir(&quot;/tmp/git-diffall.XXXXX&quot;) or exit(1);</span></span><br><span class="line"><span class="string">print $t&#x27;</span>) || <span class="built_in">exit</span> 1</span><br><span class="line"><span class="built_in">trap</span> <span class="string">&#x27;rm -rf &quot;$tmp&quot;&#x27;</span> EXIT</span><br><span class="line"></span><br><span class="line">left=</span><br><span class="line">right=</span><br><span class="line">paths=</span><br><span class="line">dashdash_seen=</span><br><span class="line">compare_staged=</span><br><span class="line">merge_base=</span><br><span class="line">left_dir=</span><br><span class="line">right_dir=</span><br><span class="line">diff_tool=</span><br><span class="line">copy_back=</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">test</span> <span class="variable">$#</span> != 0</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">-h|--h|--he|--hel|--<span class="built_in">help</span>)</span><br><span class="line">usage</span><br><span class="line">;;</span><br><span class="line">--cached)</span><br><span class="line">compare_staged=1</span><br><span class="line">;;</span><br><span class="line">--copy-back)</span><br><span class="line">copy_back=1</span><br><span class="line">;;</span><br><span class="line">-x|--e|--ex|--ext|--extc|--extcm|--extcmd)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> <span class="variable">$#</span> = 1</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> You must specify the tool <span class="keyword">for</span> use with --extcmd</span><br><span class="line">usage</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">diff_tool=<span class="variable">$2</span></span><br><span class="line"><span class="built_in">shift</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line">--)</span><br><span class="line">dashdash_seen=1</span><br><span class="line">;;</span><br><span class="line">-*)</span><br><span class="line"><span class="built_in">echo</span> Invalid option: <span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">usage</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"><span class="comment"># could be commit, commit range or path limiter</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">*...*)</span><br><span class="line">left=<span class="variable">$&#123;1%...*&#125;</span></span><br><span class="line">right=<span class="variable">$&#123;1#*...&#125;</span></span><br><span class="line">merge_base=1</span><br><span class="line">;;</span><br><span class="line">*..*)</span><br><span class="line">left=<span class="variable">$&#123;1%..*&#125;</span></span><br><span class="line">right=<span class="variable">$&#123;1#*..&#125;</span></span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$dashdash_seen</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">paths=<span class="string">&quot;$paths<span class="variable">$1</span> &quot;</span></span><br><span class="line"><span class="keyword">elif</span> <span class="built_in">test</span> -z <span class="string">&quot;<span class="variable">$left</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">left=<span class="variable">$1</span></span><br><span class="line"><span class="keyword">elif</span> <span class="built_in">test</span> -z <span class="string">&quot;<span class="variable">$right</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">right=<span class="variable">$1</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">paths=<span class="string">&quot;$paths<span class="variable">$1</span> &quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">shift</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Determine the set of files which changed</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$left</span>&quot;</span> &amp;&amp; <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$right</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">left_dir=<span class="string">&quot;cmt-<span class="subst">$(git rev-parse --short $left)</span>&quot;</span></span><br><span class="line">right_dir=<span class="string">&quot;cmt-<span class="subst">$(git rev-parse --short $right)</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$compare_staged</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">usage</span><br><span class="line"><span class="keyword">elif</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$merge_base</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">git diff --name-only <span class="string">&quot;<span class="variable">$left</span>&quot;</span>...<span class="string">&quot;<span class="variable">$right</span>&quot;</span> -- <span class="variable">$paths</span> &gt;<span class="string">&quot;<span class="variable">$tmp</span>/filelist&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">git diff --name-only <span class="string">&quot;<span class="variable">$left</span>&quot;</span> <span class="string">&quot;<span class="variable">$right</span>&quot;</span> -- <span class="variable">$paths</span> &gt;<span class="string">&quot;<span class="variable">$tmp</span>/filelist&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">elif</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$left</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">left_dir=<span class="string">&quot;cmt-<span class="subst">$(git rev-parse --short $left)</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$compare_staged</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">right_dir=<span class="string">&quot;staged&quot;</span></span><br><span class="line">git diff --name-only --cached <span class="string">&quot;<span class="variable">$left</span>&quot;</span> -- <span class="variable">$paths</span> &gt;<span class="string">&quot;<span class="variable">$tmp</span>/filelist&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">right_dir=<span class="string">&quot;working_tree&quot;</span></span><br><span class="line">git diff --name-only <span class="string">&quot;<span class="variable">$left</span>&quot;</span> -- <span class="variable">$paths</span> &gt;<span class="string">&quot;<span class="variable">$tmp</span>/filelist&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">left_dir=<span class="string">&quot;HEAD&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$compare_staged</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">right_dir=<span class="string">&quot;staged&quot;</span></span><br><span class="line">git diff --name-only --cached -- <span class="variable">$paths</span> &gt;<span class="string">&quot;<span class="variable">$tmp</span>/filelist&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">right_dir=<span class="string">&quot;working_tree&quot;</span></span><br><span class="line">git diff --name-only -- <span class="variable">$paths</span> &gt;<span class="string">&quot;<span class="variable">$tmp</span>/filelist&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Exit immediately if there are no diffs</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> ! -s <span class="string">&quot;<span class="variable">$tmp</span>/filelist&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$copy_back</span>&quot;</span> &amp;&amp; <span class="built_in">test</span> <span class="string">&quot;<span class="variable">$right_dir</span>&quot;</span> != <span class="string">&quot;working_tree&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--copy-back is only valid when diff includes the working tree.&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the named tmp directories that will hold the files to be compared</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$left_dir</span>&quot;</span> <span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$right_dir</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Populate the tmp/right_dir directory with the files to be compared</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> name</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$right</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">ls_list=$(git ls-tree <span class="variable">$right</span> <span class="string">&quot;<span class="variable">$name</span>&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$ls_list</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$right_dir</span>/<span class="subst">$(dirname <span class="string">&quot;<span class="variable">$name</span>&quot;</span>)</span>&quot;</span></span><br><span class="line">git show <span class="string">&quot;<span class="variable">$right</span>&quot;</span>:<span class="string">&quot;<span class="variable">$name</span>&quot;</span> &gt;<span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$right_dir</span>/<span class="variable">$name</span>&quot;</span> || <span class="literal">true</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">elif</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$compare_staged</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">ls_list=$(git ls-files -- <span class="string">&quot;<span class="variable">$name</span>&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$ls_list</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$right_dir</span>/<span class="subst">$(dirname <span class="string">&quot;<span class="variable">$name</span>&quot;</span>)</span>&quot;</span></span><br><span class="line">git show :<span class="string">&quot;<span class="variable">$name</span>&quot;</span> &gt;<span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$right_dir</span>/<span class="variable">$name</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -e <span class="string">&quot;<span class="variable">$name</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$right_dir</span>/<span class="subst">$(dirname <span class="string">&quot;<span class="variable">$name</span>&quot;</span>)</span>&quot;</span></span><br><span class="line"><span class="built_in">cp</span> <span class="string">&quot;<span class="variable">$name</span>&quot;</span> <span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$right_dir</span>/<span class="variable">$name</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span> &lt; <span class="string">&quot;<span class="variable">$tmp</span>/filelist&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Populate the tmp/left_dir directory with the files to be compared</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> name</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$left</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">ls_list=$(git ls-tree <span class="variable">$left</span> <span class="string">&quot;<span class="variable">$name</span>&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$ls_list</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$left_dir</span>/<span class="subst">$(dirname <span class="string">&quot;<span class="variable">$name</span>&quot;</span>)</span>&quot;</span></span><br><span class="line">git show <span class="string">&quot;<span class="variable">$left</span>&quot;</span>:<span class="string">&quot;<span class="variable">$name</span>&quot;</span> &gt;<span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$left_dir</span>/<span class="variable">$name</span>&quot;</span> || <span class="literal">true</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$compare_staged</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">ls_list=$(git ls-tree HEAD <span class="string">&quot;<span class="variable">$name</span>&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$ls_list</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$left_dir</span>/<span class="subst">$(dirname <span class="string">&quot;<span class="variable">$name</span>&quot;</span>)</span>&quot;</span></span><br><span class="line">git show HEAD:<span class="string">&quot;<span class="variable">$name</span>&quot;</span> &gt;<span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$left_dir</span>/<span class="variable">$name</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$left_dir</span>/<span class="subst">$(dirname <span class="string">&quot;<span class="variable">$name</span>&quot;</span>)</span>&quot;</span></span><br><span class="line">git show :<span class="string">&quot;<span class="variable">$name</span>&quot;</span> &gt;<span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$left_dir</span>/<span class="variable">$name</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span> &lt; <span class="string">&quot;<span class="variable">$tmp</span>/filelist&quot;</span></span><br><span class="line"></span><br><span class="line">LOCAL=<span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$left_dir</span>&quot;</span></span><br><span class="line">REMOTE=<span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$right_dir</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$diff_tool</span>&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">export</span> BASE</span><br><span class="line"><span class="built_in">eval</span> <span class="variable">$diff_tool</span> <span class="string">&#x27;&quot;$LOCAL&quot;&#x27;</span> <span class="string">&#x27;&quot;$REMOTE&quot;&#x27;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">run_merge_tool <span class="string">&quot;<span class="variable">$merge_tool</span>&quot;</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy files back to the working dir, if requested</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$copy_back</span>&quot;</span> &amp;&amp; <span class="built_in">test</span> <span class="string">&quot;<span class="variable">$right_dir</span>&quot;</span> = <span class="string">&quot;working_tree&quot;</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$start_dir</span>&quot;</span></span><br><span class="line">git_top_dir=$(git rev-parse --show-toplevel)</span><br><span class="line">find <span class="string">&quot;<span class="variable">$tmp</span>/<span class="variable">$right_dir</span>&quot;</span> -<span class="built_in">type</span> f |</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> file</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">cp</span> <span class="string">&quot;<span class="variable">$file</span>&quot;</span> <span class="string">&quot;<span class="variable">$git_top_dir</span>/<span class="variable">$&#123;file#$tmp/$right_dir/&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>ç„¶åé…ç½®<code>~/.gitconfig</code>æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[color]</span><br><span class="line">ui = auto</span><br><span class="line">[user]</span><br><span class="line">name = xxx</span><br><span class="line">email = xxx@xxx.xx</span><br><span class="line">[<span class="built_in">alias</span>]</span><br><span class="line">st = status</span><br><span class="line">co = checkout</span><br><span class="line">ci = commit</span><br><span class="line">br = branch</span><br><span class="line">last = <span class="built_in">log</span> -1</span><br><span class="line">di = diff</span><br><span class="line">lg = <span class="built_in">log</span> --color --graph --pretty=format:<span class="string">&#x27;%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset&#x27;</span> --abbrev-commit</span><br><span class="line">unstage = reset HEAD</span><br><span class="line">chp = cherry-pick</span><br><span class="line">diffall = ~/bin/git-diffall</span><br><span class="line">[core]</span><br><span class="line">quotepath = <span class="literal">false</span></span><br><span class="line">editor = vim</span><br><span class="line">[<span class="built_in">help</span>]</span><br><span class="line">autocorrect = 1</span><br><span class="line">[credential]</span><br><span class="line">helper = cache --<span class="built_in">timeout</span>=31536000</span><br><span class="line">[diff]</span><br><span class="line">    tool = bc3</span><br><span class="line">[difftool]</span><br><span class="line">    prompt = <span class="literal">false</span></span><br><span class="line">[merge]</span><br><span class="line">    tool = bcomp</span><br><span class="line">[mergetool]</span><br><span class="line">    prompt = <span class="literal">false</span></span><br><span class="line">[mergetool <span class="string">&quot;bcomp&quot;</span>]</span><br><span class="line">    cmd = \&quot;/usr/local/bin/bcomp\&quot; \&quot;<span class="variable">$LOCAL</span>\&quot; \&quot;<span class="variable">$REMOTE</span>\&quot; \&quot;<span class="variable">$BASE</span>\&quot; \&quot;<span class="variable">$MERGED</span>\&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="é…ç½®gitæ˜¾ç¤ºå½“å‰åˆ†æ”¯ï¼Œåœ¨-bashrcæ–‡ä»¶æœ«å°¾åŠ ä¸Šï¼š"><a href="#é…ç½®gitæ˜¾ç¤ºå½“å‰åˆ†æ”¯ï¼Œåœ¨-bashrcæ–‡ä»¶æœ«å°¾åŠ ä¸Šï¼š" class="headerlink" title="é…ç½®gitæ˜¾ç¤ºå½“å‰åˆ†æ”¯ï¼Œåœ¨~&#x2F;.bashrcæ–‡ä»¶æœ«å°¾åŠ ä¸Šï¼š"></a>é…ç½®gitæ˜¾ç¤ºå½“å‰åˆ†æ”¯ï¼Œåœ¨~&#x2F;.bashrcæ–‡ä»¶æœ«å°¾åŠ ä¸Šï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Parses out the branch name from .git/HEAD:</span></span><br><span class="line"><span class="function"><span class="title">find_git_branch</span></span> () &#123;</span><br><span class="line">    <span class="built_in">local</span> <span class="built_in">dir</span>=. <span class="built_in">head</span></span><br><span class="line">    <span class="keyword">until</span> [ <span class="string">&quot;<span class="variable">$dir</span>&quot;</span> -ef / ]; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$dir</span>/.git/HEAD&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">head</span>=$(&lt; <span class="string">&quot;<span class="variable">$dir</span>/.git/HEAD&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> [[ <span class="variable">$head</span> = ref:\ refs/heads/* ]]; <span class="keyword">then</span></span><br><span class="line">                git_branch=<span class="string">&quot; â†’ <span class="variable">$&#123;head#*/*/&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">elif</span> [[ <span class="variable">$head</span> != <span class="string">&#x27;&#x27;</span> ]]; <span class="keyword">then</span></span><br><span class="line">                git_branch=<span class="string">&quot; â†’ (detached)&quot;</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                git_branch=<span class="string">&quot; â†’ (unknow)&quot;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            <span class="built_in">return</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="built_in">dir</span>=<span class="string">&quot;../<span class="variable">$dir</span>&quot;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    git_branch=<span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PROMPT_COMMAND=<span class="string">&quot;find_git_branch; <span class="variable">$PROMPT_COMMAND</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Here is bash color codes you can use</span></span><br><span class="line">  black=$<span class="string">&#x27;\[\e[1;30m\]&#x27;</span></span><br><span class="line">    red=$<span class="string">&#x27;\[\e[1;31m\]&#x27;</span></span><br><span class="line">  green=$<span class="string">&#x27;\[\e[1;32m\]&#x27;</span></span><br><span class="line"> yellow=$<span class="string">&#x27;\[\e[1;33m\]&#x27;</span></span><br><span class="line">   blue=$<span class="string">&#x27;\[\e[1;34m\]&#x27;</span></span><br><span class="line">magenta=$<span class="string">&#x27;\[\e[1;35m\]&#x27;</span></span><br><span class="line">   cyan=$<span class="string">&#x27;\[\e[1;36m\]&#x27;</span></span><br><span class="line">  white=$<span class="string">&#x27;\[\e[1;37m\]&#x27;</span></span><br><span class="line"> normal=$<span class="string">&#x27;\[\e[m\]&#x27;</span></span><br><span class="line"></span><br><span class="line">PS1=<span class="string">&quot;<span class="variable">$white</span>[<span class="variable">$white</span>\u<span class="variable">$white</span>@<span class="variable">$white</span>\h<span class="variable">$white</span>:<span class="variable">$white</span>\w<span class="variable">$yellow</span>\$git_branch<span class="variable">$white</span>]\$ <span class="variable">$normal</span>&quot;</span></span><br></pre></td></tr></table></figure><h2 id="æœªå®Œå¾…ç»­â€¦"><a href="#æœªå®Œå¾…ç»­â€¦" class="headerlink" title="æœªå®Œå¾…ç»­â€¦"></a>æœªå®Œå¾…ç»­â€¦</h2>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
          <category> command </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Gitè¿›é˜¶ç”¨æ³•</title>
      <link href="/2016/12/15/notes/GitAdvance/"/>
      <url>/2016/12/15/notes/GitAdvance/</url>
      <content type="html"><![CDATA[<h2 id="Gité‡è¦æ¦‚å¿µï¼š"><a href="#Gité‡è¦æ¦‚å¿µï¼š" class="headerlink" title="Gité‡è¦æ¦‚å¿µï¼š"></a>Gité‡è¦æ¦‚å¿µï¼š</h2><p>å¯¹äºä»»ä½•ä¸€ä¸ªæ–‡ä»¶ï¼Œåœ¨ Git å†…éƒ½åªæœ‰ä¸‰ç§çŠ¶æ€ï¼šå·²ä¿®æ”¹ï¼ˆmodifiedï¼‰ã€å·²æš‚å­˜ï¼ˆstagedï¼‰ã€å·²æäº¤ï¼ˆcommittedï¼‰ï¼š</p><ul><li>å·²ä¿®æ”¹è¡¨ç¤ºä¿®æ”¹äº†æŸä¸ªæ–‡ä»¶ï¼Œä½†è¿˜æ²¡æœ‰æäº¤ä¿å­˜.</li><li>å·²æš‚å­˜è¡¨ç¤ºæŠŠå·²ä¿®æ”¹çš„æ–‡ä»¶æ”¾åœ¨ä¸‹æ¬¡æäº¤æ—¶è¦ä¿å­˜çš„æ¸…å•ä¸­.</li><li>å·²æäº¤è¡¨ç¤ºè¯¥æ–‡ä»¶å·²ç»è¢«å®‰å…¨åœ°ä¿å­˜åœ¨æœ¬åœ°æ•°æ®åº“ä¸­äº†.</li></ul> <img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/1.png"/><h2 id="ä¸¤ç§åˆ†æ”¯åˆå¹¶çš„æ–¹æ³•-rebase-ä¸-mergeï¼š"><a href="#ä¸¤ç§åˆ†æ”¯åˆå¹¶çš„æ–¹æ³•-rebase-ä¸-mergeï¼š" class="headerlink" title="ä¸¤ç§åˆ†æ”¯åˆå¹¶çš„æ–¹æ³•,rebase ä¸ mergeï¼š"></a>ä¸¤ç§åˆ†æ”¯åˆå¹¶çš„æ–¹æ³•,rebase ä¸ mergeï¼š</h2><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/2.png"/><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/3.png"/><h2 id="Rebaseçš„åŸç†"><a href="#Rebaseçš„åŸç†" class="headerlink" title="Rebaseçš„åŸç†:"></a>Rebaseçš„åŸç†:</h2><ul><li>å…ˆæŠŠæœ¬åœ°çš„æœªpushçš„æäº¤ç”Ÿæˆä¸€ä¸ªä¸ªpatch</li><li>ç„¶åç§»é™¤æœ¬åœ°æœªä¸Šä¼ çš„æäº¤</li><li>æŠŠæœåŠ¡å™¨æœ€æ–°çš„æäº¤å…¨æ‹‰ä¸‹æ¥</li><li>æŒ‰ä¿®æ”¹é¡ºåºï¼Œé‡æ–°åº”ç”¨æœ¬åœ°çš„æäº¤ç”Ÿæˆçš„patch</li></ul><p>ç”±æ­¤å¯è§ï¼Œrebaseè¿‡ç¨‹å¯èƒ½äº§ç”Ÿå†²çªï¼Œè€Œä¸”å¯èƒ½éœ€è¦è§£å†³å¤šæ¬¡</p><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/4.png"/><h2 id="åˆ é™¤ä¸€ä¸ªæœªä¸Šä¼ çš„æäº¤"><a href="#åˆ é™¤ä¸€ä¸ªæœªä¸Šä¼ çš„æäº¤" class="headerlink" title="åˆ é™¤ä¸€ä¸ªæœªä¸Šä¼ çš„æäº¤"></a>åˆ é™¤ä¸€ä¸ªæœªä¸Šä¼ çš„æäº¤</h2><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/5.png"/><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/6.png"/><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/7.png"/><p>æ³¨æ„ç‚¹:</p><ul><li>Rebaseæ—¶logæ˜¾ç¤ºæ˜¯æŒ‰ä¿®æ”¹çš„é¡ºåºæ˜¾ç¤ºçš„ï¼Œå’Œgit log æ˜¾ç¤ºåˆšå¥½æ˜¯ç›¸åçš„</li><li>Rebaseå®Œä»¥åç¼–è¾‘å™¨é‡Œé¢æœ€å°‘éœ€è¦ä¿ç•™ä¸€è¡Œæœ‰æ•ˆå†…å®¹ï¼Œå¦åˆ™ä¸ä¼šè¿›è¡Œrebase</li><li>é€‚åˆæŸä¸ªcommit,åœ¨èµ°è¯»ä»¥åå‘ç°æ˜¯ä¸éœ€è¦ä¿®æ”¹çš„</li></ul><h2 id="ä¿®æ”¹éæœ€åä¸€ä¸ªæäº¤"><a href="#ä¿®æ”¹éæœ€åä¸€ä¸ªæäº¤" class="headerlink" title="ä¿®æ”¹éæœ€åä¸€ä¸ªæäº¤"></a>ä¿®æ”¹éæœ€åä¸€ä¸ªæäº¤</h2><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/8.png"/><p>æ³¨æ„ç‚¹:</p><ul><li>è¿™ä¸ªæ–¹æ¡ˆé€‚åˆèµ°è¯»å‘ç°çš„å°é—®é¢˜ä¿®æ”¹ï¼Œé€‚åˆå°‘é‡çš„ä»£ç ä¿®æ”¹ã€‚</li><li>å¤§é‡çš„ä»£ç ä¿®æ”¹ï¼Œå»ºè®®æŠŠè¦ä¿®æ”¹çš„å†…å®¹å˜æˆä¸€ä¸ªcommit,ç„¶ååˆå¹¶åˆ°åŸæ¥çš„commit</li></ul><h2 id="åˆå¹¶æœ¬åœ°æœªä¸Šä¼ çš„æäº¤"><a href="#åˆå¹¶æœ¬åœ°æœªä¸Šä¼ çš„æäº¤" class="headerlink" title="åˆå¹¶æœ¬åœ°æœªä¸Šä¼ çš„æäº¤"></a>åˆå¹¶æœ¬åœ°æœªä¸Šä¼ çš„æäº¤</h2><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/9.png"/><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/10.png"/><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/11.png"/><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/12.png"/><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/13.png"/><p>æ³¨æ„ç‚¹:</p><ul><li>åªèƒ½åˆå¹¶åˆ°æœªä¸Šä¼ çš„commit</li><li>å¦‚æœå¤šä¸ªæäº¤åˆå¹¶åˆ°ä¸€ä¸ªæäº¤ä¹Ÿæ˜¯åŒç†çš„ï¼ŒæŠŠè¦åˆå¹¶çš„commitæŒ‰é¡ºåºç§»åŠ¨åˆ°å¾…åˆå¹¶çš„commitåé¢ï¼Œè¦åˆå¹¶çš„commitå‰é¢çš„pickéƒ½ä¿®æ”¹æˆf,ç„¶åä¿å­˜é€€å‡º</li><li>Rebaseè¿‡ç¨‹å¯èƒ½å‡ºç°å†²çªï¼Œæ­¤æ—¶éœ€è¦ä¿®æ”¹å†²çªç„¶åæ‰§è¡Œâ€git add . â€œ å’Œâ€git rebase â€“continueâ€</li></ul><h2 id="å·²ç»commitæœªpushçš„æäº¤ï¼Œä¸å°å¿ƒresetæ‰äº†ï¼Œæ€ä¹ˆæ‰¾å›æ¥"><a href="#å·²ç»commitæœªpushçš„æäº¤ï¼Œä¸å°å¿ƒresetæ‰äº†ï¼Œæ€ä¹ˆæ‰¾å›æ¥" class="headerlink" title="å·²ç»commitæœªpushçš„æäº¤ï¼Œä¸å°å¿ƒresetæ‰äº†ï¼Œæ€ä¹ˆæ‰¾å›æ¥"></a>å·²ç»commitæœªpushçš„æäº¤ï¼Œä¸å°å¿ƒresetæ‰äº†ï¼Œæ€ä¹ˆæ‰¾å›æ¥</h2><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/14.png"/><p>æ“ä½œæ­¥éª¤åŠæ³¨æ„äº‹é¡¹:</p><ul><li>æ ¹æ®åé¢çš„commit_msgæ‰¾åˆ°å¯¹åº”çš„commit</li><li>æ‰§è¡Œå‘½ä»¤git cherry-pick commit_id</li><li>å„ç§rebaseæ“ä½œé”™è¯¯çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨git reflogï¼Œæ‰¾åˆ°rebaseä¹‹å‰çš„commit,ç„¶åæ‰§è¡Œgit reset â€“hard commit_id (è¿™ä¸ªä¼šä¸¢å¼ƒæœ¬åœ°æœªcommitçš„ä¿®æ”¹å†…å®¹)</li></ul><h2 id="æŠŠè‡ªå·±çš„ä¿®æ”¹å†…å®¹åˆå¹¶åˆ°åˆ«äººçš„commité‡Œé¢å»äº†"><a href="#æŠŠè‡ªå·±çš„ä¿®æ”¹å†…å®¹åˆå¹¶åˆ°åˆ«äººçš„commité‡Œé¢å»äº†" class="headerlink" title="æŠŠè‡ªå·±çš„ä¿®æ”¹å†…å®¹åˆå¹¶åˆ°åˆ«äººçš„commité‡Œé¢å»äº†"></a>æŠŠè‡ªå·±çš„ä¿®æ”¹å†…å®¹åˆå¹¶åˆ°åˆ«äººçš„commité‡Œé¢å»äº†</h2><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/15.png"/><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/16.png"/><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/17.png"/><p>æ“ä½œæ­¥éª¤åŠæ³¨æ„äº‹é¡¹</p><ul><li>æ ¹æ®åé¢çš„commit_msgæ‰¾åˆ°å¯¹åº”çš„comit</li><li>git reset â€“soft commit_id</li></ul><h2 id="ä»gerritè·å–åˆ«äººæäº¤çš„commit"><a href="#ä»gerritè·å–åˆ«äººæäº¤çš„commit" class="headerlink" title="ä»gerritè·å–åˆ«äººæäº¤çš„commit"></a>ä»gerritè·å–åˆ«äººæäº¤çš„commit</h2><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/18.png"/><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/gitAdvance/19.png"/><p>æ“ä½œæ­¥éª¤åŠæ³¨æ„äº‹é¡¹</p><ul><li>ä»gerritæŸ¥çœ‹åˆ°è¦ä¸‹è½½çš„commitçš„commit_id</li><li>æ‰§è¡Œå‘½ä»¤git ls-remote | grep 66e1d6ec3597ï¼Œè·å–è¦ä¸‹è½½commitåœ¨gerritçš„è·¯å¾„</li><li>æ‰§è¡Œå‘½ä»¤ git pull â€“rebase origin refs&#x2F;changes&#x2F;06&#x2F;3306&#x2F;1, å°†è¦ä¸‹è½½çš„commit rebaseåˆ°æœ¬åœ°</li><li>è¦ä¸‹è½½çš„commit æ‰€ä¾èµ–çš„å…¶å®ƒcommitéƒ½ä¼šåŒæ—¶ä¸‹è½½ä¸‹æ¥ï¼Œèµ°è¯»æ—¶å¯åªä¸‹è½½æœ€åçš„commit</li></ul><h2 id="å¸¸è§é”™è¯¯"><a href="#å¸¸è§é”™è¯¯" class="headerlink" title="å¸¸è§é”™è¯¯"></a>å¸¸è§é”™è¯¯</h2><ul><li>git pull â€“rebaseï¼Œå‡ºç°å†²çªæ—¶ï¼Œè§£å†³åä¸çŸ¥é“æ‰§è¡Œgit rebase â€“continue</li><li>git cherry-pick commit_id å‡ºç°å†²çªæ—¶,è§£å†³åä¸çŸ¥é“æ‰§è¡Œgit cherry-pick â€“continue</li><li>å‡ºç°å†²çªæ—¶ï¼Œç›´æ¥åˆ‡åˆ°å…¶å®ƒåˆ†æ”¯</li></ul>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
          <category> GIT </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Androidæ·±å…¥æµ…å‡º Retrofit</title>
      <link href="/2016/09/29/blogs/Retrofit/"/>
      <url>/2016/09/29/blogs/Retrofit/</url>
      <content type="html"><![CDATA[<h3 id="æœ¬æ–‡è½¬è‡ªå¾®ä¿¡-Bugly"><a href="#æœ¬æ–‡è½¬è‡ªå¾®ä¿¡-Bugly" class="headerlink" title="æœ¬æ–‡è½¬è‡ªå¾®ä¿¡: Bugly"></a>æœ¬æ–‡è½¬è‡ªå¾®ä¿¡: <a href="http://mp.weixin.qq.com/s/5EmNqqX7rt1KT62KXNCq3A">Bugly</a></h3><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/Retrofit/1.jpg"/><p>Android å¼€å‘ä¸­ï¼Œä»åŸç”Ÿçš„ HttpUrlConnection åˆ°ç»å…¸çš„ Apache çš„ HttpClientï¼Œå†åˆ°å¯¹å‰é¢è¿™äº›ç½‘ç»œåŸºç¡€æ¡†æ¶çš„å°è£…ï¼Œæ¯”å¦‚ Volleyã€Async Http Clientï¼ŒHttp ç›¸å…³å¼€æºæ¡†æ¶çš„é€‰æ‹©è¿˜æ˜¯å¾ˆå¤šçš„ï¼Œå…¶ä¸­ç”±è‘—åçš„ Square å…¬å¸å¼€æºçš„ Retrofit æ›´æ˜¯ä»¥å…¶ç®€æ˜“çš„æ¥å£é…ç½®ã€å¼ºå¤§çš„æ‰©å±•æ”¯æŒã€ä¼˜é›…çš„ä»£ç ç»“æ„å—åˆ°å¤§å®¶çš„è¿½æ§ã€‚ä¹Ÿæ­£æ˜¯ç”±äº Square å®¶çš„æ¡†æ¶ä¸€å¦‚æ—¢å¾€çš„ç®€æ´ä¼˜é›…ï¼Œæ‰€ä»¥æˆ‘ä¸€ç›´åœ¨æƒ³ï¼ŒSquare å…¬å¸æ˜¯ä¸æ˜¯åªæ‹›å¤„å¥³åº§çš„ç¨‹åºå‘˜ï¼Ÿ</p><h2 id="åˆè¯†-Retrofit"><a href="#åˆè¯†-Retrofit" class="headerlink" title="åˆè¯† Retrofit"></a>åˆè¯† Retrofit</h2><p>å•ä» Retrofit è¿™ä¸ªå•è¯ï¼Œä½ ä¼¼ä¹çœ‹ä¸å‡ºå®ƒç©¶ç«Ÿæ˜¯å¹²å˜›çš„ï¼Œå½“ç„¶ï¼Œæˆ‘ä¹Ÿçœ‹ä¸å‡ºæ¥ :)é€ƒã€‚ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Retrofitting refers to the addition of new technology or features to older systems.</span><br><span class="line">â€”From Wikipedia</span><br></pre></td></tr></table></figure><p>äºæ˜¯æˆ‘ä»¬å°±æ˜ç™½äº†ï¼Œå† ä»¥ Retrofit è¿™ä¸ªåå­—çš„è¿™ä¸ªå®¶ä¼™ï¼Œåº”è¯¥æ˜¯æŸæŸæŸçš„ ã€Plusã€ ç‰ˆæœ¬äº†ã€‚</p><h3 id="Retrofit-æ¦‚è§ˆ"><a href="#Retrofit-æ¦‚è§ˆ" class="headerlink" title="Retrofit æ¦‚è§ˆ"></a>Retrofit æ¦‚è§ˆ</h3><p>Retrofit æ˜¯ä¸€ä¸ª RESTful çš„ HTTP ç½‘ç»œè¯·æ±‚æ¡†æ¶çš„å°è£…ã€‚æ³¨æ„è¿™é‡Œå¹¶æ²¡æœ‰è¯´å®ƒæ˜¯ç½‘ç»œè¯·æ±‚æ¡†æ¶ï¼Œä¸»è¦åŸå› åœ¨äºç½‘ç»œè¯·æ±‚çš„å·¥ä½œå¹¶ä¸æ˜¯ Retrofit æ¥å®Œæˆçš„ã€‚Retrofit 2.0 å¼€å§‹å†…ç½® OkHttpï¼Œå‰è€…ä¸“æ³¨äºæ¥å£çš„å°è£…ï¼Œåè€…ä¸“æ³¨äºç½‘ç»œè¯·æ±‚çš„é«˜æ•ˆï¼ŒäºŒè€…åˆ†å·¥åä½œï¼Œå®›å¦‚å¤äººçš„ã€ä½ è€•åœ°æ¥æˆ‘ç»‡å¸ƒã€ï¼Œå°æ—¥å­åˆ«æå¤šå¹¸ç¦äº†ã€‚<br><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/Retrofit/2.jpg"/><br>æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºé€šè¿‡ Retrofit è¯·æ±‚ç½‘ç»œï¼Œå®é™…ä¸Šæ˜¯ä½¿ç”¨ Retrofit æ¥å£å±‚å°è£…è¯·æ±‚å‚æ•°ã€Headerã€Url ç­‰ä¿¡æ¯ï¼Œä¹‹åç”± OkHttp å®Œæˆåç»­çš„è¯·æ±‚æ“ä½œï¼Œåœ¨æœåŠ¡ç«¯è¿”å›æ•°æ®ä¹‹åï¼ŒOkHttp å°†åŸå§‹çš„ç»“æœäº¤ç»™ Retrofitï¼Œåè€…æ ¹æ®ç”¨æˆ·çš„éœ€æ±‚å¯¹ç»“æœè¿›è¡Œè§£æçš„è¿‡ç¨‹ã€‚<br>è®²åˆ°è¿™é‡Œï¼Œä½ å°±ä¼šå‘ç°æ‰€è°“ Retrofitï¼Œå…¶å®å°±æ˜¯ Retrofitting OkHttp äº†ã€‚</p><h3 id="Hello-Retrofit"><a href="#Hello-Retrofit" class="headerlink" title="Hello Retrofit"></a>Hello Retrofit</h3><p>å¤šè¯´æ— ç›Šï¼Œä¸è¦æ¥æ®µä»£ç é™¶é†‰ä¸€ä¸‹ã€‚ä½¿ç”¨ Retrofit éå¸¸ç®€å•ï¼Œé¦–å…ˆä½ éœ€è¦åœ¨ä½ çš„ build.gradle ä¸­æ·»åŠ ä¾èµ–ï¼š</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">&#x27;com.squareup.retrofit2:retrofit:2.0.2&#x27;</span></span><br></pre></td></tr></table></figure><p>ä½ ä¸€å®šæ˜¯æƒ³è¦è®¿é—® GitHub çš„ api å¯¹å§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å®šä¹‰ä¸€ä¸ªæ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GitHubService</span> &#123;</span><br><span class="line">  <span class="meta">@GET(&quot;users/&#123;user&#125;/repos&quot;)</span></span><br><span class="line">  Call&lt;List&lt;Repo&gt;&gt; <span class="title function_">listRepos</span><span class="params">(<span class="meta">@Path(&quot;user&quot;)</span> String user)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥å£å½“ä¸­çš„ listRepos æ–¹æ³•ï¼Œå°±æ˜¯æˆ‘ä»¬æƒ³è¦è®¿é—®çš„ api äº†ï¼š<br><code>https://api.github.com/users/&#123;user&#125;/repos</code><br>å…¶ä¸­ï¼Œåœ¨å‘èµ·è¯·æ±‚æ—¶ï¼Œ {user} ä¼šè¢«æ›¿æ¢ä¸ºæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•° userã€‚<br>å¥½ï¼Œç°åœ¨æ¥å£æœ‰äº†ï¼Œæˆ‘ä»¬è¦æ„é€  Retrofit äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Retrofit</span> <span class="variable">retrofit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Retrofit</span>.Builder()</span><br><span class="line">    .baseUrl(<span class="string">&quot;https://api.github.com/&quot;</span>)</span><br><span class="line">    .build();</span><br><span class="line"> </span><br><span class="line"><span class="type">GitHubService</span> <span class="variable">service</span> <span class="operator">=</span> retrofit.create(GitHubService.class);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ service å°±å¥½æ¯”æˆ‘ä»¬çš„å¿«é€’å“¥ï¼Œè¿˜æ˜¯å¾€è¿”çš„é‚£ç§å“ˆ~</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Call&lt;List&lt;Repo&gt;&gt; repos = service.listRepos(<span class="string">&quot;octocat&quot;</span>);</span><br></pre></td></tr></table></figure><p>å‘è¯·æ±‚çš„ä»£ç å°±åƒå‰é¢è¿™ä¸€å¥ï¼Œè¿”å›çš„ repos å…¶å®å¹¶ä¸æ˜¯çœŸæ­£çš„æ•°æ®ç»“æœï¼Œå®ƒæ›´åƒä¸€æ¡æŒ‡ä»¤ï¼Œä½ å¯ä»¥åœ¨åˆé€‚çš„æ—¶æœºå»æ‰§è¡Œå®ƒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒæ­¥è°ƒç”¨</span></span><br><span class="line">List&lt;Repo&gt; data = repos.execute(); </span><br><span class="line"> </span><br><span class="line"><span class="comment">// å¼‚æ­¥è°ƒç”¨</span></span><br><span class="line">repos.enqueue(<span class="keyword">new</span> <span class="title class_">Callback</span>&lt;List&lt;Repo&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(Call&lt;List&lt;Repo&gt;&gt; call, Response&lt;List&lt;Repo&gt;&gt; response)</span> &#123;</span><br><span class="line">                List&lt;Repo&gt; data = response.body();</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Call&lt;List&lt;Repo&gt;&gt; call, Throwable t)</span> &#123;</span><br><span class="line">                t.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><p>å•¥æ„Ÿè§‰ï¼Ÿæœ‰æ²¡æœ‰çªç„¶è§‰å¾—è¯·æ±‚æ¥å£å°±å¥½åƒè®¿é—®è‡ªå®¶çš„æ–¹æ³•ä¸€æ ·ç®€å•ï¼Ÿå‘ï¼Œå‰é¢æˆ‘ä»¬çœ‹åˆ°çš„ï¼Œå°±æ˜¯ Retrofit å®˜æ–¹çš„ demo äº†ã€‚ä½ ä»¥ä¸ºè¿™å°±å¤Ÿäº†ï¼Ÿå™—~æ€ä¹ˆå¯èƒ½ã€‚ã€‚</p><h3 id="Url-é…ç½®"><a href="#Url-é…ç½®" class="headerlink" title="Url é…ç½®"></a>Url é…ç½®</h3><p>Retrofit æ”¯æŒçš„åè®®åŒ…æ‹¬ GET&#x2F;POST&#x2F;PUT&#x2F;DELETE&#x2F;HEAD&#x2F;PATCHï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ HTTP æ¥è‡ªå®šä¹‰è¯·æ±‚ã€‚è¿™äº›åè®®å‡ä»¥æ³¨è§£çš„å½¢å¼è¿›è¡Œé…ç½®ï¼Œæ¯”å¦‚æˆ‘ä»¬å·²ç»è§è¿‡ GET çš„ç”¨æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GET(&quot;users/&#123;user&#125;/repos&quot;)</span></span><br><span class="line">Call&lt;List&lt;Repo&gt;&gt; <span class="title function_">listRepos</span><span class="params">(<span class="meta">@Path(&quot;user&quot;)</span> String user)</span>;</span><br></pre></td></tr></table></figure><p>è¿™äº›æ³¨è§£éƒ½æœ‰ä¸€ä¸ªå‚æ•° valueï¼Œç”¨æ¥é…ç½®å…¶è·¯å¾„ï¼Œæ¯”å¦‚ç¤ºä¾‹ä¸­çš„ users&#x2F;{user}&#x2F;reposï¼Œæˆ‘ä»¬è¿˜æ³¨æ„åˆ°åœ¨æ„é€  Retrofit ä¹‹æ—¶æˆ‘ä»¬è¿˜ä¼ å…¥äº†ä¸€ä¸ª baseUrl(â€œ<a href="https://api.github.com/%22)%EF%BC%8C%E8%AF%B7%E6%B1%82%E7%9A%84%E5%AE%8C%E6%95%B4">https://api.github.com/&quot;)ï¼Œè¯·æ±‚çš„å®Œæ•´</a> Url å°±æ˜¯é€šè¿‡ baseUrl ä¸æ³¨è§£çš„ valueï¼ˆä¸‹é¢ç§° â€œpathâ€œ ï¼‰ æ•´åˆèµ·æ¥çš„ï¼Œå…·ä½“æ•´åˆçš„è§„åˆ™å¦‚ä¸‹ï¼š</p><ul><li>path æ˜¯ç»å¯¹è·¯å¾„çš„å½¢å¼ï¼š<br>   path &#x3D; â€œ&#x2F;apathâ€ï¼ŒbaseUrl &#x3D; â€œ<a href="http://host:port/a/b">http://host:port/a/b</a>â€œ<br>  Url &#x3D; â€œ<a href="http://host:port/apath">http://host:port/apath</a>â€œ</li><li>path æ˜¯ç›¸å¯¹è·¯å¾„ï¼ŒbaseUrl æ˜¯ç›®å½•å½¢å¼ï¼š<br>  path &#x3D; â€œapathâ€ï¼ŒbaseUrl &#x3D; â€œ<a href="http://host:port/a/b/">http://host:port/a/b/</a>â€œ<br>   Url &#x3D; â€œ<a href="http://host:port/a/b/apath">http://host:port/a/b/apath</a>â€œ</li><li>path æ˜¯ç›¸å¯¹è·¯å¾„ï¼ŒbaseUrl æ˜¯æ–‡ä»¶å½¢å¼ï¼š<br>   path &#x3D; â€œapathâ€ï¼ŒbaseUrl &#x3D; â€œ<a href="http://host:port/a/b">http://host:port/a/b</a>â€œ<br>   Url &#x3D; â€œ<a href="http://host:port/a/apath">http://host:port/a/apath</a>â€œ</li><li>path æ˜¯å®Œæ•´çš„ Urlï¼š<br>   path &#x3D; â€œ<a href="http://host:port/aa/apath"ï¼ŒbaseUrl">http://host:port/aa/apath&quot;ï¼ŒbaseUrl</a> &#x3D; â€œ<a href="http://host:port/a/b">http://host:port/a/b</a>â€œ<br>   Url &#x3D; â€œ<a href="http://host:port/aa/apath">http://host:port/aa/apath</a>â€œ</li></ul><p>å»ºè®®é‡‡ç”¨ç¬¬äºŒç§æ–¹å¼æ¥é…ç½®ï¼Œå¹¶å°½é‡ä½¿ç”¨åŒä¸€ç§è·¯å¾„å½¢å¼ã€‚å¦‚æœä½ åœ¨ä»£ç é‡Œé¢æ··åˆé‡‡ç”¨äº†å¤šç§é…ç½®å½¢å¼ï¼Œæ°å¥½èµ¶ä¸Šä½ å“ªå¤©å¤´æ™•çœ¼èŠ±ï¼Œä¿¡ä¸ä¿¡åˆ†åˆ†é’Ÿå†™ä¸€å † bug å•Šå“ˆå“ˆã€‚</p><h3 id="å‚æ•°ç±»å‹"><a href="#å‚æ•°ç±»å‹" class="headerlink" title="å‚æ•°ç±»å‹"></a>å‚æ•°ç±»å‹</h3><p>å‘è¯·æ±‚æ—¶ï¼Œéœ€è¦ä¼ å…¥å‚æ•°ï¼ŒRetrofit é€šè¿‡æ³¨è§£çš„å½¢å¼ä»¤ Http è¯·æ±‚çš„å‚æ•°å˜å¾—æ›´åŠ ç›´æ¥ï¼Œè€Œä¸”ç±»å‹å®‰å…¨ã€‚</p><h4 id="Query-QueryMap"><a href="#Query-QueryMap" class="headerlink" title="Query &amp; QueryMap"></a>Query &amp; QueryMap</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GET(&quot;/list&quot;)</span></span><br><span class="line">Call&lt;ResponseBody&gt; <span class="title function_">list</span><span class="params">(<span class="meta">@Query(&quot;page&quot;)</span> <span class="type">int</span> page)</span>;</span><br></pre></td></tr></table></figure><p>Query å…¶å®å°±æ˜¯ Url ä¸­ â€˜?â€™ åé¢çš„ key-valueï¼Œæ¯”å¦‚ï¼š<br><code>http://www.println.net/?cate=android</code><br>è¿™é‡Œçš„ cate&#x3D;android å°±æ˜¯ä¸€ä¸ª Queryï¼Œè€Œæˆ‘ä»¬åœ¨é…ç½®å®ƒçš„æ—¶å€™åªéœ€è¦åœ¨æ¥å£æ–¹æ³•ä¸­å¢åŠ ä¸€ä¸ªå‚æ•°ï¼Œå³å¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">PrintlnServer</span>&#123;</span><br><span class="line">    <span class="meta">@GET(&quot;/&quot;)</span></span><br><span class="line">    Call&lt;String&gt; <span class="title function_">cate</span><span class="params">(<span class="meta">@Query(&quot;cate&quot;)</span> String cate)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™ä½ è‚¯å®šæƒ³ï¼Œå¦‚æœæˆ‘æœ‰å¾ˆå¤šä¸ª Queryï¼Œè¿™ä¹ˆä¸€ä¸ªä¸ªå†™å²‚ä¸æ˜¯å¾ˆç´¯ï¼Ÿè€Œä¸”æ ¹æ®ä¸åŒçš„æƒ…å†µï¼Œæœ‰äº›å­—æ®µå¯èƒ½ä¸ä¼ ï¼Œè¿™ä¸æ–¹æ³•çš„å‚æ•°è¦æ±‚æ˜¾ç„¶ä¹Ÿä¸ç›¸ç¬¦ã€‚äºæ˜¯ï¼Œæ‰“ç¾¤æ¶ç‰ˆæœ¬çš„ QueryMap æ¨ªç©ºå‡ºä¸–äº†ï¼Œä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼Œæˆ‘å°±ä¸å¤šè¯´äº†ã€‚</p><h4 id="Field-FieldMap"><a href="#Field-FieldMap" class="headerlink" title="Field &amp; FieldMap"></a>Field &amp; FieldMap</h4><p>å…¶å®æˆ‘ä»¬ç”¨ POST çš„åœºæ™¯ç›¸å¯¹è¾ƒå¤šï¼Œç»å¤§å¤šæ•°çš„æœåŠ¡ç«¯æ¥å£éƒ½éœ€è¦åšåŠ å¯†ã€é‰´æƒå’Œæ ¡éªŒï¼ŒGET æ˜¾ç„¶ä¸èƒ½å¾ˆå¥½çš„æ»¡è¶³è¿™ä¸ªéœ€æ±‚ã€‚ä½¿ç”¨ POST æäº¤è¡¨å•çš„åœºæ™¯å°±æ›´æ˜¯åˆšéœ€äº†ï¼Œæ€ä¹ˆæå‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FormUrlEncoded</span></span><br><span class="line"><span class="meta">@POST(&quot;/&quot;)</span></span><br><span class="line">Call&lt;ResponseBody&gt; <span class="title function_">example</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@Field(&quot;name&quot;)</span> String name,</span></span><br><span class="line"><span class="params">    <span class="meta">@Field(&quot;occupation&quot;)</span> String occupation)</span>;</span><br></pre></td></tr></table></figure><p>å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰ä¸Šé¢çš„æ¥å£å°±å¯ä»¥äº†ï¼Œæˆ‘ä»¬ç”¨ Field å£°æ˜äº†è¡¨å•çš„é¡¹ï¼Œè¿™æ ·æäº¤è¡¨å•å°±è·Ÿæ™®é€šçš„å‡½æ•°è°ƒç”¨ä¸€æ ·ç®€å•ç›´æ¥äº†ã€‚<br>ç­‰ç­‰ï¼Œä½ è¯´ä½ çš„è¡¨å•é¡¹ä¸ç¡®å®šä¸ªæ•°ï¼Ÿè¿˜æ˜¯è¯´æœ‰å¾ˆå¤šé¡¹ä½ æ‡’å¾—å†™ï¼ŸField åŒæ ·æœ‰ä¸ªæ‰“ç¾¤æ¶çš„ç‰ˆæœ¬â€”â€”FieldMapï¼Œèµ¶ç´§è¯•è¯•å§~~</p><h4 id="Part-PartMap"><a href="#Part-PartMap" class="headerlink" title="Part &amp; PartMap"></a>Part &amp; PartMap</h4><p>è¿™ä¸ªæ˜¯ç”¨æ¥ä¸Šä¼ æ–‡ä»¶çš„ã€‚è¯è¯´å½“å¹´ç”¨ HttpClient ä¸Šä¼ ä¸ªæ–‡ä»¶è€è´¹åŠ²äº†ï¼Œä¸€ä¼šå„¿ç¼–ç ä¸å¯¹ï¼Œä¸€ä¼šå„¿å‚æ•°é”™è¯¯ï¼ˆä¹Ÿæ€ªé‚£æ—¶æ®µä½å¤ªä½å§TTï¼‰ã€‚ã€‚ã€‚å¯æ˜¯ç°åœ¨ä¸åŒäº†ï¼Œè‡ªä»æœ‰äº† Retrofitï¼Œå¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒæ–‡ä»¶ä¸Šä¼ è´¹åŠ²äº†~~~</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FileUploadService</span> &#123;  </span><br><span class="line">    <span class="meta">@Multipart</span></span><br><span class="line">    <span class="meta">@POST(&quot;upload&quot;)</span></span><br><span class="line">    Call&lt;ResponseBody&gt; <span class="title function_">upload</span><span class="params">(<span class="meta">@Part(&quot;description&quot;)</span> RequestBody description,</span></span><br><span class="line"><span class="params">                              <span class="meta">@Part</span> MultipartBody.Part file)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ éœ€è¦ä¸Šä¼ æ–‡ä»¶ï¼Œå’Œæˆ‘ä»¬å‰é¢çš„åšæ³•ç±»ä¼¼ï¼Œå®šä¹‰ä¸€ä¸ªæ¥å£æ–¹æ³•ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•ä¸å†æœ‰ @FormUrlEncoded è¿™ä¸ªæ³¨è§£ï¼Œè€Œæ¢æˆäº† @Multipartï¼Œåé¢åªéœ€è¦åœ¨å‚æ•°ä¸­å¢åŠ  Part å°±å¯ä»¥äº†ã€‚ä¹Ÿè®¸ä½ ä¼šé—®ï¼Œè¿™é‡Œçš„ Part å’Œ Field ç©¶ç«Ÿæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå…¶å®ä»åŠŸèƒ½ä¸Šè®²ï¼Œæ— éå°±æ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚æºå¸¦å‚æ•°çš„æ–¹å¼ä¸åŒï¼Œå¹¶ä¸”å‰è€…å¯ä»¥æºå¸¦çš„å‚æ•°ç±»å‹æ›´åŠ ä¸°å¯Œï¼ŒåŒ…æ‹¬æ•°æ®æµã€‚ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥ä¸Šä¼ æ–‡ä»¶ï¼Œä¸‹é¢æˆ‘ä»¬å°±ç»™å‡ºè¿™ä¸ªæ¥å£çš„ä½¿ç”¨æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…ˆåˆ›å»º service</span></span><br><span class="line"><span class="type">FileUploadService</span> <span class="variable">service</span> <span class="operator">=</span> retrofit.create(FileUploadService.class);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//æ„å»ºè¦ä¸Šä¼ çš„æ–‡ä»¶</span></span><br><span class="line"><span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filename);</span><br><span class="line"><span class="type">RequestBody</span> <span class="variable">requestFile</span> <span class="operator">=</span></span><br><span class="line">        RequestBody.create(MediaType.parse(<span class="string">&quot;application/otcet-stream&quot;</span>), file);</span><br><span class="line"> </span><br><span class="line">MultipartBody.<span class="type">Part</span> <span class="variable">body</span> <span class="operator">=</span></span><br><span class="line">        MultipartBody.Part.createFormData(<span class="string">&quot;aFile&quot;</span>, file.getName(), requestFile);</span><br><span class="line"> </span><br><span class="line"><span class="type">String</span> <span class="variable">descriptionString</span> <span class="operator">=</span> <span class="string">&quot;This is a description&quot;</span>;</span><br><span class="line"><span class="type">RequestBody</span> <span class="variable">description</span> <span class="operator">=</span></span><br><span class="line">        RequestBody.create(</span><br><span class="line">                MediaType.parse(<span class="string">&quot;multipart/form-data&quot;</span>), descriptionString);</span><br><span class="line"> </span><br><span class="line">Call&lt;ResponseBody&gt; call = service.upload(description, body);</span><br><span class="line">call.enqueue(<span class="keyword">new</span> <span class="title class_">Callback</span>&lt;ResponseBody&gt;() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(Call&lt;ResponseBody&gt; call,</span></span><br><span class="line"><span class="params">                         Response&lt;ResponseBody&gt; response)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Call&lt;ResponseBody&gt; call, Throwable t)</span> &#123;</span><br><span class="line">    t.printStackTrace();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>åœ¨å®éªŒæ—¶ï¼Œæˆ‘ä¸Šä¼ äº†ä¸€ä¸ªåªåŒ…å«ä¸€è¡Œæ–‡å­—çš„æ–‡ä»¶ï¼š<br>Visit me: <a href="http://www.println.net/">http://www.println.net</a><br>é‚£ä¹ˆæˆ‘ä»¬å»æœåŠ¡ç«¯çœ‹ä¸‹æˆ‘ä»¬çš„è¯·æ±‚æ˜¯ä»€ä¹ˆæ ·çš„ï¼š<br>HEADERS</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Accept-Encoding: gzip</span><br><span class="line">Content-Length: 470</span><br><span class="line">Content-Type: multipart/form-data; boundary=9b670d44-63dc-4a8a-833d-66e45e0156ca</span><br><span class="line">User-Agent: okhttp/3.2.0</span><br><span class="line">X-Request-Id: 9d70e8cc-958b-4f42-b979-4c1fcd474352</span><br><span class="line">Via: 1.1 vegur</span><br><span class="line">Host: requestb.in</span><br><span class="line">Total-Route-Time: 0</span><br><span class="line">Connection: close</span><br><span class="line">Connect-Time: 0</span><br></pre></td></tr></table></figure><p>FORM&#x2F;POST PARAMETERS</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">description: This is a description</span><br></pre></td></tr></table></figure><p>RAW BODY</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">--9b670d44-63dc-4a8a-833d-66e45e0156ca</span><br><span class="line">Content-Disposition: form-data; name=&quot;description&quot;</span><br><span class="line">Content-Transfer-Encoding: binary</span><br><span class="line">Content-Type: multipart/form-data; charset=utf-8</span><br><span class="line">Content-Length: 21</span><br><span class="line"></span><br><span class="line">This is a description</span><br><span class="line">--9b670d44-63dc-4a8a-833d-66e45e0156ca</span><br><span class="line">Content-Disposition: form-data; name=&quot;aFile&quot;; filename=&quot;uploadedfile.txt&quot;</span><br><span class="line">Content-Type: application/otcet-stream</span><br><span class="line">Content-Length: 32</span><br><span class="line"></span><br><span class="line">Visit me: http://www.println.net</span><br><span class="line">--9b670d44-63dc-4a8a-833d-66e45e0156ca--</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¸Šä¼ çš„æ–‡ä»¶çš„å†…å®¹å‡ºç°åœ¨è¯·æ±‚å½“ä¸­äº†ã€‚å¦‚æœä½ éœ€è¦ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ï¼Œå°±å£°æ˜å¤šä¸ª Part å‚æ•°ï¼Œæˆ–è€…è¯•è¯• PartMapã€‚</p><h3 id="Converterï¼Œè®©ä½ çš„å…¥å‚å’Œè¿”å›ç±»å‹ä¸°å¯Œèµ·æ¥"><a href="#Converterï¼Œè®©ä½ çš„å…¥å‚å’Œè¿”å›ç±»å‹ä¸°å¯Œèµ·æ¥" class="headerlink" title="Converterï¼Œè®©ä½ çš„å…¥å‚å’Œè¿”å›ç±»å‹ä¸°å¯Œèµ·æ¥"></a>Converterï¼Œè®©ä½ çš„å…¥å‚å’Œè¿”å›ç±»å‹ä¸°å¯Œèµ·æ¥</h3><h4 id="RequestBodyConverter"><a href="#RequestBodyConverter" class="headerlink" title="RequestBodyConverter"></a>RequestBodyConverter</h4><p>å‰é¢æˆ‘ä¸ºå¤§å®¶å±•ç¤ºäº†å¦‚ä½•ç”¨ Retrofit ä¸Šä¼ æ–‡ä»¶ï¼Œè¿™ä¸ªä¸Šä¼ çš„è¿‡ç¨‹å…¶å®ã€‚ã€‚è¿˜æ˜¯æœ‰é‚£ä¹ˆç‚¹å„¿ä¸å¤Ÿç®€ç»ƒï¼Œæˆ‘ä»¬åªæ˜¯è¦æä¾›ä¸€ä¸ªæ–‡ä»¶ç”¨äºä¸Šä¼ ï¼Œå¯æˆ‘ä»¬å‰åæ„é€ äº†ä¸‰ä¸ªå¯¹è±¡ï¼š<br><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/Retrofit/3.jpg"/><br>å¤©å“ªï¼Œè‚¯å®šæ˜¯å“ªé‡Œå‡ºäº†é—®é¢˜ã€‚å®é™…ä¸Šï¼ŒRetrofit å…è®¸æˆ‘ä»¬è‡ªå·±å®šä¹‰å…¥å‚å’Œè¿”å›çš„ç±»å‹ï¼Œä¸è¿‡ï¼Œå¦‚æœè¿™äº›ç±»å‹æ¯”è¾ƒç‰¹åˆ«ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å‡†å¤‡ç›¸åº”çš„ Converterï¼Œä¹Ÿæ­£æ˜¯å› ä¸º Converter çš„å­˜åœ¨ï¼Œ Retrofit åœ¨å…¥å‚å’Œè¿”å›ç±»å‹ä¸Šè¡¨ç°å¾—éå¸¸çµæ´»ã€‚<br>ä¸‹é¢æˆ‘ä»¬æŠŠåˆšæ‰çš„ Service ä»£ç ç¨ä½œä¿®æ”¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FileUploadService</span> &#123;  </span><br><span class="line">    <span class="meta">@Multipart</span></span><br><span class="line">    <span class="meta">@POST(&quot;upload&quot;)</span></span><br><span class="line">    Call&lt;ResponseBody&gt; <span class="title function_">upload</span><span class="params">(<span class="meta">@Part(&quot;description&quot;)</span> RequestBody description,</span></span><br><span class="line"><span class="params">        //æ³¨æ„è¿™é‡Œçš„å‚æ•° <span class="string">&quot;aFile&quot;</span> ä¹‹å‰æ˜¯åœ¨åˆ›å»º MultipartBody.Part çš„æ—¶å€™ä¼ å…¥çš„</span></span><br><span class="line"><span class="params">        <span class="meta">@Part(&quot;aFile&quot;)</span> File file)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬æŠŠå…¥å‚ç±»å‹æ”¹æˆäº†æˆ‘ä»¬ç†Ÿæ‚‰çš„ Fileï¼Œå¦‚æœä½ å°±è¿™ä¹ˆæ‹¿å»å‘è¯·æ±‚ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°çš„ç»“æœä¼šè®©ä½ å“­äº†çš„ã€‚ã€‚ã€‚</p><p>RAW BODY</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">--7d24e78e-4354-4ed4-9db4-57d799b6efb7</span><br><span class="line">Content-Disposition: form-data; name=&quot;description&quot;</span><br><span class="line">Content-Transfer-Encoding: binary</span><br><span class="line">Content-Type: multipart/form-data; charset=utf-8</span><br><span class="line">Content-Length: 21</span><br><span class="line"></span><br><span class="line">This is a description</span><br><span class="line">--7d24e78e-4354-4ed4-9db4-57d799b6efb7</span><br><span class="line">Content-Disposition: form-data; name=&quot;aFile&quot;</span><br><span class="line">Content-Transfer-Encoding: binary</span><br><span class="line">Content-Type: application/json; charset=UTF-8</span><br><span class="line">Content-Length: 35</span><br><span class="line"></span><br><span class="line">// æ³¨æ„è¿™é‡Œï¼ï¼ä¹‹å‰æ˜¯æ–‡ä»¶çš„å†…å®¹ï¼Œç°åœ¨å˜æˆäº†æ–‡ä»¶çš„è·¯å¾„</span><br><span class="line">&#123;&quot;path&quot;:&quot;samples/uploadedfile.txt&quot;&#125; </span><br><span class="line">--7d24e78e-4354-4ed4-9db4-57d799b6efb7--</span><br></pre></td></tr></table></figure><p>æœåŠ¡ç«¯æ”¶åˆ°äº†ä¸€ä¸ªæ–‡ä»¶çš„è·¯å¾„ï¼Œå®ƒè‚¯å®šä¼šè§‰å¾—<br><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/Retrofit/4.jpg"/><br>å¥½äº†ï¼Œä¸é—¹äº†ï¼Œè¿™æ˜æ˜¾æ˜¯ Retrofit åœ¨å‘ç°è‡ªå·±æ”¶åˆ°çš„å®é™…å…¥å‚æ˜¯ä¸ª File æ—¶ï¼Œä¸çŸ¥é“è¯¥æ€ä¹ˆåŠï¼Œæƒ…æ€¥ä¹‹ä¸‹ç»™ toStringäº†ï¼Œè€Œä¸”è¿˜æ˜¯ä¸ª JsonStringï¼ˆåæ¥æŸ¥è¯åŸæ¥æ˜¯ä½¿ç”¨äº† GsonRequestBodyConverterã€‚ã€‚ï¼‰ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±è‡ªå·±å®ç°ä¸€ä¸ª FileRequestBodyConverterï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FileRequestBodyConverterFactory</span> <span class="keyword">extends</span> <span class="title class_">Converter</span>.Factory &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Converter&lt;File, RequestBody&gt; <span class="title function_">requestBodyConverter</span><span class="params">(Type type, Annotation[] parameterAnnotations, Annotation[] methodAnnotations, Retrofit retrofit)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileRequestBodyConverter</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FileRequestBodyConverter</span> <span class="keyword">implements</span> <span class="title class_">Converter</span>&lt;File, RequestBody&gt; &#123;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> RequestBody <span class="title function_">convert</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">return</span> RequestBody.create(MediaType.parse(<span class="string">&quot;application/otcet-stream&quot;</span>), file);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åˆ›å»º Retrofit çš„æ—¶å€™è®°å¾—é…ç½®ä¸Šå®ƒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addConverterFactory(<span class="keyword">new</span> <span class="title class_">FileRequestBodyConverterFactory</span>())</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæˆ‘ä»¬çš„æ–‡ä»¶å†…å®¹å°±èƒ½ä¸Šä¼ äº†ã€‚æ¥ï¼Œçœ‹ä¸‹ç»“æœå§ï¼š</p><p>RAW BODY</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">--25258f46-48b0-4a6b-a617-15318c168ed4</span><br><span class="line">Content-Disposition: form-data; name=&quot;description&quot;</span><br><span class="line">Content-Transfer-Encoding: binary</span><br><span class="line">Content-Type: multipart/form-data; charset=utf-8</span><br><span class="line">Content-Length: 21</span><br><span class="line"></span><br><span class="line">This is a description</span><br><span class="line">--25258f46-48b0-4a6b-a617-15318c168ed4</span><br><span class="line">//æ³¨æ„çœ‹è¿™é‡Œï¼Œfilename æ²¡äº†</span><br><span class="line">Content-Disposition: form-data; name=&quot;aFile&quot;</span><br><span class="line">//å¤šäº†è¿™ä¸€å¥</span><br><span class="line">Content-Transfer-Encoding: binary</span><br><span class="line">Content-Type: application/otcet-stream</span><br><span class="line">Content-Length: 32</span><br><span class="line"></span><br><span class="line">Visit me: http://www.println.net</span><br><span class="line">--25258f46-48b0-4a6b-a617-15318c168ed4--</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶å†…å®¹æˆåŠŸä¸Šä¼ äº†ï¼Œå½“ç„¶å…¶ä¸­è¿˜å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œè¿™ä¸ªç›®å‰ç›´æ¥ä½¿ç”¨ Retrofit çš„ Converter è¿˜åšä¸åˆ°ï¼ŒåŸå› ä¸»è¦åœ¨äºæˆ‘ä»¬æ²¡æœ‰åŠæ³•é€šè¿‡ Converter ç›´æ¥å°† File è½¬æ¢ä¸º MultiPartBody.Partï¼Œå¦‚æœæƒ³è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ Retrofit çš„æºç ç¨ä½œä¿®æ”¹ï¼Œè¿™ä¸ªæˆ‘ä»¬åé¢å†è°ˆã€‚</p><h4 id="ResponseBodyConverter"><a href="#ResponseBodyConverter" class="headerlink" title="ResponseBodyConverter"></a>ResponseBodyConverter</h4><p>å‰é¢æˆ‘ä»¬ä¸ºå¤§å®¶ç®€å•ç¤ºä¾‹äº†å¦‚ä½•è‡ªå®šä¹‰ RequestBodyConverterï¼Œå¯¹åº”çš„ï¼ŒRetrofit ä¹Ÿæ”¯æŒè‡ªå®šä¹‰ ResponseBodyConverterã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹ä¸‹æˆ‘ä»¬å®šä¹‰çš„æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GitHubService</span> &#123;</span><br><span class="line">  <span class="meta">@GET(&quot;users/&#123;user&#125;/repos&quot;)</span></span><br><span class="line">  Call&lt;List&lt;Repo&gt;&gt; <span class="title function_">listRepos</span><span class="params">(<span class="meta">@Path(&quot;user&quot;)</span> String user)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›å€¼çš„ç±»å‹ä¸º List<Repo>ï¼Œè€Œæˆ‘ä»¬ç›´æ¥æ‹¿åˆ°çš„åŸå§‹è¿”å›è‚¯å®šå°±æ˜¯å­—ç¬¦ä¸²ï¼ˆæˆ–è€…å­—èŠ‚æµï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªè¿”å›å€¼ç±»å‹æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿé¦–å…ˆè¯´æ˜çš„ä¸€ç‚¹æ˜¯ï¼ŒGitHub çš„è¿™ä¸ª api è¿”å›çš„æ˜¯ Json å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ Json ååºåˆ—åŒ–å¾—åˆ° List<Repo>ï¼Œè¿™å…¶ä¸­ç”¨åˆ°çš„å…¶å®æ˜¯ GsonResponseBodyConverterã€‚</p><p>é—®é¢˜æ¥äº†ï¼Œå¦‚æœè¯·æ±‚å¾—åˆ°çš„ Json å­—ç¬¦ä¸²ä¸è¿”å›å€¼ç±»å‹ä¸å¯¹åº”ï¼Œæ¯”å¦‚ï¼š</p><p>æ¥å£è¿”å›çš„ Json å­—ç¬¦ä¸²ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;err&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span> <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span><span class="string">&quot;This is a content.&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="string">&quot;OK&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿”å›å€¼ç±»å‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Result</span>&#123;</span><br><span class="line">    <span class="type">int</span> code;<span class="comment">//ç­‰ä»·äº err</span></span><br><span class="line">    String body;<span class="comment">//ç­‰ä»·äº content</span></span><br><span class="line">    String msg;<span class="comment">//ç­‰ä»·äº message</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å“‡ï¼Œè¿™æ—¶å€™è‚¯å®šæœ‰äººæƒ³è¯´ï¼Œä½ æ˜¯ä¸æ˜¯è„‘æ®‹ï¼Œååè·ŸæœåŠ¡ç«¯å¯¹ç€å¹²ï¼Ÿå“ˆå“ˆï¼Œæˆ‘åªæ˜¯ç¤ºä¾‹å˜›ï¼Œè€Œä¸”åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½ æ•¢ä¿è¯è¿™ç§æƒ…å†µä¸ä¼šå‘ç”Ÿï¼Ÿï¼Ÿ<br>è¿™ç§æƒ…å†µä¸‹ï¼Œ Gson å°±æ˜¯å†ç‰›é€¼ï¼Œä¹Ÿåªèƒ½é»˜é»˜æ— è¯­ä¿©çœ¼æ³ªäº†ï¼Œå®ƒå“ªå„¿çŸ¥é“å­—æ®µçš„æ˜ å°„å…³ç³»æ€ä¹ˆè¿™ä¹ˆä»»æ€§å•Šã€‚å¥½ï¼Œç°åœ¨è®©æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ª Converter æ¥è§£å†³è¿™ä¸ªé—®é¢˜å§ï¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ArbitraryResponseBodyConverterFactory</span> <span class="keyword">extends</span> <span class="title class_">Converter</span>.Factory&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Converter&lt;ResponseBody, ?&gt; responseBodyConverter(Type type, Annotation[] annotations, Retrofit retrofit) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.responseBodyConverter(type, annotations, retrofit);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ArbitraryResponseBodyConverter</span> <span class="keyword">implements</span> <span class="title class_">Converter</span>&lt;ResponseBody, Result&gt;&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Result <span class="title function_">convert</span><span class="params">(ResponseBody value)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">RawResult</span> <span class="variable">rawResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>().fromJson(value.string(), RawResult.class);</span><br><span class="line">    <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Result</span>();</span><br><span class="line">    result.body = rawResult.content;</span><br><span class="line">    result.code = rawResult.err;</span><br><span class="line">    result.msg = rawResult.message;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RawResult</span>&#123;</span><br><span class="line">  <span class="type">int</span> err;</span><br><span class="line">  String content;</span><br><span class="line">  String message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œåˆ«å¿˜äº†åœ¨æ„é€  Retrofit çš„æ—¶å€™æ·»åŠ è¿™ä¸ª Converterï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å¤Ÿæ„‰å¿«çš„è®©æ¥å£è¿”å› Result å¯¹è±¡äº†ã€‚</p><p>æ³¨æ„ï¼ï¼Retrofit åœ¨é€‰æ‹©åˆé€‚çš„ Converter æ—¶ï¼Œä¸»è¦ä¾èµ–äºéœ€è¦è½¬æ¢çš„å¯¹è±¡ç±»å‹ï¼Œåœ¨æ·»åŠ  Converter æ—¶ï¼Œæ³¨æ„ Converter æ”¯æŒçš„ç±»å‹çš„åŒ…å«å…³ç³»ä»¥åŠå…¶é¡ºåºã€‚</p><h2 id="Retrofit-åŸç†å‰–æ"><a href="#Retrofit-åŸç†å‰–æ" class="headerlink" title="Retrofit åŸç†å‰–æ"></a>Retrofit åŸç†å‰–æ</h2><p>å‰ä¸€ä¸ªå°èŠ‚æˆ‘ä»¬æŠŠ Retrofit çš„åŸºæœ¬ç”¨æ³•å’Œæ¦‚å¿µä»‹ç»äº†ä¸€ä¸‹ï¼Œå¦‚æœä½ çš„ç›®æ ‡æ˜¯å­¦ä¼šå¦‚ä½•ä½¿ç”¨å®ƒï¼Œé‚£ä¹ˆä¸‹é¢çš„å†…å®¹ä½ å¯ä»¥ä¸ç”¨çœ‹äº†ã€‚</p><p>ä¸è¿‡å‘¢ï¼Œæˆ‘å°±çŸ¥é“ä½ ä¸æ˜¯é‚£ç§æµ…å°è¾„æ­¢çš„äººï¼è¿™ä¸€èŠ‚æˆ‘ä»¬ä¸»è¦æŠŠæ³¨æ„åŠ›æ”¾åœ¨ Retrofit èƒŒåçš„é­”æ³•ä¸Šé¢~~<br><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/Retrofit/5.jpg"/></p><h3 id="æ˜¯è°å®é™…ä¸Šå®Œæˆäº†æ¥å£è¯·æ±‚çš„å¤„ç†ï¼Ÿ"><a href="#æ˜¯è°å®é™…ä¸Šå®Œæˆäº†æ¥å£è¯·æ±‚çš„å¤„ç†ï¼Ÿ" class="headerlink" title="æ˜¯è°å®é™…ä¸Šå®Œæˆäº†æ¥å£è¯·æ±‚çš„å¤„ç†ï¼Ÿ"></a>æ˜¯è°å®é™…ä¸Šå®Œæˆäº†æ¥å£è¯·æ±‚çš„å¤„ç†ï¼Ÿ</h3><p>å‰é¢è®²äº†è¿™ä¹ˆä¹…ï¼Œæˆ‘ä»¬å§‹ç»ˆåªçœ‹åˆ°äº†æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„æ¥å£ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GitHubService</span> &#123;</span><br><span class="line">  <span class="meta">@GET(&quot;users/&#123;user&#125;/repos&quot;)</span></span><br><span class="line">  Call&lt;List&lt;Repo&gt;&gt; <span class="title function_">listRepos</span><span class="params">(<span class="meta">@Path(&quot;user&quot;)</span> String user)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€ŒçœŸæ­£æˆ‘ä½¿ç”¨çš„æ—¶å€™è‚¯å®šä¸èƒ½æ˜¯æ¥å£å•Šï¼Œè¿™ä¸ªç¥ç§˜çš„å®¶ä¼™ç©¶ç«Ÿæ˜¯è°ï¼Ÿå…¶å®å®ƒæ˜¯ Retrofit åˆ›å»ºçš„ä¸€ä¸ªä»£ç†å¯¹è±¡äº†ï¼Œè¿™é‡Œæ¶‰åŠç‚¹å„¿ Java çš„åŠ¨æ€ä»£ç†çš„çŸ¥è¯†ï¼Œç›´æ¥æ¥çœ‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> &#123;</span><br><span class="line">  Utils.validateServiceInterface(service);</span><br><span class="line">  <span class="keyword">if</span> (validateEagerly) &#123;</span><br><span class="line">    eagerlyValidateMethods(service);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//è¿™é‡Œè¿”å›ä¸€ä¸ª service çš„ä»£ç†å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[] &#123; service &#125;,</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">InvocationHandler</span>() &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Platform</span> <span class="variable">platform</span> <span class="operator">=</span> Platform.get();</span><br><span class="line"> </span><br><span class="line">        <span class="meta">@Override</span> <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object... args)</span></span><br><span class="line">            <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">          <span class="comment">// If the method is a method from Object then defer to normal invocation.</span></span><br><span class="line">          <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>, args);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//DefaultMethod æ˜¯ Java 8 çš„æ¦‚å¿µï¼Œæ˜¯å®šä¹‰åœ¨ interface å½“ä¸­çš„æœ‰å®ç°çš„æ–¹æ³•</span></span><br><span class="line">          <span class="keyword">if</span> (platform.isDefaultMethod(method)) &#123;</span><br><span class="line">            <span class="keyword">return</span> platform.invokeDefaultMethod(method, service, proxy, args);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//æ¯ä¸€ä¸ªæ¥å£æœ€ç»ˆå®ä¾‹åŒ–æˆä¸€ä¸ª ServiceMethodï¼Œå¹¶ä¸”ä¼šç¼“å­˜</span></span><br><span class="line">          <span class="type">ServiceMethod</span> <span class="variable">serviceMethod</span> <span class="operator">=</span> loadServiceMethod(method);</span><br><span class="line">           </span><br><span class="line">          <span class="comment">//ç”±æ­¤å¯è§ Retrofit ä¸ OkHttp å®Œå…¨è€¦åˆï¼Œä¸å¯åˆ†å‰²</span></span><br><span class="line">          <span class="type">OkHttpCall</span> <span class="variable">okHttpCall</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpCall</span>&lt;&gt;(serviceMethod, args);</span><br><span class="line">          <span class="comment">//ä¸‹é¢è¿™ä¸€å¥å½“ä¸­ä¼šå‘èµ·è¯·æ±‚ï¼Œå¹¶è§£ææœåŠ¡ç«¯è¿”å›çš„ç»“æœ</span></span><br><span class="line">          <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•çš„è¯´ï¼Œåœ¨æˆ‘ä»¬è°ƒç”¨ GitHubService.listRepos æ—¶ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯è¿™é‡Œçš„ InvocationHandler.invoke æ–¹æ³•~~</p><h3 id="æ¥ä¸€å‘å®Œæ•´çš„è¯·æ±‚å¤„ç†æµç¨‹"><a href="#æ¥ä¸€å‘å®Œæ•´çš„è¯·æ±‚å¤„ç†æµç¨‹" class="headerlink" title="æ¥ä¸€å‘å®Œæ•´çš„è¯·æ±‚å¤„ç†æµç¨‹"></a>æ¥ä¸€å‘å®Œæ•´çš„è¯·æ±‚å¤„ç†æµç¨‹</h3><p>å‰é¢æˆ‘ä»¬å·²ç»çœ‹åˆ° Retrofit ä¸ºæˆ‘ä»¬æ„é€ äº†ä¸€ä¸ª OkHttpCall ï¼Œå®é™…ä¸Šæ¯ä¸€ä¸ª OkHttpCall éƒ½å¯¹åº”äºä¸€ä¸ªè¯·æ±‚ï¼Œå®ƒä¸»è¦å®Œæˆæœ€åŸºç¡€çš„ç½‘ç»œè¯·æ±‚ï¼Œè€Œæˆ‘ä»¬åœ¨æ¥å£çš„è¿”å›ä¸­çœ‹åˆ°çš„ Call é»˜è®¤æƒ…å†µä¸‹å°±æ˜¯ OkHttpCall äº†ï¼Œå¦‚æœæˆ‘ä»¬æ·»åŠ äº†è‡ªå®šä¹‰çš„ callAdapterï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå°† OkHttp é€‚é…æˆæˆ‘ä»¬éœ€è¦çš„è¿”å›å€¼ï¼Œå¹¶è¿”å›ç»™æˆ‘ä»¬ã€‚</p><p>å…ˆæ¥çœ‹ä¸‹ Call çš„æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Call</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">Cloneable</span> &#123;</span><br><span class="line">  <span class="comment">//åŒæ­¥å‘èµ·è¯·æ±‚</span></span><br><span class="line">  Response&lt;T&gt; <span class="title function_">execute</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">  <span class="comment">//å¼‚æ­¥å‘èµ·è¯·æ±‚ï¼Œç»“æœé€šè¿‡å›è°ƒè¿”å›</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(Callback&lt;T&gt; callback)</span>;</span><br><span class="line">  <span class="type">boolean</span> <span class="title function_">isExecuted</span><span class="params">()</span>;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span>;</span><br><span class="line">  <span class="type">boolean</span> <span class="title function_">isCanceled</span><span class="params">()</span>;</span><br><span class="line">  Call&lt;T&gt; <span class="title function_">clone</span><span class="params">()</span>;</span><br><span class="line">  <span class="comment">//è¿”å›åŸå§‹è¯·æ±‚</span></span><br><span class="line">  Request <span class="title function_">request</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨ä½¿ç”¨æ¥å£æ—¶ï¼Œå¤§å®¶è‚¯å®šè¿˜è®°å¾—è¿™ä¸€å¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Call&lt;List&lt;Repo&gt;&gt; repos = service.listRepos(<span class="string">&quot;octocat&quot;</span>);</span><br><span class="line">List&lt;Repo&gt; data = repos.execute();</span><br></pre></td></tr></table></figure><p>è¿™ä¸ª repos å…¶å®å°±æ˜¯ä¸€ä¸ª OkHttpCall å®ä¾‹ï¼Œexecute å°±æ˜¯è¦å‘èµ·ç½‘ç»œè¯·æ±‚ã€‚<br>OkHttpCall.execute</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> Response&lt;T&gt; <span class="title function_">execute</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="comment">//è¿™ä¸ª call æ˜¯çœŸæ­£çš„ OkHttp çš„ callï¼Œæœ¬è´¨ä¸Š OkHttpCall åªæ˜¯å¯¹å®ƒåšäº†ä¸€å±‚å°è£…</span></span><br><span class="line">  okhttp3.Call call;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">    <span class="comment">//å¤„ç†é‡å¤æ‰§è¡Œçš„é€»è¾‘</span></span><br><span class="line">    <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Already executed.&quot;</span>);</span><br><span class="line">    executed = <span class="literal">true</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (creationFailure != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (creationFailure <span class="keyword">instanceof</span> IOException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (IOException) creationFailure;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> (RuntimeException) creationFailure;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    call = rawCall;</span><br><span class="line">    <span class="keyword">if</span> (call == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        call = rawCall = createRawCall();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException | RuntimeException e) &#123;</span><br><span class="line">        creationFailure = e;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (canceled) &#123;</span><br><span class="line">    call.cancel();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//å‘èµ·è¯·æ±‚ï¼Œå¹¶è§£æç»“æœ</span></span><br><span class="line">  <span class="keyword">return</span> parseResponse(call.execute());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ° OkHttpCall å…¶å®ä¹Ÿæ˜¯å°è£…äº† okhttp3.Callï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ okhttp3.Call å‘èµ·äº†è¿›æ”»ï¼Œé¢ï¼Œå‘èµ·äº†è¯·æ±‚ã€‚æœ‰å…³ OkHttp çš„å†…å®¹ï¼Œæˆ‘åœ¨è¿™é‡Œå°±ä¸å†å±•å¼€äº†ã€‚<br>parseResponse ä¸»è¦å®Œæˆäº†ç”± okhttp3.Response å‘ retrofit.Response çš„è½¬æ¢ï¼ŒåŒæ—¶ä¹Ÿå¤„ç†äº†å¯¹åŸå§‹è¿”å›çš„è§£æï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Response&lt;T&gt; <span class="title function_">parseResponse</span><span class="params">(okhttp3.Response rawResponse)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="type">ResponseBody</span> <span class="variable">rawBody</span> <span class="operator">=</span> rawResponse.body();</span><br><span class="line"> </span><br><span class="line">  <span class="comment">//ç•¥æ‰ä¸€äº›ä»£ç </span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//åœ¨è¿™é‡Œå®Œæˆäº†åŸå§‹ Response çš„è§£æï¼ŒT å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œæ¯”å¦‚ GitHubService.listRepos çš„ List&lt;Repo&gt;</span></span><br><span class="line">    <span class="type">T</span> <span class="variable">body</span> <span class="operator">=</span> serviceMethod.toResponse(catchingBody);</span><br><span class="line">    <span class="keyword">return</span> Response.success(body, rawResponse);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">    <span class="comment">// If the underlying source threw an exception, propagate that rather than indicating it was</span></span><br><span class="line">    <span class="comment">// a runtime exception.</span></span><br><span class="line">    catchingBody.throwIfCaught();</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±æ‹¿åˆ°äº†æˆ‘ä»¬æƒ³è¦çš„æ•°æ®~~</p><h3 id="ç»“æœé€‚é…ï¼Œä½ æ˜¯ä¸æ˜¯æƒ³ç”¨-RxJavaï¼Ÿ"><a href="#ç»“æœé€‚é…ï¼Œä½ æ˜¯ä¸æ˜¯æƒ³ç”¨-RxJavaï¼Ÿ" class="headerlink" title="ç»“æœé€‚é…ï¼Œä½ æ˜¯ä¸æ˜¯æƒ³ç”¨ RxJavaï¼Ÿ"></a>ç»“æœé€‚é…ï¼Œä½ æ˜¯ä¸æ˜¯æƒ³ç”¨ RxJavaï¼Ÿ</h3><p>å‰é¢æˆ‘ä»¬å·²ç»æåˆ°è¿‡ CallAdapter çš„äº‹å„¿ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå¹¶ä¸ä¼šå¯¹ OkHttpCall å®ä¾‹åšä»»ä½•å¤„ç†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">DefaultCallAdapterFactory</span> <span class="keyword">extends</span> <span class="title class_">CallAdapter</span>.Factory &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> CallAdapter.<span class="type">Factory</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultCallAdapterFactory</span>();</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> CallAdapter&lt;?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) &#123;</span><br><span class="line">    ... æ¯«ä¸ç•™æƒ…çš„çœç•¥ä¸€äº›ä»£ç  ...</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CallAdapter</span>&lt;Call&lt;?&gt;&gt;() &#123;</span><br><span class="line">      ... çœç•¥ä¸€äº›ä»£ç  ...</span><br><span class="line"> </span><br><span class="line">      <span class="meta">@Override</span> <span class="keyword">public</span> &lt;R&gt; Call&lt;R&gt; <span class="title function_">adapt</span><span class="params">(Call&lt;R&gt; call)</span> &#123;</span><br><span class="line">        <span class="comment">//çœ‹è¿™é‡Œï¼Œç›´æ¥æŠŠä¼ å…¥çš„ call è¿”å›äº†</span></span><br><span class="line">        <span class="keyword">return</span> call;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨çš„éœ€æ±‚æ˜¯ï¼Œæˆ‘æƒ³è¦æ¥å…¥ RxJavaï¼Œè®©æ¥å£çš„è¿”å›ç»“æœæ”¹ä¸º Observableï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GitHub</span> &#123;</span><br><span class="line">  <span class="meta">@GET(&quot;/repos/&#123;owner&#125;/&#123;repo&#125;/contributors&quot;)</span></span><br><span class="line">  Observable&lt;List&lt;Contributor&gt;&gt; <span class="title function_">contributors</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="meta">@Path(&quot;owner&quot;)</span> String owner,</span></span><br><span class="line"><span class="params">      <span class="meta">@Path(&quot;repo&quot;)</span> String repo)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä¸å¯ä»¥å‘¢ï¼Ÿå½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œåªéœ€è¦æä¾›ä¸€ä¸ª Adapterï¼Œå°† OkHttpCall è½¬æ¢ä¸º Observable å³å¯å‘€ï¼Retrofit çš„å¼€å‘è€…ä»¬æ—©å°±æƒ³åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œå¹¶ä¸”ä¸ºæˆ‘ä»¬æä¾›äº†ç›¸åº”çš„ Adapterï¼š<br>RxJavaCallAdapterFactory<br>æˆ‘ä»¬åªéœ€è¦åœ¨æ„é€  Retrofit æ—¶ï¼Œæ·»åŠ å®ƒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addCallAdapterFactory(RxJavaCallAdapterFactory.create())</span><br></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬çš„æ¥å£å°±å¯ä»¥ä»¥ RxJava çš„æ–¹å¼å·¥ä½œäº†ã€‚</p><p>å¥½ï¼Œæ­‡ä¼šå„¿ï¼ŒæŠ½ä¸€è¢‹çƒŸã€‚ã€‚ã€‚</p><p>æ¥ç€æˆ‘ä»¬ææ¸…æ¥š RxJavaCallAdapterFactory æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Œé¦–å…ˆè®©æˆ‘ä»¬æ¥çœ‹ä¸‹ CallAdapter çš„æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CallAdapter</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   *è¿”å› Http è¿”å›è§£æåçš„ç±»å‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªå¹¶ä¸æ˜¯æ¥å£çš„è¿”å›ç±»å‹ï¼Œ</span></span><br><span class="line"><span class="comment">   *è€Œæ˜¯æ¥å£è¿”å›ç±»å‹ä¸­çš„æ³›å‹å‚æ•°çš„å®å‚ã€‚</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  Type <span class="title function_">responseType</span><span class="params">()</span>;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * T æ˜¯æˆ‘ä»¬éœ€è¦è½¬æ¢æˆçš„æ¥å£è¿”å›ç±»å‹ï¼Œå‚æ•° call å…¶å®æœ€åˆå°±æ˜¯ OkHttpCall çš„å®ä¾‹</span></span><br><span class="line"><span class="comment">   * åœ¨è¿™é‡Œ T å…¶å®æ˜¯ RxJava æ”¯æŒçš„ç±»å‹ï¼Œæ¯”å¦‚ Observable</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  &lt;R&gt; T <span class="title function_">adapt</span><span class="params">(Call&lt;R&gt; call)</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">//æˆ‘ä»¬éœ€è¦å°† Factory çš„å­ç±»å¯¹åº”çš„å®ä¾‹åœ¨æ„é€  Retrofit æ—¶æ·»åŠ åˆ°å…¶ä¸­ã€‚</span></span><br><span class="line">  <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Factory</span> &#123;</span><br><span class="line">    <span class="comment">//æ ¹æ®æ¥å£çš„è¿”å›ç±»å‹ï¼ˆObservable&lt;T&gt;ï¼‰ï¼Œæ³¨è§£ç±»å‹ç­‰ç­‰æ¥åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰ Adapter æ”¯æŒçš„ç±»å‹ï¼Œä¸æ˜¯åˆ™è¿”å›null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> CallAdapter&lt;?&gt; get(Type returnType, Annotation[] annotations,</span><br><span class="line">        Retrofit retrofit);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//è·å–æŒ‡å®š index çš„æ³›å‹å‚æ•°çš„ä¸Šé™ï¼Œæ¯”å¦‚å¯¹äº Map&lt;String, ? extends Number&gt;ï¼Œindexä¸º 1 çš„å‚æ•°ä¸Šé™æ˜¯ Number</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> Type <span class="title function_">getParameterUpperBound</span><span class="params">(<span class="type">int</span> index, ParameterizedType type)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> Utils.getParameterUpperBound(index, type);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * è·å–åŸå§‹ç±»å‹ï¼Œæ¯”å¦‚ List&lt;String&gt; è¿”å› List.classï¼Œè¿™é‡Œä¼ å…¥çš„ type æƒ…å†µå¯èƒ½æ¯”è¾ƒå¤æ‚ï¼Œå› æ­¤ä¸èƒ½ç›´æ¥å½“åš</span></span><br><span class="line"><span class="comment">     * Class å»åšåˆ¤æ–­ã€‚è¿™ä¸ªæ–¹æ³•åœ¨åˆ¤æ–­ç±»å‹æ˜¯å¦ä¸ºæ”¯æŒçš„ç±»å‹æ—¶ç»å¸¸ç”¨åˆ°ã€‚</span></span><br><span class="line"><span class="comment">    protected static Class&lt;?&gt; getRawType(Type type) &#123;</span></span><br><span class="line"><span class="comment">      return Utils.getRawType(type);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure><p>ä»£ç ä¸­åšäº†è¾ƒä¸ºè¯¦ç»†çš„æ³¨é‡Šï¼Œç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç° CallAdapter ç±»æ¥æä¾›å…·ä½“çš„é€‚é…é€»è¾‘ï¼Œå¹¶å®ç°ç›¸åº”çš„ Factoryï¼Œç”¨æ¥å°†å½“å‰çš„ CallAdapteræ³¨å†Œåˆ° Retrofit å½“ä¸­ï¼Œå¹¶åœ¨ Factory.get æ–¹æ³•ä¸­æ ¹æ®ç±»å‹æ¥è¿”å›å½“å‰çš„ CallAdapterå³å¯ã€‚çŸ¥é“äº†è¿™äº›ï¼Œæˆ‘ä»¬å†æ¥çœ‹ RxJavaCallAdapterFactoryï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">RxJavaCallAdapterFactory</span> <span class="keyword">extends</span> <span class="title class_">CallAdapter</span>.Factory &#123;</span><br><span class="line"> </span><br><span class="line">  ... è¯·å«æˆ‘çœç•¥å›ï¼Œä¸ºäº†çœåœ°æ–¹ï¼Œä¸€ä¸ªéƒ½ä¸æ”¾è¿‡ï¼ ...</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> CallAdapter&lt;?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) &#123;</span><br><span class="line">    <span class="comment">//æ³¨æ„ä¸‹é¢çš„ä»£ç ä¸»è¦æ˜¯åˆ¤æ–­ returnType æ˜¯å¦ä¸º RxJava æ”¯æŒçš„ç±»å‹</span></span><br><span class="line">    Class&lt;?&gt; rawType = getRawType(returnType);</span><br><span class="line">    <span class="type">String</span> <span class="variable">canonicalName</span> <span class="operator">=</span> rawType.getCanonicalName();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isSingle</span> <span class="operator">=</span> <span class="string">&quot;rx.Single&quot;</span>.equals(canonicalName);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isCompletable</span> <span class="operator">=</span> <span class="string">&quot;rx.Completable&quot;</span>.equals(canonicalName);</span><br><span class="line">    <span class="keyword">if</span> (rawType != Observable.class &amp;&amp; !isSingle &amp;&amp; !isCompletable) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ... è¿™é‡Œçœç•¥æ‰çš„ä»£ç ä¸»è¦æ˜¯æ ¹æ®è¿”å›ç±»å‹è·å–åˆé€‚çš„ Adapter ...</span><br><span class="line">    <span class="keyword">return</span> callAdapter;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  ... æˆ‘åˆæ¥äº†ï¼Œç»§ç»­ç•¥å»ä¸€äº›ä»£ç  ...</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">SimpleCallAdapter</span> <span class="keyword">implements</span> <span class="title class_">CallAdapter</span>&lt;Observable&lt;?&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Type responseType;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line"> </span><br><span class="line">    SimpleCallAdapter(Type responseType, Scheduler scheduler) &#123;</span><br><span class="line">      <span class="built_in">this</span>.responseType = responseType;</span><br><span class="line">      <span class="built_in">this</span>.scheduler = scheduler;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> Type <span class="title function_">responseType</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> responseType;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> &lt;R&gt; Observable&lt;R&gt; <span class="title function_">adapt</span><span class="params">(Call&lt;R&gt; call)</span> &#123;</span><br><span class="line">      <span class="comment">//åœ¨è¿™é‡Œåˆ›å»ºéœ€ä½œä¸ºè¿”å›å€¼çš„ Observable å®ä¾‹ï¼Œå¹¶æŒæœ‰ call å®ä¾‹</span></span><br><span class="line">      <span class="comment">//å¯ä»¥æƒ³è±¡å¾—åˆ°ï¼Œåœ¨ Observable.subscribe è§¦å‘æ—¶ï¼Œ call.execute å°†ä¼šè¢«è°ƒç”¨</span></span><br><span class="line">      Observable&lt;R&gt; observable = Observable.create(<span class="keyword">new</span> <span class="title class_">CallOnSubscribe</span>&lt;&gt;(call)) </span><br><span class="line">          .lift(OperatorMapResponseToBodyOrError.&lt;R&gt;instance());</span><br><span class="line">      <span class="keyword">if</span> (scheduler != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> observable.subscribeOn(scheduler);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> observable;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">//... ç•¥å»ä¸€äº›ä»£ç  ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RxJavaCallAdapterFactory æä¾›äº†ä¸æ­¢ä¸€ç§ Adapterï¼Œä½†åŸç†å¤§åŒå°å¼‚ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œå‚é˜…å…¶æºç ã€‚</p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å¯¹ CallAdapter çš„æœºåˆ¶æœ‰äº†ä¸€ä¸ªæ¸…æ™°çš„è®¤è¯†äº†ã€‚</p><h2 id="å‡ ä¸ªè¿›é˜¶ç©æ³•"><a href="#å‡ ä¸ªè¿›é˜¶ç©æ³•" class="headerlink" title="å‡ ä¸ªè¿›é˜¶ç©æ³•"></a>å‡ ä¸ªè¿›é˜¶ç©æ³•</h2><p>å‰é¢æˆ‘ä»¬å·²ç»ä»‹ç»äº†å¾ˆå¤šä¸œè¥¿äº†ã€‚ã€‚å¯ï¼ŒæŒ–æ˜æœºä¸“ä¸šçš„åŒå­¦ä»¬ï¼Œä½ ä»¬è§‰å¾—è¿™å°±å¤Ÿäº†ä¹ˆï¼Ÿå½“ç„¶æ˜¯ä¸å¤Ÿï¼</p><h3 id="ç»§ç»­ç®€åŒ–æ–‡ä»¶ä¸Šä¼ çš„æ¥å£"><a href="#ç»§ç»­ç®€åŒ–æ–‡ä»¶ä¸Šä¼ çš„æ¥å£" class="headerlink" title="ç»§ç»­ç®€åŒ–æ–‡ä»¶ä¸Šä¼ çš„æ¥å£"></a>ç»§ç»­ç®€åŒ–æ–‡ä»¶ä¸Šä¼ çš„æ¥å£</h3><p>åœ¨å‰é¢æˆ‘ä»¬æ›¾è¯•å›¾ç®€åŒ–æ–‡ä»¶ä¸Šä¼ æ¥å£çš„ä½¿ç”¨ï¼Œå°½ç®¡æˆ‘ä»¬å·²ç»ç»™å‡ºäº†ç›¸åº”çš„ File -&gt; RequestBody çš„ Converterï¼Œä¸è¿‡åŸºäº Retrofitæœ¬èº«çš„é™åˆ¶ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¸èƒ½åƒç›´æ¥æ„é€  MultiPartBody.Part é‚£æ ·æ¥è·å¾—æ›´å¤šçš„çµæ´»æ€§ã€‚è¿™æ—¶å€™è¯¥æ€ä¹ˆåŠï¼Ÿå½“ç„¶æ˜¯ Hack~~</p><p>é¦–å…ˆæ˜ç¡®æˆ‘ä»¬çš„éœ€æ±‚ï¼š</p><ul><li>æ–‡ä»¶çš„ Content-Type éœ€è¦æ›´å¤šçš„çµæ´»æ€§ï¼Œä¸åº”è¯¥å†™æ­»åœ¨ Converter å½“ä¸­ï¼Œå¯ä»¥çš„è¯ï¼Œæœ€å¥½å¯ä»¥æ ¹æ®æ–‡ä»¶çš„æ‰©å±•åæ¥æ˜ å°„å‡ºæ¥å¯¹åº”çš„ Content-Typeï¼Œ æ¯”å¦‚ image.png -&gt; image&#x2F;pngï¼›</li><li>åœ¨è¯·æ±‚çš„æ•°æ®ä¸­ï¼Œèƒ½å¤Ÿæ­£å¸¸æºå¸¦ filename è¿™ä¸ªå­—æ®µã€‚</li></ul><p>ä¸ºæ­¤ï¼Œæˆ‘å¢åŠ äº†ä¸€å¥—å®Œæ•´çš„å‚æ•°è§£ææ–¹æ¡ˆï¼š</p><ul><li>å¢åŠ ä»»æ„ç±»å‹è½¬æ¢çš„ Converterï¼Œè¿™ä¸€æ­¥ä¸»è¦æ˜¯æ»¡è¶³åç»­æˆ‘ä»¬ç›´æ¥å°†å…¥å‚ç±»å‹è½¬æ¢ä¸º MultiPartBody.Part ç±»å‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Converter</span>&lt;F, T&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">   </span><br><span class="line">  <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Factory</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//è¿”å›ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„ä¸é™åˆ¶ç±»å‹çš„ Converter</span></span><br><span class="line">    <span class="keyword">public</span> Converter&lt;?, ?&gt; arbitraryConverter(Type originalType,</span><br><span class="line">          Type convertedType, Annotation[] parameterAnnotations, Annotation[] methodAnnotations, Retrofit retrofit)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒRetrofit ç±»å½“ä¸­ä¹Ÿéœ€è¦å¢åŠ ç›¸åº”çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;F, T&gt; Converter&lt;F, T&gt; <span class="title function_">arbitraryConverter</span><span class="params">(Type orignalType,</span></span><br><span class="line"><span class="params">                                                 Type convertedType, Annotation[] parameterAnnotations, Annotation[] methodAnnotations)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> nextArbitraryConverter(<span class="literal">null</span>, orignalType, convertedType, parameterAnnotations, methodAnnotations);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> &lt;F, T&gt; Converter&lt;F, T&gt; <span class="title function_">nextArbitraryConverter</span><span class="params">(Converter.Factory skipPast,</span></span><br><span class="line"><span class="params">                              Type type, Type convertedType,  Annotation[] parameterAnnotations, Annotation[] methodAnnotations)</span> &#123;</span><br><span class="line">  checkNotNull(type, <span class="string">&quot;type == null&quot;</span>);</span><br><span class="line">  checkNotNull(parameterAnnotations, <span class="string">&quot;parameterAnnotations == null&quot;</span>);</span><br><span class="line">  checkNotNull(methodAnnotations, <span class="string">&quot;methodAnnotations == null&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> converterFactories.indexOf(skipPast) + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start, count = converterFactories.size(); i &lt; count; i++) &#123;</span><br><span class="line">    Converter.<span class="type">Factory</span> <span class="variable">factory</span> <span class="operator">=</span> converterFactories.get(i);</span><br><span class="line">    Converter&lt;?, ?&gt; converter =</span><br><span class="line">            factory.arbitraryConverter(type, convertedType, parameterAnnotations, methodAnnotations, <span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (converter != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">//noinspection unchecked</span></span><br><span class="line">      <span class="keyword">return</span> (Converter&lt;F, T&gt;) converter;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å†ç»™å‡º arbitraryConverter çš„å…·ä½“å®ç°ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TypedFileMultiPartBodyConverterFactory</span> <span class="keyword">extends</span> <span class="title class_">Converter</span>.Factory &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Converter&lt;TypedFile, MultipartBody.Part&gt; arbitraryConverter(Type originalType, Type convertedType, Annotation[] parameterAnnotations, Annotation[] methodAnnotations, Retrofit retrofit) &#123;</span><br><span class="line">        <span class="keyword">if</span> (originalType == TypedFile.class &amp;&amp; convertedType == MultipartBody.Part.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileRequestBodyConverter</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TypedFileMultiPartBodyConverter</span> <span class="keyword">implements</span> <span class="title class_">Converter</span>&lt;TypedFile, MultipartBody.Part&gt; &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MultipartBody.Part <span class="title function_">convert</span><span class="params">(TypedFile typedFile)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">RequestBody</span> <span class="variable">requestFile</span> <span class="operator">=</span></span><br><span class="line">                RequestBody.create(typedFile.getMediaType(), typedFile.getFile());</span><br><span class="line">        <span class="keyword">return</span> MultipartBody.Part.createFormData(typedFile.getName(), typedFile.getFile().getName(), requestFile);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TypedFile</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> MediaType mediaType;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> File file;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TypedFile</span><span class="params">(String name, String filepath)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>(name, <span class="keyword">new</span> <span class="title class_">File</span>(filepath));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TypedFile</span><span class="params">(String name, File file)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(MediaType.parse(MediaTypes.getMediaType(file)), name, file);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TypedFile</span><span class="params">(MediaType mediaType, String name, String filepath)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(mediaType, name, <span class="keyword">new</span> <span class="title class_">File</span>(filepath));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TypedFile</span><span class="params">(MediaType mediaType, String name, File file)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mediaType = mediaType;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.file = file;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> MediaType <span class="title function_">getMediaType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mediaType;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> File <span class="title function_">getFile</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨å£°æ˜æ¥å£æ—¶ï¼Œ@Part ä¸è¦ä¼ å…¥å‚æ•°ï¼Œè¿™æ · Retrofit åœ¨ ServiceMethod.Builder.parseParameterAnnotation æ–¹æ³•ä¸­è§£æ Partæ—¶ï¼Œå°±ä¼šè®¤ä¸ºæˆ‘ä»¬ä¼ å…¥çš„å‚æ•°ä¸º MultiPartBody.Part ç±»å‹ï¼ˆå®é™…ä¸Šæˆ‘ä»¬å°†åœ¨åé¢è‡ªå·±è½¬æ¢ï¼‰ã€‚é‚£ä¹ˆè§£æçš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‹¿åˆ°å‰é¢å®šä¹‰å¥½çš„ Converterï¼Œæ„é€ ä¸€ä¸ª ParameterHandlerï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (MultipartBody.Part.class.isAssignableFrom(rawParameterType)) &#123;</span><br><span class="line">    <span class="keyword">return</span> ParameterHandler.RawPart.INSTANCE;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Converter&lt;?, ?&gt; converter =</span><br><span class="line">            retrofit.arbitraryConverter(type, MultipartBody.Part.class, annotations, methodAnnotations);</span><br><span class="line">    <span class="keyword">if</span>(converter == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> parameterError(p,</span><br><span class="line">                <span class="string">&quot;@Part annotation must supply a name or use MultipartBody.Part parameter type.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ParameterHandler</span>.TypedFileHandler((Converter&lt;TypedFile, MultipartBody.Part&gt;) converter);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TypedFileHandler</span> <span class="keyword">extends</span> <span class="title class_">ParameterHandler</span>&lt;TypedFile&gt;&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Converter&lt;TypedFile, MultipartBody.Part&gt; converter;</span><br><span class="line"> </span><br><span class="line">  TypedFileHandler(Converter&lt;TypedFile, MultipartBody.Part&gt; converter) &#123;</span><br><span class="line">    <span class="built_in">this</span>.converter = converter;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestBuilder builder, TypedFile value)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span>(value != <span class="literal">null</span>)&#123;</span><br><span class="line">      builder.addPart(converter.convert(value));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿™æ—¶å€™å†çœ‹æˆ‘ä»¬çš„æ¥å£å£°æ˜ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FileUploadService</span> &#123;</span><br><span class="line">  <span class="meta">@Multipart</span></span><br><span class="line">  <span class="meta">@POST(&quot;upload&quot;)</span></span><br><span class="line">  Call&lt;ResponseBody&gt; <span class="title function_">upload</span><span class="params">(<span class="meta">@Part(&quot;description&quot;)</span> RequestBody description,</span></span><br><span class="line"><span class="params">                            <span class="meta">@Part</span> TypedFile typedFile)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥åŠä½¿ç”¨æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Retrofit</span> <span class="variable">retrofit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Retrofit</span>.Builder()</span><br><span class="line">    .baseUrl(<span class="string">&quot;http://www.println.net/&quot;</span>)</span><br><span class="line">    .addConverterFactory(<span class="keyword">new</span> <span class="title class_">TypedFileMultiPartBodyConverterFactory</span>())</span><br><span class="line">    .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">    .build();</span><br><span class="line"> </span><br><span class="line"><span class="type">FileUploadService</span> <span class="variable">service</span> <span class="operator">=</span> retrofit.create(FileUploadService.class);</span><br><span class="line"><span class="type">TypedFile</span> <span class="variable">typedFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TypedFile</span>(<span class="string">&quot;aFile&quot;</span>, filename);</span><br><span class="line"><span class="type">String</span> <span class="variable">descriptionString</span> <span class="operator">=</span> <span class="string">&quot;This is a description&quot;</span>;</span><br><span class="line"><span class="type">RequestBody</span> <span class="variable">description</span> <span class="operator">=</span></span><br><span class="line">        RequestBody.create(</span><br><span class="line">                MediaType.parse(<span class="string">&quot;multipart/form-data&quot;</span>), descriptionString);</span><br><span class="line"> </span><br><span class="line">Call&lt;ResponseBody&gt; call = service.upload(description, typedFile);</span><br><span class="line">call.enqueue(...);</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»é€šè¿‡è‡ªå·±çš„åŒæ‰‹ï¼Œè®© Retrofit çš„ç‚¹äº®äº†è‡ªå®šä¹‰ä¸Šä¼ æ–‡ä»¶çš„æŠ€èƒ½ï¼Œé£éªšç­‰çº§æ›´ä¸Šä¸€å±‚æ¥¼ï¼</p><h3 id="Mock-Server"><a href="#Mock-Server" class="headerlink" title="Mock Server"></a>Mock Server</h3><p>æˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç»å¸¸é‡åˆ°æœåŠ¡ç«¯ä¸ç¨³å®šçš„æƒ…å†µï¼Œæµ‹è¯•å¼€å‘ç¯å¢ƒï¼Œè¿™æ˜¯éš¾å…çš„ã€‚äºæ˜¯æˆ‘ä»¬éœ€è¦èƒ½å¤Ÿæ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚æ¥è°ƒè¯•æˆ‘ä»¬çš„å®¢æˆ·ç«¯é€»è¾‘ï¼ŒRetrofit è‡ªç„¶æ˜¯æ”¯æŒè¿™ä¸ªåŠŸèƒ½çš„ã€‚</p><p>çœŸæ˜¯å¤ªè´´å¿ƒï¼ŒRetrofit æä¾›äº†ä¸€ä¸ª MockServer çš„åŠŸèƒ½ï¼Œå¯ä»¥åœ¨å‡ ä¹ä¸æ”¹åŠ¨å®¢æˆ·ç«¯åŸæœ‰ä»£ç çš„å‰æä¸‹ï¼Œå®ç°æ¥å£æ•°æ®è¿”å›çš„è‡ªå®šä¹‰ï¼Œæˆ‘ä»¬åœ¨è‡ªå·±çš„å·¥ç¨‹ä¸­å¢åŠ ä¸‹é¢çš„ä¾èµ–ï¼š</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">&#x27;com.squareup.retrofit2:retrofit-mock:2.0.2</span></span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯å…ˆè®©æˆ‘ä»¬æ¥çœ‹çœ‹å®˜æ–¹ demoï¼Œé¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª GituHb apiï¼Œå¥½ç†Ÿæ‚‰çš„æ„Ÿè§‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GitHub</span> &#123;</span><br><span class="line">  <span class="meta">@GET(&quot;/repos/&#123;owner&#125;/&#123;repo&#125;/contributors&quot;)</span></span><br><span class="line">  Call&lt;List&lt;Contributor&gt;&gt; <span class="title function_">contributors</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="meta">@Path(&quot;owner&quot;)</span> String owner,</span></span><br><span class="line"><span class="params">      <span class="meta">@Path(&quot;repo&quot;)</span> String repo)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯æˆ‘ä»¬è¦è¯·æ±‚çš„æ¥å£äº†ï¼Œæ€ä¹ˆ Mock å‘¢ï¼Ÿ</p><ul><li>å®šä¹‰ä¸€ä¸ªæ¥å£å®ç°ç±» MockGitHubï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ‰€æœ‰æˆ‘ä»¬éœ€è¦è¯·æ±‚çš„æ¥å£éƒ½åœ¨è¿™é‡Œå¾—åˆ°äº†å®ç°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¾…ä¼šå„¿è°ƒç”¨ GitHub çš„ api æ—¶ï¼Œå®é™…ä¸Šæ˜¯è®¿é—® MockGitHub çš„æ–¹æ³•ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MockGitHub</span> <span class="keyword">implements</span> <span class="title class_">GitHub</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BehaviorDelegate&lt;GitHub&gt; delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Map&lt;String, List&lt;Contributor&gt;&gt;&gt; ownerRepoContributors;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MockGitHub</span><span class="params">(BehaviorDelegate&lt;GitHub&gt; delegate)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.delegate = delegate;</span><br><span class="line">      ownerRepoContributors = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// Seed some mock data.</span></span><br><span class="line">      addContributor(<span class="string">&quot;square&quot;</span>, <span class="string">&quot;retrofit&quot;</span>, <span class="string">&quot;John Doe&quot;</span>, <span class="number">12</span>);</span><br><span class="line">      addContributor(<span class="string">&quot;square&quot;</span>, <span class="string">&quot;retrofit&quot;</span>, <span class="string">&quot;Bob Smith&quot;</span>, <span class="number">2</span>);</span><br><span class="line">      addContributor(<span class="string">&quot;square&quot;</span>, <span class="string">&quot;retrofit&quot;</span>, <span class="string">&quot;Big Bird&quot;</span>, <span class="number">40</span>);</span><br><span class="line">      addContributor(<span class="string">&quot;square&quot;</span>, <span class="string">&quot;picasso&quot;</span>, <span class="string">&quot;Proposition Joe&quot;</span>, <span class="number">39</span>);</span><br><span class="line">      addContributor(<span class="string">&quot;square&quot;</span>, <span class="string">&quot;picasso&quot;</span>, <span class="string">&quot;Keiser Soze&quot;</span>, <span class="number">152</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> Call&lt;List&lt;Contributor&gt;&gt; <span class="title function_">contributors</span><span class="params">(String owner, String repo)</span> &#123;</span><br><span class="line">      List&lt;Contributor&gt; response = Collections.emptyList();</span><br><span class="line">      Map&lt;String, List&lt;Contributor&gt;&gt; repoContributors = ownerRepoContributors.get(owner);</span><br><span class="line">      <span class="keyword">if</span> (repoContributors != <span class="literal">null</span>) &#123;</span><br><span class="line">        List&lt;Contributor&gt; contributors = repoContributors.get(repo);</span><br><span class="line">        <span class="keyword">if</span> (contributors != <span class="literal">null</span>) &#123;</span><br><span class="line">          response = contributors;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> delegate.returningResponse(response).contributors(owner, repo);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addContributor</span><span class="params">(String owner, String repo, String name, <span class="type">int</span> contributions)</span> &#123;</span><br><span class="line">      Map&lt;String, List&lt;Contributor&gt;&gt; repoContributors = ownerRepoContributors.get(owner);</span><br><span class="line">      <span class="keyword">if</span> (repoContributors == <span class="literal">null</span>) &#123;</span><br><span class="line">        repoContributors = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        ownerRepoContributors.put(owner, repoContributors);</span><br><span class="line">      &#125;</span><br><span class="line">      List&lt;Contributor&gt; contributors = repoContributors.get(repo);</span><br><span class="line">      <span class="keyword">if</span> (contributors == <span class="literal">null</span>) &#123;</span><br><span class="line">        contributors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        repoContributors.put(repo, contributors);</span><br><span class="line">      &#125;</span><br><span class="line">      contributors.add(<span class="keyword">new</span> <span class="title class_">Contributor</span>(name, contributions));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ„å»º Mock Server å¯¹è±¡ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a very simple Retrofit adapter which points the GitHub API.</span></span><br><span class="line"><span class="type">Retrofit</span> <span class="variable">retrofit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Retrofit</span>.Builder()</span><br><span class="line">    .baseUrl(SimpleService.API_URL)</span><br><span class="line">    .build();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Create a MockRetrofit object with a NetworkBehavior which manages the fake behavior of calls.</span></span><br><span class="line"><span class="type">NetworkBehavior</span> <span class="variable">behavior</span> <span class="operator">=</span> NetworkBehavior.create();</span><br><span class="line"><span class="type">MockRetrofit</span> <span class="variable">mockRetrofit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockRetrofit</span>.Builder(retrofit)</span><br><span class="line">    .networkBehavior(behavior)</span><br><span class="line">    .build();</span><br><span class="line"> </span><br><span class="line">BehaviorDelegate&lt;GitHub&gt; delegate = mockRetrofit.create(GitHub.class);</span><br><span class="line"><span class="type">MockGitHub</span> <span class="variable">gitHub</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockGitHub</span>(delegate);</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ Mock Server ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Call&lt;List&lt;Contributor&gt;&gt; contributors = gitHub.contributors(owner, repo);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥è‡ªå·±é€ ä¸€ä¸ªå‡çš„æ•°æ®æºï¼Œé€šè¿‡ Mock Server æ¥è¿”å›è¿™äº›å†™æ•°æ®ã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¿™å…¶å®å¹¶æ²¡æœ‰å®Œå…¨æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚çš„è§£ææµç¨‹ï¼Œå¦‚æœæˆ‘åªèƒ½æä¾›åŸå§‹çš„ json å­—ç¬¦ä¸²ï¼Œæ€ä¹ˆé€šè¿‡ Retrofit æ¥å®ç° Mock Serverï¼Ÿ</p><p>æ—¶é—´å·²ç»ä¸æ—©å•¦ï¼Œæˆ‘å°±ä¸çŒ¥çå‘è‚²äº†ï¼Œç›´æ¥æ¨å¡”~</p><p>æœ¬æ–‡å‰é¢ä¸€ç›´ä¸“æ³¨äºä»‹ç» Retrofitï¼Œå¾ˆå°‘æåŠ OkHttpï¼Œæ®Šä¸çŸ¥ OkHttp æœ‰ä¸€å¥—æ‹¦æˆªå™¨çš„æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä»»æ€§çš„æ£€æŸ¥ Retrofit å³å°†å‘å‡ºæˆ–è€…æ­£åœ¨å‘å‡ºçš„æ‰€æœ‰è¯·æ±‚ï¼Œå¹¶ä¸”ç¯¡æ”¹å®ƒã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ‰¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ¥å£ï¼Œå®šåˆ¶è‡ªå·±çš„è¿”å›ç»“æœå°±å¥½äº†ï¼Œä¸‹é¢æ˜¯ä¸€æ®µç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder().addInterceptor(<span class="keyword">new</span> <span class="title class_">Interceptor</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Response <span class="title function_">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(BuildConfig.DEBUG &amp;&amp; chain.request().url().uri().getPath().equals(<span class="string">&quot;/contributors&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">//è¿™é‡Œè¯»å–æˆ‘ä»¬éœ€è¦è¿”å›çš„ Json å­—ç¬¦ä¸²</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">responseString</span> <span class="operator">=</span> ...;</span><br><span class="line">             </span><br><span class="line">            response = <span class="keyword">new</span> <span class="title class_">Response</span>.Builder()</span><br><span class="line">                    .code(<span class="number">200</span>)</span><br><span class="line">                    .message(responseString)</span><br><span class="line">                    .request(chain.request())</span><br><span class="line">                    .protocol(Protocol.HTTP_1_0)</span><br><span class="line">                    .body(ResponseBody.create(MediaType.parse(<span class="string">&quot;application/json&quot;</span>), responseString.getBytes()))</span><br><span class="line">                    .addHeader(<span class="string">&quot;content-type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            response = chain.proceed(chain.request());</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).build();</span><br><span class="line"> </span><br><span class="line"><span class="type">Retrofit</span> <span class="variable">retrofit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Retrofit</span>.Builder()</span><br><span class="line">        .baseUrl(BASE_URL)</span><br><span class="line">        .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">        .client(client)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±ä¼šæ‹¦æˆª contributors è¿™ä¸ª api å¹¶å®šåˆ¶å…¶è¿”å›äº†ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>Retrofit æ˜¯éå¸¸å¼ºå¤§çš„ï¼Œæœ¬æ–‡é€šè¿‡ä¸°å¯Œçš„ç¤ºä¾‹å’Œå¯¹æºç çš„æŒ–æ˜ï¼Œå‘å¤§å®¶å±•ç¤ºäº† Retrofit è‡ªèº«å¼ºå¤§çš„åŠŸèƒ½ä»¥åŠæ‰©å±•æ€§ï¼Œå°±ç®—å®ƒæœ¬èº«åŠŸèƒ½ä¸èƒ½æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œä½ ä¹Ÿå¯ä»¥å¾ˆå®¹æ˜“çš„è¿›è¡Œæ”¹é€ ï¼Œæ¯•ç«Ÿäººå®¶çš„ä»£ç çœŸæ˜¯å†™çš„æ¼‚äº®å•Šã€‚</p>]]></content>
      
      <categories>
          
          <category> åšå®¢ </category>
          
          <category> Retrofit </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åšå®¢ </tag>
            
            <tag> Retrofit </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Android Sensoræ¡†æ¶Frameworkå±‚è§£è¯»</title>
      <link href="/2016/09/15/blogs/SensorFramework/"/>
      <url>/2016/09/15/blogs/SensorFramework/</url>
      <content type="html"><![CDATA[<h2 id="Sensoræ•´ä½“æ¶æ„ï¼š"><a href="#Sensoræ•´ä½“æ¶æ„ï¼š" class="headerlink" title="Sensoræ•´ä½“æ¶æ„ï¼š"></a>Sensoræ•´ä½“æ¶æ„ï¼š</h2><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/sensorFramework/1.png"/><h3 id="æ•´ä½“æ¶æ„è¯´æ˜"><a href="#æ•´ä½“æ¶æ„è¯´æ˜" class="headerlink" title="æ•´ä½“æ¶æ„è¯´æ˜:"></a>æ•´ä½“æ¶æ„è¯´æ˜:</h3><ol><li>é»„è‰²éƒ¨åˆ†è¡¨ç¤ºç¡¬ä»¶ï¼Œå®ƒè¦æŒ‚åœ¨I2Cæ€»çº¿ä¸Š    </li><li>çº¢è‰²éƒ¨åˆ†è¡¨ç¤ºé©±åŠ¨ï¼Œé©±åŠ¨æ³¨å†Œåˆ°Kernelçš„Input Subsystemä¸Šï¼Œç„¶åé€šè¿‡Event DeviceæŠŠSensoræ•°æ®ä¼ åˆ°HALå±‚ï¼Œå‡†ç¡®è¯´æ˜¯HALä»Eventè¯»</li><li>ç»¿è‰²éƒ¨åˆ†è¡¨ç¤ºåŠ¨æ€åº“ï¼Œå®ƒå°è£…äº†æ•´ä¸ªSensorçš„IPCæœºåˆ¶ï¼Œå¦‚SensorManageræ˜¯å®¢æˆ·ç«¯ï¼ŒSensorServiceæ˜¯æœåŠ¡ç«¯ï¼Œè€ŒHALéƒ¨åˆ†æ˜¯å°è£…äº†æœåŠ¡ç«¯å¯¹Kernelçš„ç›´æ¥è®¿é—®</li><li>è“è‰²éƒ¨åˆ†å°±æ˜¯æˆ‘ä»¬çš„Frameworkå’ŒApplicationäº†ï¼ŒJNIè´Ÿè´£è®¿é—®Sensorçš„å®¢æˆ·ç«¯ï¼Œè€ŒApplicationå°±æ˜¯å…·ä½“çš„åº”ç”¨ç¨‹åºï¼Œç”¨æ¥æ¥æ”¶Sensorè¿”å›çš„æ•°æ®ï¼Œå¹¶å¤„ç†å®ç°å¯¹åº”çš„UIæ•ˆæœï¼Œå¦‚å±å¹•æ—‹è½¬ï¼Œæ‰“ç”µè¯æ—¶ç­å±ï¼Œè‡ªåŠ¨è°ƒæ¥èƒŒå…‰ï¼ˆè¿™ä¸‰ä¸ªåŠŸèƒ½çš„å…·ä½“å®ç°ä¼šåœ¨ä»¥ååˆ†æï¼‰</li></ol><h3 id="Sensoræ€»ä½“è°ƒç”¨å…³ç³»å›¾"><a href="#Sensoræ€»ä½“è°ƒç”¨å…³ç³»å›¾" class="headerlink" title="Sensoræ€»ä½“è°ƒç”¨å…³ç³»å›¾"></a>Sensoræ€»ä½“è°ƒç”¨å…³ç³»å›¾</h3><ul><li>æœ¬èŠ‚ä¸»è¦è§£è¯»Androidçš„Frameworkå±‚æ¡†æ¶ã€‚</li><li>Sensor æ¡†æ¶åˆ†ä¸ºä¸‰ä¸ªå±‚æ¬¡ï¼Œå®¢æˆ·åº¦ã€æœåŠ¡ç«¯ã€HALå±‚ï¼ŒæœåŠ¡ç«¯è´Ÿè´£ä»HALè¯»å–æ•°æ®ï¼Œå¹¶å°†æ•°æ®å†™åˆ°ç®¡é“ä¸­ï¼Œå®¢æˆ·ç«¯é€šè¿‡ç®¡é“è¯»å–æœåŠ¡ç«¯æ•°æ®ã€‚</li></ul><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/sensorFramework/2.png"/><h3 id="å®¢æˆ·ç«¯ä¸»è¦ç±»"><a href="#å®¢æˆ·ç«¯ä¸»è¦ç±»" class="headerlink" title="å®¢æˆ·ç«¯ä¸»è¦ç±»"></a>å®¢æˆ·ç«¯ä¸»è¦ç±»</h3><ul><li><code>SensorManager.java</code>ï¼šä»android4.1å¼€å§‹ï¼ŒæŠŠSensorManagerå®šä¹‰ä¸ºä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®šä¹‰äº†ä¸€äº›ä¸»è¦çš„æ–¹æ³•ï¼Œè¯¥ç±»ä¸»è¦æ˜¯åº”ç”¨å±‚ç›´æ¥ä½¿ç”¨çš„ç±»ï¼Œæä¾›ç»™åº”ç”¨å±‚çš„æ¥å£</li><li><code>SystemSensorManager.java</code>ï¼šç»§æ‰¿äºSensorManagerï¼Œå®¢æˆ·ç«¯æ¶ˆæ¯å¤„ç†çš„å®ä½“ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡è·å–å…¶å®ä¾‹ï¼Œå¹¶æ³¨å†Œç›‘å¬æ¥å£ï¼Œè·å–sensoræ•°æ®ã€‚</li><li><code>sensorEventListener</code>æ¥å£ï¼šç”¨äºæ³¨å†Œç›‘å¬çš„æ¥å£</li><li><code>sensorThread</code>ï¼šæ˜¯SystemSensorManagerçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œå¼€å¯ä¸€ä¸ªæ–°çº¿ç¨‹è´Ÿè´£è¯»å–è¯»å–sensoræ•°æ®ï¼Œå½“æ³¨å†Œäº†sensorEventListeneræ¥å£çš„æ—¶å€™æ‰ä¼šå¯åŠ¨çº¿ç¨‹</li><li><code>android_hardware_SensorManager.cpp</code>ï¼šè´Ÿè´£ä¸javaå±‚é€šä¿¡çš„JNIæ¥å£</li><li><code>SensorManager.cpp</code>ï¼šsensoråœ¨Nativeå±‚çš„å®¢æˆ·ç«¯ï¼Œè´Ÿè´£ä¸æœåŠ¡ç«¯SensorService.cppçš„é€šä¿¡</li><li><code>SenorEventQueue.cpp</code>ï¼šæ¶ˆæ¯é˜Ÿåˆ—</li></ul><h3 id="æœåŠ¡ç«¯ä¸»è¦ç±»"><a href="#æœåŠ¡ç«¯ä¸»è¦ç±»" class="headerlink" title="æœåŠ¡ç«¯ä¸»è¦ç±»"></a>æœåŠ¡ç«¯ä¸»è¦ç±»</h3><ul><li><code>SensorService.cpp</code>ï¼šæœåŠ¡ç«¯æ•°æ®å¤„ç†ä¸­å¿ƒ</li><li><code>SensorEventConnection</code>ï¼šä»BnSensorEventConnectionç»§æ‰¿æ¥ï¼Œå®ç°æ¥å£ISensorEventConnectionçš„ä¸€äº›æ–¹æ³•ï¼ŒISensorEventConnectionåœ¨SensorEventQueueä¼šä¿å­˜ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘è°ƒç”¨æœåŠ¡æ¥å£åˆ›å»ºçš„SensorEventConnectionå¯¹è±¡</li><li><code>Bittube.cpp</code>ï¼šåœ¨è¿™ä¸ªç±»ä¸­åˆ›å»ºäº†ç®¡é“ï¼Œç”¨äºæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯è¯»å†™æ•°æ®</li><li><code>SensorDevice</code>ï¼šè´Ÿè´£ä¸HALè¯»å–æ•°æ®</li></ul><h3 id="HALå±‚"><a href="#HALå±‚" class="headerlink" title="HALå±‚"></a>HALå±‚</h3><ul><li><code>Sensor.h</code>æ˜¯googleä¸ºSensorå®šä¹‰çš„Halæ¥å£ï¼Œå•ç‹¬æå‡ºå»</li></ul><h2 id="å®¢æˆ·ç«¯è¯»å–æ•°æ®"><a href="#å®¢æˆ·ç«¯è¯»å–æ•°æ®" class="headerlink" title="å®¢æˆ·ç«¯è¯»å–æ•°æ®"></a>å®¢æˆ·ç«¯è¯»å–æ•°æ®</h2><h3 id="è°ƒç”¨æ—¶åºå›¾"><a href="#è°ƒç”¨æ—¶åºå›¾" class="headerlink" title="è°ƒç”¨æ—¶åºå›¾"></a>è°ƒç”¨æ—¶åºå›¾</h3><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/sensorFramework/3.jpg"/><h3 id="apkæ³¨å†Œç›‘å¬å™¨"><a href="#apkæ³¨å†Œç›‘å¬å™¨" class="headerlink" title="apkæ³¨å†Œç›‘å¬å™¨"></a>apkæ³¨å†Œç›‘å¬å™¨</h3><ul><li>Activityå®ç°äº†SensorEventListeneræ¥å£ã€‚åœ¨onCreateæ–¹æ³•ä¸­ï¼Œè·å–SystemSensorManagerï¼Œå¹¶è·å–åˆ°åŠ é€Ÿä¼ æ„Ÿå™¨çš„Sensorï¼›åœ¨onResumeæ–¹æ³•ä¸­è°ƒç”¨SystemSensorManagerï¼ŒregisterListenerImplæ³¨å†Œç›‘å¬å™¨ï¼›å½“Sensoræ•°æ®æœ‰æ”¹å˜çš„æ—¶å€™å°†ä¼šå›è°ƒonSensorChangedæ–¹æ³•ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SensorManager</span>  <span class="variable">mSensorManager</span> <span class="operator">=</span></span><br><span class="line"> (SensorManager)getSystemService(SENSOR_SERVICE);</span><br><span class="line"> <span class="type">Sensor</span>   <span class="variable">mAccelerometer</span> <span class="operator">=</span></span><br><span class="line"> mSensorManager.getDefaultSensor(Sensor.TYPE_ACCELEROMETER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">           <span class="built_in">super</span>.onResume();</span><br><span class="line">          mSensorManager. registerListenerImpl (<span class="built_in">this</span>, mAccelerometer,</span><br><span class="line">     SensorManager.SENSOR_DELAY_NORMAL);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onPause</span><span class="params">()</span> &#123;</span><br><span class="line">           <span class="built_in">super</span>.onPause();</span><br><span class="line">         mSensorManager.unregisterListener(<span class="built_in">this</span>);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SensorEventListener</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSensorChanged</span><span class="params">(SensorEvent event)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAccuracyChanged</span><span class="params">(Sensor sensor, <span class="type">int</span> accuracy)</span>;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆå§‹åŒ–SystemSensorManager"><a href="#åˆå§‹åŒ–SystemSensorManager" class="headerlink" title="åˆå§‹åŒ–SystemSensorManager"></a>åˆå§‹åŒ–SystemSensorManager</h3><ul><li><p>ç³»ç»Ÿå¼€æœºå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºSystemSensorManagerçš„å®ä¾‹ï¼Œåœ¨å…¶æ„é€ å‡½æ•°ä¸­ï¼Œä¸»è¦åšäº†å››ä»¶äº‹æƒ…ï¼š</p><ol><li>åˆå§‹åŒ–JNIï¼šè°ƒç”¨JNIå‡½æ•°nativeClassInit()è¿›è¡Œåˆå§‹åŒ–</li><li>åˆå§‹åŒ–Sensoråˆ—è¡¨ï¼šè°ƒç”¨JNIå‡½æ•°sensors_module_initï¼Œå¯¹Sensoræ¨¡å—è¿›è¡Œåˆå§‹åŒ–ã€‚åˆ›å»ºäº†nativeå±‚SensorManagerçš„å®ä¾‹ã€‚</li><li>è·å–Sensoråˆ—è¡¨ï¼šè°ƒç”¨JNIå‡½æ•°sensors_module_get_next_sensor()è·å–Sensorï¼Œå¹¶å­˜åœ¨sHandleToSensoråˆ—è¡¨ä¸­</li><li>æ„é€ SensorThreadç±»ï¼šæ„é€ çº¿ç¨‹çš„ç±»å‡½æ•°ï¼Œå¹¶æ²¡æœ‰å¯åŠ¨çº¿ç¨‹ï¼Œå½“æœ‰åº”ç”¨æ³¨å†Œçš„æ—¶å€™æ‰ä¼šå¯åŠ¨çº¿ç¨‹</li></ol></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SystemSensorManager</span><span class="params">(Context context,Looper mainLooper)</span> &#123;</span><br><span class="line">        mMainLooper = mainLooper;       </span><br><span class="line">              mContext = context;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(sListeners) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!sSensorModuleInitialized) &#123;</span><br><span class="line">                sSensorModuleInitialized = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                nativeClassInit();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// initialize the sensor list</span></span><br><span class="line">                sensors_module_init();</span><br><span class="line">                <span class="keyword">final</span> ArrayList&lt;Sensor&gt; fullList = sFullSensorsList;</span><br><span class="line">                <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="type">Sensor</span> <span class="variable">sensor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Sensor</span>();</span><br><span class="line">                    i = sensors_module_get_next_sensor(sensor, i);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (i&gt;=<span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">//Log.d(TAG, &quot;found sensor: &quot; + sensor.getName() +</span></span><br><span class="line">                        <span class="comment">//        &quot;, handle=&quot; + sensor.getHandle());</span></span><br><span class="line">                        fullList.add(sensor);</span><br><span class="line">                        sHandleToSensor.append(sensor.getHandle(), sensor);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">while</span> (i&gt;<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                sPool = <span class="keyword">new</span> <span class="title class_">SensorEventPool</span>( sFullSensorsList.size()*<span class="number">2</span> );</span><br><span class="line">                sSensorThread = <span class="keyword">new</span> <span class="title class_">SensorThread</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨SensorThreadçº¿ç¨‹è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ•°æ®"><a href="#å¯åŠ¨SensorThreadçº¿ç¨‹è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ•°æ®" class="headerlink" title="å¯åŠ¨SensorThreadçº¿ç¨‹è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ•°æ®"></a>å¯åŠ¨SensorThreadçº¿ç¨‹è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ•°æ®</h3><ul><li>å½“æœ‰åº”ç”¨ç¨‹åºè°ƒç”¨registerListenerImpl()æ–¹æ³•æ³¨å†Œç›‘å¬çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨SensorThread.startLoacked()å¯åŠ¨çº¿ç¨‹ã€‚çº¿ç¨‹åªä¼šå¯åŠ¨ä¸€æ¬¡ï¼Œå¹¶è°ƒç”¨enableSensorLocked()æ¥å£å¯¹æŒ‡å®šçš„sensorä½¿èƒ½ï¼Œå¹¶è®¾ç½®é‡‡æ ·æ—¶é—´ã€‚ã€€ã€€SensorThreadRunnableå®ç°äº†Runnableæ¥å£ï¼Œåœ¨SensorThreadç±»ä¸­è¢«å¯åŠ¨ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">registerListenerImpl</span><span class="params">(SensorEventListener listener, Sensor sensor,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> delay, Handler handler)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (sListeners) &#123;</span><br><span class="line">            <span class="type">ListenerDelegate</span> <span class="variable">l</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (ListenerDelegate i : sListeners) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i.getListener() == listener) &#123;</span><br><span class="line">                    l = i;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            â€¦â€¦.</span><br><span class="line">            <span class="comment">// if we don&#x27;t find it, add it to the list</span></span><br><span class="line">            <span class="keyword">if</span> (l == <span class="literal">null</span>) &#123;</span><br><span class="line">                l = <span class="keyword">new</span> <span class="title class_">ListenerDelegate</span>(listener, sensor, handler);</span><br><span class="line">                sListeners.add(l);</span><br><span class="line">                  â€¦â€¦</span><br><span class="line">                    <span class="keyword">if</span> (sSensorThread.startLocked()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!enableSensorLocked(sensor, delay)) &#123;</span><br><span class="line">                          â€¦â€¦.</span><br><span class="line">                        &#125;</span><br><span class="line">                 â€¦â€¦</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!l.hasSensor(sensor)) &#123;</span><br><span class="line">                l.addSensor(sensor);</span><br><span class="line">                <span class="keyword">if</span> (!enableSensorLocked(sensor, delay)) &#123;</span><br><span class="line">                    â€¦â€¦</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨openå‡½æ•°ä¸­è°ƒç”¨JNIå‡½æ•°sensors_create_queue()æ¥åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—,ç„¶åè°ƒç”¨SensorManager. createEventQueue()åˆ›å»ºã€‚åœ¨startLockedå‡½æ•°ä¸­å¯åŠ¨æ–°çš„çº¿ç¨‹åï¼Œåšäº†ä¸€ä¸ªwhileçš„ç­‰å¾…while (mSensorsReady &#x3D;&#x3D; false)ï¼Œåªæœ‰å½“mSensorsReadyç­‰äºtrueçš„æ—¶å€™ï¼Œæ‰ä¼šæ‰§è¡ŒenableSensorLocked()å‡½æ•°å¯¹sensorä½¿èƒ½ã€‚è€ŒmSensorsReadyå˜é‡ï¼Œæ˜¯åœ¨open()è°ƒç”¨åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—æˆåŠŸä¹‹åæ‰ä¼štrueï¼Œæ‰€ä»¥è®¤ä¸ºï¼Œä¸‰ä¸ªåŠŸèƒ½è°ƒç”¨é¡ºåºæ˜¯å¦‚ä¸‹ï¼š<ol><li>è°ƒç”¨openå‡½æ•°åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—</li><li>è°ƒç”¨enableSensorLocked()å‡½æ•°å¯¹sensorä½¿èƒ½</li><li>è°ƒç”¨sensors_data_pollä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ•°æ®ï¼Œè€Œä¸”æ˜¯åœ¨while (true)å¾ªç¯é‡Œä¸€ç›´è¯»å–</li></ol></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">startLocked</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (mThread == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">SensorThreadRunnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SensorThreadRunnable</span>();</span><br><span class="line">                    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, SensorThread.class.getName());</span><br><span class="line">                    thread.start();</span><br><span class="line">                    <span class="keyword">synchronized</span> (runnable) &#123;  <span class="comment">//é˜Ÿåˆ—åˆ›å»ºæˆåŠŸ,çº¿ç¨‹åŒæ­¥</span></span><br><span class="line">                        <span class="keyword">while</span> (mSensorsReady == <span class="literal">false</span>) &#123;</span><br><span class="line">                            runnable.wait();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">SensorThreadRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">            SensorThreadRunnable() &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">open</span><span class="params">()</span> &#123;</span><br><span class="line">                sQueue = sensors_create_queue();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                â€¦â€¦.</span><br><span class="line">                <span class="keyword">if</span> (!open()) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                    mSensorsReady = <span class="literal">true</span>;</span><br><span class="line">                    <span class="built_in">this</span>.notify();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">sensor</span> <span class="operator">=</span> sensors_data_poll(sQueue, values, status, timestamp);</span><br><span class="line">                    â€¦â€¦.</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="æœåŠ¡ç«¯å®ç°"><a href="#æœåŠ¡ç«¯å®ç°" class="headerlink" title="æœåŠ¡ç«¯å®ç°"></a>æœåŠ¡ç«¯å®ç°</h2><h3 id="è°ƒç”¨æ—¶åºå›¾-1"><a href="#è°ƒç”¨æ—¶åºå›¾-1" class="headerlink" title="è°ƒç”¨æ—¶åºå›¾"></a>è°ƒç”¨æ—¶åºå›¾</h3><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/sensorFramework/4.png"/><h3 id="å¯åŠ¨SensorServiceæœåŠ¡"><a href="#å¯åŠ¨SensorServiceæœåŠ¡" class="headerlink" title="å¯åŠ¨SensorServiceæœåŠ¡"></a>å¯åŠ¨SensorServiceæœåŠ¡</h3><ul><li>åœ¨SystemServerè¿›ç¨‹ä¸­çš„mainå‡½æ•°ä¸­ï¼Œé€šè¿‡JNIè°ƒç”¨ï¼Œè°ƒç”¨åˆ°<code>com_android_server_SystemServer.cpp</code>çš„<code>android_server_SystemServer_init1()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åˆè°ƒç”¨<code>system_init.cppä¸­çš„system_init()</code>ï¼Œåœ¨è¿™é‡Œåˆ›å»ºäº†SensorServiceçš„å®ä¾‹ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">status_t</span> <span class="title">system_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    â€¦â€¦</span><br><span class="line">    <span class="built_in">property_get</span>(<span class="string">&quot;system_init.startsensorservice&quot;</span>, propBuf, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(propBuf, <span class="string">&quot;1&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Start the sensor service</span></span><br><span class="line">        SensorService::<span class="built_in">instantiate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    â€¦..</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="SensorServiceåˆå§‹åŒ–"><a href="#SensorServiceåˆå§‹åŒ–" class="headerlink" title="SensorServiceåˆå§‹åŒ–"></a>SensorServiceåˆå§‹åŒ–</h3><ul><li>SensorServiceåˆ›å»ºå®Œä¹‹åï¼Œå°†ä¼šè°ƒç”¨SensorService::onFirstRef()æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­å®Œæˆåˆå§‹åŒ–å·¥ä½œã€‚é¦–å…ˆè·å–SensorDeviceå®ä¾‹ï¼Œåœ¨å…¶æ„é€ å‡½æ•°ä¸­ï¼Œå®Œæˆäº†å¯¹Sensoræ¨¡å—HALçš„åˆå§‹åŒ–ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">SensorDevice::<span class="built_in">SensorDevice</span>()</span><br><span class="line">    :  <span class="built_in">mSensorDevice</span>(<span class="number">0</span>),</span><br><span class="line">       <span class="built_in">mSensorModule</span>(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">status_t</span> err = <span class="built_in">hw_get_module</span>(SENSORS_HARDWARE_MODULE_ID,</span><br><span class="line">            (<span class="type">hw_module_t</span> <span class="type">const</span>**)&amp;mSensorModule);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mSensorModule) &#123;</span><br><span class="line">        err = <span class="built_in">sensors_open</span>(&amp;mSensorModule-&gt;common, &amp;mSensorDevice);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">ALOGE_IF</span>(err, <span class="string">&quot;couldn&#x27;t open device for module %s (%s)&quot;</span>,</span><br><span class="line">                SENSORS_HARDWARE_MODULE_ID, <span class="built_in">strerror</span>(-err));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mSensorDevice) &#123;</span><br><span class="line">            <span class="type">sensor_t</span> <span class="type">const</span>* list;</span><br><span class="line">            <span class="type">ssize_t</span> count = mSensorModule-&gt;<span class="built_in">get_sensors_list</span>(mSensorModule, &amp;list);</span><br><span class="line">            mActivationCount.<span class="built_in">setCapacity</span>(count);</span><br><span class="line">            Info model;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i=<span class="number">0</span> ; i&lt;<span class="built_in">size_t</span>(count) ; i++) &#123;</span><br><span class="line">                mActivationCount.<span class="built_in">add</span>(list[i].handle, model);</span><br><span class="line">                mSensorDevice-&gt;<span class="built_in">activate</span>(mSensorDevice, list[i].handle, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>è¿™é‡Œä¸»è¦åšäº†ä¸‰ä¸ªå·¥ä½œï¼š</p><ol><li>è°ƒç”¨HALå±‚çš„hw_get_modele()æ–¹æ³•ï¼ŒåŠ è½½Sensoræ¨¡å—soæ–‡ä»¶</li><li>è°ƒç”¨sensor.hçš„sensors_openæ–¹æ³•æ‰“å¼€è®¾å¤‡</li><li>è°ƒç”¨sensors_poll_device_t-&gt;activate()å¯¹Sensoræ¨¡å—ä½¿èƒ½</li></ol></li><li><p>å†çœ‹çœ‹SensorService::onFirstRef()æ–¹æ³•:</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SensorService::onFirstRef</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">SensorDevice&amp; <span class="title">dev</span><span class="params">(SensorDevice::getInstance())</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dev.<span class="built_in">initCheck</span>() == NO_ERROR) &#123;</span><br><span class="line">        <span class="type">sensor_t</span> <span class="type">const</span>* list;</span><br><span class="line">        <span class="type">ssize_t</span> count = dev.<span class="built_in">getSensorList</span>(&amp;list);</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            â€¦â€¦</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">ssize_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">                <span class="built_in">registerSensor</span>( <span class="keyword">new</span> <span class="built_in">HardwareSensor</span>(list[i]) );</span><br><span class="line">                â€¦â€¦</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// it&#x27;s safe to instantiate the SensorFusion object here</span></span><br><span class="line">            <span class="comment">// (it wants to be instantiated after h/w sensors have been</span></span><br><span class="line">            <span class="comment">// registered)</span></span><br><span class="line">            <span class="function"><span class="type">const</span> SensorFusion&amp; <span class="title">fusion</span><span class="params">(SensorFusion::getInstance())</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (hasGyro) &#123;</span><br><span class="line">               â€¦â€¦</span><br><span class="line">            &#125;</span><br><span class="line">            â€¦â€¦</span><br><span class="line">            <span class="built_in">run</span>(<span class="string">&quot;SensorService&quot;</span>, PRIORITY_URGENT_DISPLAY);</span><br><span class="line">            mInitCheck = NO_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¸»è¦åšäº†4ä»¶äº‹æƒ…ï¼š</p><ol><li>åˆ›å»ºSensorDeviceå®ä¾‹</li><li>è·å–Sensoråˆ—è¡¨</li><li>è°ƒç”¨SensorDevice.getSensorList(),è·å–Sensoræ¨¡å—æ‰€æœ‰ä¼ æ„Ÿå™¨åˆ—è¡¨</li><li>ä¸ºæ¯ä¸ªä¼ æ„Ÿå™¨æ³¨å†Œç›‘å¬å™¨</li></ol></li><li><p><code>registerSensor(new HardwareSensor(list[i]))</code>;</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SensorService::registerSensor</span><span class="params">(SensorInterface* s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">sensors_event_t</span> event;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;event, <span class="number">0</span>, <span class="built_in">sizeof</span>(event));</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> Sensor <span class="title">sensor</span><span class="params">(s-&gt;getSensor())</span></span>;</span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°Sensoråˆ—è¡¨ï¼Œç»™å®¢æˆ·ç«¯ä½¿ç”¨</span></span><br><span class="line">    mSensorList.<span class="built_in">add</span>(sensor);</span><br><span class="line">    <span class="comment">// add to our handle-&gt;SensorInterface mapping</span></span><br><span class="line">    mSensorMap.<span class="built_in">add</span>(sensor.<span class="built_in">getHandle</span>(), s);</span><br><span class="line">    <span class="comment">// create an entry in the mLastEventSeen array</span></span><br><span class="line">    mLastEventSeen.<span class="built_in">add</span>(sensor.<span class="built_in">getHandle</span>(), event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>HardwareSensorå®ç°äº†SensorInterfaceæ¥å£ã€‚å¯åŠ¨çº¿ç¨‹è¯»å–æ•°æ®ï¼Œè°ƒç”¨runæ–¹æ³•å¯åŠ¨æ–°çº¿ç¨‹ï¼Œå°†è°ƒç”¨SensorService::threadLoop()æ–¹æ³•ã€‚</li></ul><h3 id="åœ¨æ–°çš„çº¿ç¨‹ä¸­è¯»å–HALå±‚æ•°æ®"><a href="#åœ¨æ–°çš„çº¿ç¨‹ä¸­è¯»å–HALå±‚æ•°æ®" class="headerlink" title="åœ¨æ–°çš„çº¿ç¨‹ä¸­è¯»å–HALå±‚æ•°æ®"></a>åœ¨æ–°çš„çº¿ç¨‹ä¸­è¯»å–HALå±‚æ•°æ®</h3><ul><li>SensorServiceå®ç°äº†Threadç±»ï¼Œå½“åœ¨onFirstRefä¸­è°ƒç”¨runæ–¹æ³•åï¼Œå°†åœ¨æ–°çš„çº¿ç¨‹ä¸­è°ƒç”¨<code>SensorService::threadLoop()</code>æ–¹æ³•ã€‚åœ¨whileå¾ªç¯ä¸­ä¸€ç›´è¯»å–HALå±‚æ•°æ®ï¼Œå†è°ƒç”¨<code>SensorEventConnection-&gt;sendEvents</code>å°†æ•°æ®å†™åˆ°ç®¡é“ä¸­ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SensorService::threadLoop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    â€¦â€¦</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        count = device.<span class="built_in">poll</span>(buffer, numEventMax);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">recordLastValue</span>(buffer, count);</span><br><span class="line">        â€¦â€¦</span><br><span class="line"></span><br><span class="line">        <span class="comment">// send our events to clients...</span></span><br><span class="line">        <span class="type">const</span> SortedVector&lt; wp&lt;SensorEventConnection&gt; &gt; <span class="built_in">activeConnections</span>(</span><br><span class="line">                <span class="built_in">getActiveConnections</span>());</span><br><span class="line">        <span class="type">size_t</span> numConnections = activeConnections.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i=<span class="number">0</span> ; i&lt;numConnections ; i++) &#123;</span><br><span class="line">            <span class="function">sp&lt;SensorEventConnection&gt; <span class="title">connection</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">                    activeConnections[i].promote())</span></span>;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="number">0</span>) &#123;</span><br><span class="line">                connection-&gt;<span class="built_in">sendEvents</span>(buffer, count, scratch);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (count &gt;= <span class="number">0</span> || Thread::<span class="built_in">exitPending</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡"><a href="#å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡" class="headerlink" title="å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡"></a>å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡</h2><h3 id="æ•°æ®ä¼ é€"><a href="#æ•°æ®ä¼ é€" class="headerlink" title="æ•°æ®ä¼ é€"></a>æ•°æ®ä¼ é€</h3><ul><li>å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡çš„çŠ¶æ€å›¾ï¼š</li></ul><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/sensorFramework/5.png"/><ul><li>å®¢æˆ·ç«¯æœåŠ¡ç«¯çº¿ç¨‹ï¼Œåœ¨å›¾ä¸­å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼š<ol><li>ä¸€ä¸ªæ˜¯æœåŠ¡ç«¯çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹è´Ÿè´£æºæºä¸æ–­çš„ä»HALè¯»å–æ•°æ®ã€‚</li><li>å¦ä¸€ä¸ªæ˜¯å®¢æˆ·ç«¯çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œå®¢æˆ·ç«¯çº¿ç¨‹è´Ÿè´£ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»æ•°æ®ã€‚</li></ol></li><li>åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®¢æˆ·ç«¯å¯ä»¥åˆ›å»ºå¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å¯¹åº”æœ‰ä¸€ä¸ªä¸æœåŠ¡å™¨é€šä¿¡çš„è¿æ¥æ¥å£</li><li>åˆ›å»ºè¿æ¥æ¥å£ï¼ŒæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯æ²Ÿé€šçš„æ¡¥æ¢ï¼ŒæœåŠ¡ç«¯è¯»å–åˆ°HALå±‚æ•°æ®åï¼Œä¼šæ‰«é¢æœ‰å¤šå°‘ä¸ªä¸å®¢æˆ·ç«¯è¿æ¥çš„æ¥å£ï¼Œç„¶åå¾€æ¯ä¸ªæ¥å£çš„ç®¡é“ä¸­å†™æ•°æ®</li><li>åˆ›å»ºç®¡é“ï¼Œæ¯ä¸€ä¸ªè¿æ¥æ¥å£éƒ½æœ‰å¯¹åº”çš„ä¸€ä¸ªç®¡é“ã€‚</li><li>ä¸Šé¢æ˜¯è®¾è®¡è€…è®¾è®¡æ•°æ®ä¼ é€çš„åŸç†ï¼Œä½†æ˜¯ç›®å‰Androidä¸Šé¢çš„æ•°æ®ä¼ é€ä¸èƒ½å®Œå…¨æŒ‰ç…§ä¸Šé¢çš„ç†è§£ã€‚å› ä¸ºåœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæ¶ˆæ¯é˜Ÿåˆ—åªä¼šåˆ›å»ºä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯è¯´å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´çš„é€šä¿¡åªæœ‰ä¸€ä¸ªè¿æ¥æ¥å£ï¼Œåªæœ‰ä¸€ä¸ªç®¡é“ä¼ æ•°æ®ã€‚é‚£ä¹ˆæ•°æ®çš„å½¢å¼æ˜¯æ€ä¹ˆä»HALå±‚ä¼ åˆ°JAVAå±‚çš„å‘¢ï¼Ÿå…¶å®æ•°æ®æ˜¯ä»¥ä¸€ä¸ªç»“æ„ä½“sensors_event_tçš„å½¢å¼ä»HALå±‚ä¼ åˆ°JNIå±‚ã€‚çœ‹çœ‹HALçš„sensors_event_tç»“æ„ä½“ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">sensors_event_t</span> &#123;</span><br><span class="line">    <span class="type">int32_t</span> version;</span><br><span class="line">    <span class="type">int32_t</span> sensor;            <span class="comment">//æ ‡è¯†ç¬¦</span></span><br><span class="line">    <span class="type">int32_t</span> type;             <span class="comment">//ä¼ æ„Ÿå™¨ç±»å‹</span></span><br><span class="line">    <span class="type">int32_t</span> reserved0;</span><br><span class="line">    <span class="type">int64_t</span> timestamp;        <span class="comment">//æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="type">float</span>           data[<span class="number">16</span>];</span><br><span class="line">        <span class="type">sensors_vec_t</span>   acceleration;   <span class="comment">//åŠ é€Ÿåº¦</span></span><br><span class="line">        <span class="type">sensors_vec_t</span>   magnetic;      <span class="comment">//ç£çŸ¢é‡</span></span><br><span class="line">        <span class="type">sensors_vec_t</span>   orientation;     <span class="comment">//æ–¹å‘</span></span><br><span class="line">        <span class="type">sensors_vec_t</span>   gyro;          <span class="comment">//é™€èºä»ª</span></span><br><span class="line">        <span class="type">float</span>           temperature;     <span class="comment">//æ¸©åº¦</span></span><br><span class="line">        <span class="type">float</span>           distance;        <span class="comment">//è·ç¦»</span></span><br><span class="line">        <span class="type">float</span>           light;           <span class="comment">//å…‰ç…§</span></span><br><span class="line">        <span class="type">float</span>           pressure;         <span class="comment">//å‹åŠ›</span></span><br><span class="line">        <span class="type">float</span>           relative_humidity;  <span class="comment">//ç›¸å¯¹æ¹¿åº¦</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">uint32_t</span>        reserved1[<span class="number">4</span>];</span><br><span class="line">&#125; <span class="type">sensors_event_t</span>;</span><br></pre></td></tr></table></figure><ul><li>åœ¨JNIå±‚æœ‰ä¸€ä¸ªASensorEventç»“æ„ä½“ä¸sensors_event_tå‘å¯¹åº”ï¼Œframeworks&#x2F;native&#x2F;include&#x2F;android&#x2F;sensor.hï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">ASensorEvent</span> &#123;</span><br><span class="line">    <span class="type">int32_t</span> version;</span><br><span class="line">    <span class="type">int32_t</span> sensor;</span><br><span class="line">    <span class="type">int32_t</span> type;</span><br><span class="line">    <span class="type">int32_t</span> reserved0;</span><br><span class="line">    <span class="type">int64_t</span> timestamp;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="type">float</span>           data[<span class="number">16</span>];</span><br><span class="line">        ASensorVector   vector;</span><br><span class="line">        ASensorVector   acceleration;</span><br><span class="line">        ASensorVector   magnetic;</span><br><span class="line">        <span class="type">float</span>           temperature;</span><br><span class="line">        <span class="type">float</span>           distance;</span><br><span class="line">        <span class="type">float</span>           light;</span><br><span class="line">        <span class="type">float</span>           pressure;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">int32_t</span> reserved1[<span class="number">4</span>];</span><br><span class="line">&#125; ASensorEvent;</span><br></pre></td></tr></table></figure><h2 id="äº¤äº’è°ƒç”¨æ—¶åºå›¾"><a href="#äº¤äº’è°ƒç”¨æ—¶åºå›¾" class="headerlink" title="äº¤äº’è°ƒç”¨æ—¶åºå›¾"></a>äº¤äº’è°ƒç”¨æ—¶åºå›¾</h2><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/sensorFramework/6.jpg"/><ul><li>ç»è¿‡å‰é¢çš„ä»‹ç»ï¼Œç°åœ¨çŸ¥é“äº†å®¢æˆ·ç«¯å®ç°çš„æ–¹å¼åŠæœåŠ¡ç«¯çš„å®ç°ï¼Œä½†æ˜¯æ²¡æœ‰å…·ä½“è®²åˆ°å®ƒä»¬æ˜¯å¦‚ä½•è¿›è¡Œé€šä¿¡çš„ï¼Œç°åœ¨çœ‹çœ‹å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´çš„é€šä¿¡ã€‚</li><li>ä¸»è¦æ¶‰åŠçš„æ˜¯è¿›ç¨‹é—´é€šä¿¡ï¼Œæœ‰IBindå’Œç®¡é“é€šä¿¡ã€‚</li><li>å®¢æˆ·ç«¯é€šè¿‡IBindé€šä¿¡è·å–åˆ°æœåŠ¡ç«¯çš„è¿œç¨‹è°ƒç”¨ï¼Œç„¶åé€šè¿‡ç®¡é“è¿›è¡Œsensoræ•°æ®çš„ä¼ è¾“ã€‚</li></ul><h3 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h3><ul><li>nativeå±‚å®ç°äº†sensoræœåŠ¡çš„æ ¸å¿ƒå®ç°ï¼ŒSensoræœåŠ¡çš„ä¸»è¦æµç¨‹çš„å®ç°åœ¨sensorserviceç±»ä¸­ï¼Œä¸‹é¢é‡ç‚¹åˆ†æä¸‹è¿™ä¸ªç±»çš„æµç¨‹ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SensorService</span> :</span><br><span class="line">        <span class="keyword">public</span> BinderService&lt;SensorService&gt;,</span><br><span class="line">        <span class="keyword">public</span> BnSensorServer,</span><br><span class="line">        <span class="keyword">protected</span> Thread</span><br></pre></td></tr></table></figure><ul><li>çœ‹çœ‹sensorServiceç»§æ‰¿çš„ç±»:ç»§æ‰¿BinderService<SensorService>è¿™ä¸ªæ¨¡æ¿ç±»æ·»åŠ åˆ°ç³»ç»ŸæœåŠ¡,ç”¨äºIbinderè¿›ç¨‹é—´é€šä¿¡ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> SERVICE&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BinderService</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">status_t</span> <span class="title">publish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="function">sp&lt;IServiceManager&gt; <span class="title">sm</span><span class="params">(defaultServiceManager())</span></span>;</span><br><span class="line">        <span class="keyword">return</span> sm-&gt;<span class="built_in">addService</span>(<span class="built_in">String16</span>(SERVICE::<span class="built_in">getServiceName</span>()), <span class="keyword">new</span> <span class="built_in">SERVICE</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">publishAndJoinThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="function">sp&lt;ProcessState&gt; <span class="title">proc</span><span class="params">(ProcessState::self())</span></span>;</span><br><span class="line">        <span class="function">sp&lt;IServiceManager&gt; <span class="title">sm</span><span class="params">(defaultServiceManager())</span></span>;</span><br><span class="line">        sm-&gt;<span class="built_in">addService</span>(<span class="built_in">String16</span>(SERVICE::<span class="built_in">getServiceName</span>()), <span class="keyword">new</span> <span class="built_in">SERVICE</span>());</span><br><span class="line">        ProcessState::<span class="built_in">self</span>()-&gt;<span class="built_in">startThreadPool</span>();</span><br><span class="line">        IPCThreadState::<span class="built_in">self</span>()-&gt;<span class="built_in">joinThreadPool</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">instantiate</span><span class="params">()</span> </span>&#123; <span class="built_in">publish</span>(); &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;; <span class="comment">// namespace android</span></span><br></pre></td></tr></table></figure><ul><li><p>åœ¨å‰é¢çš„ä»‹ç»ä¸­ï¼ŒSensorServiceæœåŠ¡çš„å®ä¾‹æ˜¯åœ¨System_init.cppä¸­è°ƒç”¨SensorService::instantiate()åˆ›å»ºçš„ï¼Œå³è°ƒç”¨äº†ä¸Šé¢çš„instantiate()æ–¹æ³•ï¼Œæ¥ç€è°ƒç”¨äº†publish(),åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†new SensorServiceçš„å®ä¾‹ï¼Œå¹¶ä¸”è°ƒç”¨äº†defaultServiceManager::addService()å°†SensoræœåŠ¡æ·»åŠ åˆ°äº†ç³»ç»ŸæœåŠ¡ç®¡ç†ä¸­ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡defaultServiceManager:getService()è·å–åˆ°SensoræœåŠ¡çš„å®ä¾‹ã€‚</p></li><li><p>ç»§æ‰¿BnSensorServerè¿™ä¸ªæ˜¯sensoræœåŠ¡æŠ½è±¡æ¥å£ç±»æä¾›ç»™å®¢æˆ·ç«¯è°ƒç”¨ï¼š</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Sensor</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ISensorEventConnection</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ISensorServer</span> : <span class="keyword">public</span> IInterface</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">DECLARE_META_INTERFACE</span>(SensorServer);</span><br><span class="line">    <span class="comment">//è·å–Sensoråˆ—è¡¨</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> Vector&lt;Sensor&gt; <span class="title">getSensorList</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªè¿æ¥çš„æ¥å£,è¿™äº›éƒ½æ˜¯æä¾›ç»™å®¢æˆ·ç«¯çš„æŠ½è±¡æ¥å£,æœåŠ¡ç«¯å®ä¾‹åŒ–æ—¶å€™å¿…é¡»å®ç°</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> sp&lt;ISensorEventConnection&gt; <span class="title">createSensorEventConnection</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BnSensorServer</span> : <span class="keyword">public</span> BnInterface&lt;ISensorServer&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//ä¼ è¾“æ‰“åŒ…æ•°æ®çš„é€šè®¯æ¥å£,åœ¨BnSensorServerè¢«å®ç°</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">status_t</span>    <span class="title">onTransact</span><span class="params">( <span class="type">uint32_t</span> code,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">const</span> Parcel&amp; data,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    Parcel* reply,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">uint32_t</span> flags = <span class="number">0</span>)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;; <span class="comment">// namespace android</span></span><br></pre></td></tr></table></figure><ul><li>ISensorServeræ¥å£æä¾›äº†ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ç»™å®¢æˆ·ç«¯è°ƒç”¨ï¼Œå…³é”®åœ¨äºcreateSensorEventConnection()æ–¹æ³•ï¼Œè¯¥åœ¨æœåŠ¡ç«¯è¢«å®ç°ï¼Œåœ¨å®¢æˆ·ç«¯è¢«è°ƒç”¨ï¼Œå¹¶è¿”å›ä¸€ä¸ªSensorEventConnectionçš„å®ä¾‹ï¼Œåˆ›å»ºè¿æ¥ï¼Œå®¢æˆ·ç«¯æ‹¿åˆ°SensorEventConnectionå®ä¾‹ä¹‹åï¼Œå¯ä»¥å¯¹sensorè¿›è¡Œé€šä¿¡æ“ä½œï¼Œä»…ä»…ä½œä¸ºé€šä¿¡çš„æ¥å£è€Œå·²ï¼Œå®ƒå¹¶æ²¡æœ‰ç”¨æ¥ä¼ é€Sensoræ•°æ®ï¼Œå› ä¸ºSensoræ•°æ®é‡æ¯”è¾ƒå¤§ï¼ŒIBindå®ç°æ¯”è¾ƒå›°éš¾ã€‚çœŸæ­£å®ç°Sensoræ•°æ®ä¼ é€çš„æ˜¯ç®¡é“ï¼Œåœ¨åˆ›å»ºSensorEventConnectionå®ä¾‹ä¸­ï¼Œåˆ›å»ºäº†BitTubeå¯¹è±¡ï¼Œé‡Œé¢åˆ›å»ºäº†ç®¡é“ï¼Œç”¨äºå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡ã€‚</li></ul><h3 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h3><ul><li>æ—¶åºå›¾ï¼š</li></ul><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/sensorFramework/7.png"/><ul><li>å®¢æˆ·ç«¯ä¸»è¦åœ¨SensorManager.cppä¸­åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—:</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ISensorEventConnection</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sensor</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Looper</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SensorEventQueue</span> : <span class="keyword">public</span> ASensorEventQueue, <span class="keyword">public</span> RefBase</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">SensorEventQueue</span>(<span class="type">const</span> sp&lt;ISensorEventConnection&gt;&amp; connection);</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">SensorEventQueue</span>();</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">onFirstRef</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//è·å–ç®¡é“å¥æŸ„</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getFd</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">//å‘ç®¡é“å†™æ•°æ®</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title">write</span><span class="params">(<span class="type">const</span> sp&lt;BitTube&gt;&amp; tube,</span></span></span><br><span class="line"><span class="params"><span class="function">            ASensorEvent <span class="type">const</span>* events, <span class="type">size_t</span> numEvents)</span></span>;</span><br><span class="line">    <span class="comment">//å‘ç®¡é“è¯»æ•°æ®</span></span><br><span class="line">    <span class="function"><span class="type">ssize_t</span> <span class="title">read</span><span class="params">(ASensorEvent* events, <span class="type">size_t</span> numEvents)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">status_t</span> <span class="title">waitForEvent</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">status_t</span> <span class="title">wake</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">//ä½¿èƒ½Sensorä¼ æ„Ÿå™¨</span></span><br><span class="line">    <span class="function"><span class="type">status_t</span> <span class="title">enableSensor</span><span class="params">(Sensor <span class="type">const</span>* sensor)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">status_t</span> <span class="title">disableSensor</span><span class="params">(Sensor <span class="type">const</span>* sensor)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">status_t</span> <span class="title">setEventRate</span><span class="params">(Sensor <span class="type">const</span>* sensor, <span class="type">nsecs_t</span> ns)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// these are here only to support SensorManager.java</span></span><br><span class="line">    <span class="function"><span class="type">status_t</span> <span class="title">enableSensor</span><span class="params">(<span class="type">int32_t</span> handle, <span class="type">int32_t</span> us)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">status_t</span> <span class="title">disableSensor</span><span class="params">(<span class="type">int32_t</span> handle)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="function">sp&lt;Looper&gt; <span class="title">getLooper</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="comment">//è¿æ¥æ¥å£ï¼Œåœ¨SensorServiceä¸­åˆ›å»ºçš„</span></span><br><span class="line">sp&lt;ISensorEventConnection&gt; mSensorEventConnection;</span><br><span class="line"><span class="comment">//ç®¡é“æŒ‡é’ˆ</span></span><br><span class="line">    sp&lt;BitTube&gt; mSensorChannel;</span><br><span class="line">    <span class="keyword">mutable</span> Mutex mLock;</span><br><span class="line">    <span class="keyword">mutable</span> sp&lt;Looper&gt; mLooper;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>SensorEventQueueç±»ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½œç”¨éå¸¸é‡è¦ï¼Œåœ¨åˆ›å»ºå…¶å®ä¾‹çš„æ—¶å€™ï¼Œä¼ å…¥äº†SensorEventConnectionçš„å®ä¾‹ï¼ŒSensorEventConnectionç»§æ‰¿äºISensorEventConnectionã€‚SensorEventConnectionå…¶å®æ˜¯å®¢æˆ·ç«¯è°ƒç”¨SensorServiceçš„createSensorEventConnection()æ–¹æ³•åˆ›å»ºçš„ï¼Œå®ƒæ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æ²Ÿé€šçš„æ¡¥æ¢ï¼Œé€šè¿‡è¿™ä¸ªæ¡¥æ¢ï¼Œå¯ä»¥å®Œæˆä¸€ä¸‹ä»»åŠ¡ï¼š<ol><li>è·å–ç®¡é“çš„å¥æŸ„</li><li>å¾€ç®¡é“è¯»å†™æ•°æ®</li><li>é€šçŸ¥æœåŠ¡ç«¯å¯¹Sensorä½¿èƒ½</li></ol></li></ul><h2 id="æµç¨‹è§£æ"><a href="#æµç¨‹è§£æ" class="headerlink" title="æµç¨‹è§£æ"></a>æµç¨‹è§£æ</h2><h3 id="å®¢æˆ·ç«¯è·å–SensorServiceæœåŠ¡å®ä¾‹"><a href="#å®¢æˆ·ç«¯è·å–SensorServiceæœåŠ¡å®ä¾‹" class="headerlink" title="å®¢æˆ·ç«¯è·å–SensorServiceæœåŠ¡å®ä¾‹"></a>å®¢æˆ·ç«¯è·å–SensorServiceæœåŠ¡å®ä¾‹</h3><ul><li>å®¢æˆ·ç«¯åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå³SystemSensorManagerçš„æ„é€ å‡½æ•°ä¸­ï¼Œé€šè¿‡JNIè°ƒç”¨ï¼Œåˆ›å»ºnativeå±‚SensorManagerçš„å®ä¾‹ï¼Œç„¶åè°ƒç”¨SensorManager::assertStateLocked()æ–¹æ³•åšä¸€äº›åˆå§‹åŒ–çš„åŠ¨ä½œã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">SensorManager::assertStateLocked</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mSensorServer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// try for one second</span></span><br><span class="line">        <span class="function"><span class="type">const</span> String16 <span class="title">name</span><span class="params">(<span class="string">&quot;sensorservice&quot;</span>)</span></span>;</span><br><span class="line">        â€¦â€¦</span><br><span class="line">            <span class="type">status_t</span> err = <span class="built_in">getService</span>(name, &amp;mSensorServer);</span><br><span class="line">        â€¦â€¦</span><br><span class="line">        mSensors = mSensorServer-&gt;<span class="built_in">getSensorList</span>();</span><br><span class="line">        <span class="type">size_t</span> count = mSensors.<span class="built_in">size</span>();</span><br><span class="line">        mSensorList = (Sensor <span class="type">const</span>**)<span class="built_in">malloc</span>(count * <span class="built_in">sizeof</span>(Sensor*));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">            mSensorList[i] = mSensors.<span class="built_in">array</span>() + i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å‰é¢æˆ‘ä»¬è®²åˆ°è¿‡ï¼ŒSensorServiceçš„åˆ›å»ºçš„æ—¶å€™è°ƒç”¨äº†defaultServiceManager:getService()å°†æœåŠ¡æ·»åŠ åˆ°äº†ç³»ç»ŸæœåŠ¡ç®¡ç†ä¸­ã€‚ç°åœ¨æˆ‘ä»¬åˆè°ƒç”¨defaultServiceManager::geService()è·å–åˆ°SensorServiceæœåŠ¡çš„å®ä¾‹ã€‚åœ¨é€šè¿‡IBindé€šä¿¡ï¼Œå°±å¯ä»¥è·å–åˆ°Sensoråˆ—è¡¨ï¼Œæ‰€ä»¥åœ¨å®¢æˆ·ç«¯åˆå§‹åŒ–çš„æ—¶å€™ï¼Œåšäº†ä¸¤ä»¶äº‹æƒ…ï¼š<ol><li>è·å–SensorServiceå®ä¾‹å¼•ç”¨</li><li>è·å–Sensorä¼ æ„Ÿå™¨åˆ—è¡¨</li></ol></li></ul><h3 id="æ³¨å†ŒSensorLisenter"><a href="#æ³¨å†ŒSensorLisenter" class="headerlink" title="æ³¨å†ŒSensorLisenter"></a>æ³¨å†ŒSensorLisenter</h3><ul><li>æ—¶åºå›¾ï¼š</li></ul><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/sensorFramework/8.png"/><ul><li><code>new ListenerDelegate(SensorEventListener listener, Sensor sensor, Handler handler)</code>åœ¨è¿™ä¸ªæ„é€ å‡½æ•°ä¸­ä¼šåˆ›å»ºä¸€ä¸ªHandlerï¼Œå®ƒä¼šåœ¨è·å–åˆ°Sensoræ•°æ®çš„æ—¶å€™è¢«è°ƒç”¨ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mHandler = <span class="keyword">new</span> <span class="title class_">Handler</span>(looper) &#123;  </span><br><span class="line">                <span class="meta">@Override</span>  </span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;  </span><br><span class="line">                    <span class="keyword">final</span> <span class="type">SensorEvent</span> <span class="variable">t</span> <span class="operator">=</span> (SensorEvent)msg.obj;  </span><br><span class="line">                    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">handle</span> <span class="operator">=</span> t.sensor.getHandle();  </span><br><span class="line"></span><br><span class="line">                    <span class="keyword">switch</span> (t.sensor.getType()) &#123;  </span><br><span class="line">                        <span class="comment">// Only report accuracy for sensors that support it.  </span></span><br><span class="line">                        <span class="keyword">case</span> Sensor.TYPE_MAGNETIC_FIELD:  </span><br><span class="line">                        <span class="keyword">case</span> Sensor.TYPE_ORIENTATION:  </span><br><span class="line">                            <span class="comment">// call onAccuracyChanged() only if the value changes  </span></span><br><span class="line">                            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">accuracy</span> <span class="operator">=</span> mSensorAccuracies.get(handle);  </span><br><span class="line">                            <span class="keyword">if</span> ((t.accuracy &gt;= <span class="number">0</span>) &amp;&amp; (accuracy != t.accuracy)) &#123;  </span><br><span class="line">                                mSensorAccuracies.put(handle, t.accuracy);  </span><br><span class="line">                                mSensorEventListener.onAccuracyChanged(t.sensor, t.accuracy);  </span><br><span class="line">                            &#125;  </span><br><span class="line">                            <span class="keyword">break</span>;  </span><br><span class="line">                        <span class="keyword">default</span>:  </span><br><span class="line">                            <span class="comment">// For other sensors, just report the accuracy once  </span></span><br><span class="line">                            <span class="keyword">if</span> (mFirstEvent.get(handle) == <span class="literal">false</span>) &#123;  </span><br><span class="line">                                mFirstEvent.put(handle, <span class="literal">true</span>);  </span><br><span class="line">                                mSensorEventListener.onAccuracyChanged(  </span><br><span class="line">                                        t.sensor, SENSOR_STATUS_ACCURACY_HIGH);  </span><br><span class="line">                            &#125;  </span><br><span class="line">                            <span class="keyword">break</span>;  </span><br><span class="line">                    &#125;  </span><br><span class="line"></span><br><span class="line">                    mSensorEventListener.onSensorChanged(t);  </span><br><span class="line">                    sPool.returnToPool(t);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;;  </span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—"><a href="#åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—"></a>åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—</h3><ul><li>æ—¶åºå›¾ï¼š</li></ul><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/sensorFramework/9.png"/><ul><li><p>å½“å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡æ³¨å†Œç›‘å¬å™¨çš„æ—¶å€™ï¼Œå°±éœ€è¦åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>androidåœ¨ç›®å‰çš„å®ç°ä¸­ï¼Œåªåˆ›å»ºäº†ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰ä¸€ä¸ªç®¡é“ï¼Œç”¨äºæœåŠ¡ç«¯ä¸å®¢æˆ·æ–­ä¼ é€Sensoræ•°æ®</strong>ã€‚</p></li><li><p>åœ¨SensorManager.cppä¸­çš„createEventQueueæ–¹æ³•åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—ï¼š</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sp&lt;SensorEventQueue&gt; <span class="title">SensorManager::createEventQueue</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;SensorEventQueue&gt; queue;</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line"><span class="keyword">while</span> (<span class="built_in">assertStateLocked</span>() == NO_ERROR) &#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºè¿æ¥æ¥å£</span></span><br><span class="line">        sp&lt;ISensorEventConnection&gt; connection =</span><br><span class="line">                mSensorServer-&gt;<span class="built_in">createSensorEventConnection</span>();</span><br><span class="line">        <span class="keyword">if</span> (connection == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// SensorService just died.</span></span><br><span class="line">            <span class="built_in">LOGE</span>(<span class="string">&quot;createEventQueue: connection is NULL. SensorService died.&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">        queue = <span class="keyword">new</span> <span class="built_in">SensorEventQueue</span>(connection);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨åˆ›å»ºä¸€ä¸ª<code>SensorEventConnection</code>è¿æ¥æ¥å£ï¼Œ<strong>è€Œä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­åŒ…å«ä¸€ä¸ªè¿æ¥æ¥å£</strong>ã€‚åˆ›å»ºè¿æ¥æ¥å£ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sp&lt;ISensorEventConnection&gt; <span class="title">SensorService::createSensorEventConnection</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">sp&lt;SensorEventConnection&gt; <span class="title">result</span><span class="params">(<span class="keyword">new</span> SensorEventConnection(<span class="keyword">this</span>))</span></span>;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">SensorService::SensorEventConnection::<span class="built_in">SensorEventConnection</span>(</span><br><span class="line">        <span class="type">const</span> sp&lt;SensorService&gt;&amp; service)</span><br><span class="line">    : <span class="built_in">mService</span>(service), <span class="built_in">mChannel</span>(<span class="keyword">new</span> <span class="built_in">BitTube</span> ())</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å…³é”®åœ¨äºBitTubeï¼Œåœ¨æ„é€ å‡½æ•°ä¸­åˆ›å»ºäº†ç®¡é“ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">BitTube::<span class="built_in">BitTube</span>()</span><br><span class="line">    : <span class="built_in">mSendFd</span>(<span class="number">-1</span>), <span class="built_in">mReceiveFd</span>(<span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> sockets[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">socketpair</span>(AF_UNIX, SOCK_SEQPACKET, <span class="number">0</span>, sockets) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> size = SOCKET_BUFFER_SIZE;</span><br><span class="line">        <span class="built_in">setsockopt</span>(sockets[<span class="number">0</span>], SOL_SOCKET, SO_SNDBUF, &amp;size, <span class="built_in">sizeof</span>(size));</span><br><span class="line">        <span class="built_in">setsockopt</span>(sockets[<span class="number">0</span>], SOL_SOCKET, SO_RCVBUF, &amp;size, <span class="built_in">sizeof</span>(size));</span><br><span class="line">        <span class="built_in">setsockopt</span>(sockets[<span class="number">1</span>], SOL_SOCKET, SO_SNDBUF, &amp;size, <span class="built_in">sizeof</span>(size));</span><br><span class="line">        <span class="built_in">setsockopt</span>(sockets[<span class="number">1</span>], SOL_SOCKET, SO_RCVBUF, &amp;size, <span class="built_in">sizeof</span>(size));</span><br><span class="line">        <span class="built_in">fcntl</span>(sockets[<span class="number">0</span>], F_SETFL, O_NONBLOCK);</span><br><span class="line">        <span class="built_in">fcntl</span>(sockets[<span class="number">1</span>], F_SETFL, O_NONBLOCK);</span><br><span class="line">        mReceiveFd = sockets[<span class="number">0</span>];</span><br><span class="line">        mSendFd = sockets[<span class="number">1</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mReceiveFd = -errno;</span><br><span class="line">        <span class="built_in">ALOGE</span>(<span class="string">&quot;BitTube: pipe creation failed (%s)&quot;</span>, <span class="built_in">strerror</span>(-mReceiveFd));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å…¶ä¸­ï¼šfds[0]å°±æ˜¯å¯¹åº”çš„mReceiveFd,æ˜¯ç®¡é“çš„è¯»ç«¯ï¼Œsensoræ•°æ®çš„è¯»å–ç«¯ï¼Œå¯¹åº”çš„æ˜¯å®¢æˆ·ç«¯è¿›ç¨‹è®¿é—®çš„ã€‚fds[1]å°±æ˜¯å¯¹åº”mSendFd,æ˜¯ç®¡é“çš„å†™ç«¯,sensoræ•°æ®å†™å…¥ç«¯,æ˜¯sensorçš„æœåŠ¡è¿›ç¨‹è®¿é—®çš„ä¸€ç«¯ã€‚é€šè¿‡pipe(fds)åˆ›å»ºç®¡é“,é€šè¿‡fcntlæ¥è®¾ç½®æ“ä½œç®¡é“çš„æ–¹å¼,è®¾ç½®é€šé“ä¸¤ç«¯çš„æ“ä½œæ–¹å¼ä¸ºO_NONBLOCK ï¼Œéé˜»å¡IOæ–¹å¼ï¼Œreadæˆ–writeè°ƒç”¨è¿”å›-1å’ŒEAGAINé”™è¯¯ã€‚æ€»ç»“ä¸‹æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡æ³¨å†Œç›‘å¬å™¨çš„æ—¶å€™ï¼Œå°±éœ€è¦åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®¢æˆ·ç«¯åˆ›äº†SensorThreadçº¿ç¨‹ä»æ¶ˆæ¯é˜Ÿåˆ—é‡Œé¢è¯»å–æ•°æ®ã€‚SensorEventQueueä¸­æœ‰ä¸€ä¸ªSensorEventConnectionå®ä¾‹çš„å¼•ç”¨ï¼ŒSensorEventConnectionä¸­æœ‰ä¸€ä¸ªBitTubeå®ä¾‹çš„å¼•ç”¨ã€‚</li></ul><h3 id="ä½¿èƒ½Sensor"><a href="#ä½¿èƒ½Sensor" class="headerlink" title="ä½¿èƒ½Sensor"></a>ä½¿èƒ½Sensor</h3><ul><li>å®¢æˆ·ç«¯åˆ›å»ºäº†è¿æ¥æ¥å£SensorEventConnectionåï¼Œå¯ä»¥è°ƒç”¨å…¶æ–¹æ³•ä½¿èƒ½Sensorä¼ æ„Ÿå™¨ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">status_t</span> SensorService::SensorEventConnection::<span class="built_in">enableDisable</span>(</span><br><span class="line">        <span class="type">int</span> handle, <span class="type">bool</span> enabled)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">status_t</span> err;</span><br><span class="line">    <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">        err = mService-&gt;<span class="built_in">enable</span>(<span class="keyword">this</span>, handle);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = mService-&gt;<span class="built_in">disable</span>(<span class="keyword">this</span>, handle);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>handleå¯¹åº”ç€Sensorä¼ æ„Ÿå™¨çš„å¥æŸ„</li></ul><h3 id="æœåŠ¡ç«¯å¾€ç®¡é“å†™æ•°æ®"><a href="#æœåŠ¡ç«¯å¾€ç®¡é“å†™æ•°æ®" class="headerlink" title="æœåŠ¡ç«¯å¾€ç®¡é“å†™æ•°æ®"></a>æœåŠ¡ç«¯å¾€ç®¡é“å†™æ•°æ®</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SensorService::threadLoop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    â€¦â€¦</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        count = device.<span class="built_in">poll</span>(buffer, numEventMax);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">recordLastValue</span>(buffer, count);</span><br><span class="line">        â€¦â€¦</span><br><span class="line"></span><br><span class="line">        <span class="comment">// send our events to clients...</span></span><br><span class="line">        <span class="type">const</span> SortedVector&lt; wp&lt;SensorEventConnection&gt; &gt; <span class="built_in">activeConnections</span>(</span><br><span class="line">                <span class="built_in">getActiveConnections</span>());</span><br><span class="line">        <span class="type">size_t</span> numConnections = activeConnections.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i=<span class="number">0</span> ; i&lt;numConnections ; i++) &#123;</span><br><span class="line">            <span class="function">sp&lt;SensorEventConnection&gt; <span class="title">connection</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">                    activeConnections[i].promote())</span></span>;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="number">0</span>) &#123;</span><br><span class="line">                connection-&gt;<span class="built_in">sendEvents</span>(buffer, count, scratch);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (count &gt;= <span class="number">0</span> || Thread::<span class="built_in">exitPending</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>å‰é¢ä»‹ç»è¿‡ï¼Œåœ¨SensorServiceä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ä¸æ–­ä»HALå±‚è¯»å–Sensoræ•°æ®ï¼Œå°±æ˜¯åœ¨threadLoopæ–¹æ³•ä¸­ã€‚</p></li><li><p>å…³é”®åœ¨ä¸ä¸‹é¢äº†ä¸€ä¸ªforå¾ªç¯ï¼Œå…¶å®æ˜¯æ‰«ææœ‰å¤šå°‘ä¸ªå®¢æˆ·ç«¯è¿æ¥æ¥å£ï¼Œç„¶åå°±å¾€æ²¡æ¯ä¸ªè¿æ¥çš„ç®¡é“ä¸­å†™æ•°æ®</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">status_t</span> SensorService::SensorEventConnection::<span class="built_in">sendEvents</span>(</span><br><span class="line">        <span class="type">sensors_event_t</span> <span class="type">const</span>* buffer, <span class="type">size_t</span> numEvents,</span><br><span class="line">        <span class="type">sensors_event_t</span>* scratch)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// filter out events not for this connection</span></span><br><span class="line">    <span class="type">size_t</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (scratch) &#123;</span><br><span class="line">      â€¦â€¦</span><br><span class="line">    &#125;</span><br><span class="line">    â€¦â€¦</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">ssize_t</span> size = mChannel-&gt;<span class="built_in">write</span>(scratch, count*<span class="built_in">sizeof</span>(<span class="type">sensors_event_t</span>));</span><br><span class="line">    â€¦â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è°ƒç”¨è¯¥è¿æ¥æ¥å£çš„BitTube::write()ï¼Œåˆ°æ­¤ï¼ŒæœåŠ¡ç«¯å°±å®Œæˆäº†å¾€ç®¡é“çš„å†™ç«¯å†™å…¥æ•°æ®:</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">BitTube::write</span><span class="params">(<span class="type">void</span> <span class="type">const</span>* vaddr, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">ssize_t</span> err, len;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        len = ::<span class="built_in">send</span>(mSendFd, vaddr, size, MSG_DONTWAIT | MSG_NOSIGNAL);</span><br><span class="line">        err = len &lt; <span class="number">0</span> ? errno : <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (err == EINTR);</span><br><span class="line">    <span class="keyword">return</span> err == <span class="number">0</span> ? len : -err;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®¢æˆ·ç«¯è¯»ç®¡é“æ•°æ®"><a href="#å®¢æˆ·ç«¯è¯»ç®¡é“æ•°æ®" class="headerlink" title="å®¢æˆ·ç«¯è¯»ç®¡é“æ•°æ®"></a>å®¢æˆ·ç«¯è¯»ç®¡é“æ•°æ®</h3><ul><li>æ—¶åºå›¾:</li></ul><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/sensorFramework/10.png"/><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">SensorEventQueue::read</span><span class="params">(ASensorEvent* events, <span class="type">size_t</span> numEvents)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> BitTube::<span class="built_in">recvObjects</span>(mSensorChannel, events, numEvents);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è°ƒç”¨åˆ°äº†BitTube::read()ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title">recvObjects</span><span class="params">(<span class="type">const</span> sp&lt;BitTube&gt;&amp; tube,</span></span></span><br><span class="line"><span class="params"><span class="function">            T* events, <span class="type">size_t</span> count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">recvObjects</span>(tube, events, count, <span class="built_in">sizeof</span>(T));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">BitTube::recvObjects</span><span class="params">(<span class="type">const</span> sp&lt;BitTube&gt;&amp; tube,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">void</span>* events, <span class="type">size_t</span> count, <span class="type">size_t</span> objSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">ssize_t</span> numObjects = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i=<span class="number">0</span> ; i&lt;count ; i++) &#123;</span><br><span class="line">        <span class="type">char</span>* vaddr = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(events) + objSize * i;</span><br><span class="line">        <span class="type">ssize_t</span> size = tube-&gt;<span class="built_in">read</span>(vaddr, objSize);</span><br><span class="line">        <span class="keyword">if</span> (size &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// error occurred</span></span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// no more messages</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        numObjects++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> numObjects;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">BitTube::read</span><span class="params">(<span class="type">void</span>* vaddr, <span class="type">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">ssize_t</span> err, len;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        len = ::<span class="built_in">recv</span>(mReceiveFd, vaddr, size, MSG_DONTWAIT);</span><br><span class="line">        err = len &lt; <span class="number">0</span> ? errno : <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (err == EINTR);</span><br><span class="line">    <span class="keyword">if</span> (err == EAGAIN || err == EWOULDBLOCK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err == <span class="number">0</span> ? len : -err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> åšå®¢ </category>
          
          <category> Sensor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åšå®¢ </tag>
            
            <tag> Sensor </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Android Sensoræ¡†æ¶HALå±‚è§£è¯»</title>
      <link href="/2016/09/14/blogs/SensorHAL/"/>
      <url>/2016/09/14/blogs/SensorHAL/</url>
      <content type="html"><![CDATA[<h2 id="Android-sensoræ„å»º"><a href="#Android-sensoræ„å»º" class="headerlink" title="Android sensoræ„å»º"></a>Android sensoræ„å»º</h2><ol><li><p>Android6.0 ç³»ç»Ÿå†…ç½®å¯¹ä¼ æ„Ÿå™¨çš„æ”¯æŒè¾¾26ç§ï¼Œä»–ä»¬åˆ†åˆ«æ˜¯ï¼šåŠ é€Ÿåº¦ä¼ æ„Ÿå™¨(accelerometer)ã€ç£åŠ›ä¼ æ„Ÿå™¨(magnetic field)ã€æ–¹å‘ä¼ æ„Ÿå™¨(orientation)ã€é™€èºä»ª(gyroscope)ã€ç¯å¢ƒå…‰ç…§ä¼ æ„Ÿå™¨(light)ã€å‹åŠ›ä¼ æ„Ÿå™¨(pressure)ã€æ¸©åº¦ä¼ æ„Ÿå™¨(temperature)å’Œè·ç¦»ä¼ æ„Ÿå™¨(proximity)ç­‰ã€‚</p></li><li><p>Androidå®ç°ä¼ æ„Ÿå™¨ç³»ç»ŸåŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>javaå±‚</li><li>JNIå±‚</li><li>HALå±‚</li><li>é©±åŠ¨å±‚</li></ul></li><li><p>å„éƒ¨åˆ†ä¹‹é—´æ¶æ„å›¾å¦‚ä¸‹ï¼š</p></li></ol><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/sensorHAL/1.png"/><h2 id="Sensor-HALå±‚æ¥å£"><a href="#Sensor-HALå±‚æ¥å£" class="headerlink" title="Sensor HALå±‚æ¥å£"></a>Sensor HALå±‚æ¥å£</h2><ol><li><p>Googleä¸ºSensoræä¾›äº†ç»Ÿä¸€çš„HALæ¥å£ï¼Œä¸åŒçš„ç¡¬ä»¶å‚å•†éœ€è¦æ ¹æ®è¯¥æ¥å£æ¥å®ç°å¹¶å®Œæˆå…·ä½“çš„ç¡¬ä»¶æŠ½è±¡å±‚ã€‚Androidä¸­Sensorçš„HALæ¥å£å®šä¹‰åœ¨ï¼š<code>hardware/libhardware/include/hardware/sensors.h</code></p></li><li><p>å¯¹ä¼ æ„Ÿå™¨ç±»å‹çš„å®šä¹‰:</p></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_ACCELEROMETER                   (1)  <span class="comment">//åŠ é€Ÿåº¦ä¼ æ„Ÿå™¨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_MAGNETIC_FIELD                  (2)  <span class="comment">//ç£åŠ›ä¼ æ„Ÿå™¨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_ORIENTATION                     (3)  <span class="comment">//æ–¹å‘</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_GYROSCOPE                       (4)  <span class="comment">//é™€èºä»ª</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_LIGHT                           (5)  <span class="comment">//ç¯å¢ƒå…‰ç…§ä¼ æ„Ÿå™¨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_PRESSURE                        (6)  <span class="comment">//å‹åŠ›ä¼ æ„Ÿå™¨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_TEMPERATURE                     (7)  <span class="comment">//æ¸©åº¦ä¼ æ„Ÿå™¨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_PROXIMITY                       (8)  <span class="comment">//è·ç¦»ä¼ æ„Ÿå™¨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_GRAVITY                         (9)  <span class="comment">//é‡åŠ›</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_LINEAR_ACCELERATION             (10) <span class="comment">//çº¿æ€§åŠ é€Ÿåº¦</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_ROTATION_VECTOR                 (11) <span class="comment">//è¿åŠ¨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_RELATIVE_HUMIDITY               (12) <span class="comment">//æ¹¿åº¦ä¼ æ„Ÿå™¨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_AMBIENT_TEMPERATURE             (13) <span class="comment">//ç¯å¢ƒæ¸©åº¦ä¼ æ„Ÿå™¨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_MAGNETIC_FIELD_UNCALIBRATED     (14) <span class="comment">//æœªæ ¡å‡†ç£åŠ›ä¼ æ„Ÿå™¨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_GAME_ROTATION_VECTOR            (15) <span class="comment">//æ¸¸æˆåŠ¨ä½œä¼ æ„Ÿå™¨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_GYROSCOPE_UNCALIBRATED          (16) <span class="comment">//æœªæ ¡å‡†é™€èºä»ª</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_SIGNIFICANT_MOTION              (17) <span class="comment">//ç‰¹æ®ŠåŠ¨ä½œè§¦å‘ä¼ æ„Ÿå™¨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_STEP_DETECTOR                   (18) <span class="comment">//æ­¥è¡Œæ£€æµ‹ä¼ æ„Ÿå™¨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_STEP_COUNTER                    (19) <span class="comment">//è®¡æ­¥ä¼ æ„Ÿå™¨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_GEOMAGNETIC_ROTATION_VECTOR     (20) <span class="comment">//åœ°ç£æ—‹è½¬çŸ¢é‡ä¼ æ„Ÿå™¨,æä¾›æ‰‹æœºçš„æ—‹è½¬çŸ¢é‡</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_HEART_RATE                      (21) <span class="comment">//å¿ƒç‡ä¼ æ„Ÿå™¨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_TILT_DETECTOR                   (22) <span class="comment">//æ¯æ¬¡æ£€æµ‹åˆ°å€¾æ–œäº‹ä»¶åå‡ç”Ÿæˆäº‹ä»¶</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_WAKE_GESTURE                    (23) <span class="comment">//æ”¯æŒæ ¹æ®è®¾å¤‡ç‰¹å®šçš„åŠ¨ä½œå”¤é†’è®¾å¤‡</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_GLANCE_GESTURE                  (24) <span class="comment">//æ”¯æŒçŸ­æš‚æ‰“å¼€å±å¹•ï¼Œä»¥ä¾¿ç”¨æˆ·æ ¹æ®ç‰¹å®šåŠ¨ä½œæµè§ˆå±å¹•ä¸Šçš„å†…å®¹</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_PICK_UP_GESTURE                 (25) <span class="comment">//æ‹¾èµ·è®¾å¤‡æ—¶è§¦å‘,æ— è®ºé¢å‰æ˜¯ä»€ä¹ˆ(æ¡Œå­ã€å£è¢‹ã€æ‰‹æè¢‹)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_TYPE_WRIST_TILT_GESTURE              (26) <span class="comment">//è…•å…³èŠ‚å€¾æ–œè§¦å‘ç”Ÿæˆäº‹ä»¶</span></span></span><br></pre></td></tr></table></figure><ol start="3"><li>ä¼ æ„Ÿå™¨æ¨¡å—çš„å®šä¹‰ç»“æ„ä½“å¦‚ä¸‹ï¼Œè¯¥æ¥å£çš„å®šä¹‰å®é™…ä¸Šæ˜¯å¯¹æ ‡å‡†çš„ç¡¬ä»¶æ¨¡å—hw_module_tçš„ä¸€ä¸ªæ‰©å±•ï¼Œå¢åŠ äº†ä¸€ä¸ª<code>get_sensors_list</code>å‡½æ•°ï¼Œç”¨äºè·å–ä¼ æ„Ÿå™¨çš„åˆ—è¡¨ã€‚</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">sensors_module_t</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">hw_module_t</span> common;</span><br><span class="line">    <span class="built_in">int</span> (*get_sensors_list)(<span class="keyword">struct</span> <span class="type">sensors_module_t</span>* <span class="keyword">module</span>,</span><br><span class="line">            <span class="keyword">struct</span> <span class="type">sensor_t</span> <span class="type">const</span>** list);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol start="4"><li>å¯¹ä»»æ„ä¸€ä¸ªsensorè®¾å¤‡éƒ½ä¼šæœ‰ä¸€ä¸ª<code>sensor_t</code>ç»“æ„ä½“ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">sensor_t</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>*     name;       <span class="comment">//ä¼ æ„Ÿå™¨åå­—</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>*     vendor;</span><br><span class="line">    <span class="type">int</span>             version;     <span class="comment">//ç‰ˆæœ¬</span></span><br><span class="line">    <span class="type">int</span>             handle;     <span class="comment">//ä¼ æ„Ÿå™¨çš„handleå¥æŸ„</span></span><br><span class="line">    <span class="type">int</span>             type;       <span class="comment">//ä¼ æ„Ÿå™¨ç±»å‹</span></span><br><span class="line">    <span class="type">float</span>           maxRange;   <span class="comment">//æœ€å¤§èŒƒå›´</span></span><br><span class="line">    <span class="type">float</span>           resolution;    <span class="comment">//è§£æåº¦</span></span><br><span class="line">    <span class="type">float</span>           power;       <span class="comment">//æ¶ˆè€—èƒ½æº</span></span><br><span class="line">    <span class="type">int32_t</span>         minDelay;    <span class="comment">//äº‹ä»¶é—´éš”æœ€å°æ—¶é—´</span></span><br><span class="line">    <span class="type">void</span>*           reserved[<span class="number">8</span>];   <span class="comment">//ä¿ç•™å­—æ®µï¼Œå¿…é¡»ä¸º0</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol start="5"><li>æ¯ä¸ªä¼ æ„Ÿå™¨çš„æ•°æ®ç”±<code>sensors_event_t</code>ç»“æ„ä½“è¡¨ç¤ºï¼Œå®šä¹‰å¦‚ä¸‹ï¼Œå…¶ä¸­ï¼Œsensorä¸ºä¼ æ„Ÿå™¨çš„æ ‡å¿—ç¬¦ï¼Œè€Œä¸åŒçš„ä¼ æ„Ÿå™¨åˆ™é‡‡ç”¨unionæ–¹å¼æ¥è¡¨ç¤ºã€‚</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">sensors_event_t</span> &#123;</span><br><span class="line">    <span class="type">int32_t</span> version;</span><br><span class="line">    <span class="type">int32_t</span> sensor;            <span class="comment">//æ ‡è¯†ç¬¦</span></span><br><span class="line">    <span class="type">int32_t</span> type;             <span class="comment">//ä¼ æ„Ÿå™¨ç±»å‹</span></span><br><span class="line">    <span class="type">int32_t</span> reserved0;</span><br><span class="line">    <span class="type">int64_t</span> timestamp;        <span class="comment">//æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="type">float</span>           data[<span class="number">16</span>];</span><br><span class="line">        <span class="type">sensors_vec_t</span>   acceleration;   <span class="comment">//åŠ é€Ÿåº¦</span></span><br><span class="line">        <span class="type">sensors_vec_t</span>   magnetic;      <span class="comment">//ç£çŸ¢é‡</span></span><br><span class="line">        <span class="type">sensors_vec_t</span>   orientation;     <span class="comment">//æ–¹å‘</span></span><br><span class="line">        <span class="type">sensors_vec_t</span>   gyro;          <span class="comment">//é™€èºä»ª</span></span><br><span class="line">        <span class="type">float</span>           temperature;     <span class="comment">//æ¸©åº¦</span></span><br><span class="line">        <span class="type">float</span>           distance;        <span class="comment">//è·ç¦»</span></span><br><span class="line">        <span class="type">float</span>           light;           <span class="comment">//å…‰ç…§</span></span><br><span class="line">        <span class="type">float</span>           pressure;         <span class="comment">//å‹åŠ›</span></span><br><span class="line">        <span class="type">float</span>           relative_humidity;  <span class="comment">//ç›¸å¯¹æ¹¿åº¦</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">uint32_t</span>        reserved1[<span class="number">4</span>];</span><br><span class="line">&#125; <span class="type">sensors_event_t</span>;</span><br></pre></td></tr></table></figure><ol start="6"><li><code>sensors_vec_t</code>ç»“æ„ä½“ç”¨æ¥è¡¨ç¤ºä¸åŒä¼ æ„Ÿå™¨çš„æ•°æ®ï¼š</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="type">float</span> v[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            <span class="type">float</span> x;</span><br><span class="line">            <span class="type">float</span> y;</span><br><span class="line">            <span class="type">float</span> z;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            <span class="type">float</span> azimuth;</span><br><span class="line">            <span class="type">float</span> pitch;</span><br><span class="line">            <span class="type">float</span> roll;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">int8_t</span> status;</span><br><span class="line">    <span class="type">uint8_t</span> reserved[<span class="number">3</span>];</span><br><span class="line">&#125; <span class="type">sensors_vec_t</span>;</span><br></pre></td></tr></table></figure><ol start="7"><li>Sensorè®¾å¤‡ç»“æ„ä½“<code>sensors_poll_device_t</code>ï¼Œå¯¹æ ‡å‡†ç¡¬ä»¶è®¾å¤‡<code>hw_device_t</code>ç»“æ„ä½“çš„æ‰©å±•ï¼Œä¸»è¦å®Œæˆè¯»å–åº•å±‚æ•°æ®ï¼Œå¹¶å°†æ•°æ®å­˜å‚¨åœ¨<code>struct sensors_poll_device_t</code>ç»“æ„ä½“ä¸­ï¼›pollå‡½æ•°ç”¨æ¥è·å–åº•å±‚æ•°æ®ï¼Œè°ƒç”¨æ—¶å°†è¢«é˜»å¡å®šä¹‰å¦‚ä¸‹ï¼š</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">sensors_poll_device_t</span> &#123;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">hw_device_t</span> common;</span><br><span class="line"><span class="comment">//Activate/deactivate one sensor</span></span><br><span class="line">    <span class="built_in">int</span> (*activate)(<span class="keyword">struct</span> <span class="type">sensors_poll_device_t</span> *dev,</span><br><span class="line">            <span class="type">int</span> handle, <span class="type">int</span> enabled);</span><br><span class="line">    <span class="comment">//Set the delay between sensor events in nanoseconds for a given sensor.</span></span><br><span class="line">    <span class="built_in">int</span> (*setDelay)(<span class="keyword">struct</span> <span class="type">sensors_poll_device_t</span> *dev,</span><br><span class="line">            <span class="type">int</span> handle, <span class="type">int64_t</span> ns);</span><br><span class="line">    <span class="comment">//è·å–æ•°æ®</span></span><br><span class="line">    <span class="built_in">int</span> (*poll)(<span class="keyword">struct</span> <span class="type">sensors_poll_device_t</span> *dev,</span><br><span class="line">            <span class="type">sensors_event_t</span>* data, <span class="type">int</span> count);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol start="8"><li>æ§åˆ¶è®¾å¤‡æ‰“å¼€&#x2F;å…³é—­ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title">sensors_open</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> <span class="type">hw_module_t</span>* <span class="keyword">module</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">struct</span> <span class="type">sensors_poll_device_t</span>** device)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">module</span>-&gt;methods-&gt;<span class="built_in">open</span>(<span class="keyword">module</span>,</span><br><span class="line">            SENSORS_HARDWARE_POLL, (<span class="keyword">struct</span> <span class="type">hw_device_t</span>**)device);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title">sensors_close</span><span class="params">(<span class="keyword">struct</span> <span class="type">sensors_poll_device_t</span>* device)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> device-&gt;common.<span class="built_in">close</span>(&amp;device-&gt;common);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Sensor-HALå®ç°"><a href="#Sensor-HALå®ç°" class="headerlink" title="Sensor HALå®ç°"></a>Sensor HALå®ç°</h2><ol><li>æ‰“å¼€è®¾å¤‡æ—¶åºå›¾</li></ol><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/sensorHAL/2.jpg"/><ol start="2"><li>SensorDeviceå±äºJNIå±‚ï¼Œä¸HALè¿›è¡Œé€šä¿¡çš„æ¥å£ï¼Œåœ¨JNIå±‚è°ƒç”¨äº†HALå±‚çš„<code>open_sensors()</code>æ–¹æ³•æ‰“å¼€è®¾å¤‡æ¨¡å—ï¼Œå†è°ƒç”¨<code>poll__activate()</code>å¯¹è®¾å¤‡ä½¿èƒ½ï¼Œç„¶åè°ƒç”¨<code>poll__poll</code>è¯»å–æ•°æ®ã€‚</li></ol>]]></content>
      
      <categories>
          
          <category> åšå®¢ </category>
          
          <category> Sensor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åšå®¢ </tag>
            
            <tag> Sensor </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Hexoæ¢äº†ç”µè„‘å¤„ç†æ–¹æ³•</title>
      <link href="/2016/09/12/notes/HexoForBlog/"/>
      <url>/2016/09/12/notes/HexoForBlog/</url>
      <content type="html"><![CDATA[<h2 id="æœ¬æ–‡åªè®²è¿°hexoæ¢äº†ç”µè„‘å¤„ç†æ–¹æ³•ï¼Œå¦‚æœæƒ³äº†è§£ä½¿ç”¨hexoæ­å»ºä¸ªäººåšå®¢ï¼Œè¯·è®¿é—®ï¼šä½¿ç”¨hexoæ­å»ºä¸ªäººåšå®¢"><a href="#æœ¬æ–‡åªè®²è¿°hexoæ¢äº†ç”µè„‘å¤„ç†æ–¹æ³•ï¼Œå¦‚æœæƒ³äº†è§£ä½¿ç”¨hexoæ­å»ºä¸ªäººåšå®¢ï¼Œè¯·è®¿é—®ï¼šä½¿ç”¨hexoæ­å»ºä¸ªäººåšå®¢" class="headerlink" title="æœ¬æ–‡åªè®²è¿°hexoæ¢äº†ç”µè„‘å¤„ç†æ–¹æ³•ï¼Œå¦‚æœæƒ³äº†è§£ä½¿ç”¨hexoæ­å»ºä¸ªäººåšå®¢ï¼Œè¯·è®¿é—®ï¼šä½¿ç”¨hexoæ­å»ºä¸ªäººåšå®¢"></a>æœ¬æ–‡åªè®²è¿°hexoæ¢äº†ç”µè„‘å¤„ç†æ–¹æ³•ï¼Œå¦‚æœæƒ³äº†è§£ä½¿ç”¨hexoæ­å»ºä¸ªäººåšå®¢ï¼Œè¯·è®¿é—®ï¼š<a href="http://www.jianshu.com/p/73ca570e4d61">ä½¿ç”¨hexoæ­å»ºä¸ªäººåšå®¢</a></h2><h2 id="ä¸ºäº†å¯ä»¥åœ¨å¤šä¸ªç”µè„‘ä¸Šé¢éƒ½å¤„ç†hexoåšå®¢ï¼Œæ‰€ä»¥æˆ‘æŠŠsourceæ–‡ä»¶å’Œç½‘ç«™çš„æ–‡ä»¶åˆ†åˆ«æ”¾åœ¨hexoå’Œmasteråˆ†æ”¯ä¸Šé¢ï¼Œé¦–å…ˆå°†hexoåˆ†æ”¯å…‹éš†åˆ°æœ¬åœ°ï¼š"><a href="#ä¸ºäº†å¯ä»¥åœ¨å¤šä¸ªç”µè„‘ä¸Šé¢éƒ½å¤„ç†hexoåšå®¢ï¼Œæ‰€ä»¥æˆ‘æŠŠsourceæ–‡ä»¶å’Œç½‘ç«™çš„æ–‡ä»¶åˆ†åˆ«æ”¾åœ¨hexoå’Œmasteråˆ†æ”¯ä¸Šé¢ï¼Œé¦–å…ˆå°†hexoåˆ†æ”¯å…‹éš†åˆ°æœ¬åœ°ï¼š" class="headerlink" title="ä¸ºäº†å¯ä»¥åœ¨å¤šä¸ªç”µè„‘ä¸Šé¢éƒ½å¤„ç†hexoåšå®¢ï¼Œæ‰€ä»¥æˆ‘æŠŠsourceæ–‡ä»¶å’Œç½‘ç«™çš„æ–‡ä»¶åˆ†åˆ«æ”¾åœ¨hexoå’Œmasteråˆ†æ”¯ä¸Šé¢ï¼Œé¦–å…ˆå°†hexoåˆ†æ”¯å…‹éš†åˆ°æœ¬åœ°ï¼š"></a>ä¸ºäº†å¯ä»¥åœ¨å¤šä¸ªç”µè„‘ä¸Šé¢éƒ½å¤„ç†hexoåšå®¢ï¼Œæ‰€ä»¥æˆ‘æŠŠsourceæ–‡ä»¶å’Œç½‘ç«™çš„æ–‡ä»¶åˆ†åˆ«æ”¾åœ¨hexoå’Œmasteråˆ†æ”¯ä¸Šé¢ï¼Œé¦–å…ˆå°†hexoåˆ†æ”¯å…‹éš†åˆ°æœ¬åœ°ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> -b hexo git@github.com:way1989/way1989.github.io.git</span><br><span class="line">$ <span class="built_in">cd</span> way1989.github.io</span><br><span class="line">$ npm install</span><br></pre></td></tr></table></figure><h2 id="æ­¤æ—¶ï¼Œä½ çš„åšå®¢å°±OKäº†ï¼Œè¿è¡Œ-hexo-s-â€“debugçœ‹ä¸€çœ‹ï¼Œæ˜¯ä¸æ˜¯ä¸€åˆ‡æ­£å¸¸ï¼Ÿç„¶åæµ‹è¯•æ˜¯å¦èƒ½åœ¨æ–°çš„ç”µè„‘ä¸Šå‘è¡¨æ–‡ç« ã€‚"><a href="#æ­¤æ—¶ï¼Œä½ çš„åšå®¢å°±OKäº†ï¼Œè¿è¡Œ-hexo-s-â€“debugçœ‹ä¸€çœ‹ï¼Œæ˜¯ä¸æ˜¯ä¸€åˆ‡æ­£å¸¸ï¼Ÿç„¶åæµ‹è¯•æ˜¯å¦èƒ½åœ¨æ–°çš„ç”µè„‘ä¸Šå‘è¡¨æ–‡ç« ã€‚" class="headerlink" title="æ­¤æ—¶ï¼Œä½ çš„åšå®¢å°±OKäº†ï¼Œè¿è¡Œ hexo s â€“debugçœ‹ä¸€çœ‹ï¼Œæ˜¯ä¸æ˜¯ä¸€åˆ‡æ­£å¸¸ï¼Ÿç„¶åæµ‹è¯•æ˜¯å¦èƒ½åœ¨æ–°çš„ç”µè„‘ä¸Šå‘è¡¨æ–‡ç« ã€‚"></a>æ­¤æ—¶ï¼Œä½ çš„åšå®¢å°±OKäº†ï¼Œè¿è¡Œ hexo s â€“debugçœ‹ä¸€çœ‹ï¼Œæ˜¯ä¸æ˜¯ä¸€åˆ‡æ­£å¸¸ï¼Ÿç„¶åæµ‹è¯•æ˜¯å¦èƒ½åœ¨æ–°çš„ç”µè„‘ä¸Šå‘è¡¨æ–‡ç« ã€‚</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo s --debug ç„¶åæ‰“å¼€`localhost:4000`å°±å¯ä»¥çœ‹è§åˆšæ‰å‘è¡¨çš„æµ‹è¯•æ–‡ç« äº†</span><br></pre></td></tr></table></figure><h2 id="å½“åœ¨æœ¬åœ°ç¡®è®¤åšå®¢æ•ˆæœåï¼Œå°±å¯ä»¥å°†mdæ–‡ä»¶ç”Ÿæˆé™æ€ç½‘é¡µä¸Šä¼ è‡³GithubPagesï¼Œåœ¨ç»ˆç«¯å®šä½åˆ°way1989-github-ioç›®å½•ä¸‹ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å³å¯"><a href="#å½“åœ¨æœ¬åœ°ç¡®è®¤åšå®¢æ•ˆæœåï¼Œå°±å¯ä»¥å°†mdæ–‡ä»¶ç”Ÿæˆé™æ€ç½‘é¡µä¸Šä¼ è‡³GithubPagesï¼Œåœ¨ç»ˆç«¯å®šä½åˆ°way1989-github-ioç›®å½•ä¸‹ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å³å¯" class="headerlink" title="å½“åœ¨æœ¬åœ°ç¡®è®¤åšå®¢æ•ˆæœåï¼Œå°±å¯ä»¥å°†mdæ–‡ä»¶ç”Ÿæˆé™æ€ç½‘é¡µä¸Šä¼ è‡³GithubPagesï¼Œåœ¨ç»ˆç«¯å®šä½åˆ°way1989.github.ioç›®å½•ä¸‹ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å³å¯:"></a>å½“åœ¨æœ¬åœ°ç¡®è®¤åšå®¢æ•ˆæœåï¼Œå°±å¯ä»¥å°†mdæ–‡ä»¶ç”Ÿæˆé™æ€ç½‘é¡µä¸Šä¼ è‡³GithubPagesï¼Œåœ¨ç»ˆç«¯å®šä½åˆ°way1989.github.ioç›®å½•ä¸‹ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å³å¯:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ hexo clean <span class="comment">#æ¸…é™¤ç½‘é¡µç¼“å­˜</span></span><br><span class="line">$ hexo g <span class="comment">#ç”Ÿæˆé™æ€ç½‘é¡µ</span></span><br><span class="line">ï¿¥ hexo d <span class="comment">#å¼€å§‹éƒ¨ç½²</span></span><br><span class="line">//å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€æ¬¡æ€§å‘½ä»¤ï¼š</span><br><span class="line">ï¿¥ hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</span><br></pre></td></tr></table></figure><h2 id="æ·»åŠ ç™¾åº¦-è°·æ­Œ-æœ¬åœ°-è‡ªå®šä¹‰ç«™ç‚¹å†…å®¹æœç´¢"><a href="#æ·»åŠ ç™¾åº¦-è°·æ­Œ-æœ¬åœ°-è‡ªå®šä¹‰ç«™ç‚¹å†…å®¹æœç´¢" class="headerlink" title="æ·»åŠ ç™¾åº¦&#x2F;è°·æ­Œ&#x2F;æœ¬åœ° è‡ªå®šä¹‰ç«™ç‚¹å†…å®¹æœç´¢"></a>æ·»åŠ ç™¾åº¦&#x2F;è°·æ­Œ&#x2F;æœ¬åœ° è‡ªå®šä¹‰ç«™ç‚¹å†…å®¹æœç´¢</h2><h3 id="å®‰è£…hexo-generator-searchï¼Œåœ¨ç«™ç‚¹çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"><a href="#å®‰è£…hexo-generator-searchï¼Œåœ¨ç«™ç‚¹çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š" class="headerlink" title="å®‰è£…hexo-generator-searchï¼Œåœ¨ç«™ç‚¹çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"></a>å®‰è£…<code>hexo-generator-search</code>ï¼Œåœ¨ç«™ç‚¹çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install hexo-generator-search --save</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¾‘ç«™ç‚¹é…ç½®æ–‡ä»¶ï¼Œæ–°å¢ä»¥ä¸‹å†…å®¹åˆ°ä»»æ„ä½ç½®"><a href="#ç¼–è¾‘ç«™ç‚¹é…ç½®æ–‡ä»¶ï¼Œæ–°å¢ä»¥ä¸‹å†…å®¹åˆ°ä»»æ„ä½ç½®" class="headerlink" title="ç¼–è¾‘ç«™ç‚¹é…ç½®æ–‡ä»¶ï¼Œæ–°å¢ä»¥ä¸‹å†…å®¹åˆ°ä»»æ„ä½ç½®:"></a>ç¼–è¾‘<code>ç«™ç‚¹é…ç½®æ–‡ä»¶</code>ï¼Œæ–°å¢ä»¥ä¸‹å†…å®¹åˆ°ä»»æ„ä½ç½®:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">search:</span><br><span class="line">  path: search.xml</span><br><span class="line">  field: post</span><br></pre></td></tr></table></figure><h3 id="hexoéƒ¨ç½²å¤±è´¥-ERROR-Deployer-not-found-git"><a href="#hexoéƒ¨ç½²å¤±è´¥-ERROR-Deployer-not-found-git" class="headerlink" title="hexoéƒ¨ç½²å¤±è´¥ ERROR Deployer not found: git"></a>hexoéƒ¨ç½²å¤±è´¥ ERROR Deployer not found: git</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ubuntuæ–°å¢SSDæŒ‡å—</title>
      <link href="/2016/09/02/notes/AddSSDForUbuntu/"/>
      <url>/2016/09/02/notes/AddSSDForUbuntu/</url>
      <content type="html"><![CDATA[<h2 id="æ‰“å¼€Applicationsâ€“-System-Toolsâ€“-Preferencesâ€“-Disk-Utilityï¼Œå…ˆæ ¼å¼åŒ–240Gçš„é‚£ä¸ªç¡¬ç›˜ï¼Œé€‰æ‹©ext4æ ¼å¼ï¼Œç„¶ååˆ›å»ºåˆ†åŒºï¼š"><a href="#æ‰“å¼€Applicationsâ€“-System-Toolsâ€“-Preferencesâ€“-Disk-Utilityï¼Œå…ˆæ ¼å¼åŒ–240Gçš„é‚£ä¸ªç¡¬ç›˜ï¼Œé€‰æ‹©ext4æ ¼å¼ï¼Œç„¶ååˆ›å»ºåˆ†åŒºï¼š" class="headerlink" title="æ‰“å¼€Applicationsâ€“&gt;System Toolsâ€“&gt;Preferencesâ€“&gt;Disk Utilityï¼Œå…ˆæ ¼å¼åŒ–240Gçš„é‚£ä¸ªç¡¬ç›˜ï¼Œé€‰æ‹©ext4æ ¼å¼ï¼Œç„¶ååˆ›å»ºåˆ†åŒºï¼š"></a>æ‰“å¼€Applicationsâ€“&gt;System Toolsâ€“&gt;Preferencesâ€“&gt;Disk Utilityï¼Œå…ˆæ ¼å¼åŒ–240Gçš„é‚£ä¸ªç¡¬ç›˜ï¼Œé€‰æ‹©ext4æ ¼å¼ï¼Œç„¶ååˆ›å»ºåˆ†åŒºï¼š</h2><h2 id="æŸ¥çœ‹ç¡¬ç›˜ä¿¡æ¯ï¼Œç»ˆç«¯æ‰§è¡Œï¼š-dev-sdb1å¯èƒ½ä¸åŒï¼Œå…·ä½“å‚è€ƒDisk-Utilityä¸­æ˜¾ç¤º-ï¼š"><a href="#æŸ¥çœ‹ç¡¬ç›˜ä¿¡æ¯ï¼Œç»ˆç«¯æ‰§è¡Œï¼š-dev-sdb1å¯èƒ½ä¸åŒï¼Œå…·ä½“å‚è€ƒDisk-Utilityä¸­æ˜¾ç¤º-ï¼š" class="headerlink" title="æŸ¥çœ‹ç¡¬ç›˜ä¿¡æ¯ï¼Œç»ˆç«¯æ‰§è¡Œï¼š(&#x2F;dev&#x2F;sdb1å¯èƒ½ä¸åŒï¼Œå…·ä½“å‚è€ƒDisk Utilityä¸­æ˜¾ç¤º)ï¼š"></a>æŸ¥çœ‹ç¡¬ç›˜ä¿¡æ¯ï¼Œç»ˆç«¯æ‰§è¡Œï¼š(&#x2F;dev&#x2F;sdb1å¯èƒ½ä¸åŒï¼Œå…·ä½“å‚è€ƒDisk Utilityä¸­æ˜¾ç¤º)ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> blkid /dev/sdb1</span><br></pre></td></tr></table></figure><h3 id="æ˜¾ç¤ºç±»ä¼¼ä»¥ä¸‹ä¿¡æ¯"><a href="#æ˜¾ç¤ºç±»ä¼¼ä»¥ä¸‹ä¿¡æ¯" class="headerlink" title="æ˜¾ç¤ºç±»ä¼¼ä»¥ä¸‹ä¿¡æ¯:"></a>æ˜¾ç¤ºç±»ä¼¼ä»¥ä¸‹ä¿¡æ¯:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/sdb1: LABEL=<span class="string">&quot;SSD&quot;</span> UUID=<span class="string">&quot;861ada17-a2a2-4781-8ec7-5b93794adf9b&quot;</span> TYPE=<span class="string">&quot;ext4&quot;</span></span><br></pre></td></tr></table></figure><h2 id="ä¿®æ”¹è‡ªåŠ¨æŒ‚è½½ç‚¹ï¼Œåœ¨æœ€åå¢åŠ ä¸€è¡Œ-éœ€è¦å…ˆåˆ›å»ºå¥½SSDç›®å½•sudo-mkdir-SSD-ï¼š"><a href="#ä¿®æ”¹è‡ªåŠ¨æŒ‚è½½ç‚¹ï¼Œåœ¨æœ€åå¢åŠ ä¸€è¡Œ-éœ€è¦å…ˆåˆ›å»ºå¥½SSDç›®å½•sudo-mkdir-SSD-ï¼š" class="headerlink" title="ä¿®æ”¹è‡ªåŠ¨æŒ‚è½½ç‚¹ï¼Œåœ¨æœ€åå¢åŠ ä¸€è¡Œ(éœ€è¦å…ˆåˆ›å»ºå¥½SSDç›®å½•sudo mkdir &#x2F;SSD)ï¼š"></a>ä¿®æ”¹è‡ªåŠ¨æŒ‚è½½ç‚¹ï¼Œåœ¨æœ€åå¢åŠ ä¸€è¡Œ(éœ€è¦å…ˆåˆ›å»ºå¥½SSDç›®å½•sudo mkdir &#x2F;SSD)ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> vim /etc/fstab</span><br></pre></td></tr></table></figure><h3 id="æ˜¾ç¤ºç±»ä¼¼ä»¥ä¸‹ä¿¡æ¯-1"><a href="#æ˜¾ç¤ºç±»ä¼¼ä»¥ä¸‹ä¿¡æ¯-1" class="headerlink" title="æ˜¾ç¤ºç±»ä¼¼ä»¥ä¸‹ä¿¡æ¯:"></a>æ˜¾ç¤ºç±»ä¼¼ä»¥ä¸‹ä¿¡æ¯:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UUID=861ada17-a2a2-4781-8ec7-5b93794adf9b /SSD           ext4    defaults        1       2</span><br></pre></td></tr></table></figure><h2 id="æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ï¼Œä»¥åå¼€æœºéƒ½ä¼šè‡ªåŠ¨æŒ‚è½½åˆ°-SSDç›®å½•äº†-ç›®å½•åå­—å¯ä»¥éšæ„å–"><a href="#æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ï¼Œä»¥åå¼€æœºéƒ½ä¼šè‡ªåŠ¨æŒ‚è½½åˆ°-SSDç›®å½•äº†-ç›®å½•åå­—å¯ä»¥éšæ„å–" class="headerlink" title="æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ï¼Œä»¥åå¼€æœºéƒ½ä¼šè‡ªåŠ¨æŒ‚è½½åˆ°&#x2F;SSDç›®å½•äº†(ç›®å½•åå­—å¯ä»¥éšæ„å–)"></a>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ï¼Œä»¥åå¼€æœºéƒ½ä¼šè‡ªåŠ¨æŒ‚è½½åˆ°&#x2F;SSDç›®å½•äº†(ç›®å½•åå­—å¯ä»¥éšæ„å–)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> mount -a</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
          <category> SSD </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>EventBus</title>
      <link href="/2016/08/18/blogs/EventBus/"/>
      <url>/2016/08/18/blogs/EventBus/</url>
      <content type="html"><![CDATA[<h1 id="EventBus"><a href="#EventBus" class="headerlink" title="EventBus"></a>EventBus</h1><p>EventBus is a publish&#x2F;subscribe event bus optimized for Android.<br/><br><img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/eventbus/EventBus-Publish-Subscribe.png" width="500" height="187"/></p><h2 id="EventBusä»‹ç»"><a href="#EventBusä»‹ç»" class="headerlink" title="EventBusä»‹ç»"></a>EventBusä»‹ç»</h2><ul><li>simplifies the communication between components<ul><li>decouples event senders and receivers  </li><li>performs well with Activities, Fragments, and background threads</li><li>avoids complex and error-prone dependencies and life cycle issues</li></ul></li><li>makes your code simpler</li><li>is fast</li><li>is tiny (~50k jar)</li><li>is proven in practice by apps with 100,000,000+ installs</li><li>has advanced features like delivery threads, subscriber priorities, etc.</li></ul><h2 id="æ·»åŠ EventBusæ”¯æŒ"><a href="#æ·»åŠ EventBusæ”¯æŒ" class="headerlink" title="æ·»åŠ EventBusæ”¯æŒ"></a>æ·»åŠ EventBusæ”¯æŒ</h2><p>Gradle:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gradle</span><br><span class="line">compile &#x27;org.greenrobot:eventbus:3.0.0&#x27;</span><br></pre></td></tr></table></figure><p><a href="http://search.maven.org/#search%7Cga%7C1%7Cg%3A%22de.greenrobot%22%20AND%20a%3A%22eventbus%22">download EventBus from Maven Central</a></p><h2 id="EventBus-ä½¿ç”¨ç¤ºä¾‹"><a href="#EventBus-ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="EventBus ä½¿ç”¨ç¤ºä¾‹"></a>EventBus ä½¿ç”¨ç¤ºä¾‹</h2><h3 id="å®šä¹‰äº‹ä»¶"><a href="#å®šä¹‰äº‹ä»¶" class="headerlink" title="å®šä¹‰äº‹ä»¶"></a>å®šä¹‰äº‹ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoadEvent</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="onCreateä¸­æ³¨å†Œäº‹ä»¶"><a href="#onCreateä¸­æ³¨å†Œäº‹ä»¶" class="headerlink" title="onCreateä¸­æ³¨å†Œäº‹ä»¶"></a>onCreateä¸­æ³¨å†Œäº‹ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EventBus.getDefault().register(<span class="built_in">this</span>);</span><br></pre></td></tr></table></figure><h3 id="onDestroyä¸­å–æ¶ˆæ³¨å†Œ"><a href="#onDestroyä¸­å–æ¶ˆæ³¨å†Œ" class="headerlink" title="onDestroyä¸­å–æ¶ˆæ³¨å†Œ"></a>onDestroyä¸­å–æ¶ˆæ³¨å†Œ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EventBus.getDefault().unregister(<span class="built_in">this</span>);</span><br></pre></td></tr></table></figure><h3 id="è®¢é˜…äº‹ä»¶"><a href="#è®¢é˜…äº‹ä»¶" class="headerlink" title="è®¢é˜…äº‹ä»¶"></a>è®¢é˜…äº‹ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Subscribe(threadMode = ThreadMode.MAIN, priority = 0, sticky = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLoadEvent</span><span class="params">(LoadEvent event)</span> &#123;</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;onLoadEvent&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>threadMode<ul><li>POSTING åœ¨è°ƒç”¨postæ‰€åœ¨çš„çº¿ç¨‹æ‰§è¡Œå›è°ƒï¼Œç›´æ¥è¿è¡Œã€‚</li><li>MAIN åœ¨ä¸»çº¿ç¨‹å›è°ƒï¼Œå¦‚æœpostæ‰€åœ¨çº¿ç¨‹ä¸ºä¸»çº¿ç¨‹åˆ™ç›´æ¥æ‰§è¡Œï¼Œå¦åˆ™åˆ™é€šè¿‡mainThreadPosteræ¥è°ƒåº¦ã€‚</li><li>BACKGROUND å¦‚æœpostæ‰€åœ¨çº¿ç¨‹ä¸ºéUIçº¿ç¨‹åˆ™ç›´æ¥æ‰§è¡Œï¼Œå¦åˆ™åˆ™é€šè¿‡backgroundPosteræ¥è°ƒåº¦ï¼Œè¿™é‡Œåªé€‚åˆæ‰§è¡Œæ—¶é—´æ¯”è¾ƒçŸ­çš„ä»»åŠ¡ã€‚</li><li>ASYNCï¼ˆäº¤ç»™çº¿ç¨‹æ± æ¥ç®¡ç†ï¼‰ï¼šç›´æ¥é€šè¿‡asyncPosterè°ƒåº¦ã€‚</li></ul></li><li>sticky æ˜¯å¦ç›‘å¬é»æ€§äº‹ä»¶      <blockquote><p>If true, delivers the most recent sticky event (posted with EventBus#postSticky(Object)) to this subscriber (if event available).</p></blockquote></li></ul><h3 id="å‘å¸ƒäº‹ä»¶"><a href="#å‘å¸ƒäº‹ä»¶" class="headerlink" title="å‘å¸ƒäº‹ä»¶"></a>å‘å¸ƒäº‹ä»¶</h3>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EventBus.getDefault().post(<span class="keyword">new</span> <span class="title class_">LoadEvent</span>());</span><br></pre></td></tr></table></figure><h3 id="å®Œæ•´ç¤ºä¾‹"><a href="#å®Œæ•´ç¤ºä¾‹" class="headerlink" title="å®Œæ•´ç¤ºä¾‹"></a>å®Œæ•´ç¤ºä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;MainActivity&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        EventBus.getDefault().register(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Button</span> <span class="variable">start</span> <span class="operator">=</span> (Button) findViewById(R.id.start_load);</span><br><span class="line">        start.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                EventBus.getDefault().post(<span class="keyword">new</span> <span class="title class_">LoadEvent</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">        EventBus.getDefault().unregister(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subscribe(threadMode = ThreadMode.MAIN, priority = 0, sticky = false)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLoadEvent</span><span class="params">(LoadEvent event)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onLoadEvent&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LoadEvent</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="EventBusçš„æ³¨è§£ç”Ÿæˆç´¢å¼•"><a href="#EventBusçš„æ³¨è§£ç”Ÿæˆç´¢å¼•" class="headerlink" title="EventBusçš„æ³¨è§£ç”Ÿæˆç´¢å¼•"></a>EventBusçš„æ³¨è§£ç”Ÿæˆç´¢å¼•</h2><h3 id="é¡¹ç›®çš„æ ¹ç›®å½•build-gradleå¼•å…¥aptç¼–è¯‘æ’ä»¶"><a href="#é¡¹ç›®çš„æ ¹ç›®å½•build-gradleå¼•å…¥aptç¼–è¯‘æ’ä»¶" class="headerlink" title="é¡¹ç›®çš„æ ¹ç›®å½•build.gradleå¼•å…¥aptç¼–è¯‘æ’ä»¶"></a>é¡¹ç›®çš„æ ¹ç›®å½•build.gradleå¼•å…¥aptç¼–è¯‘æ’ä»¶</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">classpath</span> <span class="string">&#x27;com.neenbedankt.gradle.plugins:android-apt:1.8&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="appçš„build-gradle-åº”ç”¨aptæ’ä»¶ï¼Œå¹¶è®¾ç½®aptç”Ÿæˆçš„ç´¢å¼•çš„åŒ…åå’Œç±»å"><a href="#appçš„build-gradle-åº”ç”¨aptæ’ä»¶ï¼Œå¹¶è®¾ç½®aptç”Ÿæˆçš„ç´¢å¼•çš„åŒ…åå’Œç±»å" class="headerlink" title="appçš„build.gradle åº”ç”¨aptæ’ä»¶ï¼Œå¹¶è®¾ç½®aptç”Ÿæˆçš„ç´¢å¼•çš„åŒ…åå’Œç±»å"></a>appçš„build.gradle åº”ç”¨aptæ’ä»¶ï¼Œå¹¶è®¾ç½®aptç”Ÿæˆçš„ç´¢å¼•çš„åŒ…åå’Œç±»å</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">&#x27;com.neenbedankt.android-apt&#x27;</span></span><br><span class="line">apt &#123;</span><br><span class="line">    arguments &#123;</span><br><span class="line">        eventBusIndex <span class="string">&quot;com.android.gallery3d.MySubscriberInfoIndex&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="appçš„dependenciesä¸­å¼•å…¥EventBusAnnotationProcessorï¼š"><a href="#appçš„dependenciesä¸­å¼•å…¥EventBusAnnotationProcessorï¼š" class="headerlink" title="appçš„dependenciesä¸­å¼•å…¥EventBusAnnotationProcessorï¼š"></a>appçš„dependenciesä¸­å¼•å…¥EventBusAnnotationProcessorï¼š</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt <span class="string">&#x27;org.greenrobot:eventbus-annotation-processor:3.0.1&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="æŠŠæ³¨è§£ç”Ÿæˆçš„ç´¢å¼•æ·»åŠ åˆ°EventBusé»˜è®¤çš„å•ä¾‹ä¸­ï¼Œæ³¨æ„installDefaultEventBusè¿™ä¸ªæ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡"><a href="#æŠŠæ³¨è§£ç”Ÿæˆçš„ç´¢å¼•æ·»åŠ åˆ°EventBusé»˜è®¤çš„å•ä¾‹ä¸­ï¼Œæ³¨æ„installDefaultEventBusè¿™ä¸ªæ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡" class="headerlink" title="æŠŠæ³¨è§£ç”Ÿæˆçš„ç´¢å¼•æ·»åŠ åˆ°EventBusé»˜è®¤çš„å•ä¾‹ä¸­ï¼Œæ³¨æ„installDefaultEventBusè¿™ä¸ªæ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡"></a>æŠŠæ³¨è§£ç”Ÿæˆçš„ç´¢å¼•æ·»åŠ åˆ°EventBusé»˜è®¤çš„å•ä¾‹ä¸­ï¼Œæ³¨æ„installDefaultEventBusè¿™ä¸ªæ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EventBus.builder().addIndex(<span class="keyword">new</span> <span class="title class_">MySubscriberInfoIndex</span>()).installDefaultEventBus();  </span><br></pre></td></tr></table></figure><h2 id="EventBusåŸç†æµ…æ"><a href="#EventBusåŸç†æµ…æ" class="headerlink" title="EventBusåŸç†æµ…æ"></a>EventBusåŸç†æµ…æ</h2><h3 id="EventBus-getDefault-æ–¹æ³•"><a href="#EventBus-getDefault-æ–¹æ³•" class="headerlink" title="EventBus.getDefault()æ–¹æ³•"></a>EventBus.getDefault()æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> EventBus <span class="title function_">getDefault</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (defaultInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (EventBus.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (defaultInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">                defaultInstance = <span class="keyword">new</span> <span class="title class_">EventBus</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> defaultInstance;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><h3 id="EventBus-getDefault-register-this-æ–¹æ³•"><a href="#EventBus-getDefault-register-this-æ–¹æ³•" class="headerlink" title="EventBus.getDefault().register(this)æ–¹æ³•"></a>EventBus.getDefault().register(this)æ–¹æ³•</h3>  <img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/eventbus//register.png"/><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(Object subscriber)</span> &#123;</span><br><span class="line">    Class&lt;?&gt; subscriberClass = subscriber.getClass();</span><br><span class="line">    List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (SubscriberMethod subscriberMethod : subscriberMethods) &#123;</span><br><span class="line">            subscribe(subscriber, subscriberMethod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, CopyOnWriteArrayList&lt;Subscription&gt;&gt; subscriptionsByEventType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, List&lt;Class&lt;?&gt;&gt;&gt; typesBySubscriber;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(Object subscriber, SubscriberMethod subscriberMethod)</span> &#123;</span><br><span class="line">    Class&lt;?&gt; eventType = subscriberMethod.eventType;</span><br><span class="line">    <span class="type">Subscription</span> <span class="variable">newSubscription</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Subscription</span>(subscriber, subscriberMethod);</span><br><span class="line">    CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</span><br><span class="line">    <span class="keyword">if</span> (subscriptions == <span class="literal">null</span>) &#123;</span><br><span class="line">        subscriptions = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class="line">        subscriptionsByEventType.put(eventType, subscriptions);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (subscriptions.contains(newSubscription)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">EventBusException</span>(<span class="string">&quot;Subscriber &quot;</span> + subscriber.getClass() + <span class="string">&quot; already registered to event &quot;</span></span><br><span class="line">                    + eventType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> subscriptions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= size; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == size || subscriberMethod.priority &gt; subscriptions.get(i).subscriberMethod.priority) &#123;</span><br><span class="line">            subscriptions.add(i, newSubscription);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.get(subscriber);</span><br><span class="line">    <span class="keyword">if</span> (subscribedEvents == <span class="literal">null</span>) &#123;</span><br><span class="line">        subscribedEvents = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        typesBySubscriber.put(subscriber, subscribedEvents);</span><br><span class="line">    &#125;</span><br><span class="line">    subscribedEvents.add(eventType);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (subscriberMethod.sticky) &#123;</span><br><span class="line">        <span class="keyword">if</span> (eventInheritance) &#123;</span><br><span class="line">            <span class="comment">// Existing sticky events of all subclasses of eventType have to be considered.</span></span><br><span class="line">            <span class="comment">// Note: Iterating over all events may be inefficient with lots of sticky events,</span></span><br><span class="line">            <span class="comment">// thus data structure should be changed to allow a more efficient lookup</span></span><br><span class="line">            <span class="comment">// (e.g. an additional map storing sub classes of super classes: Class -&gt; List&lt;Class&gt;).</span></span><br><span class="line">            Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;</span><br><span class="line">                Class&lt;?&gt; candidateEventType = entry.getKey();</span><br><span class="line">                <span class="keyword">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">stickyEvent</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">                    checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">stickyEvent</span> <span class="operator">=</span> stickyEvents.get(eventType);</span><br><span class="line">            checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkPostStickyEventToSubscription</span><span class="params">(Subscription newSubscription, Object stickyEvent)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (stickyEvent != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If the subscriber is trying to abort the event, it will fail (event is not tracked in posting state)</span></span><br><span class="line">        <span class="comment">// --&gt; Strange corner case, which we don&#x27;t take care of here.</span></span><br><span class="line">        postToSubscription(newSubscription, stickyEvent, Looper.getMainLooper() == Looper.myLooper());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">postToSubscription</span><span class="params">(Subscription subscription, Object event, <span class="type">boolean</span> isMainThread)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (subscription.subscriberMethod.threadMode) &#123;</span><br><span class="line">        <span class="keyword">case</span> POSTING:</span><br><span class="line">            invokeSubscriber(subscription, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MAIN:</span><br><span class="line">            <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mainThreadPoster.enqueue(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> BACKGROUND:</span><br><span class="line">            <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                backgroundPoster.enqueue(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ASYNC:</span><br><span class="line">            asyncPoster.enqueue(subscription, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unknown thread mode: &quot;</span> + subscription.subscriberMethod.threadMode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><h3 id="EventBus-getDefault-post-new-LoadEvent"><a href="#EventBus-getDefault-post-new-LoadEvent" class="headerlink" title="EventBus.getDefault().post(new LoadEvent());"></a>EventBus.getDefault().post(new LoadEvent());</h3>  <img src="https://raw.githubusercontent.com/way1989/way1989.github.io/hexo/images_post/eventbus//post.png"/><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">post</span><span class="params">(Object event)</span> &#123;</span><br><span class="line">    <span class="type">PostingThreadState</span> <span class="variable">postingState</span> <span class="operator">=</span> currentPostingThreadState.get();</span><br><span class="line">    List&lt;Object&gt; eventQueue = postingState.eventQueue;</span><br><span class="line">    eventQueue.add(event);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!postingState.isPosting) &#123;</span><br><span class="line">        postingState.isMainThread = Looper.getMainLooper() == Looper.myLooper();</span><br><span class="line">        postingState.isPosting = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (postingState.canceled) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">EventBusException</span>(<span class="string">&quot;Internal error. Abort state was not reset&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!eventQueue.isEmpty()) &#123;</span><br><span class="line">                postSingleEvent(eventQueue.remove(<span class="number">0</span>), postingState);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            postingState.isPosting = <span class="literal">false</span>;</span><br><span class="line">            postingState.isMainThread = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">postSingleEvent</span><span class="params">(Object event, PostingThreadState postingState)</span> <span class="keyword">throws</span> Error &#123;</span><br><span class="line">    Class&lt;?&gt; eventClass = event.getClass();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">subscriptionFound</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (eventInheritance) &#123;</span><br><span class="line">        List&lt;Class&lt;?&gt;&gt; eventTypes = lookupAllEventTypes(eventClass);</span><br><span class="line">        <span class="type">int</span> <span class="variable">countTypes</span> <span class="operator">=</span> eventTypes.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">0</span>; h &lt; countTypes; h++) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = eventTypes.get(h);</span><br><span class="line">            subscriptionFound |= postSingleEventForEventType(event, postingState, clazz);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        subscriptionFound = postSingleEventForEventType(event, postingState, eventClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!subscriptionFound) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logNoSubscriberMessages) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;No subscribers registered for event &quot;</span> + eventClass);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sendNoSubscriberEvent &amp;&amp; eventClass != NoSubscriberEvent.class &amp;&amp;</span><br><span class="line">                eventClass != SubscriberExceptionEvent.class) &#123;</span><br><span class="line">            post(<span class="keyword">new</span> <span class="title class_">NoSubscriberEvent</span>(<span class="built_in">this</span>, event));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">postSingleEventForEventType</span><span class="params">(Object event, PostingThreadState postingState, Class&lt;?&gt; eventClass)</span> &#123;</span><br><span class="line">    CopyOnWriteArrayList&lt;Subscription&gt; subscriptions;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        subscriptions = subscriptionsByEventType.get(eventClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (subscriptions != <span class="literal">null</span> &amp;&amp; !subscriptions.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Subscription subscription : subscriptions) &#123;</span><br><span class="line">            postingState.event = event;</span><br><span class="line">            postingState.subscription = subscription;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">aborted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                postToSubscription(subscription, event, postingState.isMainThread);</span><br><span class="line">                aborted = postingState.canceled;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                postingState.event = <span class="literal">null</span>;</span><br><span class="line">                postingState.subscription = <span class="literal">null</span>;</span><br><span class="line">                postingState.canceled = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (aborted) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">postToSubscription</span><span class="params">(Subscription subscription, Object event, <span class="type">boolean</span> isMainThread)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (subscription.subscriberMethod.threadMode) &#123;</span><br><span class="line">        <span class="keyword">case</span> POSTING:</span><br><span class="line">            invokeSubscriber(subscription, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MAIN:</span><br><span class="line">            <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mainThreadPoster.enqueue(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> BACKGROUND:</span><br><span class="line">            <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                backgroundPoster.enqueue(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ASYNC:</span><br><span class="line">            asyncPoster.enqueue(subscription, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unknown thread mode: &quot;</span> + subscription.subscriberMethod.threadMode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">invokeSubscriber</span><span class="params">(Subscription subscription, Object event)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        subscription.subscriberMethod.method.invoke(subscription.subscriber, event);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">        handleSubscriberException(subscription, event, e.getCause());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unexpected exception&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><h3 id="EventBus-getDefault-unregister-this"><a href="#EventBus-getDefault-unregister-this" class="headerlink" title="EventBus.getDefault().unregister(this);"></a>EventBus.getDefault().unregister(this);</h3>  <img src="https://raw.githubusercontent.com/way1989/way1989.github.io/master/images/unregister.png"/><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, List&lt;Class&lt;?&gt;&gt;&gt; typesBySubscriber;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">unregister</span><span class="params">(Object subscriber)</span> &#123;</span><br><span class="line">    List&lt;Class&lt;?&gt;&gt; subscribedTypes = typesBySubscriber.get(subscriber);</span><br><span class="line">    <span class="keyword">if</span> (subscribedTypes != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; eventType : subscribedTypes) &#123;</span><br><span class="line">            unsubscribeByEventType(subscriber, eventType);</span><br><span class="line">        &#125;</span><br><span class="line">        typesBySubscriber.remove(subscriber);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">&quot;Subscriber to unregister was not registered before: &quot;</span> + subscriber.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, CopyOnWriteArrayList&lt;Subscription&gt;&gt; subscriptionsByEventType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unsubscribeByEventType</span><span class="params">(Object subscriber, Class&lt;?&gt; eventType)</span> &#123;</span><br><span class="line">    List&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</span><br><span class="line">    <span class="keyword">if</span> (subscriptions != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> subscriptions.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            <span class="type">Subscription</span> <span class="variable">subscription</span> <span class="operator">=</span> subscriptions.get(i);</span><br><span class="line">            <span class="keyword">if</span> (subscription.subscriber == subscriber) &#123;</span><br><span class="line">                subscription.active = <span class="literal">false</span>;</span><br><span class="line">                subscriptions.remove(i);</span><br><span class="line">                i--;</span><br><span class="line">                size--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><h2 id="EventBusç¼ºç‚¹"><a href="#EventBusç¼ºç‚¹" class="headerlink" title="EventBusç¼ºç‚¹"></a>EventBusç¼ºç‚¹</h2><ul><li>è€¦åˆæ€§å¤ªä½</li><li>è®¢é˜…çš„äº‹ä»¶æ˜¯åˆ©ç”¨åå°„çš„æœºåˆ¶æ‰§è¡Œçš„</li><li>ä¸èƒ½è·¨è¿›ç¨‹</li></ul><h2 id="ç”¨RxJavaå®ç°ç®€æ˜“RxBus"><a href="#ç”¨RxJavaå®ç°ç®€æ˜“RxBus" class="headerlink" title="ç”¨RxJavaå®ç°ç®€æ˜“RxBus"></a>ç”¨RxJavaå®ç°ç®€æ˜“RxBus</h2><h3 id="å®ç°RxBus"><a href="#å®ç°RxBus" class="headerlink" title="å®ç°RxBus"></a>å®ç°RxBus</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RxBus</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> RxBus sInstance;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Subject subject;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">RxBus</span><span class="params">()</span> &#123;</span><br><span class="line">        subject = <span class="keyword">new</span> <span class="title class_">SerializedSubject</span>&lt;&gt;(PublishSubject.create());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RxBus <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (RxBus.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (sInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    sInstance = <span class="keyword">new</span> <span class="title class_">RxBus</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">post</span><span class="params">(Object event)</span> &#123;</span><br><span class="line">        subject.onNext(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Observable&lt;T&gt; <span class="title function_">toObservable</span><span class="params">(Class&lt;T&gt; eventType)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> subject.ofType(eventType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><h3 id="è®¢é˜…äº‹ä»¶-1"><a href="#è®¢é˜…äº‹ä»¶-1" class="headerlink" title="è®¢é˜…äº‹ä»¶"></a>è®¢é˜…äº‹ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RxBus.getInstance().toObservable(ForceUpdateEvent.class)</span><br><span class="line">        .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">        .compose(<span class="built_in">this</span>.&lt;ForceUpdateEvent&gt;bindUntilEvent(ActivityEvent.DESTROY))</span><br><span class="line">        .subscribe(<span class="keyword">new</span> <span class="title class_">Action1</span>&lt;ForceUpdateEvent&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(ForceUpdateEvent forceUpdateEvent)</span> &#123;</span><br><span class="line">                <span class="comment">//do some thing</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);  </span><br></pre></td></tr></table></figure><h3 id="å‘å¸ƒäº‹ä»¶-1"><a href="#å‘å¸ƒäº‹ä»¶-1" class="headerlink" title="å‘å¸ƒäº‹ä»¶"></a>å‘å¸ƒäº‹ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RxBus.getInstance().post(<span class="keyword">new</span> <span class="title class_">ForceUpdateEvent</span>(parameter));  </span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForceUpdateEvent</span> &#123;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ul><li><a href="https://github.com/greenrobot/EventBus">EventBus github</a></li><li><a href="http://www.cnblogs.com/bugly/p/5475034.html">Buglyå¹²è´§åˆ†äº«ã€‘è€å¸æœºæ•™ä½  â€œé£™â€ EventBus 3</a></li><li><a href="http://blog.csdn.net/lmj623565791/article/details/40920453">Android EventBusæºç è§£æ å¸¦ä½ æ·±å…¥ç†è§£EventBus</a></li><li><a href="http://www.jianshu.com/p/ca090f6e2fe2">ç”¨RxJavaå®ç°äº‹ä»¶æ€»çº¿(Event Bus)</a></li></ul>]]></content>
      
      <categories>
          
          <category> åšå®¢ </category>
          
          <category> EventBus </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åšå®¢ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>å°†.pemä¸.pk8æ–‡ä»¶è½¬æ¢æˆ.keystoreç­¾åæ–‡ä»¶</title>
      <link href="/2016/08/04/notes/ApkKeystore/"/>
      <url>/2016/08/04/notes/ApkKeystore/</url>
      <content type="html"><![CDATA[<h2 id="æ–°å»ºä¸€ä¸ªplatformç›®å½•ï¼Œå°†å¹³å°ç”¨åˆ°çš„ä¸¤ä¸ªæ–‡ä»¶platform-x509-pemå’Œplatform-pk8æ‹·è´è¿‡æ¥ï¼Œé€šå¸¸åœ¨build-target-product-security-ç›®å½•ä¸‹-æ™®é€šç­¾åæ–¹å¼æ˜¯ï¼š"><a href="#æ–°å»ºä¸€ä¸ªplatformç›®å½•ï¼Œå°†å¹³å°ç”¨åˆ°çš„ä¸¤ä¸ªæ–‡ä»¶platform-x509-pemå’Œplatform-pk8æ‹·è´è¿‡æ¥ï¼Œé€šå¸¸åœ¨build-target-product-security-ç›®å½•ä¸‹-æ™®é€šç­¾åæ–¹å¼æ˜¯ï¼š" class="headerlink" title="æ–°å»ºä¸€ä¸ªplatformç›®å½•ï¼Œå°†å¹³å°ç”¨åˆ°çš„ä¸¤ä¸ªæ–‡ä»¶platform.x509.pemå’Œplatform.pk8æ‹·è´è¿‡æ¥ï¼Œé€šå¸¸åœ¨build&#x2F;target&#x2F;product&#x2F;security&#x2F;ç›®å½•ä¸‹,æ™®é€šç­¾åæ–¹å¼æ˜¯ï¼š"></a>æ–°å»ºä¸€ä¸ªplatformç›®å½•ï¼Œå°†å¹³å°ç”¨åˆ°çš„ä¸¤ä¸ªæ–‡ä»¶platform.x509.pemå’Œplatform.pk8æ‹·è´è¿‡æ¥ï¼Œé€šå¸¸åœ¨build&#x2F;target&#x2F;product&#x2F;security&#x2F;ç›®å½•ä¸‹,æ™®é€šç­¾åæ–¹å¼æ˜¯ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">inPath=<span class="variable">$1</span></span><br><span class="line">outPath=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line">java -jar out/host/linux-x86/framework/signapk.jar build/target/product/security/tinno_common/platform.x509.pem  build/target/product/security/tinno_common/platform.pk8 <span class="variable">$&#123;inPath&#125;</span> <span class="variable">$&#123;outPath&#125;</span></span><br></pre></td></tr></table></figure><h2 id="æŠŠpkcs8æ ¼å¼çš„ç§é’¥è½¬æ¢ä¸ºpkcs12æ ¼å¼ï¼Œç”Ÿæˆplatform-priv-pemæ–‡ä»¶ï¼š"><a href="#æŠŠpkcs8æ ¼å¼çš„ç§é’¥è½¬æ¢ä¸ºpkcs12æ ¼å¼ï¼Œç”Ÿæˆplatform-priv-pemæ–‡ä»¶ï¼š" class="headerlink" title="æŠŠpkcs8æ ¼å¼çš„ç§é’¥è½¬æ¢ä¸ºpkcs12æ ¼å¼ï¼Œç”Ÿæˆplatform.priv.pemæ–‡ä»¶ï¼š"></a>æŠŠpkcs8æ ¼å¼çš„ç§é’¥è½¬æ¢ä¸ºpkcs12æ ¼å¼ï¼Œç”Ÿæˆplatform.priv.pemæ–‡ä»¶ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl pkcs8 -<span class="keyword">in</span> platform.pk8 -inform DER -outform PEM -out platform.priv.pem -nocrypt</span><br></pre></td></tr></table></figure><h2 id="ç”Ÿæˆpkcs12æ ¼å¼çš„å¯†é’¥æ–‡ä»¶-ç”Ÿæˆplatform-pk12æ–‡ä»¶ï¼Œæœ€åçš„brillianceæ˜¯keystoreçš„aliasï¼Œéœ€è¦è¾“å…¥ä¸¤æ¬¡å¯†ç ï¼Œæˆ‘ä»¬è¿™é‡Œé»˜è®¤ä¸ºandroidã€‚"><a href="#ç”Ÿæˆpkcs12æ ¼å¼çš„å¯†é’¥æ–‡ä»¶-ç”Ÿæˆplatform-pk12æ–‡ä»¶ï¼Œæœ€åçš„brillianceæ˜¯keystoreçš„aliasï¼Œéœ€è¦è¾“å…¥ä¸¤æ¬¡å¯†ç ï¼Œæˆ‘ä»¬è¿™é‡Œé»˜è®¤ä¸ºandroidã€‚" class="headerlink" title="ç”Ÿæˆpkcs12æ ¼å¼çš„å¯†é’¥æ–‡ä»¶,ç”Ÿæˆplatform.pk12æ–‡ä»¶ï¼Œæœ€åçš„brillianceæ˜¯keystoreçš„aliasï¼Œéœ€è¦è¾“å…¥ä¸¤æ¬¡å¯†ç ï¼Œæˆ‘ä»¬è¿™é‡Œé»˜è®¤ä¸ºandroidã€‚"></a>ç”Ÿæˆpkcs12æ ¼å¼çš„å¯†é’¥æ–‡ä»¶,ç”Ÿæˆplatform.pk12æ–‡ä»¶ï¼Œæœ€åçš„brillianceæ˜¯keystoreçš„aliasï¼Œéœ€è¦è¾“å…¥ä¸¤æ¬¡å¯†ç ï¼Œæˆ‘ä»¬è¿™é‡Œé»˜è®¤ä¸ºandroidã€‚</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl pkcs12 -<span class="built_in">export</span> -<span class="keyword">in</span> platform.x509.pem -inkey platform.priv.pem -out platform.pk12 -name brilliance</span><br></pre></td></tr></table></figure><h2 id="ç”Ÿæˆplatform-keystore"><a href="#ç”Ÿæˆplatform-keystore" class="headerlink" title="ç”Ÿæˆplatform.keystore"></a>ç”Ÿæˆplatform.keystore</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ keytool -importkeystore -deststorepass android -destkeypass android -destkeystore platform.keystore -srckeystore platform.pk12 -srcstoretype PKCS12 -srcstorepass android -<span class="built_in">alias</span> brilliance</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨-keystoreç­¾åçš„è„šæœ¬signapkï¼š"><a href="#ä½¿ç”¨-keystoreç­¾åçš„è„šæœ¬signapkï¼š" class="headerlink" title="ä½¿ç”¨.keystoreç­¾åçš„è„šæœ¬signapkï¼š"></a>ä½¿ç”¨.keystoreç­¾åçš„è„šæœ¬signapkï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Sample usage is as follows;</span></span><br><span class="line"><span class="comment"># ./signapk myapp.apk debug.keystore android androiddebugkey</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># param1, APK file: Calculator_debug.apk</span></span><br><span class="line"><span class="comment"># param2, keystore location: ~/.android/debug.keystore</span></span><br><span class="line"><span class="comment"># param3, key storepass: android</span></span><br><span class="line"><span class="comment"># param4, key alias: androiddebugkey</span></span><br><span class="line"></span><br><span class="line">USER_HOME=$(<span class="built_in">eval</span> <span class="built_in">echo</span> ~<span class="variable">$&#123;SUDO_USER&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># use my debug key default</span></span><br><span class="line">APK=<span class="variable">$1</span></span><br><span class="line">KEYSTORE=<span class="string">&quot;<span class="variable">$&#123;2:-<span class="variable">$USER_HOME</span>/.android/debug.keystore&#125;</span>&quot;</span></span><br><span class="line">STOREPASS=<span class="string">&quot;<span class="variable">$&#123;3:-android&#125;</span>&quot;</span></span><br><span class="line">ALIAS=<span class="string">&quot;<span class="variable">$&#123;4:-androiddebugkey&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># get the filename</span></span><br><span class="line">APK_BASENAME=$(<span class="built_in">basename</span> <span class="variable">$APK</span>)</span><br><span class="line">SIGNED_APK=<span class="string">&quot;signed_&quot;</span><span class="variable">$APK_BASENAME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#debug</span></span><br><span class="line"><span class="built_in">echo</span> param1 <span class="variable">$APK</span></span><br><span class="line"><span class="built_in">echo</span> param2 <span class="variable">$KEYSTORE</span></span><br><span class="line"><span class="built_in">echo</span> param3 <span class="variable">$STOREPASS</span></span><br><span class="line"><span class="built_in">echo</span> param4 <span class="variable">$ALIAS</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># delete META-INF folder</span></span><br><span class="line">zip -d <span class="variable">$APK</span> META-INF/\*</span><br><span class="line"></span><br><span class="line"><span class="comment"># sign APK</span></span><br><span class="line">jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore <span class="variable">$KEYSTORE</span> -storepass <span class="variable">$STOREPASS</span> <span class="variable">$APK</span> <span class="variable">$ALIAS</span></span><br><span class="line"><span class="comment">#verify</span></span><br><span class="line">jarsigner -verify <span class="variable">$APK</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#zipalign</span></span><br><span class="line">zipalign -v 4 <span class="variable">$APK</span> <span class="variable">$SIGNED_APK</span></span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
          <category> keystore </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ä¸‹è½½åŠ¨ç”»ï¼Œå›¾æ ‡é£å…¥ä¸‹è½½ç®¡ç†åŠ¨ç”»å®ç°</title>
      <link href="/2016/07/02/notes/AndroidAnimation/"/>
      <url>/2016/07/02/notes/AndroidAnimation/</url>
      <content type="html"><![CDATA[<h2 id="ä¸»è¦ä»£ç ï¼š"><a href="#ä¸»è¦ä»£ç ï¼š" class="headerlink" title="ä¸»è¦ä»£ç ï¼š"></a>ä¸»è¦ä»£ç ï¼š</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Button sActionBarDownload;  <span class="comment">//titleæ çš„ä¸‹è½½  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> FrameLayout sParentView;  <span class="comment">//è·å–çˆ¶view  </span></span><br><span class="line">    <span class="keyword">protected</span> ImageView mImageSwitcher;  </span><br><span class="line">    <span class="comment">// ä¸‹è½½é£å‡ºåŠ¨ç”»çš„è§†å›¾  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">ImageView</span> <span class="variable">mAnimationImageView</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–å±å¹•çš„æ•´ä¸ªå¤§view  </span></span><br><span class="line">    sParentView = (FrameLayout) findViewById(R.id.parent_view);  </span><br><span class="line">    mActionBarContainer = (ActionBarContainer) findViewById(R.id.actionbar);  </span><br><span class="line">    sActionBarDownload = (Button) findViewById(R.id.btn_download_recommend);  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">iconFlyOutAnimation</span><span class="params">(<span class="keyword">final</span> AppInfoDataBean app, <span class="keyword">final</span> View v)</span> &#123;  </span><br><span class="line">        <span class="type">int</span>[] location = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">2</span>];  </span><br><span class="line">        mImageSwitcher.getLocationInWindow(location);  <span class="comment">//è¦ä¸‹è½½åº”ç”¨å›¾æ ‡çš„ä½ç½®,ç›¸å¯¹äºwindowçš„ä½ç½®  </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> mImageSwitcher.getWidth();  </span><br><span class="line">        <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> mImageSwitcher.getHeight();  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (MyActivity.sParentView != <span class="literal">null</span>)  <span class="comment">//titleä¸‹è½½çš„ä½ç½®  </span></span><br><span class="line">        &#123;  </span><br><span class="line">            <span class="comment">//è·å–åˆ°ç›®æ ‡viewç›¸å¯¹äºwindowçš„ä½ç½®  </span></span><br><span class="line">            <span class="type">int</span>[] locationRelative = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">2</span>];  </span><br><span class="line">            MyActivity.sActionBarDownload.getLocationInWindow(locationRelative);  </span><br><span class="line"></span><br><span class="line">            <span class="comment">//å°†æºviewæ”¾åˆ°ImageViewä¸­  </span></span><br><span class="line">            mAnimationImageView = <span class="keyword">new</span> <span class="title class_">ImageView</span>(getContext());  </span><br><span class="line">            FrameLayout.<span class="type">LayoutParams</span> <span class="variable">params</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FrameLayout</span>.LayoutParams(width, height);  </span><br><span class="line">            params.leftMargin = locationRelative[<span class="number">0</span>] - location[<span class="number">0</span>];  </span><br><span class="line">            params.topMargin = location[<span class="number">1</span>] - locationRelative[<span class="number">1</span>];  </span><br><span class="line"></span><br><span class="line">            <span class="comment">//è·å–åˆ°æºå›¾ç‰‡çš„å½“å‰viewï¼Œå¹¶è®¾ç½®åˆ°Drawable  </span></span><br><span class="line">            <span class="type">ImageView</span> <span class="variable">iconImage</span> <span class="operator">=</span> (ImageView) mImageSwitcher.getCurrentView();  </span><br><span class="line">            mAnimationImageView.setImageDrawable(iconImage.getDrawable());  </span><br><span class="line">            <span class="comment">//å°†åŠ¨ç”»æ·»åŠ åˆ°æ§ä»¶å†…ï¼ŒæºåŠ åˆ°ç›®æ ‡ä¸­  </span></span><br><span class="line">            MyActivity.sParentView.addView(mAnimationImageView, params);  </span><br><span class="line"></span><br><span class="line">            <span class="comment">//è·å–ç›®æ ‡çš„ä½ç½®æ§ä»¶çš„é•¿ã€å®½  </span></span><br><span class="line">            <span class="type">int</span>[] locationDst = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">2</span>];  </span><br><span class="line">            locationDst[<span class="number">0</span>] = MyActivity.sActionBarDownload.getWidth();  </span><br><span class="line">            locationDst[<span class="number">1</span>] = MyActivity.sActionBarDownload.getHeight();  </span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">destXp</span> <span class="operator">=</span> locationDst[<span class="number">0</span>] / <span class="number">2</span>;  </span><br><span class="line">            <span class="type">int</span> <span class="variable">destYp</span> <span class="operator">=</span> locationDst[<span class="number">1</span>] / <span class="number">2</span>;  </span><br><span class="line">            <span class="type">int</span> <span class="variable">destX</span> <span class="operator">=</span> params.leftMargin - destXp;  </span><br><span class="line">            <span class="type">int</span> <span class="variable">destY</span> <span class="operator">=</span> params.topMargin - destYp + DrawUtils.dip2px(<span class="number">20</span>);  </span><br><span class="line">            <span class="comment">//ä½ç§»  </span></span><br><span class="line">            <span class="type">Animation</span> <span class="variable">translateAnimation</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TranslateAnimation</span>(-destX, DrawUtils.dip2px(<span class="number">12</span>), <span class="number">0</span>, -destY);  </span><br><span class="line">            translateAnimation.setDuration(<span class="number">600</span>);  </span><br><span class="line">            <span class="comment">//ç¼©æ”¾  </span></span><br><span class="line">            <span class="type">Animation</span> <span class="variable">scaleAnimation</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScaleAnimation</span>(<span class="number">1</span>, <span class="number">0.1f</span>, <span class="number">1</span>, <span class="number">0.1f</span>, Animation.RELATIVE_TO_SELF, <span class="number">0.5f</span>,  </span><br><span class="line">                    Animation.RELATIVE_TO_SELF, <span class="number">0.5f</span>);  </span><br><span class="line">            scaleAnimation.setDuration(<span class="number">600</span>);  </span><br><span class="line">            <span class="comment">//æ—‹è½¬åŠ¨ç”»æ•ˆæœ    </span></span><br><span class="line">            <span class="type">Animation</span> <span class="variable">rotateAnimation</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RotateAnimation</span>(<span class="number">0f</span>, <span class="number">720</span>, Animation.RELATIVE_TO_SELF, <span class="number">0.5f</span>,  </span><br><span class="line">                    Animation.RELATIVE_TO_SELF, <span class="number">0.5f</span>);  </span><br><span class="line">            rotateAnimation.setDuration(<span class="number">600</span>);  </span><br><span class="line"></span><br><span class="line">            <span class="type">AnimationSet</span> <span class="variable">animationSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnimationSet</span>(<span class="literal">true</span>);  </span><br><span class="line">            animationSet.setInterpolator(<span class="keyword">new</span> <span class="title class_">DecelerateInterpolator</span>(<span class="number">2.0f</span>));  </span><br><span class="line"></span><br><span class="line">            animationSet.addAnimation(rotateAnimation);  </span><br><span class="line">            animationSet.addAnimation(scaleAnimation);  </span><br><span class="line">            animationSet.addAnimation(translateAnimation);  </span><br><span class="line">            <span class="comment">//            BaseDataActivity.mActionBarDownload.InterceptTouchEvent(true); //è®¾ç½®ä¸å¯ç‚¹å‡»  </span></span><br><span class="line"></span><br><span class="line">            animationSet.setAnimationListener(<span class="keyword">new</span> <span class="title class_">AnimationListener</span>() &#123;  </span><br><span class="line">                <span class="meta">@Override</span>  </span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animation animation)</span> &#123;  </span><br><span class="line">                    <span class="keyword">if</span> (mAnimationImageView != <span class="literal">null</span> &amp;&amp; mAnimationImageView.getTag() == animation) &#123;  </span><br><span class="line">                        MyActivity.sParentView.removeView(mAnimationImageView);  </span><br><span class="line"></span><br><span class="line">                        mAnimationImageView = <span class="literal">null</span>;  </span><br><span class="line">                        <span class="comment">// è¿è¡Œå®ŒåŠ¨ç”»å†ä¸‹è½½  </span></span><br><span class="line">                        downLoad(app);  </span><br><span class="line">                    &#125;  </span><br><span class="line">                    <span class="comment">//                    BaseDataActivity.mActionBarDownload.onInterceptTouchEvent(false);  </span></span><br><span class="line">                &#125;  </span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span>  </span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationRepeat</span><span class="params">(Animation animation)</span> &#123;  </span><br><span class="line"></span><br><span class="line">                &#125;  </span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span>  </span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationStart</span><span class="params">(Animation animation)</span> &#123;  </span><br><span class="line"></span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;);  </span><br><span class="line"></span><br><span class="line">            mAnimationImageView.startAnimation(animationSet);  </span><br><span class="line">            mAnimationImageView.setTag(animationSet);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
          <category> Animation </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>è“ç‰™ä¼ è¾“æ–‡ä»¶ä»£ç </title>
      <link href="/2016/06/05/notes/BluetoothShare/"/>
      <url>/2016/06/05/notes/BluetoothShare/</url>
      <content type="html"><![CDATA[<h2 id="ä¸»è¦ä»£ç ï¼š"><a href="#ä¸»è¦ä»£ç ï¼š" class="headerlink" title="ä¸»è¦ä»£ç ï¼š"></a>ä¸»è¦ä»£ç ï¼š</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendFile</span><span class="params">(Activity activity)</span> &#123;</span><br><span class="line">    <span class="type">PackageManager</span> <span class="variable">localPackageManager</span> <span class="operator">=</span> activity.getPackageManager();</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">    HashMap&lt;String, ActivityInfo&gt; shareItems = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        intent.setAction(Intent.ACTION_SEND);</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> App.getContext().getPackageManager()</span><br><span class="line">              .getApplicationInfo(BuildConfig.APPLICATION_ID, <span class="number">0</span>).sourceDir;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filepath);</span><br><span class="line">        intent.putExtra(Intent.EXTRA_STREAM, Uri.fromFile(file));</span><br><span class="line">        <span class="comment">// intent.putExtra(Intent.EXTRA_STREAM,</span></span><br><span class="line">        <span class="comment">// Uri.fromFile(new File(localApplicationInfo.sourceDir)));</span></span><br><span class="line">        intent.setType(<span class="string">&quot;*/*&quot;</span>);</span><br><span class="line">        List&lt;ResolveInfo&gt; resolveInfos = localPackageManager.queryIntentActivities(intent, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span>(ResolveInfo resolveInfo : resolveInfos)&#123;</span><br><span class="line">           <span class="type">ActivityInfo</span> <span class="variable">activityInfo</span> <span class="operator">=</span> resolveInfo.activityInfo;</span><br><span class="line">           <span class="type">String</span> <span class="variable">progressName</span> <span class="operator">=</span> activityInfo.applicationInfo.processName;</span><br><span class="line">           <span class="keyword">if</span>(progressName.contains(<span class="string">&quot;bluetooth&quot;</span>))</span><br><span class="line">                shareItems.put(progressName, activityInfo);</span><br><span class="line">            &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          Log.e(e.getMessage(), e);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">ActivityInfo</span> <span class="variable">activityInfo</span> <span class="operator">=</span> shareItems.get(<span class="string">&quot;com.android.bluetooth&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (activityInfo == <span class="literal">null</span>)</span><br><span class="line">          activityInfo = shareItems.get(<span class="string">&quot;com.mediatek.bluetooth&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (activityInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">          Iterator&lt;ActivityInfo&gt; iterator = shareItems.values().iterator();</span><br><span class="line">          <span class="keyword">if</span> (iterator.hasNext())</span><br><span class="line">                activityInfo =  iterator.next();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (activityInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">          intent.setComponent(<span class="keyword">new</span> <span class="title class_">ComponentName</span>(activityInfo.packageName, activityInfo.name));</span><br><span class="line">          activity.startActivityForResult(intent, BLUETOOTH_SHARE_REQUEST_CODE);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
          <category> Bluetooth </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Capturerå¸®åŠ©æ–‡æ¡£</title>
      <link href="/2016/05/15/help/CapturerHelp/"/>
      <url>/2016/05/15/help/CapturerHelp/</url>
      <content type="html"><![CDATA[<h1 id="Capturerä½¿ç”¨è¯´æ˜"><a href="#Capturerä½¿ç”¨è¯´æ˜" class="headerlink" title="Capturerä½¿ç”¨è¯´æ˜"></a>Capturerä½¿ç”¨è¯´æ˜</h1><p><a href="http://fir.im/capturer">Capturer</a>æ˜¯ä¸ºAndroidå¹³å°è®¾è®¡çš„ï¼Œé›†<code>æˆªå±ã€é•¿æˆªå±ã€å½•å±ä»¥åŠå°†å½•å±å†…å®¹è½¬æ¢æˆGIFåŠ¨æ€å›¾</code>ç­‰å¤šåŠŸèƒ½äºä¸€ä½“çš„ï¼Œå°å·§å¼ºæ‚çš„å®ç”¨å‹å·¥å…·è½¯ä»¶ã€‚</p><h2 id="æ™®é€šæˆªå±"><a href="#æ™®é€šæˆªå±" class="headerlink" title="æ™®é€šæˆªå±"></a>æ™®é€šæˆªå±</h2><h3 id="æ“ä½œæ–¹å¼"><a href="#æ“ä½œæ–¹å¼" class="headerlink" title="æ“ä½œæ–¹å¼"></a>æ“ä½œæ–¹å¼</h3><p>  ç¡®ä¿__Capturer__å·²ç»æ­£å¸¸å¯åŠ¨ï¼Œè¿›å…¥åˆ°ä»»ä½•éœ€è¦æˆªå±çš„åº”ç”¨ï¼Œæ‘‡ä¸€æ‘‡å¯åŠ¨Captainä¸»èœå•ï¼Œç‚¹å‡»é¡ºæ—¶é’ˆ<code>ä¸¤ç‚¹é’Ÿä½ç½®çš„å›¾æ ‡</code>å¼€å§‹æˆªå±(é•¿æŒ‰ä¼šæœ‰æç¤º)ã€‚</p><p>  ä¸ç³»ç»Ÿ<code>é•¿æŒ‰ç”µæºé”®+éŸ³é‡é”®</code>æˆªå±æ˜¯ä¸€æ ·çš„ã€‚</p><p>  æ™®é€šæˆªå±æ¼”ç¤ºèŒƒä¾‹ï¼š</p><p><img src="https://raw.githubusercontent.com/way1989/Captain/master/help/normal_screenshot.gif" alt="Long Screenshot"></p><h2 id="å½•å±"><a href="#å½•å±" class="headerlink" title="å½•å±"></a>å½•å±</h2><h3 id="æ“ä½œæ–¹å¼-1"><a href="#æ“ä½œæ–¹å¼-1" class="headerlink" title="æ“ä½œæ–¹å¼"></a>æ“ä½œæ–¹å¼</h3><p>  ç¡®ä¿__Capturer__å·²ç»æ­£å¸¸å¯åŠ¨ï¼Œè¿›å…¥åˆ°ä»»ä½•éœ€è¦å½•å±çš„åº”ç”¨ï¼Œæ‘‡ä¸€æ‘‡å¯åŠ¨Captainä¸»èœå•ï¼Œç‚¹å‡»é¡ºæ—¶é’ˆ<code>å››ç‚¹é’Ÿä½ç½®çš„å›¾æ ‡</code>å¼€å§‹å½•å±(é•¿æŒ‰ä¼šæœ‰æç¤º)ã€‚</p><p>  å½“å±å¹•ä¸Šæ–¹å½•å±æ“ä½œèœå•åï¼Œè¿˜æ²¡çœŸæ­£å¼€å§‹å½•å±ï¼Œå¯ä»¥ç‚¹å‡»<code>å·¦è¾¹çš„æŒ‰é’®</code>å–æ¶ˆå½•å±ï¼Œç‚¹å‡»<code>å³è¾¹çš„æŒ‰é’®</code>åˆ‡æ¢å½•åˆ¶è§†é¢‘çš„ç”»è´¨è´¨é‡(å…¨é«˜æ¸…ç”»è´¨ä¸å±å¹•åˆ†è¾¨ç‡ä¸€è‡´ï¼Œé«˜æ¸…ä¸ºå±å¹•åˆ†è¾¨ç‡çš„75%ï¼Œæ ‡æ¸…ä¸º50%)ï¼Œç‚¹å‡»<code>ä¸­é—´çš„æŒ‰é’®</code>æ‰å¼€å§‹çœŸæ­£çš„å½•å±ã€‚</p><p>  å€’è®¡æ—¶3ç§’åï¼Œæ˜¾ç¤ºåœæ­¢æŒ‰é’®å¹¶è®¡æ—¶è¡¨ç¤ºçœŸæ­£å¼€å§‹å½•å±äº†ï¼Œå¯ä»¥é€šè¿‡ç‚¹å‡»<code>åœæ­¢æŒ‰é’®</code>éšæ—¶ç»“æŸå½•å±ã€‚</p><h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><p>   <strong>ç”»è´¨è¶Šé«˜ï¼Œå½•åˆ¶çš„è§†é¢‘æ–‡ä»¶å°±è¶Šå¤§ï¼Œæ˜¾ç¤ºæ•ˆæœè¶Šå¥½</strong>ã€‚<br>   <strong>3ç§’å€’è®¡æ—¶å¯ä»¥åœ¨è®¾ç½®ä¸­å–æ¶ˆ</strong>ã€‚<br>   <strong>åœæ­¢æŒ‰é’®å¯ä»¥è®¾ç½®æ˜¾ç¤ºåœ¨é€šçŸ¥æ ä¸­</strong>ã€‚</p><h3 id="å½•å±æ¼”ç¤º"><a href="#å½•å±æ¼”ç¤º" class="headerlink" title="å½•å±æ¼”ç¤º"></a>å½•å±æ¼”ç¤º</h3><p><img src="https://raw.githubusercontent.com/way1989/Captain/master/help/screen_record.gif" alt="Long Screenshot"></p><h2 id="é•¿æˆªå±"><a href="#é•¿æˆªå±" class="headerlink" title="é•¿æˆªå±"></a>é•¿æˆªå±</h2><h3 id="æ“ä½œæ–¹å¼-2"><a href="#æ“ä½œæ–¹å¼-2" class="headerlink" title="æ“ä½œæ–¹å¼"></a>æ“ä½œæ–¹å¼</h3><p>  ç¡®ä¿__Capturer__å·²ç»æ­£å¸¸å¯åŠ¨ï¼Œè¿›å…¥åˆ°éœ€è¦é•¿æˆªå±çš„åº”ç”¨ï¼Œæ‘‡ä¸€æ‘‡å¯åŠ¨Captainä¸»èœå•ï¼Œç‚¹å‡»é¡ºæ—¶é’ˆ<code>å…­ç‚¹é’Ÿä½ç½®çš„å›¾æ ‡</code>å¼€å§‹é•¿æˆªå±(é•¿æŒ‰ä¼šæœ‰æç¤º)ã€‚</p><p>  å½“å±å¹•ä¸Šæ–¹æ˜¾ç¤ºæç¤ºç•Œé¢åï¼ŒæŒ‰ç…§å±å¹•ç®­å¤´çš„æ–¹å‘æ»šåŠ¨ä¸__ç®­å¤´é•¿åº¦ç›¸åŒ__çš„é«˜åº¦ã€‚</p><p>  æ»šåŠ¨å®Œä¸€æ¬¡ä¹‹åï¼Œç‚¹å‡»ä¸€æ¬¡ä¸Šæ–¹çš„æç¤ºç•Œé¢ï¼Œå†æ¥ç€æ»šåŠ¨ä¸€æ¬¡ï¼Œç‚¹å‡»ä¸€æ¬¡ï¼Œå¦‚æœæƒ³ç»“æŸé•¿æˆªå±ï¼Œç›´æ¥ç‚¹å‡»ä¸¤æ¬¡å³å¯ã€‚</p><h3 id="æ³¨æ„äº‹é¡¹-1"><a href="#æ³¨æ„äº‹é¡¹-1" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><p>   <strong>æ»šåŠ¨ä¸€æ¬¡ï¼Œç‚¹å‡»ä¸€æ¬¡ï¼Œè¿ç‚¹ä¸¤æ¬¡ç›´æ¥ç»“æŸ</strong>ã€‚<br>   <strong>æ¯æ¬¡æ»šåŠ¨çš„é«˜åº¦å°½é‡ä¸ç®­å¤´é•¿åº¦ç›¸è¿‘ï¼Œé¿å…æ»šåŠ¨è¿‡å¤§å¯¼è‡´é•¿å›¾æ‹¼æ¥å¤±è´¥</strong>ã€‚</p><h3 id="é•¿æˆªå±æ¼”ç¤º"><a href="#é•¿æˆªå±æ¼”ç¤º" class="headerlink" title="é•¿æˆªå±æ¼”ç¤º"></a>é•¿æˆªå±æ¼”ç¤º</h3><p><img src="https://raw.githubusercontent.com/way1989/Captain/master/help/long_screenshot.gif" alt="Long Screenshot"></p><h2 id="ä»»æ„æˆªå±"><a href="#ä»»æ„æˆªå±" class="headerlink" title="ä»»æ„æˆªå±"></a>ä»»æ„æˆªå±</h2><h3 id="æ“ä½œæ–¹å¼-3"><a href="#æ“ä½œæ–¹å¼-3" class="headerlink" title="æ“ä½œæ–¹å¼"></a>æ“ä½œæ–¹å¼</h3><p>  ç¡®ä¿__Capturer__å·²ç»æ­£å¸¸å¯åŠ¨ï¼Œè¿›å…¥åˆ°éœ€è¦ä»»æ„æˆªå±çš„åº”ç”¨ï¼Œæ‘‡ä¸€æ‘‡å¯åŠ¨Captainä¸»èœå•ï¼Œç‚¹å‡»é¡ºæ—¶é’ˆ<code>åç‚¹é’Ÿä½ç½®çš„å›¾æ ‡</code>å¼€å§‹ä»»æ„æˆªå±(é•¿æŒ‰ä¼šæœ‰æç¤º)ã€‚</p><p>  å½“å±å¹•ä¸­æ˜¾ç¤ºæç¤ºç•Œé¢ï¼ŒæŒ‰ç…§æç¤ºç”¨æ‰‹æŒ‡åœˆé€‰éœ€è¦æˆªå–çš„éƒ¨åˆ†ï¼Œç‚¹å‡»<code>ç¡®å®š</code>æŒ‰é’®ä¿å­˜æˆªå›¾ã€‚</p><p>  å¦‚æœéœ€è¦é‡æ–°é€‰å–æˆªå±åŒºåŸŸï¼Œç›´æ¥ç”¨æ‰‹æŒ‡åœˆé€‰æ–°çš„åŒºåŸŸå³å¯ã€‚</p><h3 id="æ³¨æ„äº‹é¡¹-2"><a href="#æ³¨æ„äº‹é¡¹-2" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><p>   <strong>ä¿å­˜åœˆé€‰åŒºåŸŸå†…å®¹éœ€è¦ç‚¹å‡»<code>ç¡®å®š</code>æŒ‰é’®</strong>ã€‚<br>   <strong>é€‰æ‹©æ–°åŒºåŸŸæ—¶ï¼Œä¸éœ€è¦åšå…¶ä»–æ“ä½œï¼Œç›´æ¥åœ¨å±å¹•ä¸Šé‡æ–°åœˆé€‰</strong>ã€‚<br>   <strong>ä¸åœˆé€‰ç›´æ¥ç‚¹å‡»<code>ç¡®å®š</code>æŒ‰é’®ï¼Œå°†ç›´æ¥ä¿å­˜å®Œæ•´å±å¹•æˆªå›¾</strong>ã€‚</p><h3 id="ä»»æ„æˆªå±æ¼”ç¤º"><a href="#ä»»æ„æˆªå±æ¼”ç¤º" class="headerlink" title="ä»»æ„æˆªå±æ¼”ç¤º"></a>ä»»æ„æˆªå±æ¼”ç¤º</h3><p><img src="https://raw.githubusercontent.com/way1989/Captain/master/help/free_screenshot.gif" alt="Long Screenshot"></p><h2 id="çŸ©å½¢åŒºåŸŸæˆªå±"><a href="#çŸ©å½¢åŒºåŸŸæˆªå±" class="headerlink" title="çŸ©å½¢åŒºåŸŸæˆªå±"></a>çŸ©å½¢åŒºåŸŸæˆªå±</h2><h3 id="æ“ä½œæ–¹å¼-4"><a href="#æ“ä½œæ–¹å¼-4" class="headerlink" title="æ“ä½œæ–¹å¼"></a>æ“ä½œæ–¹å¼</h3><p>  ç¡®ä¿__Capturer__å·²ç»æ­£å¸¸å¯åŠ¨ï¼Œè¿›å…¥åˆ°éœ€è¦çŸ©å½¢åŒºåŸŸæˆªå±çš„åº”ç”¨ï¼Œæ‘‡ä¸€æ‘‡å¯åŠ¨Captainä¸»èœå•ï¼Œç‚¹å‡»é¡ºæ—¶é’ˆ<code>åäºŒç‚¹ç§ä½ç½®çš„å›¾æ ‡</code>å¼€å§‹çŸ©å½¢åŒºåŸŸæˆªå±(é•¿æŒ‰ä¼šæœ‰æç¤º)ã€‚</p><p>  å½“å±å¹•ä¸­æ˜¾ç¤ºæç¤ºç•Œé¢ï¼ŒæŒ‰ç…§æç¤ºï¼Œè°ƒæ•´çŸ©å½¢æ¡†çš„å¤§å°å’Œæ‹–åŠ¨çŸ©å½¢æ¡†çš„ä½ç½®æ¥é€‰æ‹©éœ€è¦æˆªå±çš„éƒ¨åˆ†ã€‚</p><p>  åŒå‡»å±å¹•å³å¯ä¿å­˜æ‰€é€‰åŒºåŸŸæˆªå±å†…å®¹ã€‚</p><h3 id="æ³¨æ„äº‹é¡¹-3"><a href="#æ³¨æ„äº‹é¡¹-3" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><p>   <strong>é€šè¿‡çŸ©å½¢æ¡†å››ä¸ªè§’è°ƒæ•´å¤§å°ï¼Œé€šè¿‡è§¦æ‘¸çŸ©å½¢æ¡†å…¶ä»–åŒºåŸŸå¯ä»¥æ‹–åŠ¨</strong>ã€‚<br>   <strong>åŒå‡»å³å¯ä¿å­˜çŸ©å½¢æ¡†åŒºåŸŸå†…çš„æˆªå±å†…å®¹</strong>ã€‚</p><h3 id="çŸ©å½¢åŒºåŸŸæˆªå±æ¼”ç¤º"><a href="#çŸ©å½¢åŒºåŸŸæˆªå±æ¼”ç¤º" class="headerlink" title="çŸ©å½¢åŒºåŸŸæˆªå±æ¼”ç¤º"></a>çŸ©å½¢åŒºåŸŸæˆªå±æ¼”ç¤º</h3><p><img src="https://raw.githubusercontent.com/way1989/Captain/master/help/rect_screenshot.gif" alt="Long Screenshot"></p><h2 id="è§†é¢‘è½¬æ¢æˆGIF"><a href="#è§†é¢‘è½¬æ¢æˆGIF" class="headerlink" title="è§†é¢‘è½¬æ¢æˆGIF"></a>è§†é¢‘è½¬æ¢æˆGIF</h2><h3 id="æ“ä½œæ–¹å¼-5"><a href="#æ“ä½œæ–¹å¼-5" class="headerlink" title="æ“ä½œæ–¹å¼"></a>æ“ä½œæ–¹å¼</h3><p>  è¿›å…¥__Capturer__ï¼Œé€‰æ‹©è§†é¢‘TABé¡µï¼Œç‚¹å‡»ä»»ä½•éœ€è¦è½¬æ¢çš„è§†é¢‘ï¼Œç„¶åå†ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹æ’­æ”¾ç¼–è¾‘è§†é¢‘ã€‚</p><p>  é€šè¿‡åº•éƒ¨æ‹–åŠ¨æŒ‰é’®é€‰å–éœ€è¦è½¬æ¢è§†é¢‘çš„æ—¶é—´ã€‚</p><p>  ç‚¹å‡»<code>ç”ŸæˆGIF</code>æŒ‰é’®å³å¯å¼¹å‡ºé€‰æ‹©GIFç”»è´¨çš„å¯¹è¯æ¡†ï¼Œé€‰æ‹©ä¸€ä¸ªç”»è´¨ç‚¹å‡»ç¡®å®šå³å¯å¼€å§‹è½¬æ¢ã€‚</p><h3 id="æ³¨æ„äº‹é¡¹-4"><a href="#æ³¨æ„äº‹é¡¹-4" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><p>   <strong>ç¬¬ä¸€æ¬¡å¼€å§‹è½¬æ¢æ—¶ï¼Œéœ€è¦ä¸‹è½½ä¸€ä¸ª<code>FFmpeg</code>åŠ¨æ€åº“</strong>ã€‚<br>   <strong>é€‰å–è½¬æ¢çš„æ—¶é—´åªèƒ½ç²¾ç¡®åˆ°ç§’ï¼Œå› æ­¤å¯èƒ½ç”ŸæˆGIFå›¾å‰åä¼šå­˜åœ¨å°‘è®¸è¯¯å·®</strong>ã€‚<br>   <strong>ç²¾ç»†ç”»è´¨å®½480ï¼Œå¸§ç‡12ï¼Œæ ‡å‡†ç”»è´¨360ï¼Œå¸§ç‡10ï¼Œå‹ç¼©ç”»è´¨å®½240ï¼Œå¸§ç‡8ï¼Œä¸ºå‡å°‘ç”¨æˆ·æ“ä½œï¼Œæš‚æ—¶å›ºå®šè¿™å‡ ç§ç”»è´¨</strong>ã€‚<br>   <strong>ç”»è´¨è¶Šé«˜ï¼Œé€‰æ‹©è§†é¢‘æ—¶é—´è¶Šé•¿ï¼Œç”ŸæˆGIFæ–‡ä»¶ä¹Ÿå°±è¶Šå¤§</strong>ã€‚</p><h3 id="è§†é¢‘è½¬æ¢æˆGIFæ¼”ç¤º"><a href="#è§†é¢‘è½¬æ¢æˆGIFæ¼”ç¤º" class="headerlink" title="è§†é¢‘è½¬æ¢æˆGIFæ¼”ç¤º"></a>è§†é¢‘è½¬æ¢æˆGIFæ¼”ç¤º</h3><p><img src="https://raw.githubusercontent.com/way1989/Captain/master/help/video_to_gif.gif" alt="Long Screenshot"></p>]]></content>
      
      <categories>
          
          <category> å¸®åŠ©æ–‡æ¡£ </category>
          
          <category> Capturer </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¸®åŠ©æ–‡æ¡£ </tag>
            
        </tags>
      
    </entry>
    
  
  
</search>
